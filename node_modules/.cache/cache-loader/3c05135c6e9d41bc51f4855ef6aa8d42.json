{"remainingRequest":"C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\thread-loader\\dist\\cjs.js!C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\babel-loader\\lib\\index.js!C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\vue\\dist\\vue.runtime.esm.js","dependencies":[{"path":"C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\vue\\dist\\vue.runtime.esm.js","mtime":499162500000},{"path":"C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\thread-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Administrator\\Desktop\\webpack\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:ZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgovKiEKICogVnVlLmpzIHYyLjYuMTAKICogKGMpIDIwMTQtMjAxOSBFdmFuIFlvdQogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuCiAqLwoKLyogICovCnZhciBlbXB0eU9iamVjdCA9IE9iamVjdC5mcmVlemUoe30pOyAvLyBUaGVzZSBoZWxwZXJzIHByb2R1Y2UgYmV0dGVyIFZNIGNvZGUgaW4gSlMgZW5naW5lcyBkdWUgdG8gdGhlaXIKLy8gZXhwbGljaXRuZXNzIGFuZCBmdW5jdGlvbiBpbmxpbmluZy4KCmZ1bmN0aW9uIGlzVW5kZWYodikgewogIHJldHVybiB2ID09PSB1bmRlZmluZWQgfHwgdiA9PT0gbnVsbDsKfQoKZnVuY3Rpb24gaXNEZWYodikgewogIHJldHVybiB2ICE9PSB1bmRlZmluZWQgJiYgdiAhPT0gbnVsbDsKfQoKZnVuY3Rpb24gaXNUcnVlKHYpIHsKICByZXR1cm4gdiA9PT0gdHJ1ZTsKfQoKZnVuY3Rpb24gaXNGYWxzZSh2KSB7CiAgcmV0dXJuIHYgPT09IGZhbHNlOwp9Ci8qKgogKiBDaGVjayBpZiB2YWx1ZSBpcyBwcmltaXRpdmUuCiAqLwoKCmZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbHVlKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fCAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICBfdHlwZW9mKHZhbHVlKSA9PT0gJ3N5bWJvbCcgfHwgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbic7Cn0KLyoqCiAqIFF1aWNrIG9iamVjdCBjaGVjayAtIHRoaXMgaXMgcHJpbWFyaWx5IHVzZWQgdG8gdGVsbAogKiBPYmplY3RzIGZyb20gcHJpbWl0aXZlIHZhbHVlcyB3aGVuIHdlIGtub3cgdGhlIHZhbHVlCiAqIGlzIGEgSlNPTi1jb21wbGlhbnQgdHlwZS4KICovCgoKZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgcmV0dXJuIG9iaiAhPT0gbnVsbCAmJiBfdHlwZW9mKG9iaikgPT09ICdvYmplY3QnOwp9Ci8qKgogKiBHZXQgdGhlIHJhdyB0eXBlIHN0cmluZyBvZiBhIHZhbHVlLCBlLmcuLCBbb2JqZWN0IE9iamVjdF0uCiAqLwoKCnZhciBfdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKZnVuY3Rpb24gdG9SYXdUeXBlKHZhbHVlKSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKHZhbHVlKS5zbGljZSg4LCAtMSk7Cn0KLyoqCiAqIFN0cmljdCBvYmplY3QgdHlwZSBjaGVjay4gT25seSByZXR1cm5zIHRydWUKICogZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cy4KICovCgoKZnVuY3Rpb24gaXNQbGFpbk9iamVjdChvYmopIHsKICByZXR1cm4gX3RvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7Cn0KCmZ1bmN0aW9uIGlzUmVnRXhwKHYpIHsKICByZXR1cm4gX3RvU3RyaW5nLmNhbGwodikgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9Ci8qKgogKiBDaGVjayBpZiB2YWwgaXMgYSB2YWxpZCBhcnJheSBpbmRleC4KICovCgoKZnVuY3Rpb24gaXNWYWxpZEFycmF5SW5kZXgodmFsKSB7CiAgdmFyIG4gPSBwYXJzZUZsb2F0KFN0cmluZyh2YWwpKTsKICByZXR1cm4gbiA+PSAwICYmIE1hdGguZmxvb3IobikgPT09IG4gJiYgaXNGaW5pdGUodmFsKTsKfQoKZnVuY3Rpb24gaXNQcm9taXNlKHZhbCkgewogIHJldHVybiBpc0RlZih2YWwpICYmIHR5cGVvZiB2YWwudGhlbiA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgdmFsWyJjYXRjaCJdID09PSAnZnVuY3Rpb24nOwp9Ci8qKgogKiBDb252ZXJ0IGEgdmFsdWUgdG8gYSBzdHJpbmcgdGhhdCBpcyBhY3R1YWxseSByZW5kZXJlZC4KICovCgoKZnVuY3Rpb24gdG9TdHJpbmcodmFsKSB7CiAgcmV0dXJuIHZhbCA9PSBudWxsID8gJycgOiBBcnJheS5pc0FycmF5KHZhbCkgfHwgaXNQbGFpbk9iamVjdCh2YWwpICYmIHZhbC50b1N0cmluZyA9PT0gX3RvU3RyaW5nID8gSlNPTi5zdHJpbmdpZnkodmFsLCBudWxsLCAyKSA6IFN0cmluZyh2YWwpOwp9Ci8qKgogKiBDb252ZXJ0IGFuIGlucHV0IHZhbHVlIHRvIGEgbnVtYmVyIGZvciBwZXJzaXN0ZW5jZS4KICogSWYgdGhlIGNvbnZlcnNpb24gZmFpbHMsIHJldHVybiBvcmlnaW5hbCBzdHJpbmcuCiAqLwoKCmZ1bmN0aW9uIHRvTnVtYmVyKHZhbCkgewogIHZhciBuID0gcGFyc2VGbG9hdCh2YWwpOwogIHJldHVybiBpc05hTihuKSA/IHZhbCA6IG47Cn0KLyoqCiAqIE1ha2UgYSBtYXAgYW5kIHJldHVybiBhIGZ1bmN0aW9uIGZvciBjaGVja2luZyBpZiBhIGtleQogKiBpcyBpbiB0aGF0IG1hcC4KICovCgoKZnVuY3Rpb24gbWFrZU1hcChzdHIsIGV4cGVjdHNMb3dlckNhc2UpIHsKICB2YXIgbWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB2YXIgbGlzdCA9IHN0ci5zcGxpdCgnLCcpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgIG1hcFtsaXN0W2ldXSA9IHRydWU7CiAgfQoKICByZXR1cm4gZXhwZWN0c0xvd2VyQ2FzZSA/IGZ1bmN0aW9uICh2YWwpIHsKICAgIHJldHVybiBtYXBbdmFsLnRvTG93ZXJDYXNlKCldOwogIH0gOiBmdW5jdGlvbiAodmFsKSB7CiAgICByZXR1cm4gbWFwW3ZhbF07CiAgfTsKfQovKioKICogQ2hlY2sgaWYgYSB0YWcgaXMgYSBidWlsdC1pbiB0YWcuCiAqLwoKCnZhciBpc0J1aWx0SW5UYWcgPSBtYWtlTWFwKCdzbG90LGNvbXBvbmVudCcsIHRydWUpOwovKioKICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIGEgcmVzZXJ2ZWQgYXR0cmlidXRlLgogKi8KCnZhciBpc1Jlc2VydmVkQXR0cmlidXRlID0gbWFrZU1hcCgna2V5LHJlZixzbG90LHNsb3Qtc2NvcGUsaXMnKTsKLyoqCiAqIFJlbW92ZSBhbiBpdGVtIGZyb20gYW4gYXJyYXkuCiAqLwoKZnVuY3Rpb24gcmVtb3ZlKGFyciwgaXRlbSkgewogIGlmIChhcnIubGVuZ3RoKSB7CiAgICB2YXIgaW5kZXggPSBhcnIuaW5kZXhPZihpdGVtKTsKCiAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICByZXR1cm4gYXJyLnNwbGljZShpbmRleCwgMSk7CiAgICB9CiAgfQp9Ci8qKgogKiBDaGVjayB3aGV0aGVyIGFuIG9iamVjdCBoYXMgdGhlIHByb3BlcnR5LgogKi8KCgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKZnVuY3Rpb24gaGFzT3duKG9iaiwga2V5KSB7CiAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwp9Ci8qKgogKiBDcmVhdGUgYSBjYWNoZWQgdmVyc2lvbiBvZiBhIHB1cmUgZnVuY3Rpb24uCiAqLwoKCmZ1bmN0aW9uIGNhY2hlZChmbikgewogIHZhciBjYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgcmV0dXJuIGZ1bmN0aW9uIGNhY2hlZEZuKHN0cikgewogICAgdmFyIGhpdCA9IGNhY2hlW3N0cl07CiAgICByZXR1cm4gaGl0IHx8IChjYWNoZVtzdHJdID0gZm4oc3RyKSk7CiAgfTsKfQovKioKICogQ2FtZWxpemUgYSBoeXBoZW4tZGVsaW1pdGVkIHN0cmluZy4KICovCgoKdmFyIGNhbWVsaXplUkUgPSAvLShcdykvZzsKdmFyIGNhbWVsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoY2FtZWxpemVSRSwgZnVuY3Rpb24gKF8sIGMpIHsKICAgIHJldHVybiBjID8gYy50b1VwcGVyQ2FzZSgpIDogJyc7CiAgfSk7Cn0pOwovKioKICogQ2FwaXRhbGl6ZSBhIHN0cmluZy4KICovCgp2YXIgY2FwaXRhbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0ci5zbGljZSgxKTsKfSk7Ci8qKgogKiBIeXBoZW5hdGUgYSBjYW1lbENhc2Ugc3RyaW5nLgogKi8KCnZhciBoeXBoZW5hdGVSRSA9IC9cQihbQS1aXSkvZzsKdmFyIGh5cGhlbmF0ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKGh5cGhlbmF0ZVJFLCAnLSQxJykudG9Mb3dlckNhc2UoKTsKfSk7Ci8qKgogKiBTaW1wbGUgYmluZCBwb2x5ZmlsbCBmb3IgZW52aXJvbm1lbnRzIHRoYXQgZG8gbm90IHN1cHBvcnQgaXQsCiAqIGUuZy4sIFBoYW50b21KUyAxLnguIFRlY2huaWNhbGx5LCB3ZSBkb24ndCBuZWVkIHRoaXMgYW55bW9yZQogKiBzaW5jZSBuYXRpdmUgYmluZCBpcyBub3cgcGVyZm9ybWFudCBlbm91Z2ggaW4gbW9zdCBicm93c2Vycy4KICogQnV0IHJlbW92aW5nIGl0IHdvdWxkIG1lYW4gYnJlYWtpbmcgY29kZSB0aGF0IHdhcyBhYmxlIHRvIHJ1biBpbgogKiBQaGFudG9tSlMgMS54LCBzbyB0aGlzIG11c3QgYmUga2VwdCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4KICovCgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKZnVuY3Rpb24gcG9seWZpbGxCaW5kKGZuLCBjdHgpIHsKICBmdW5jdGlvbiBib3VuZEZuKGEpIHsKICAgIHZhciBsID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIHJldHVybiBsID8gbCA+IDEgPyBmbi5hcHBseShjdHgsIGFyZ3VtZW50cykgOiBmbi5jYWxsKGN0eCwgYSkgOiBmbi5jYWxsKGN0eCk7CiAgfQoKICBib3VuZEZuLl9sZW5ndGggPSBmbi5sZW5ndGg7CiAgcmV0dXJuIGJvdW5kRm47Cn0KCmZ1bmN0aW9uIG5hdGl2ZUJpbmQoZm4sIGN0eCkgewogIHJldHVybiBmbi5iaW5kKGN0eCk7Cn0KCnZhciBiaW5kID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPyBuYXRpdmVCaW5kIDogcG9seWZpbGxCaW5kOwovKioKICogQ29udmVydCBhbiBBcnJheS1saWtlIG9iamVjdCB0byBhIHJlYWwgQXJyYXkuCiAqLwoKZnVuY3Rpb24gdG9BcnJheShsaXN0LCBzdGFydCkgewogIHN0YXJ0ID0gc3RhcnQgfHwgMDsKICB2YXIgaSA9IGxpc3QubGVuZ3RoIC0gc3RhcnQ7CiAgdmFyIHJldCA9IG5ldyBBcnJheShpKTsKCiAgd2hpbGUgKGktLSkgewogICAgcmV0W2ldID0gbGlzdFtpICsgc3RhcnRdOwogIH0KCiAgcmV0dXJuIHJldDsKfQovKioKICogTWl4IHByb3BlcnRpZXMgaW50byB0YXJnZXQgb2JqZWN0LgogKi8KCgpmdW5jdGlvbiBleHRlbmQodG8sIF9mcm9tKSB7CiAgZm9yICh2YXIga2V5IGluIF9mcm9tKSB7CiAgICB0b1trZXldID0gX2Zyb21ba2V5XTsKICB9CgogIHJldHVybiB0bzsKfQovKioKICogTWVyZ2UgYW4gQXJyYXkgb2YgT2JqZWN0cyBpbnRvIGEgc2luZ2xlIE9iamVjdC4KICovCgoKZnVuY3Rpb24gdG9PYmplY3QoYXJyKSB7CiAgdmFyIHJlcyA9IHt9OwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgaWYgKGFycltpXSkgewogICAgICBleHRlbmQocmVzLCBhcnJbaV0pOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQovKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqLwoKLyoqCiAqIFBlcmZvcm0gbm8gb3BlcmF0aW9uLgogKiBTdHViYmluZyBhcmdzIHRvIG1ha2UgRmxvdyBoYXBweSB3aXRob3V0IGxlYXZpbmcgdXNlbGVzcyB0cmFuc3BpbGVkIGNvZGUKICogd2l0aCAuLi5yZXN0IChodHRwczovL2Zsb3cub3JnL2Jsb2cvMjAxNy8wNS8wNy9TdHJpY3QtRnVuY3Rpb24tQ2FsbC1Bcml0eS8pLgogKi8KCgpmdW5jdGlvbiBub29wKGEsIGIsIGMpIHt9Ci8qKgogKiBBbHdheXMgcmV0dXJuIGZhbHNlLgogKi8KCgp2YXIgbm8gPSBmdW5jdGlvbiBubyhhLCBiLCBjKSB7CiAgcmV0dXJuIGZhbHNlOwp9OwovKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovCgovKioKICogUmV0dXJuIHRoZSBzYW1lIHZhbHVlLgogKi8KCgp2YXIgaWRlbnRpdHkgPSBmdW5jdGlvbiBpZGVudGl0eShfKSB7CiAgcmV0dXJuIF87Cn07Ci8qKgogKiBDaGVjayBpZiB0d28gdmFsdWVzIGFyZSBsb29zZWx5IGVxdWFsIC0gdGhhdCBpcywKICogaWYgdGhleSBhcmUgcGxhaW4gb2JqZWN0cywgZG8gdGhleSBoYXZlIHRoZSBzYW1lIHNoYXBlPwogKi8KCgpmdW5jdGlvbiBsb29zZUVxdWFsKGEsIGIpIHsKICBpZiAoYSA9PT0gYikgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgaXNPYmplY3RBID0gaXNPYmplY3QoYSk7CiAgdmFyIGlzT2JqZWN0QiA9IGlzT2JqZWN0KGIpOwoKICBpZiAoaXNPYmplY3RBICYmIGlzT2JqZWN0QikgewogICAgdHJ5IHsKICAgICAgdmFyIGlzQXJyYXlBID0gQXJyYXkuaXNBcnJheShhKTsKICAgICAgdmFyIGlzQXJyYXlCID0gQXJyYXkuaXNBcnJheShiKTsKCiAgICAgIGlmIChpc0FycmF5QSAmJiBpc0FycmF5QikgewogICAgICAgIHJldHVybiBhLmxlbmd0aCA9PT0gYi5sZW5ndGggJiYgYS5ldmVyeShmdW5jdGlvbiAoZSwgaSkgewogICAgICAgICAgcmV0dXJuIGxvb3NlRXF1YWwoZSwgYltpXSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoYSBpbnN0YW5jZW9mIERhdGUgJiYgYiBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICByZXR1cm4gYS5nZXRUaW1lKCkgPT09IGIuZ2V0VGltZSgpOwogICAgICB9IGVsc2UgaWYgKCFpc0FycmF5QSAmJiAhaXNBcnJheUIpIHsKICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhhKTsKICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhiKTsKICAgICAgICByZXR1cm4ga2V5c0EubGVuZ3RoID09PSBrZXlzQi5sZW5ndGggJiYga2V5c0EuZXZlcnkoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgcmV0dXJuIGxvb3NlRXF1YWwoYVtrZXldLCBiW2tleV0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9IGVsc2UgaWYgKCFpc09iamVjdEEgJiYgIWlzT2JqZWN0QikgewogICAgcmV0dXJuIFN0cmluZyhhKSA9PT0gU3RyaW5nKGIpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9Ci8qKgogKiBSZXR1cm4gdGhlIGZpcnN0IGluZGV4IGF0IHdoaWNoIGEgbG9vc2VseSBlcXVhbCB2YWx1ZSBjYW4gYmUKICogZm91bmQgaW4gdGhlIGFycmF5IChpZiB2YWx1ZSBpcyBhIHBsYWluIG9iamVjdCwgdGhlIGFycmF5IG11c3QKICogY29udGFpbiBhbiBvYmplY3Qgb2YgdGhlIHNhbWUgc2hhcGUpLCBvciAtMSBpZiBpdCBpcyBub3QgcHJlc2VudC4KICovCgoKZnVuY3Rpb24gbG9vc2VJbmRleE9mKGFyciwgdmFsKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgIGlmIChsb29zZUVxdWFsKGFycltpXSwgdmFsKSkgewogICAgICByZXR1cm4gaTsKICAgIH0KICB9CgogIHJldHVybiAtMTsKfQovKioKICogRW5zdXJlIGEgZnVuY3Rpb24gaXMgY2FsbGVkIG9ubHkgb25jZS4KICovCgoKZnVuY3Rpb24gb25jZShmbikgewogIHZhciBjYWxsZWQgPSBmYWxzZTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjYWxsZWQpIHsKICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9Owp9Cgp2YXIgU1NSX0FUVFIgPSAnZGF0YS1zZXJ2ZXItcmVuZGVyZWQnOwp2YXIgQVNTRVRfVFlQRVMgPSBbJ2NvbXBvbmVudCcsICdkaXJlY3RpdmUnLCAnZmlsdGVyJ107CnZhciBMSUZFQ1lDTEVfSE9PS1MgPSBbJ2JlZm9yZUNyZWF0ZScsICdjcmVhdGVkJywgJ2JlZm9yZU1vdW50JywgJ21vdW50ZWQnLCAnYmVmb3JlVXBkYXRlJywgJ3VwZGF0ZWQnLCAnYmVmb3JlRGVzdHJveScsICdkZXN0cm95ZWQnLCAnYWN0aXZhdGVkJywgJ2RlYWN0aXZhdGVkJywgJ2Vycm9yQ2FwdHVyZWQnLCAnc2VydmVyUHJlZmV0Y2gnXTsKLyogICovCgp2YXIgY29uZmlnID0gewogIC8qKgogICAqIE9wdGlvbiBtZXJnZSBzdHJhdGVnaWVzICh1c2VkIGluIGNvcmUvdXRpbC9vcHRpb25zKQogICAqLwogIC8vICRmbG93LWRpc2FibGUtbGluZQogIG9wdGlvbk1lcmdlU3RyYXRlZ2llczogT2JqZWN0LmNyZWF0ZShudWxsKSwKCiAgLyoqCiAgICogV2hldGhlciB0byBzdXBwcmVzcyB3YXJuaW5ncy4KICAgKi8KICBzaWxlbnQ6IGZhbHNlLAoKICAvKioKICAgKiBTaG93IHByb2R1Y3Rpb24gbW9kZSB0aXAgbWVzc2FnZSBvbiBib290PwogICAqLwogIHByb2R1Y3Rpb25UaXA6IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicsCgogIC8qKgogICAqIFdoZXRoZXIgdG8gZW5hYmxlIGRldnRvb2xzCiAgICovCiAgZGV2dG9vbHM6IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicsCgogIC8qKgogICAqIFdoZXRoZXIgdG8gcmVjb3JkIHBlcmYKICAgKi8KICBwZXJmb3JtYW5jZTogZmFsc2UsCgogIC8qKgogICAqIEVycm9yIGhhbmRsZXIgZm9yIHdhdGNoZXIgZXJyb3JzCiAgICovCiAgZXJyb3JIYW5kbGVyOiBudWxsLAoKICAvKioKICAgKiBXYXJuIGhhbmRsZXIgZm9yIHdhdGNoZXIgd2FybnMKICAgKi8KICB3YXJuSGFuZGxlcjogbnVsbCwKCiAgLyoqCiAgICogSWdub3JlIGNlcnRhaW4gY3VzdG9tIGVsZW1lbnRzCiAgICovCiAgaWdub3JlZEVsZW1lbnRzOiBbXSwKCiAgLyoqCiAgICogQ3VzdG9tIHVzZXIga2V5IGFsaWFzZXMgZm9yIHYtb24KICAgKi8KICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICBrZXlDb2RlczogT2JqZWN0LmNyZWF0ZShudWxsKSwKCiAgLyoqCiAgICogQ2hlY2sgaWYgYSB0YWcgaXMgcmVzZXJ2ZWQgc28gdGhhdCBpdCBjYW5ub3QgYmUgcmVnaXN0ZXJlZCBhcyBhCiAgICogY29tcG9uZW50LiBUaGlzIGlzIHBsYXRmb3JtLWRlcGVuZGVudCBhbmQgbWF5IGJlIG92ZXJ3cml0dGVuLgogICAqLwogIGlzUmVzZXJ2ZWRUYWc6IG5vLAoKICAvKioKICAgKiBDaGVjayBpZiBhbiBhdHRyaWJ1dGUgaXMgcmVzZXJ2ZWQgc28gdGhhdCBpdCBjYW5ub3QgYmUgdXNlZCBhcyBhIGNvbXBvbmVudAogICAqIHByb3AuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uCiAgICovCiAgaXNSZXNlcnZlZEF0dHI6IG5vLAoKICAvKioKICAgKiBDaGVjayBpZiBhIHRhZyBpcyBhbiB1bmtub3duIGVsZW1lbnQuCiAgICogUGxhdGZvcm0tZGVwZW5kZW50LgogICAqLwogIGlzVW5rbm93bkVsZW1lbnQ6IG5vLAoKICAvKioKICAgKiBHZXQgdGhlIG5hbWVzcGFjZSBvZiBhbiBlbGVtZW50CiAgICovCiAgZ2V0VGFnTmFtZXNwYWNlOiBub29wLAoKICAvKioKICAgKiBQYXJzZSB0aGUgcmVhbCB0YWcgbmFtZSBmb3IgdGhlIHNwZWNpZmljIHBsYXRmb3JtLgogICAqLwogIHBhcnNlUGxhdGZvcm1UYWdOYW1lOiBpZGVudGl0eSwKCiAgLyoqCiAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIG11c3QgYmUgYm91bmQgdXNpbmcgcHJvcGVydHksIGUuZy4gdmFsdWUKICAgKiBQbGF0Zm9ybS1kZXBlbmRlbnQuCiAgICovCiAgbXVzdFVzZVByb3A6IG5vLAoKICAvKioKICAgKiBQZXJmb3JtIHVwZGF0ZXMgYXN5bmNocm9ub3VzbHkuIEludGVuZGVkIHRvIGJlIHVzZWQgYnkgVnVlIFRlc3QgVXRpbHMKICAgKiBUaGlzIHdpbGwgc2lnbmlmaWNhbnRseSByZWR1Y2UgcGVyZm9ybWFuY2UgaWYgc2V0IHRvIGZhbHNlLgogICAqLwogIGFzeW5jOiB0cnVlLAoKICAvKioKICAgKiBFeHBvc2VkIGZvciBsZWdhY3kgcmVhc29ucwogICAqLwogIF9saWZlY3ljbGVIb29rczogTElGRUNZQ0xFX0hPT0tTCn07Ci8qICAqLwoKLyoqCiAqIHVuaWNvZGUgbGV0dGVycyB1c2VkIGZvciBwYXJzaW5nIGh0bWwgdGFncywgY29tcG9uZW50IG5hbWVzIGFuZCBwcm9wZXJ0eSBwYXRocy4KICogdXNpbmcgaHR0cHM6Ly93d3cudzMub3JnL1RSL2h0bWw1My9zZW1hbnRpY3Mtc2NyaXB0aW5nLmh0bWwjcG90ZW50aWFsY3VzdG9tZWxlbWVudG5hbWUKICogc2tpcHBpbmcgXHUxMDAwMC1cdUVGRkZGIGR1ZSB0byBpdCBmcmVlemluZyB1cCBQaGFudG9tSlMKICovCgp2YXIgdW5pY29kZVJlZ0V4cCA9IC9hLXpBLVpcdTAwQjdcdTAwQzAtXHUwMEQ2XHUwMEQ4LVx1MDBGNlx1MDBGOC1cdTAzN0RcdTAzN0YtXHUxRkZGXHUyMDBDLVx1MjAwRFx1MjAzRi1cdTIwNDBcdTIwNzAtXHUyMThGXHUyQzAwLVx1MkZFRlx1MzAwMS1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkZGRC87Ci8qKgogKiBDaGVjayBpZiBhIHN0cmluZyBzdGFydHMgd2l0aCAkIG9yIF8KICovCgpmdW5jdGlvbiBpc1Jlc2VydmVkKHN0cikgewogIHZhciBjID0gKHN0ciArICcnKS5jaGFyQ29kZUF0KDApOwogIHJldHVybiBjID09PSAweDI0IHx8IGMgPT09IDB4NUY7Cn0KLyoqCiAqIERlZmluZSBhIHByb3BlcnR5LgogKi8KCgpmdW5jdGlvbiBkZWYob2JqLCBrZXksIHZhbCwgZW51bWVyYWJsZSkgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgdmFsdWU6IHZhbCwKICAgIGVudW1lcmFibGU6ICEhZW51bWVyYWJsZSwKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7Cn0KLyoqCiAqIFBhcnNlIHNpbXBsZSBwYXRoLgogKi8KCgp2YXIgYmFpbFJFID0gbmV3IFJlZ0V4cCgiW14iICsgdW5pY29kZVJlZ0V4cC5zb3VyY2UgKyAiLiRfXFxkXSIpOwoKZnVuY3Rpb24gcGFyc2VQYXRoKHBhdGgpIHsKICBpZiAoYmFpbFJFLnRlc3QocGF0aCkpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy4nKTsKICByZXR1cm4gZnVuY3Rpb24gKG9iaikgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoIW9iaikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgb2JqID0gb2JqW3NlZ21lbnRzW2ldXTsKICAgIH0KCiAgICByZXR1cm4gb2JqOwogIH07Cn0KLyogICovCi8vIGNhbiB3ZSB1c2UgX19wcm90b19fPwoKCnZhciBoYXNQcm90byA9ICdfX3Byb3RvX18nIGluIHt9OyAvLyBCcm93c2VyIGVudmlyb25tZW50IHNuaWZmaW5nCgp2YXIgaW5Ccm93c2VyID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCc7CnZhciBpbldlZXggPSB0eXBlb2YgV1hFbnZpcm9ubWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgISFXWEVudmlyb25tZW50LnBsYXRmb3JtOwp2YXIgd2VleFBsYXRmb3JtID0gaW5XZWV4ICYmIFdYRW52aXJvbm1lbnQucGxhdGZvcm0udG9Mb3dlckNhc2UoKTsKdmFyIFVBID0gaW5Ccm93c2VyICYmIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CnZhciBpc0lFID0gVUEgJiYgL21zaWV8dHJpZGVudC8udGVzdChVQSk7CnZhciBpc0lFOSA9IFVBICYmIFVBLmluZGV4T2YoJ21zaWUgOS4wJykgPiAwOwp2YXIgaXNFZGdlID0gVUEgJiYgVUEuaW5kZXhPZignZWRnZS8nKSA+IDA7CnZhciBpc0FuZHJvaWQgPSBVQSAmJiBVQS5pbmRleE9mKCdhbmRyb2lkJykgPiAwIHx8IHdlZXhQbGF0Zm9ybSA9PT0gJ2FuZHJvaWQnOwp2YXIgaXNJT1MgPSBVQSAmJiAvaXBob25lfGlwYWR8aXBvZHxpb3MvLnRlc3QoVUEpIHx8IHdlZXhQbGF0Zm9ybSA9PT0gJ2lvcyc7CnZhciBpc0Nocm9tZSA9IFVBICYmIC9jaHJvbWVcL1xkKy8udGVzdChVQSkgJiYgIWlzRWRnZTsKdmFyIGlzUGhhbnRvbUpTID0gVUEgJiYgL3BoYW50b21qcy8udGVzdChVQSk7CnZhciBpc0ZGID0gVUEgJiYgVUEubWF0Y2goL2ZpcmVmb3hcLyhcZCspLyk7IC8vIEZpcmVmb3ggaGFzIGEgIndhdGNoIiBmdW5jdGlvbiBvbiBPYmplY3QucHJvdG90eXBlLi4uCgp2YXIgbmF0aXZlV2F0Y2ggPSB7fS53YXRjaDsKdmFyIHN1cHBvcnRzUGFzc2l2ZSA9IGZhbHNlOwoKaWYgKGluQnJvd3NlcikgewogIHRyeSB7CiAgICB2YXIgb3B0cyA9IHt9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdHMsICdwYXNzaXZlJywgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHN1cHBvcnRzUGFzc2l2ZSA9IHRydWU7CiAgICAgIH0KICAgIH0pOyAvLyBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svZmxvdy9pc3N1ZXMvMjg1CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Rlc3QtcGFzc2l2ZScsIG51bGwsIG9wdHMpOwogIH0gY2F0Y2ggKGUpIHt9Cn0gLy8gdGhpcyBuZWVkcyB0byBiZSBsYXp5LWV2YWxlZCBiZWNhdXNlIHZ1ZSBtYXkgYmUgcmVxdWlyZWQgYmVmb3JlCi8vIHZ1ZS1zZXJ2ZXItcmVuZGVyZXIgY2FuIHNldCBWVUVfRU5WCgoKdmFyIF9pc1NlcnZlcjsKCnZhciBpc1NlcnZlclJlbmRlcmluZyA9IGZ1bmN0aW9uIGlzU2VydmVyUmVuZGVyaW5nKCkgewogIGlmIChfaXNTZXJ2ZXIgPT09IHVuZGVmaW5lZCkgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoIWluQnJvd3NlciAmJiAhaW5XZWV4ICYmIHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8vIGRldGVjdCBwcmVzZW5jZSBvZiB2dWUtc2VydmVyLXJlbmRlcmVyIGFuZCBhdm9pZAogICAgICAvLyBXZWJwYWNrIHNoaW1taW5nIHRoZSBwcm9jZXNzCiAgICAgIF9pc1NlcnZlciA9IGdsb2JhbFsncHJvY2VzcyddICYmIGdsb2JhbFsncHJvY2VzcyddLmVudi5WVUVfRU5WID09PSAnc2VydmVyJzsKICAgIH0gZWxzZSB7CiAgICAgIF9pc1NlcnZlciA9IGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIF9pc1NlcnZlcjsKfTsgLy8gZGV0ZWN0IGRldnRvb2xzCgoKdmFyIGRldnRvb2xzID0gaW5Ccm93c2VyICYmIHdpbmRvdy5fX1ZVRV9ERVZUT09MU19HTE9CQUxfSE9PS19fOwovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKZnVuY3Rpb24gaXNOYXRpdmUoQ3RvcikgewogIHJldHVybiB0eXBlb2YgQ3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiAvbmF0aXZlIGNvZGUvLnRlc3QoQ3Rvci50b1N0cmluZygpKTsKfQoKdmFyIGhhc1N5bWJvbCA9IHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFN5bWJvbCkgJiYgdHlwZW9mIFJlZmxlY3QgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFJlZmxlY3Qub3duS2V5cyk7Cgp2YXIgX1NldDsKLyogaXN0YW5idWwgaWdub3JlIGlmICovCi8vICRmbG93LWRpc2FibGUtbGluZQoKCmlmICh0eXBlb2YgU2V0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTZXQpKSB7CiAgLy8gdXNlIG5hdGl2ZSBTZXQgd2hlbiBhdmFpbGFibGUuCiAgX1NldCA9IFNldDsKfSBlbHNlIHsKICAvLyBhIG5vbi1zdGFuZGFyZCBTZXQgcG9seWZpbGwgdGhhdCBvbmx5IHdvcmtzIHdpdGggcHJpbWl0aXZlIGtleXMuCiAgX1NldCA9CiAgLypAX19QVVJFX18qLwogIGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIFNldCgpIHsKICAgICAgdGhpcy5zZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfQoKICAgIFNldC5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gaGFzKGtleSkgewogICAgICByZXR1cm4gdGhpcy5zZXRba2V5XSA9PT0gdHJ1ZTsKICAgIH07CgogICAgU2V0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQoa2V5KSB7CiAgICAgIHRoaXMuc2V0W2tleV0gPSB0cnVlOwogICAgfTsKCiAgICBTZXQucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH07CgogICAgcmV0dXJuIFNldDsKICB9KCk7Cn0KLyogICovCgoKdmFyIHdhcm4gPSBub29wOwp2YXIgdGlwID0gbm9vcDsKdmFyIGdlbmVyYXRlQ29tcG9uZW50VHJhY2UgPSBub29wOyAvLyB3b3JrIGFyb3VuZCBmbG93IGNoZWNrCgp2YXIgZm9ybWF0Q29tcG9uZW50TmFtZSA9IG5vb3A7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBoYXNDb25zb2xlID0gdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnOwogIHZhciBjbGFzc2lmeVJFID0gLyg/Ol58Wy1fXSkoXHcpL2c7CgogIHZhciBjbGFzc2lmeSA9IGZ1bmN0aW9uIGNsYXNzaWZ5KHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKGNsYXNzaWZ5UkUsIGZ1bmN0aW9uIChjKSB7CiAgICAgIHJldHVybiBjLnRvVXBwZXJDYXNlKCk7CiAgICB9KS5yZXBsYWNlKC9bLV9dL2csICcnKTsKICB9OwoKICB3YXJuID0gZnVuY3Rpb24gd2Fybihtc2csIHZtKSB7CiAgICB2YXIgdHJhY2UgPSB2bSA/IGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIDogJyc7CgogICAgaWYgKGNvbmZpZy53YXJuSGFuZGxlcikgewogICAgICBjb25maWcud2FybkhhbmRsZXIuY2FsbChudWxsLCBtc2csIHZtLCB0cmFjZSk7CiAgICB9IGVsc2UgaWYgKGhhc0NvbnNvbGUgJiYgIWNvbmZpZy5zaWxlbnQpIHsKICAgICAgY29uc29sZS5lcnJvcigiW1Z1ZSB3YXJuXTogIiArIG1zZyArIHRyYWNlKTsKICAgIH0KICB9OwoKICB0aXAgPSBmdW5jdGlvbiB0aXAobXNnLCB2bSkgewogICAgaWYgKGhhc0NvbnNvbGUgJiYgIWNvbmZpZy5zaWxlbnQpIHsKICAgICAgY29uc29sZS53YXJuKCJbVnVlIHRpcF06ICIgKyBtc2cgKyAodm0gPyBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSA6ICcnKSk7CiAgICB9CiAgfTsKCiAgZm9ybWF0Q29tcG9uZW50TmFtZSA9IGZ1bmN0aW9uIGZvcm1hdENvbXBvbmVudE5hbWUodm0sIGluY2x1ZGVGaWxlKSB7CiAgICBpZiAodm0uJHJvb3QgPT09IHZtKSB7CiAgICAgIHJldHVybiAnPFJvb3Q+JzsKICAgIH0KCiAgICB2YXIgb3B0aW9ucyA9IHR5cGVvZiB2bSA9PT0gJ2Z1bmN0aW9uJyAmJiB2bS5jaWQgIT0gbnVsbCA/IHZtLm9wdGlvbnMgOiB2bS5faXNWdWUgPyB2bS4kb3B0aW9ucyB8fCB2bS5jb25zdHJ1Y3Rvci5vcHRpb25zIDogdm07CiAgICB2YXIgbmFtZSA9IG9wdGlvbnMubmFtZSB8fCBvcHRpb25zLl9jb21wb25lbnRUYWc7CiAgICB2YXIgZmlsZSA9IG9wdGlvbnMuX19maWxlOwoKICAgIGlmICghbmFtZSAmJiBmaWxlKSB7CiAgICAgIHZhciBtYXRjaCA9IGZpbGUubWF0Y2goLyhbXi9cXF0rKVwudnVlJC8pOwogICAgICBuYW1lID0gbWF0Y2ggJiYgbWF0Y2hbMV07CiAgICB9CgogICAgcmV0dXJuIChuYW1lID8gIjwiICsgY2xhc3NpZnkobmFtZSkgKyAiPiIgOiAiPEFub255bW91cz4iKSArIChmaWxlICYmIGluY2x1ZGVGaWxlICE9PSBmYWxzZSA/ICIgYXQgIiArIGZpbGUgOiAnJyk7CiAgfTsKCiAgdmFyIHJlcGVhdCA9IGZ1bmN0aW9uIHJlcGVhdChzdHIsIG4pIHsKICAgIHZhciByZXMgPSAnJzsKCiAgICB3aGlsZSAobikgewogICAgICBpZiAobiAlIDIgPT09IDEpIHsKICAgICAgICByZXMgKz0gc3RyOwogICAgICB9CgogICAgICBpZiAobiA+IDEpIHsKICAgICAgICBzdHIgKz0gc3RyOwogICAgICB9CgogICAgICBuID4+PSAxOwogICAgfQoKICAgIHJldHVybiByZXM7CiAgfTsKCiAgZ2VuZXJhdGVDb21wb25lbnRUcmFjZSA9IGZ1bmN0aW9uIGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIHsKICAgIGlmICh2bS5faXNWdWUgJiYgdm0uJHBhcmVudCkgewogICAgICB2YXIgdHJlZSA9IFtdOwogICAgICB2YXIgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID0gMDsKCiAgICAgIHdoaWxlICh2bSkgewogICAgICAgIGlmICh0cmVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciBsYXN0ID0gdHJlZVt0cmVlLmxlbmd0aCAtIDFdOwoKICAgICAgICAgIGlmIChsYXN0LmNvbnN0cnVjdG9yID09PSB2bS5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UrKzsKICAgICAgICAgICAgdm0gPSB2bS4kcGFyZW50OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID4gMCkgewogICAgICAgICAgICB0cmVlW3RyZWUubGVuZ3RoIC0gMV0gPSBbbGFzdCwgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlXTsKICAgICAgICAgICAgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRyZWUucHVzaCh2bSk7CiAgICAgICAgdm0gPSB2bS4kcGFyZW50OwogICAgICB9CgogICAgICByZXR1cm4gJ1xuXG5mb3VuZCBpblxuXG4nICsgdHJlZS5tYXAoZnVuY3Rpb24gKHZtLCBpKSB7CiAgICAgICAgcmV0dXJuICIiICsgKGkgPT09IDAgPyAnLS0tPiAnIDogcmVwZWF0KCcgJywgNSArIGkgKiAyKSkgKyAoQXJyYXkuaXNBcnJheSh2bSkgPyBmb3JtYXRDb21wb25lbnROYW1lKHZtWzBdKSArICIuLi4gKCIgKyB2bVsxXSArICIgcmVjdXJzaXZlIGNhbGxzKSIgOiBmb3JtYXRDb21wb25lbnROYW1lKHZtKSk7CiAgICAgIH0pLmpvaW4oJ1xuJyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gIlxuXG4oZm91bmQgaW4gIiArIGZvcm1hdENvbXBvbmVudE5hbWUodm0pICsgIikiOwogICAgfQogIH07Cn0KLyogICovCgoKdmFyIHVpZCA9IDA7Ci8qKgogKiBBIGRlcCBpcyBhbiBvYnNlcnZhYmxlIHRoYXQgY2FuIGhhdmUgbXVsdGlwbGUKICogZGlyZWN0aXZlcyBzdWJzY3JpYmluZyB0byBpdC4KICovCgp2YXIgRGVwID0gZnVuY3Rpb24gRGVwKCkgewogIHRoaXMuaWQgPSB1aWQrKzsKICB0aGlzLnN1YnMgPSBbXTsKfTsKCkRlcC5wcm90b3R5cGUuYWRkU3ViID0gZnVuY3Rpb24gYWRkU3ViKHN1YikgewogIHRoaXMuc3Vicy5wdXNoKHN1Yik7Cn07CgpEZXAucHJvdG90eXBlLnJlbW92ZVN1YiA9IGZ1bmN0aW9uIHJlbW92ZVN1YihzdWIpIHsKICByZW1vdmUodGhpcy5zdWJzLCBzdWIpOwp9OwoKRGVwLnByb3RvdHlwZS5kZXBlbmQgPSBmdW5jdGlvbiBkZXBlbmQoKSB7CiAgaWYgKERlcC50YXJnZXQpIHsKICAgIERlcC50YXJnZXQuYWRkRGVwKHRoaXMpOwogIH0KfTsKCkRlcC5wcm90b3R5cGUubm90aWZ5ID0gZnVuY3Rpb24gbm90aWZ5KCkgewogIC8vIHN0YWJpbGl6ZSB0aGUgc3Vic2NyaWJlciBsaXN0IGZpcnN0CiAgdmFyIHN1YnMgPSB0aGlzLnN1YnMuc2xpY2UoKTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWNvbmZpZy5hc3luYykgewogICAgLy8gc3VicyBhcmVuJ3Qgc29ydGVkIGluIHNjaGVkdWxlciBpZiBub3QgcnVubmluZyBhc3luYwogICAgLy8gd2UgbmVlZCB0byBzb3J0IHRoZW0gbm93IHRvIG1ha2Ugc3VyZSB0aGV5IGZpcmUgaW4gY29ycmVjdAogICAgLy8gb3JkZXIKICAgIHN1YnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYS5pZCAtIGIuaWQ7CiAgICB9KTsKICB9CgogIGZvciAodmFyIGkgPSAwLCBsID0gc3Vicy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHN1YnNbaV0udXBkYXRlKCk7CiAgfQp9OyAvLyBUaGUgY3VycmVudCB0YXJnZXQgd2F0Y2hlciBiZWluZyBldmFsdWF0ZWQuCi8vIFRoaXMgaXMgZ2xvYmFsbHkgdW5pcXVlIGJlY2F1c2Ugb25seSBvbmUgd2F0Y2hlcgovLyBjYW4gYmUgZXZhbHVhdGVkIGF0IGEgdGltZS4KCgpEZXAudGFyZ2V0ID0gbnVsbDsKdmFyIHRhcmdldFN0YWNrID0gW107CgpmdW5jdGlvbiBwdXNoVGFyZ2V0KHRhcmdldCkgewogIHRhcmdldFN0YWNrLnB1c2godGFyZ2V0KTsKICBEZXAudGFyZ2V0ID0gdGFyZ2V0Owp9CgpmdW5jdGlvbiBwb3BUYXJnZXQoKSB7CiAgdGFyZ2V0U3RhY2sucG9wKCk7CiAgRGVwLnRhcmdldCA9IHRhcmdldFN0YWNrW3RhcmdldFN0YWNrLmxlbmd0aCAtIDFdOwp9Ci8qICAqLwoKCnZhciBWTm9kZSA9IGZ1bmN0aW9uIFZOb2RlKHRhZywgZGF0YSwgY2hpbGRyZW4sIHRleHQsIGVsbSwgY29udGV4dCwgY29tcG9uZW50T3B0aW9ucywgYXN5bmNGYWN0b3J5KSB7CiAgdGhpcy50YWcgPSB0YWc7CiAgdGhpcy5kYXRhID0gZGF0YTsKICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgdGhpcy50ZXh0ID0gdGV4dDsKICB0aGlzLmVsbSA9IGVsbTsKICB0aGlzLm5zID0gdW5kZWZpbmVkOwogIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgdGhpcy5mbkNvbnRleHQgPSB1bmRlZmluZWQ7CiAgdGhpcy5mbk9wdGlvbnMgPSB1bmRlZmluZWQ7CiAgdGhpcy5mblNjb3BlSWQgPSB1bmRlZmluZWQ7CiAgdGhpcy5rZXkgPSBkYXRhICYmIGRhdGEua2V5OwogIHRoaXMuY29tcG9uZW50T3B0aW9ucyA9IGNvbXBvbmVudE9wdGlvbnM7CiAgdGhpcy5jb21wb25lbnRJbnN0YW5jZSA9IHVuZGVmaW5lZDsKICB0aGlzLnBhcmVudCA9IHVuZGVmaW5lZDsKICB0aGlzLnJhdyA9IGZhbHNlOwogIHRoaXMuaXNTdGF0aWMgPSBmYWxzZTsKICB0aGlzLmlzUm9vdEluc2VydCA9IHRydWU7CiAgdGhpcy5pc0NvbW1lbnQgPSBmYWxzZTsKICB0aGlzLmlzQ2xvbmVkID0gZmFsc2U7CiAgdGhpcy5pc09uY2UgPSBmYWxzZTsKICB0aGlzLmFzeW5jRmFjdG9yeSA9IGFzeW5jRmFjdG9yeTsKICB0aGlzLmFzeW5jTWV0YSA9IHVuZGVmaW5lZDsKICB0aGlzLmlzQXN5bmNQbGFjZWhvbGRlciA9IGZhbHNlOwp9OwoKdmFyIHByb3RvdHlwZUFjY2Vzc29ycyA9IHsKICBjaGlsZDogewogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfQp9OyAvLyBERVBSRUNBVEVEOiBhbGlhcyBmb3IgY29tcG9uZW50SW5zdGFuY2UgZm9yIGJhY2t3YXJkcyBjb21wYXQuCgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKcHJvdG90eXBlQWNjZXNzb3JzLmNoaWxkLmdldCA9IGZ1bmN0aW9uICgpIHsKICByZXR1cm4gdGhpcy5jb21wb25lbnRJbnN0YW5jZTsKfTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFZOb2RlLnByb3RvdHlwZSwgcHJvdG90eXBlQWNjZXNzb3JzKTsKCnZhciBjcmVhdGVFbXB0eVZOb2RlID0gZnVuY3Rpb24gY3JlYXRlRW1wdHlWTm9kZSh0ZXh0KSB7CiAgaWYgKHRleHQgPT09IHZvaWQgMCkgdGV4dCA9ICcnOwogIHZhciBub2RlID0gbmV3IFZOb2RlKCk7CiAgbm9kZS50ZXh0ID0gdGV4dDsKICBub2RlLmlzQ29tbWVudCA9IHRydWU7CiAgcmV0dXJuIG5vZGU7Cn07CgpmdW5jdGlvbiBjcmVhdGVUZXh0Vk5vZGUodmFsKSB7CiAgcmV0dXJuIG5ldyBWTm9kZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBTdHJpbmcodmFsKSk7Cn0gLy8gb3B0aW1pemVkIHNoYWxsb3cgY2xvbmUKLy8gdXNlZCBmb3Igc3RhdGljIG5vZGVzIGFuZCBzbG90IG5vZGVzIGJlY2F1c2UgdGhleSBtYXkgYmUgcmV1c2VkIGFjcm9zcwovLyBtdWx0aXBsZSByZW5kZXJzLCBjbG9uaW5nIHRoZW0gYXZvaWRzIGVycm9ycyB3aGVuIERPTSBtYW5pcHVsYXRpb25zIHJlbHkKLy8gb24gdGhlaXIgZWxtIHJlZmVyZW5jZS4KCgpmdW5jdGlvbiBjbG9uZVZOb2RlKHZub2RlKSB7CiAgdmFyIGNsb25lZCA9IG5ldyBWTm9kZSh2bm9kZS50YWcsIHZub2RlLmRhdGEsIC8vICM3OTc1CiAgLy8gY2xvbmUgY2hpbGRyZW4gYXJyYXkgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgaW4gY2FzZSBvZiBjbG9uaW5nCiAgLy8gYSBjaGlsZC4KICB2bm9kZS5jaGlsZHJlbiAmJiB2bm9kZS5jaGlsZHJlbi5zbGljZSgpLCB2bm9kZS50ZXh0LCB2bm9kZS5lbG0sIHZub2RlLmNvbnRleHQsIHZub2RlLmNvbXBvbmVudE9wdGlvbnMsIHZub2RlLmFzeW5jRmFjdG9yeSk7CiAgY2xvbmVkLm5zID0gdm5vZGUubnM7CiAgY2xvbmVkLmlzU3RhdGljID0gdm5vZGUuaXNTdGF0aWM7CiAgY2xvbmVkLmtleSA9IHZub2RlLmtleTsKICBjbG9uZWQuaXNDb21tZW50ID0gdm5vZGUuaXNDb21tZW50OwogIGNsb25lZC5mbkNvbnRleHQgPSB2bm9kZS5mbkNvbnRleHQ7CiAgY2xvbmVkLmZuT3B0aW9ucyA9IHZub2RlLmZuT3B0aW9uczsKICBjbG9uZWQuZm5TY29wZUlkID0gdm5vZGUuZm5TY29wZUlkOwogIGNsb25lZC5hc3luY01ldGEgPSB2bm9kZS5hc3luY01ldGE7CiAgY2xvbmVkLmlzQ2xvbmVkID0gdHJ1ZTsKICByZXR1cm4gY2xvbmVkOwp9Ci8qCiAqIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aAogKiBkeW5hbWljYWxseSBhY2Nlc3NpbmcgbWV0aG9kcyBvbiBBcnJheSBwcm90b3R5cGUKICovCgoKdmFyIGFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGU7CnZhciBhcnJheU1ldGhvZHMgPSBPYmplY3QuY3JlYXRlKGFycmF5UHJvdG8pOwp2YXIgbWV0aG9kc1RvUGF0Y2ggPSBbJ3B1c2gnLCAncG9wJywgJ3NoaWZ0JywgJ3Vuc2hpZnQnLCAnc3BsaWNlJywgJ3NvcnQnLCAncmV2ZXJzZSddOwovKioKICogSW50ZXJjZXB0IG11dGF0aW5nIG1ldGhvZHMgYW5kIGVtaXQgZXZlbnRzCiAqLwoKbWV0aG9kc1RvUGF0Y2guZm9yRWFjaChmdW5jdGlvbiAobWV0aG9kKSB7CiAgLy8gY2FjaGUgb3JpZ2luYWwgbWV0aG9kCiAgdmFyIG9yaWdpbmFsID0gYXJyYXlQcm90b1ttZXRob2RdOwogIGRlZihhcnJheU1ldGhvZHMsIG1ldGhvZCwgZnVuY3Rpb24gbXV0YXRvcigpIHsKICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKCiAgICB3aGlsZSAobGVuLS0pIHsKICAgICAgYXJnc1tsZW5dID0gYXJndW1lbnRzW2xlbl07CiAgICB9CgogICAgdmFyIHJlc3VsdCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgdmFyIG9iID0gdGhpcy5fX29iX187CiAgICB2YXIgaW5zZXJ0ZWQ7CgogICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgY2FzZSAncHVzaCc6CiAgICAgIGNhc2UgJ3Vuc2hpZnQnOgogICAgICAgIGluc2VydGVkID0gYXJnczsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NwbGljZSc6CiAgICAgICAgaW5zZXJ0ZWQgPSBhcmdzLnNsaWNlKDIpOwogICAgICAgIGJyZWFrOwogICAgfQoKICAgIGlmIChpbnNlcnRlZCkgewogICAgICBvYi5vYnNlcnZlQXJyYXkoaW5zZXJ0ZWQpOwogICAgfSAvLyBub3RpZnkgY2hhbmdlCgoKICAgIG9iLmRlcC5ub3RpZnkoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfSk7Cn0pOwovKiAgKi8KCnZhciBhcnJheUtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhhcnJheU1ldGhvZHMpOwovKioKICogSW4gc29tZSBjYXNlcyB3ZSBtYXkgd2FudCB0byBkaXNhYmxlIG9ic2VydmF0aW9uIGluc2lkZSBhIGNvbXBvbmVudCdzCiAqIHVwZGF0ZSBjb21wdXRhdGlvbi4KICovCgp2YXIgc2hvdWxkT2JzZXJ2ZSA9IHRydWU7CgpmdW5jdGlvbiB0b2dnbGVPYnNlcnZpbmcodmFsdWUpIHsKICBzaG91bGRPYnNlcnZlID0gdmFsdWU7Cn0KLyoqCiAqIE9ic2VydmVyIGNsYXNzIHRoYXQgaXMgYXR0YWNoZWQgdG8gZWFjaCBvYnNlcnZlZAogKiBvYmplY3QuIE9uY2UgYXR0YWNoZWQsIHRoZSBvYnNlcnZlciBjb252ZXJ0cyB0aGUgdGFyZ2V0CiAqIG9iamVjdCdzIHByb3BlcnR5IGtleXMgaW50byBnZXR0ZXIvc2V0dGVycyB0aGF0CiAqIGNvbGxlY3QgZGVwZW5kZW5jaWVzIGFuZCBkaXNwYXRjaCB1cGRhdGVzLgogKi8KCgp2YXIgT2JzZXJ2ZXIgPSBmdW5jdGlvbiBPYnNlcnZlcih2YWx1ZSkgewogIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB0aGlzLmRlcCA9IG5ldyBEZXAoKTsKICB0aGlzLnZtQ291bnQgPSAwOwogIGRlZih2YWx1ZSwgJ19fb2JfXycsIHRoaXMpOwoKICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgIGlmIChoYXNQcm90bykgewogICAgICBwcm90b0F1Z21lbnQodmFsdWUsIGFycmF5TWV0aG9kcyk7CiAgICB9IGVsc2UgewogICAgICBjb3B5QXVnbWVudCh2YWx1ZSwgYXJyYXlNZXRob2RzLCBhcnJheUtleXMpOwogICAgfQoKICAgIHRoaXMub2JzZXJ2ZUFycmF5KHZhbHVlKTsKICB9IGVsc2UgewogICAgdGhpcy53YWxrKHZhbHVlKTsKICB9Cn07Ci8qKgogKiBXYWxrIHRocm91Z2ggYWxsIHByb3BlcnRpZXMgYW5kIGNvbnZlcnQgdGhlbSBpbnRvCiAqIGdldHRlci9zZXR0ZXJzLiBUaGlzIG1ldGhvZCBzaG91bGQgb25seSBiZSBjYWxsZWQgd2hlbgogKiB2YWx1ZSB0eXBlIGlzIE9iamVjdC4KICovCgoKT2JzZXJ2ZXIucHJvdG90eXBlLndhbGsgPSBmdW5jdGlvbiB3YWxrKG9iaikgewogIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBkZWZpbmVSZWFjdGl2ZSQkMShvYmosIGtleXNbaV0pOwogIH0KfTsKLyoqCiAqIE9ic2VydmUgYSBsaXN0IG9mIEFycmF5IGl0ZW1zLgogKi8KCgpPYnNlcnZlci5wcm90b3R5cGUub2JzZXJ2ZUFycmF5ID0gZnVuY3Rpb24gb2JzZXJ2ZUFycmF5KGl0ZW1zKSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBpdGVtcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIG9ic2VydmUoaXRlbXNbaV0pOwogIH0KfTsgLy8gaGVscGVycwoKLyoqCiAqIEF1Z21lbnQgYSB0YXJnZXQgT2JqZWN0IG9yIEFycmF5IGJ5IGludGVyY2VwdGluZwogKiB0aGUgcHJvdG90eXBlIGNoYWluIHVzaW5nIF9fcHJvdG9fXwogKi8KCgpmdW5jdGlvbiBwcm90b0F1Z21lbnQodGFyZ2V0LCBzcmMpIHsKICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wcm90byAqLwogIHRhcmdldC5fX3Byb3RvX18gPSBzcmM7CiAgLyogZXNsaW50LWVuYWJsZSBuby1wcm90byAqLwp9Ci8qKgogKiBBdWdtZW50IGEgdGFyZ2V0IE9iamVjdCBvciBBcnJheSBieSBkZWZpbmluZwogKiBoaWRkZW4gcHJvcGVydGllcy4KICovCgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCmZ1bmN0aW9uIGNvcHlBdWdtZW50KHRhcmdldCwgc3JjLCBrZXlzKSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIGtleSA9IGtleXNbaV07CiAgICBkZWYodGFyZ2V0LCBrZXksIHNyY1trZXldKTsKICB9Cn0KLyoqCiAqIEF0dGVtcHQgdG8gY3JlYXRlIGFuIG9ic2VydmVyIGluc3RhbmNlIGZvciBhIHZhbHVlLAogKiByZXR1cm5zIHRoZSBuZXcgb2JzZXJ2ZXIgaWYgc3VjY2Vzc2Z1bGx5IG9ic2VydmVkLAogKiBvciB0aGUgZXhpc3Rpbmcgb2JzZXJ2ZXIgaWYgdGhlIHZhbHVlIGFscmVhZHkgaGFzIG9uZS4KICovCgoKZnVuY3Rpb24gb2JzZXJ2ZSh2YWx1ZSwgYXNSb290RGF0YSkgewogIGlmICghaXNPYmplY3QodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBvYjsKCiAgaWYgKGhhc093bih2YWx1ZSwgJ19fb2JfXycpICYmIHZhbHVlLl9fb2JfXyBpbnN0YW5jZW9mIE9ic2VydmVyKSB7CiAgICBvYiA9IHZhbHVlLl9fb2JfXzsKICB9IGVsc2UgaWYgKHNob3VsZE9ic2VydmUgJiYgIWlzU2VydmVyUmVuZGVyaW5nKCkgJiYgKEFycmF5LmlzQXJyYXkodmFsdWUpIHx8IGlzUGxhaW5PYmplY3QodmFsdWUpKSAmJiBPYmplY3QuaXNFeHRlbnNpYmxlKHZhbHVlKSAmJiAhdmFsdWUuX2lzVnVlKSB7CiAgICBvYiA9IG5ldyBPYnNlcnZlcih2YWx1ZSk7CiAgfQoKICBpZiAoYXNSb290RGF0YSAmJiBvYikgewogICAgb2Iudm1Db3VudCsrOwogIH0KCiAgcmV0dXJuIG9iOwp9Ci8qKgogKiBEZWZpbmUgYSByZWFjdGl2ZSBwcm9wZXJ0eSBvbiBhbiBPYmplY3QuCiAqLwoKCmZ1bmN0aW9uIGRlZmluZVJlYWN0aXZlJCQxKG9iaiwga2V5LCB2YWwsIGN1c3RvbVNldHRlciwgc2hhbGxvdykgewogIHZhciBkZXAgPSBuZXcgRGVwKCk7CiAgdmFyIHByb3BlcnR5ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSk7CgogIGlmIChwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5jb25maWd1cmFibGUgPT09IGZhbHNlKSB7CiAgICByZXR1cm47CiAgfSAvLyBjYXRlciBmb3IgcHJlLWRlZmluZWQgZ2V0dGVyL3NldHRlcnMKCgogIHZhciBnZXR0ZXIgPSBwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5nZXQ7CiAgdmFyIHNldHRlciA9IHByb3BlcnR5ICYmIHByb3BlcnR5LnNldDsKCiAgaWYgKCghZ2V0dGVyIHx8IHNldHRlcikgJiYgYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgdmFsID0gb2JqW2tleV07CiAgfQoKICB2YXIgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUodmFsKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIHJlYWN0aXZlR2V0dGVyKCkgewogICAgICB2YXIgdmFsdWUgPSBnZXR0ZXIgPyBnZXR0ZXIuY2FsbChvYmopIDogdmFsOwoKICAgICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgICBkZXAuZGVwZW5kKCk7CgogICAgICAgIGlmIChjaGlsZE9iKSB7CiAgICAgICAgICBjaGlsZE9iLmRlcC5kZXBlbmQoKTsKCiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgZGVwZW5kQXJyYXkodmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gcmVhY3RpdmVTZXR0ZXIobmV3VmFsKSB7CiAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKG9iaikgOiB2YWw7CiAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLXNlbGYtY29tcGFyZSAqLwoKICAgICAgaWYgKG5ld1ZhbCA9PT0gdmFsdWUgfHwgbmV3VmFsICE9PSBuZXdWYWwgJiYgdmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tc2VsZi1jb21wYXJlICovCgoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY3VzdG9tU2V0dGVyKSB7CiAgICAgICAgY3VzdG9tU2V0dGVyKCk7CiAgICAgIH0gLy8gIzc5ODE6IGZvciBhY2Nlc3NvciBwcm9wZXJ0aWVzIHdpdGhvdXQgc2V0dGVyCgoKICAgICAgaWYgKGdldHRlciAmJiAhc2V0dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoc2V0dGVyKSB7CiAgICAgICAgc2V0dGVyLmNhbGwob2JqLCBuZXdWYWwpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbCA9IG5ld1ZhbDsKICAgICAgfQoKICAgICAgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUobmV3VmFsKTsKICAgICAgZGVwLm5vdGlmeSgpOwogICAgfQogIH0pOwp9Ci8qKgogKiBTZXQgYSBwcm9wZXJ0eSBvbiBhbiBvYmplY3QuIEFkZHMgdGhlIG5ldyBwcm9wZXJ0eSBhbmQKICogdHJpZ2dlcnMgY2hhbmdlIG5vdGlmaWNhdGlvbiBpZiB0aGUgcHJvcGVydHkgZG9lc24ndAogKiBhbHJlYWR5IGV4aXN0LgogKi8KCgpmdW5jdGlvbiBzZXQodGFyZ2V0LCBrZXksIHZhbCkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIChpc1VuZGVmKHRhcmdldCkgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkpIHsKICAgIHdhcm4oIkNhbm5vdCBzZXQgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIgKyB0YXJnZXQpOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSAmJiBpc1ZhbGlkQXJyYXlJbmRleChrZXkpKSB7CiAgICB0YXJnZXQubGVuZ3RoID0gTWF0aC5tYXgodGFyZ2V0Lmxlbmd0aCwga2V5KTsKICAgIHRhcmdldC5zcGxpY2Uoa2V5LCAxLCB2YWwpOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGlmIChrZXkgaW4gdGFyZ2V0ICYmICEoa2V5IGluIE9iamVjdC5wcm90b3R5cGUpKSB7CiAgICB0YXJnZXRba2V5XSA9IHZhbDsKICAgIHJldHVybiB2YWw7CiAgfQoKICB2YXIgb2IgPSB0YXJnZXQuX19vYl9fOwoKICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCBvYiAmJiBvYi52bUNvdW50KSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0F2b2lkIGFkZGluZyByZWFjdGl2ZSBwcm9wZXJ0aWVzIHRvIGEgVnVlIGluc3RhbmNlIG9yIGl0cyByb290ICRkYXRhICcgKyAnYXQgcnVudGltZSAtIGRlY2xhcmUgaXQgdXBmcm9udCBpbiB0aGUgZGF0YSBvcHRpb24uJyk7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgaWYgKCFvYikgewogICAgdGFyZ2V0W2tleV0gPSB2YWw7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgZGVmaW5lUmVhY3RpdmUkJDEob2IudmFsdWUsIGtleSwgdmFsKTsKICBvYi5kZXAubm90aWZ5KCk7CiAgcmV0dXJuIHZhbDsKfQovKioKICogRGVsZXRlIGEgcHJvcGVydHkgYW5kIHRyaWdnZXIgY2hhbmdlIGlmIG5lY2Vzc2FyeS4KICovCgoKZnVuY3Rpb24gZGVsKHRhcmdldCwga2V5KSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgKGlzVW5kZWYodGFyZ2V0KSB8fCBpc1ByaW1pdGl2ZSh0YXJnZXQpKSkgewogICAgd2FybigiQ2Fubm90IGRlbGV0ZSByZWFjdGl2ZSBwcm9wZXJ0eSBvbiB1bmRlZmluZWQsIG51bGwsIG9yIHByaW1pdGl2ZSB2YWx1ZTogIiArIHRhcmdldCk7CiAgfQoKICBpZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpICYmIGlzVmFsaWRBcnJheUluZGV4KGtleSkpIHsKICAgIHRhcmdldC5zcGxpY2Uoa2V5LCAxKTsKICAgIHJldHVybjsKICB9CgogIHZhciBvYiA9IHRhcmdldC5fX29iX187CgogIGlmICh0YXJnZXQuX2lzVnVlIHx8IG9iICYmIG9iLnZtQ291bnQpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignQXZvaWQgZGVsZXRpbmcgcHJvcGVydGllcyBvbiBhIFZ1ZSBpbnN0YW5jZSBvciBpdHMgcm9vdCAkZGF0YSAnICsgJy0ganVzdCBzZXQgaXQgdG8gbnVsbC4nKTsKICAgIHJldHVybjsKICB9CgogIGlmICghaGFzT3duKHRhcmdldCwga2V5KSkgewogICAgcmV0dXJuOwogIH0KCiAgZGVsZXRlIHRhcmdldFtrZXldOwoKICBpZiAoIW9iKSB7CiAgICByZXR1cm47CiAgfQoKICBvYi5kZXAubm90aWZ5KCk7Cn0KLyoqCiAqIENvbGxlY3QgZGVwZW5kZW5jaWVzIG9uIGFycmF5IGVsZW1lbnRzIHdoZW4gdGhlIGFycmF5IGlzIHRvdWNoZWQsIHNpbmNlCiAqIHdlIGNhbm5vdCBpbnRlcmNlcHQgYXJyYXkgZWxlbWVudCBhY2Nlc3MgbGlrZSBwcm9wZXJ0eSBnZXR0ZXJzLgogKi8KCgpmdW5jdGlvbiBkZXBlbmRBcnJheSh2YWx1ZSkgewogIGZvciAodmFyIGUgPSB2b2lkIDAsIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBlID0gdmFsdWVbaV07CiAgICBlICYmIGUuX19vYl9fICYmIGUuX19vYl9fLmRlcC5kZXBlbmQoKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgICBkZXBlbmRBcnJheShlKTsKICAgIH0KICB9Cn0KLyogICovCgovKioKICogT3B0aW9uIG92ZXJ3cml0aW5nIHN0cmF0ZWdpZXMgYXJlIGZ1bmN0aW9ucyB0aGF0IGhhbmRsZQogKiBob3cgdG8gbWVyZ2UgYSBwYXJlbnQgb3B0aW9uIHZhbHVlIGFuZCBhIGNoaWxkIG9wdGlvbgogKiB2YWx1ZSBpbnRvIHRoZSBmaW5hbCB2YWx1ZS4KICovCgoKdmFyIHN0cmF0cyA9IGNvbmZpZy5vcHRpb25NZXJnZVN0cmF0ZWdpZXM7Ci8qKgogKiBPcHRpb25zIHdpdGggcmVzdHJpY3Rpb25zCiAqLwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICBzdHJhdHMuZWwgPSBzdHJhdHMucHJvcHNEYXRhID0gZnVuY3Rpb24gKHBhcmVudCwgY2hpbGQsIHZtLCBrZXkpIHsKICAgIGlmICghdm0pIHsKICAgICAgd2Fybigib3B0aW9uIFwiIiArIGtleSArICJcIiBjYW4gb25seSBiZSB1c2VkIGR1cmluZyBpbnN0YW5jZSAiICsgJ2NyZWF0aW9uIHdpdGggdGhlIGBuZXdgIGtleXdvcmQuJyk7CiAgICB9CgogICAgcmV0dXJuIGRlZmF1bHRTdHJhdChwYXJlbnQsIGNoaWxkKTsKICB9Owp9Ci8qKgogKiBIZWxwZXIgdGhhdCByZWN1cnNpdmVseSBtZXJnZXMgdHdvIGRhdGEgb2JqZWN0cyB0b2dldGhlci4KICovCgoKZnVuY3Rpb24gbWVyZ2VEYXRhKHRvLCBmcm9tKSB7CiAgaWYgKCFmcm9tKSB7CiAgICByZXR1cm4gdG87CiAgfQoKICB2YXIga2V5LCB0b1ZhbCwgZnJvbVZhbDsKICB2YXIga2V5cyA9IGhhc1N5bWJvbCA/IFJlZmxlY3Qub3duS2V5cyhmcm9tKSA6IE9iamVjdC5rZXlzKGZyb20pOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIGtleSA9IGtleXNbaV07IC8vIGluIGNhc2UgdGhlIG9iamVjdCBpcyBhbHJlYWR5IG9ic2VydmVkLi4uCgogICAgaWYgKGtleSA9PT0gJ19fb2JfXycpIHsKICAgICAgY29udGludWU7CiAgICB9CgogICAgdG9WYWwgPSB0b1trZXldOwogICAgZnJvbVZhbCA9IGZyb21ba2V5XTsKCiAgICBpZiAoIWhhc093bih0bywga2V5KSkgewogICAgICBzZXQodG8sIGtleSwgZnJvbVZhbCk7CiAgICB9IGVsc2UgaWYgKHRvVmFsICE9PSBmcm9tVmFsICYmIGlzUGxhaW5PYmplY3QodG9WYWwpICYmIGlzUGxhaW5PYmplY3QoZnJvbVZhbCkpIHsKICAgICAgbWVyZ2VEYXRhKHRvVmFsLCBmcm9tVmFsKTsKICAgIH0KICB9CgogIHJldHVybiB0bzsKfQovKioKICogRGF0YQogKi8KCgpmdW5jdGlvbiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtKSB7CiAgaWYgKCF2bSkgewogICAgLy8gaW4gYSBWdWUuZXh0ZW5kIG1lcmdlLCBib3RoIHNob3VsZCBiZSBmdW5jdGlvbnMKICAgIGlmICghY2hpbGRWYWwpIHsKICAgICAgcmV0dXJuIHBhcmVudFZhbDsKICAgIH0KCiAgICBpZiAoIXBhcmVudFZhbCkgewogICAgICByZXR1cm4gY2hpbGRWYWw7CiAgICB9IC8vIHdoZW4gcGFyZW50VmFsICYgY2hpbGRWYWwgYXJlIGJvdGggcHJlc2VudCwKICAgIC8vIHdlIG5lZWQgdG8gcmV0dXJuIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZQogICAgLy8gbWVyZ2VkIHJlc3VsdCBvZiBib3RoIGZ1bmN0aW9ucy4uLiBubyBuZWVkIHRvCiAgICAvLyBjaGVjayBpZiBwYXJlbnRWYWwgaXMgYSBmdW5jdGlvbiBoZXJlIGJlY2F1c2UKICAgIC8vIGl0IGhhcyB0byBiZSBhIGZ1bmN0aW9uIHRvIHBhc3MgcHJldmlvdXMgbWVyZ2VzLgoKCiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkRGF0YUZuKCkgewogICAgICByZXR1cm4gbWVyZ2VEYXRhKHR5cGVvZiBjaGlsZFZhbCA9PT0gJ2Z1bmN0aW9uJyA/IGNoaWxkVmFsLmNhbGwodGhpcywgdGhpcykgOiBjaGlsZFZhbCwgdHlwZW9mIHBhcmVudFZhbCA9PT0gJ2Z1bmN0aW9uJyA/IHBhcmVudFZhbC5jYWxsKHRoaXMsIHRoaXMpIDogcGFyZW50VmFsKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWRJbnN0YW5jZURhdGFGbigpIHsKICAgICAgLy8gaW5zdGFuY2UgbWVyZ2UKICAgICAgdmFyIGluc3RhbmNlRGF0YSA9IHR5cGVvZiBjaGlsZFZhbCA9PT0gJ2Z1bmN0aW9uJyA/IGNoaWxkVmFsLmNhbGwodm0sIHZtKSA6IGNoaWxkVmFsOwogICAgICB2YXIgZGVmYXVsdERhdGEgPSB0eXBlb2YgcGFyZW50VmFsID09PSAnZnVuY3Rpb24nID8gcGFyZW50VmFsLmNhbGwodm0sIHZtKSA6IHBhcmVudFZhbDsKCiAgICAgIGlmIChpbnN0YW5jZURhdGEpIHsKICAgICAgICByZXR1cm4gbWVyZ2VEYXRhKGluc3RhbmNlRGF0YSwgZGVmYXVsdERhdGEpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWZhdWx0RGF0YTsKICAgICAgfQogICAgfTsKICB9Cn0KCnN0cmF0cy5kYXRhID0gZnVuY3Rpb24gKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtKSB7CiAgaWYgKCF2bSkgewogICAgaWYgKGNoaWxkVmFsICYmIHR5cGVvZiBjaGlsZFZhbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ1RoZSAiZGF0YSIgb3B0aW9uIHNob3VsZCBiZSBhIGZ1bmN0aW9uICcgKyAndGhhdCByZXR1cm5zIGEgcGVyLWluc3RhbmNlIHZhbHVlIGluIGNvbXBvbmVudCAnICsgJ2RlZmluaXRpb25zLicsIHZtKTsKICAgICAgcmV0dXJuIHBhcmVudFZhbDsKICAgIH0KCiAgICByZXR1cm4gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsKTsKICB9CgogIHJldHVybiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtKTsKfTsKLyoqCiAqIEhvb2tzIGFuZCBwcm9wcyBhcmUgbWVyZ2VkIGFzIGFycmF5cy4KICovCgoKZnVuY3Rpb24gbWVyZ2VIb29rKHBhcmVudFZhbCwgY2hpbGRWYWwpIHsKICB2YXIgcmVzID0gY2hpbGRWYWwgPyBwYXJlbnRWYWwgPyBwYXJlbnRWYWwuY29uY2F0KGNoaWxkVmFsKSA6IEFycmF5LmlzQXJyYXkoY2hpbGRWYWwpID8gY2hpbGRWYWwgOiBbY2hpbGRWYWxdIDogcGFyZW50VmFsOwogIHJldHVybiByZXMgPyBkZWR1cGVIb29rcyhyZXMpIDogcmVzOwp9CgpmdW5jdGlvbiBkZWR1cGVIb29rcyhob29rcykgewogIHZhciByZXMgPSBbXTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKykgewogICAgaWYgKHJlcy5pbmRleE9mKGhvb2tzW2ldKSA9PT0gLTEpIHsKICAgICAgcmVzLnB1c2goaG9va3NbaV0pOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQoKTElGRUNZQ0xFX0hPT0tTLmZvckVhY2goZnVuY3Rpb24gKGhvb2spIHsKICBzdHJhdHNbaG9va10gPSBtZXJnZUhvb2s7Cn0pOwovKioKICogQXNzZXRzCiAqCiAqIFdoZW4gYSB2bSBpcyBwcmVzZW50IChpbnN0YW5jZSBjcmVhdGlvbiksIHdlIG5lZWQgdG8gZG8KICogYSB0aHJlZS13YXkgbWVyZ2UgYmV0d2VlbiBjb25zdHJ1Y3RvciBvcHRpb25zLCBpbnN0YW5jZQogKiBvcHRpb25zIGFuZCBwYXJlbnQgb3B0aW9ucy4KICovCgpmdW5jdGlvbiBtZXJnZUFzc2V0cyhwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSwga2V5KSB7CiAgdmFyIHJlcyA9IE9iamVjdC5jcmVhdGUocGFyZW50VmFsIHx8IG51bGwpOwoKICBpZiAoY2hpbGRWYWwpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgICByZXR1cm4gZXh0ZW5kKHJlcywgY2hpbGRWYWwpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gcmVzOwogIH0KfQoKQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogIHN0cmF0c1t0eXBlICsgJ3MnXSA9IG1lcmdlQXNzZXRzOwp9KTsKLyoqCiAqIFdhdGNoZXJzLgogKgogKiBXYXRjaGVycyBoYXNoZXMgc2hvdWxkIG5vdCBvdmVyd3JpdGUgb25lCiAqIGFub3RoZXIsIHNvIHdlIG1lcmdlIHRoZW0gYXMgYXJyYXlzLgogKi8KCnN0cmF0cy53YXRjaCA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSwga2V5KSB7CiAgLy8gd29yayBhcm91bmQgRmlyZWZveCdzIE9iamVjdC5wcm90b3R5cGUud2F0Y2guLi4KICBpZiAocGFyZW50VmFsID09PSBuYXRpdmVXYXRjaCkgewogICAgcGFyZW50VmFsID0gdW5kZWZpbmVkOwogIH0KCiAgaWYgKGNoaWxkVmFsID09PSBuYXRpdmVXYXRjaCkgewogICAgY2hpbGRWYWwgPSB1bmRlZmluZWQ7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKCFjaGlsZFZhbCkgewogICAgcmV0dXJuIE9iamVjdC5jcmVhdGUocGFyZW50VmFsIHx8IG51bGwpOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogIH0KCiAgaWYgKCFwYXJlbnRWYWwpIHsKICAgIHJldHVybiBjaGlsZFZhbDsKICB9CgogIHZhciByZXQgPSB7fTsKICBleHRlbmQocmV0LCBwYXJlbnRWYWwpOwoKICBmb3IgKHZhciBrZXkkMSBpbiBjaGlsZFZhbCkgewogICAgdmFyIHBhcmVudCA9IHJldFtrZXkkMV07CiAgICB2YXIgY2hpbGQgPSBjaGlsZFZhbFtrZXkkMV07CgogICAgaWYgKHBhcmVudCAmJiAhQXJyYXkuaXNBcnJheShwYXJlbnQpKSB7CiAgICAgIHBhcmVudCA9IFtwYXJlbnRdOwogICAgfQoKICAgIHJldFtrZXkkMV0gPSBwYXJlbnQgPyBwYXJlbnQuY29uY2F0KGNoaWxkKSA6IEFycmF5LmlzQXJyYXkoY2hpbGQpID8gY2hpbGQgOiBbY2hpbGRdOwogIH0KCiAgcmV0dXJuIHJldDsKfTsKLyoqCiAqIE90aGVyIG9iamVjdCBoYXNoZXMuCiAqLwoKCnN0cmF0cy5wcm9wcyA9IHN0cmF0cy5tZXRob2RzID0gc3RyYXRzLmluamVjdCA9IHN0cmF0cy5jb21wdXRlZCA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSwga2V5KSB7CiAgaWYgKGNoaWxkVmFsICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogIH0KCiAgaWYgKCFwYXJlbnRWYWwpIHsKICAgIHJldHVybiBjaGlsZFZhbDsKICB9CgogIHZhciByZXQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIGV4dGVuZChyZXQsIHBhcmVudFZhbCk7CgogIGlmIChjaGlsZFZhbCkgewogICAgZXh0ZW5kKHJldCwgY2hpbGRWYWwpOwogIH0KCiAgcmV0dXJuIHJldDsKfTsKCnN0cmF0cy5wcm92aWRlID0gbWVyZ2VEYXRhT3JGbjsKLyoqCiAqIERlZmF1bHQgc3RyYXRlZ3kuCiAqLwoKdmFyIGRlZmF1bHRTdHJhdCA9IGZ1bmN0aW9uIGRlZmF1bHRTdHJhdChwYXJlbnRWYWwsIGNoaWxkVmFsKSB7CiAgcmV0dXJuIGNoaWxkVmFsID09PSB1bmRlZmluZWQgPyBwYXJlbnRWYWwgOiBjaGlsZFZhbDsKfTsKLyoqCiAqIFZhbGlkYXRlIGNvbXBvbmVudCBuYW1lcwogKi8KCgpmdW5jdGlvbiBjaGVja0NvbXBvbmVudHMob3B0aW9ucykgewogIGZvciAodmFyIGtleSBpbiBvcHRpb25zLmNvbXBvbmVudHMpIHsKICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShrZXkpOwogIH0KfQoKZnVuY3Rpb24gdmFsaWRhdGVDb21wb25lbnROYW1lKG5hbWUpIHsKICBpZiAoIW5ldyBSZWdFeHAoIl5bYS16QS1aXVtcXC1cXC4wLTlfIiArIHVuaWNvZGVSZWdFeHAuc291cmNlICsgIl0qJCIpLnRlc3QobmFtZSkpIHsKICAgIHdhcm4oJ0ludmFsaWQgY29tcG9uZW50IG5hbWU6ICInICsgbmFtZSArICciLiBDb21wb25lbnQgbmFtZXMgJyArICdzaG91bGQgY29uZm9ybSB0byB2YWxpZCBjdXN0b20gZWxlbWVudCBuYW1lIGluIGh0bWw1IHNwZWNpZmljYXRpb24uJyk7CiAgfQoKICBpZiAoaXNCdWlsdEluVGFnKG5hbWUpIHx8IGNvbmZpZy5pc1Jlc2VydmVkVGFnKG5hbWUpKSB7CiAgICB3YXJuKCdEbyBub3QgdXNlIGJ1aWx0LWluIG9yIHJlc2VydmVkIEhUTUwgZWxlbWVudHMgYXMgY29tcG9uZW50ICcgKyAnaWQ6ICcgKyBuYW1lKTsKICB9Cn0KLyoqCiAqIEVuc3VyZSBhbGwgcHJvcHMgb3B0aW9uIHN5bnRheCBhcmUgbm9ybWFsaXplZCBpbnRvIHRoZQogKiBPYmplY3QtYmFzZWQgZm9ybWF0LgogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVQcm9wcyhvcHRpb25zLCB2bSkgewogIHZhciBwcm9wcyA9IG9wdGlvbnMucHJvcHM7CgogIGlmICghcHJvcHMpIHsKICAgIHJldHVybjsKICB9CgogIHZhciByZXMgPSB7fTsKICB2YXIgaSwgdmFsLCBuYW1lOwoKICBpZiAoQXJyYXkuaXNBcnJheShwcm9wcykpIHsKICAgIGkgPSBwcm9wcy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICB2YWwgPSBwcm9wc1tpXTsKCiAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICAgIG5hbWUgPSBjYW1lbGl6ZSh2YWwpOwogICAgICAgIHJlc1tuYW1lXSA9IHsKICAgICAgICAgIHR5cGU6IG51bGwKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB3YXJuKCdwcm9wcyBtdXN0IGJlIHN0cmluZ3Mgd2hlbiB1c2luZyBhcnJheSBzeW50YXguJyk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QocHJvcHMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgdmFsID0gcHJvcHNba2V5XTsKICAgICAgbmFtZSA9IGNhbWVsaXplKGtleSk7CiAgICAgIHJlc1tuYW1lXSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IHZhbCA6IHsKICAgICAgICB0eXBlOiB2YWwKICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcInByb3BzXCI6IGV4cGVjdGVkIGFuIEFycmF5IG9yIGFuIE9iamVjdCwgIiArICJidXQgZ290ICIgKyB0b1Jhd1R5cGUocHJvcHMpICsgIi4iLCB2bSk7CiAgfQoKICBvcHRpb25zLnByb3BzID0gcmVzOwp9Ci8qKgogKiBOb3JtYWxpemUgYWxsIGluamVjdGlvbnMgaW50byBPYmplY3QtYmFzZWQgZm9ybWF0CiAqLwoKCmZ1bmN0aW9uIG5vcm1hbGl6ZUluamVjdChvcHRpb25zLCB2bSkgewogIHZhciBpbmplY3QgPSBvcHRpb25zLmluamVjdDsKCiAgaWYgKCFpbmplY3QpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBub3JtYWxpemVkID0gb3B0aW9ucy5pbmplY3QgPSB7fTsKCiAgaWYgKEFycmF5LmlzQXJyYXkoaW5qZWN0KSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmplY3QubGVuZ3RoOyBpKyspIHsKICAgICAgbm9ybWFsaXplZFtpbmplY3RbaV1dID0gewogICAgICAgIGZyb206IGluamVjdFtpXQogICAgICB9OwogICAgfQogIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChpbmplY3QpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gaW5qZWN0KSB7CiAgICAgIHZhciB2YWwgPSBpbmplY3Rba2V5XTsKICAgICAgbm9ybWFsaXplZFtrZXldID0gaXNQbGFpbk9iamVjdCh2YWwpID8gZXh0ZW5kKHsKICAgICAgICBmcm9tOiBrZXkKICAgICAgfSwgdmFsKSA6IHsKICAgICAgICBmcm9tOiB2YWwKICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcImluamVjdFwiOiBleHBlY3RlZCBhbiBBcnJheSBvciBhbiBPYmplY3QsICIgKyAiYnV0IGdvdCAiICsgdG9SYXdUeXBlKGluamVjdCkgKyAiLiIsIHZtKTsKICB9Cn0KLyoqCiAqIE5vcm1hbGl6ZSByYXcgZnVuY3Rpb24gZGlyZWN0aXZlcyBpbnRvIG9iamVjdCBmb3JtYXQuCiAqLwoKCmZ1bmN0aW9uIG5vcm1hbGl6ZURpcmVjdGl2ZXMob3B0aW9ucykgewogIHZhciBkaXJzID0gb3B0aW9ucy5kaXJlY3RpdmVzOwoKICBpZiAoZGlycykgewogICAgZm9yICh2YXIga2V5IGluIGRpcnMpIHsKICAgICAgdmFyIGRlZiQkMSA9IGRpcnNba2V5XTsKCiAgICAgIGlmICh0eXBlb2YgZGVmJCQxID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZGlyc1trZXldID0gewogICAgICAgICAgYmluZDogZGVmJCQxLAogICAgICAgICAgdXBkYXRlOiBkZWYkJDEKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBhc3NlcnRPYmplY3RUeXBlKG5hbWUsIHZhbHVlLCB2bSkgewogIGlmICghaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHsKICAgIHdhcm4oIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcIiIgKyBuYW1lICsgIlwiOiBleHBlY3RlZCBhbiBPYmplY3QsICIgKyAiYnV0IGdvdCAiICsgdG9SYXdUeXBlKHZhbHVlKSArICIuIiwgdm0pOwogIH0KfQovKioKICogTWVyZ2UgdHdvIG9wdGlvbiBvYmplY3RzIGludG8gYSBuZXcgb25lLgogKiBDb3JlIHV0aWxpdHkgdXNlZCBpbiBib3RoIGluc3RhbnRpYXRpb24gYW5kIGluaGVyaXRhbmNlLgogKi8KCgpmdW5jdGlvbiBtZXJnZU9wdGlvbnMocGFyZW50LCBjaGlsZCwgdm0pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgY2hlY2tDb21wb25lbnRzKGNoaWxkKTsKICB9CgogIGlmICh0eXBlb2YgY2hpbGQgPT09ICdmdW5jdGlvbicpIHsKICAgIGNoaWxkID0gY2hpbGQub3B0aW9uczsKICB9CgogIG5vcm1hbGl6ZVByb3BzKGNoaWxkLCB2bSk7CiAgbm9ybWFsaXplSW5qZWN0KGNoaWxkLCB2bSk7CiAgbm9ybWFsaXplRGlyZWN0aXZlcyhjaGlsZCk7IC8vIEFwcGx5IGV4dGVuZHMgYW5kIG1peGlucyBvbiB0aGUgY2hpbGQgb3B0aW9ucywKICAvLyBidXQgb25seSBpZiBpdCBpcyBhIHJhdyBvcHRpb25zIG9iamVjdCB0aGF0IGlzbid0CiAgLy8gdGhlIHJlc3VsdCBvZiBhbm90aGVyIG1lcmdlT3B0aW9ucyBjYWxsLgogIC8vIE9ubHkgbWVyZ2VkIG9wdGlvbnMgaGFzIHRoZSBfYmFzZSBwcm9wZXJ0eS4KCiAgaWYgKCFjaGlsZC5fYmFzZSkgewogICAgaWYgKGNoaWxkWyJleHRlbmRzIl0pIHsKICAgICAgcGFyZW50ID0gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGRbImV4dGVuZHMiXSwgdm0pOwogICAgfQoKICAgIGlmIChjaGlsZC5taXhpbnMpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGlsZC5taXhpbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcGFyZW50ID0gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQubWl4aW5zW2ldLCB2bSk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBvcHRpb25zID0ge307CiAgdmFyIGtleTsKCiAgZm9yIChrZXkgaW4gcGFyZW50KSB7CiAgICBtZXJnZUZpZWxkKGtleSk7CiAgfQoKICBmb3IgKGtleSBpbiBjaGlsZCkgewogICAgaWYgKCFoYXNPd24ocGFyZW50LCBrZXkpKSB7CiAgICAgIG1lcmdlRmllbGQoa2V5KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1lcmdlRmllbGQoa2V5KSB7CiAgICB2YXIgc3RyYXQgPSBzdHJhdHNba2V5XSB8fCBkZWZhdWx0U3RyYXQ7CiAgICBvcHRpb25zW2tleV0gPSBzdHJhdChwYXJlbnRba2V5XSwgY2hpbGRba2V5XSwgdm0sIGtleSk7CiAgfQoKICByZXR1cm4gb3B0aW9uczsKfQovKioKICogUmVzb2x2ZSBhbiBhc3NldC4KICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGJlY2F1c2UgY2hpbGQgaW5zdGFuY2VzIG5lZWQgYWNjZXNzCiAqIHRvIGFzc2V0cyBkZWZpbmVkIGluIGl0cyBhbmNlc3RvciBjaGFpbi4KICovCgoKZnVuY3Rpb24gcmVzb2x2ZUFzc2V0KG9wdGlvbnMsIHR5cGUsIGlkLCB3YXJuTWlzc2luZykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICh0eXBlb2YgaWQgIT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgYXNzZXRzID0gb3B0aW9uc1t0eXBlXTsgLy8gY2hlY2sgbG9jYWwgcmVnaXN0cmF0aW9uIHZhcmlhdGlvbnMgZmlyc3QKCiAgaWYgKGhhc093bihhc3NldHMsIGlkKSkgewogICAgcmV0dXJuIGFzc2V0c1tpZF07CiAgfQoKICB2YXIgY2FtZWxpemVkSWQgPSBjYW1lbGl6ZShpZCk7CgogIGlmIChoYXNPd24oYXNzZXRzLCBjYW1lbGl6ZWRJZCkpIHsKICAgIHJldHVybiBhc3NldHNbY2FtZWxpemVkSWRdOwogIH0KCiAgdmFyIFBhc2NhbENhc2VJZCA9IGNhcGl0YWxpemUoY2FtZWxpemVkSWQpOwoKICBpZiAoaGFzT3duKGFzc2V0cywgUGFzY2FsQ2FzZUlkKSkgewogICAgcmV0dXJuIGFzc2V0c1tQYXNjYWxDYXNlSWRdOwogIH0gLy8gZmFsbGJhY2sgdG8gcHJvdG90eXBlIGNoYWluCgoKICB2YXIgcmVzID0gYXNzZXRzW2lkXSB8fCBhc3NldHNbY2FtZWxpemVkSWRdIHx8IGFzc2V0c1tQYXNjYWxDYXNlSWRdOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuTWlzc2luZyAmJiAhcmVzKSB7CiAgICB3YXJuKCdGYWlsZWQgdG8gcmVzb2x2ZSAnICsgdHlwZS5zbGljZSgwLCAtMSkgKyAnOiAnICsgaWQsIG9wdGlvbnMpOwogIH0KCiAgcmV0dXJuIHJlczsKfQovKiAgKi8KCgpmdW5jdGlvbiB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhLCB2bSkgewogIHZhciBwcm9wID0gcHJvcE9wdGlvbnNba2V5XTsKICB2YXIgYWJzZW50ID0gIWhhc093bihwcm9wc0RhdGEsIGtleSk7CiAgdmFyIHZhbHVlID0gcHJvcHNEYXRhW2tleV07IC8vIGJvb2xlYW4gY2FzdGluZwoKICB2YXIgYm9vbGVhbkluZGV4ID0gZ2V0VHlwZUluZGV4KEJvb2xlYW4sIHByb3AudHlwZSk7CgogIGlmIChib29sZWFuSW5kZXggPiAtMSkgewogICAgaWYgKGFic2VudCAmJiAhaGFzT3duKHByb3AsICdkZWZhdWx0JykpIHsKICAgICAgdmFsdWUgPSBmYWxzZTsKICAgIH0gZWxzZSBpZiAodmFsdWUgPT09ICcnIHx8IHZhbHVlID09PSBoeXBoZW5hdGUoa2V5KSkgewogICAgICAvLyBvbmx5IGNhc3QgZW1wdHkgc3RyaW5nIC8gc2FtZSBuYW1lIHRvIGJvb2xlYW4gaWYKICAgICAgLy8gYm9vbGVhbiBoYXMgaGlnaGVyIHByaW9yaXR5CiAgICAgIHZhciBzdHJpbmdJbmRleCA9IGdldFR5cGVJbmRleChTdHJpbmcsIHByb3AudHlwZSk7CgogICAgICBpZiAoc3RyaW5nSW5kZXggPCAwIHx8IGJvb2xlYW5JbmRleCA8IHN0cmluZ0luZGV4KSB7CiAgICAgICAgdmFsdWUgPSB0cnVlOwogICAgICB9CiAgICB9CiAgfSAvLyBjaGVjayBkZWZhdWx0IHZhbHVlCgoKICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgdmFsdWUgPSBnZXRQcm9wRGVmYXVsdFZhbHVlKHZtLCBwcm9wLCBrZXkpOyAvLyBzaW5jZSB0aGUgZGVmYXVsdCB2YWx1ZSBpcyBhIGZyZXNoIGNvcHksCiAgICAvLyBtYWtlIHN1cmUgdG8gb2JzZXJ2ZSBpdC4KCiAgICB2YXIgcHJldlNob3VsZE9ic2VydmUgPSBzaG91bGRPYnNlcnZlOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwogICAgb2JzZXJ2ZSh2YWx1ZSk7CiAgICB0b2dnbGVPYnNlcnZpbmcocHJldlNob3VsZE9ic2VydmUpOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgLy8gc2tpcCB2YWxpZGF0aW9uIGZvciB3ZWV4IHJlY3ljbGUtbGlzdCBjaGlsZCBjb21wb25lbnQgcHJvcHMKICAhZmFsc2UpIHsKICAgIGFzc2VydFByb3AocHJvcCwga2V5LCB2YWx1ZSwgdm0sIGFic2VudCk7CiAgfQoKICByZXR1cm4gdmFsdWU7Cn0KLyoqCiAqIEdldCB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhIHByb3AuCiAqLwoKCmZ1bmN0aW9uIGdldFByb3BEZWZhdWx0VmFsdWUodm0sIHByb3AsIGtleSkgewogIC8vIG5vIGRlZmF1bHQsIHJldHVybiB1bmRlZmluZWQKICBpZiAoIWhhc093bihwcm9wLCAnZGVmYXVsdCcpKSB7CiAgICByZXR1cm4gdW5kZWZpbmVkOwogIH0KCiAgdmFyIGRlZiA9IHByb3BbImRlZmF1bHQiXTsgLy8gd2FybiBhZ2FpbnN0IG5vbi1mYWN0b3J5IGRlZmF1bHRzIGZvciBPYmplY3QgJiBBcnJheQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc09iamVjdChkZWYpKSB7CiAgICB3YXJuKCdJbnZhbGlkIGRlZmF1bHQgdmFsdWUgZm9yIHByb3AgIicgKyBrZXkgKyAnIjogJyArICdQcm9wcyB3aXRoIHR5cGUgT2JqZWN0L0FycmF5IG11c3QgdXNlIGEgZmFjdG9yeSBmdW5jdGlvbiAnICsgJ3RvIHJldHVybiB0aGUgZGVmYXVsdCB2YWx1ZS4nLCB2bSk7CiAgfSAvLyB0aGUgcmF3IHByb3AgdmFsdWUgd2FzIGFsc28gdW5kZWZpbmVkIGZyb20gcHJldmlvdXMgcmVuZGVyLAogIC8vIHJldHVybiBwcmV2aW91cyBkZWZhdWx0IHZhbHVlIHRvIGF2b2lkIHVubmVjZXNzYXJ5IHdhdGNoZXIgdHJpZ2dlcgoKCiAgaWYgKHZtICYmIHZtLiRvcHRpb25zLnByb3BzRGF0YSAmJiB2bS4kb3B0aW9ucy5wcm9wc0RhdGFba2V5XSA9PT0gdW5kZWZpbmVkICYmIHZtLl9wcm9wc1trZXldICE9PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiB2bS5fcHJvcHNba2V5XTsKICB9IC8vIGNhbGwgZmFjdG9yeSBmdW5jdGlvbiBmb3Igbm9uLUZ1bmN0aW9uIHR5cGVzCiAgLy8gYSB2YWx1ZSBpcyBGdW5jdGlvbiBpZiBpdHMgcHJvdG90eXBlIGlzIGZ1bmN0aW9uIGV2ZW4gYWNyb3NzIGRpZmZlcmVudCBleGVjdXRpb24gY29udGV4dAoKCiAgcmV0dXJuIHR5cGVvZiBkZWYgPT09ICdmdW5jdGlvbicgJiYgZ2V0VHlwZShwcm9wLnR5cGUpICE9PSAnRnVuY3Rpb24nID8gZGVmLmNhbGwodm0pIDogZGVmOwp9Ci8qKgogKiBBc3NlcnQgd2hldGhlciBhIHByb3AgaXMgdmFsaWQuCiAqLwoKCmZ1bmN0aW9uIGFzc2VydFByb3AocHJvcCwgbmFtZSwgdmFsdWUsIHZtLCBhYnNlbnQpIHsKICBpZiAocHJvcC5yZXF1aXJlZCAmJiBhYnNlbnQpIHsKICAgIHdhcm4oJ01pc3NpbmcgcmVxdWlyZWQgcHJvcDogIicgKyBuYW1lICsgJyInLCB2bSk7CiAgICByZXR1cm47CiAgfQoKICBpZiAodmFsdWUgPT0gbnVsbCAmJiAhcHJvcC5yZXF1aXJlZCkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHR5cGUgPSBwcm9wLnR5cGU7CiAgdmFyIHZhbGlkID0gIXR5cGUgfHwgdHlwZSA9PT0gdHJ1ZTsKICB2YXIgZXhwZWN0ZWRUeXBlcyA9IFtdOwoKICBpZiAodHlwZSkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KHR5cGUpKSB7CiAgICAgIHR5cGUgPSBbdHlwZV07CiAgICB9CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0eXBlLmxlbmd0aCAmJiAhdmFsaWQ7IGkrKykgewogICAgICB2YXIgYXNzZXJ0ZWRUeXBlID0gYXNzZXJ0VHlwZSh2YWx1ZSwgdHlwZVtpXSk7CiAgICAgIGV4cGVjdGVkVHlwZXMucHVzaChhc3NlcnRlZFR5cGUuZXhwZWN0ZWRUeXBlIHx8ICcnKTsKICAgICAgdmFsaWQgPSBhc3NlcnRlZFR5cGUudmFsaWQ7CiAgICB9CiAgfQoKICBpZiAoIXZhbGlkKSB7CiAgICB3YXJuKGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcyksIHZtKTsKICAgIHJldHVybjsKICB9CgogIHZhciB2YWxpZGF0b3IgPSBwcm9wLnZhbGlkYXRvcjsKCiAgaWYgKHZhbGlkYXRvcikgewogICAgaWYgKCF2YWxpZGF0b3IodmFsdWUpKSB7CiAgICAgIHdhcm4oJ0ludmFsaWQgcHJvcDogY3VzdG9tIHZhbGlkYXRvciBjaGVjayBmYWlsZWQgZm9yIHByb3AgIicgKyBuYW1lICsgJyIuJywgdm0pOwogICAgfQogIH0KfQoKdmFyIHNpbXBsZUNoZWNrUkUgPSAvXihTdHJpbmd8TnVtYmVyfEJvb2xlYW58RnVuY3Rpb258U3ltYm9sKSQvOwoKZnVuY3Rpb24gYXNzZXJ0VHlwZSh2YWx1ZSwgdHlwZSkgewogIHZhciB2YWxpZDsKICB2YXIgZXhwZWN0ZWRUeXBlID0gZ2V0VHlwZSh0eXBlKTsKCiAgaWYgKHNpbXBsZUNoZWNrUkUudGVzdChleHBlY3RlZFR5cGUpKSB7CiAgICB2YXIgdCA9IF90eXBlb2YodmFsdWUpOwoKICAgIHZhbGlkID0gdCA9PT0gZXhwZWN0ZWRUeXBlLnRvTG93ZXJDYXNlKCk7IC8vIGZvciBwcmltaXRpdmUgd3JhcHBlciBvYmplY3RzCgogICAgaWYgKCF2YWxpZCAmJiB0ID09PSAnb2JqZWN0JykgewogICAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICAgIH0KICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gJ09iamVjdCcpIHsKICAgIHZhbGlkID0gaXNQbGFpbk9iamVjdCh2YWx1ZSk7CiAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdBcnJheScpIHsKICAgIHZhbGlkID0gQXJyYXkuaXNBcnJheSh2YWx1ZSk7CiAgfSBlbHNlIHsKICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwogIH0KCiAgcmV0dXJuIHsKICAgIHZhbGlkOiB2YWxpZCwKICAgIGV4cGVjdGVkVHlwZTogZXhwZWN0ZWRUeXBlCiAgfTsKfQovKioKICogVXNlIGZ1bmN0aW9uIHN0cmluZyBuYW1lIHRvIGNoZWNrIGJ1aWx0LWluIHR5cGVzLAogKiBiZWNhdXNlIGEgc2ltcGxlIGVxdWFsaXR5IGNoZWNrIHdpbGwgZmFpbCB3aGVuIHJ1bm5pbmcKICogYWNyb3NzIGRpZmZlcmVudCB2bXMgLyBpZnJhbWVzLgogKi8KCgpmdW5jdGlvbiBnZXRUeXBlKGZuKSB7CiAgdmFyIG1hdGNoID0gZm4gJiYgZm4udG9TdHJpbmcoKS5tYXRjaCgvXlxzKmZ1bmN0aW9uIChcdyspLyk7CiAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsKfQoKZnVuY3Rpb24gaXNTYW1lVHlwZShhLCBiKSB7CiAgcmV0dXJuIGdldFR5cGUoYSkgPT09IGdldFR5cGUoYik7Cn0KCmZ1bmN0aW9uIGdldFR5cGVJbmRleCh0eXBlLCBleHBlY3RlZFR5cGVzKSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGV4cGVjdGVkVHlwZXMpKSB7CiAgICByZXR1cm4gaXNTYW1lVHlwZShleHBlY3RlZFR5cGVzLCB0eXBlKSA/IDAgOiAtMTsKICB9CgogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBleHBlY3RlZFR5cGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICBpZiAoaXNTYW1lVHlwZShleHBlY3RlZFR5cGVzW2ldLCB0eXBlKSkgewogICAgICByZXR1cm4gaTsKICAgIH0KICB9CgogIHJldHVybiAtMTsKfQoKZnVuY3Rpb24gZ2V0SW52YWxpZFR5cGVNZXNzYWdlKG5hbWUsIHZhbHVlLCBleHBlY3RlZFR5cGVzKSB7CiAgdmFyIG1lc3NhZ2UgPSAiSW52YWxpZCBwcm9wOiB0eXBlIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCBcIiIgKyBuYW1lICsgIlwiLiIgKyAiIEV4cGVjdGVkICIgKyBleHBlY3RlZFR5cGVzLm1hcChjYXBpdGFsaXplKS5qb2luKCcsICcpOwogIHZhciBleHBlY3RlZFR5cGUgPSBleHBlY3RlZFR5cGVzWzBdOwogIHZhciByZWNlaXZlZFR5cGUgPSB0b1Jhd1R5cGUodmFsdWUpOwogIHZhciBleHBlY3RlZFZhbHVlID0gc3R5bGVWYWx1ZSh2YWx1ZSwgZXhwZWN0ZWRUeXBlKTsKICB2YXIgcmVjZWl2ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIHJlY2VpdmVkVHlwZSk7IC8vIGNoZWNrIGlmIHdlIG5lZWQgdG8gc3BlY2lmeSBleHBlY3RlZCB2YWx1ZQoKICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDEgJiYgaXNFeHBsaWNhYmxlKGV4cGVjdGVkVHlwZSkgJiYgIWlzQm9vbGVhbihleHBlY3RlZFR5cGUsIHJlY2VpdmVkVHlwZSkpIHsKICAgIG1lc3NhZ2UgKz0gIiB3aXRoIHZhbHVlICIgKyBleHBlY3RlZFZhbHVlOwogIH0KCiAgbWVzc2FnZSArPSAiLCBnb3QgIiArIHJlY2VpdmVkVHlwZSArICIgIjsgLy8gY2hlY2sgaWYgd2UgbmVlZCB0byBzcGVjaWZ5IHJlY2VpdmVkIHZhbHVlCgogIGlmIChpc0V4cGxpY2FibGUocmVjZWl2ZWRUeXBlKSkgewogICAgbWVzc2FnZSArPSAid2l0aCB2YWx1ZSAiICsgcmVjZWl2ZWRWYWx1ZSArICIuIjsKICB9CgogIHJldHVybiBtZXNzYWdlOwp9CgpmdW5jdGlvbiBzdHlsZVZhbHVlKHZhbHVlLCB0eXBlKSB7CiAgaWYgKHR5cGUgPT09ICdTdHJpbmcnKSB7CiAgICByZXR1cm4gIlwiIiArIHZhbHVlICsgIlwiIjsKICB9IGVsc2UgaWYgKHR5cGUgPT09ICdOdW1iZXInKSB7CiAgICByZXR1cm4gIiIgKyBOdW1iZXIodmFsdWUpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICB9Cn0KCmZ1bmN0aW9uIGlzRXhwbGljYWJsZSh2YWx1ZSkgewogIHZhciBleHBsaWNpdFR5cGVzID0gWydzdHJpbmcnLCAnbnVtYmVyJywgJ2Jvb2xlYW4nXTsKICByZXR1cm4gZXhwbGljaXRUeXBlcy5zb21lKGZ1bmN0aW9uIChlbGVtKSB7CiAgICByZXR1cm4gdmFsdWUudG9Mb3dlckNhc2UoKSA9PT0gZWxlbTsKICB9KTsKfQoKZnVuY3Rpb24gaXNCb29sZWFuKCkgewogIHZhciBhcmdzID0gW10sCiAgICAgIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CgogIHdoaWxlIChsZW4tLSkgewogICAgYXJnc1tsZW5dID0gYXJndW1lbnRzW2xlbl07CiAgfQoKICByZXR1cm4gYXJncy5zb21lKGZ1bmN0aW9uIChlbGVtKSB7CiAgICByZXR1cm4gZWxlbS50b0xvd2VyQ2FzZSgpID09PSAnYm9vbGVhbic7CiAgfSk7Cn0KLyogICovCgoKZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIC8vIERlYWN0aXZhdGUgZGVwcyB0cmFja2luZyB3aGlsZSBwcm9jZXNzaW5nIGVycm9yIGhhbmRsZXIgdG8gYXZvaWQgcG9zc2libGUgaW5maW5pdGUgcmVuZGVyaW5nLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZXgvaXNzdWVzLzE1MDUKICBwdXNoVGFyZ2V0KCk7CgogIHRyeSB7CiAgICBpZiAodm0pIHsKICAgICAgdmFyIGN1ciA9IHZtOwoKICAgICAgd2hpbGUgKGN1ciA9IGN1ci4kcGFyZW50KSB7CiAgICAgICAgdmFyIGhvb2tzID0gY3VyLiRvcHRpb25zLmVycm9yQ2FwdHVyZWQ7CgogICAgICAgIGlmIChob29rcykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBjYXB0dXJlID0gaG9va3NbaV0uY2FsbChjdXIsIGVyciwgdm0sIGluZm8pID09PSBmYWxzZTsKCiAgICAgICAgICAgICAgaWYgKGNhcHR1cmUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBnbG9iYWxIYW5kbGVFcnJvcihlLCBjdXIsICdlcnJvckNhcHR1cmVkIGhvb2snKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGdsb2JhbEhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pOwogIH0gZmluYWxseSB7CiAgICBwb3BUYXJnZXQoKTsKICB9Cn0KCmZ1bmN0aW9uIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGhhbmRsZXIsIGNvbnRleHQsIGFyZ3MsIHZtLCBpbmZvKSB7CiAgdmFyIHJlczsKCiAgdHJ5IHsKICAgIHJlcyA9IGFyZ3MgPyBoYW5kbGVyLmFwcGx5KGNvbnRleHQsIGFyZ3MpIDogaGFuZGxlci5jYWxsKGNvbnRleHQpOwoKICAgIGlmIChyZXMgJiYgIXJlcy5faXNWdWUgJiYgaXNQcm9taXNlKHJlcykgJiYgIXJlcy5faGFuZGxlZCkgewogICAgICByZXNbImNhdGNoIl0oZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8gKyAiIChQcm9taXNlL2FzeW5jKSIpOwogICAgICB9KTsgLy8gaXNzdWUgIzk1MTEKICAgICAgLy8gYXZvaWQgY2F0Y2ggdHJpZ2dlcmluZyBtdWx0aXBsZSB0aW1lcyB3aGVuIG5lc3RlZCBjYWxscwoKICAgICAgcmVzLl9oYW5kbGVkID0gdHJ1ZTsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBoYW5kbGVFcnJvcihlLCB2bSwgaW5mbyk7CiAgfQoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBnbG9iYWxIYW5kbGVFcnJvcihlcnIsIHZtLCBpbmZvKSB7CiAgaWYgKGNvbmZpZy5lcnJvckhhbmRsZXIpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBjb25maWcuZXJyb3JIYW5kbGVyLmNhbGwobnVsbCwgZXJyLCB2bSwgaW5mbyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIC8vIGlmIHRoZSB1c2VyIGludGVudGlvbmFsbHkgdGhyb3dzIHRoZSBvcmlnaW5hbCBlcnJvciBpbiB0aGUgaGFuZGxlciwKICAgICAgLy8gZG8gbm90IGxvZyBpdCB0d2ljZQogICAgICBpZiAoZSAhPT0gZXJyKSB7CiAgICAgICAgbG9nRXJyb3IoZSwgbnVsbCwgJ2NvbmZpZy5lcnJvckhhbmRsZXInKTsKICAgICAgfQogICAgfQogIH0KCiAgbG9nRXJyb3IoZXJyLCB2bSwgaW5mbyk7Cn0KCmZ1bmN0aW9uIGxvZ0Vycm9yKGVyciwgdm0sIGluZm8pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2FybigiRXJyb3IgaW4gIiArIGluZm8gKyAiOiBcIiIgKyBlcnIudG9TdHJpbmcoKSArICJcIiIsIHZtKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogIGlmICgoaW5Ccm93c2VyIHx8IGluV2VleCkgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICBjb25zb2xlLmVycm9yKGVycik7CiAgfSBlbHNlIHsKICAgIHRocm93IGVycjsKICB9Cn0KLyogICovCgoKdmFyIGlzVXNpbmdNaWNyb1Rhc2sgPSBmYWxzZTsKdmFyIGNhbGxiYWNrcyA9IFtdOwp2YXIgcGVuZGluZyA9IGZhbHNlOwoKZnVuY3Rpb24gZmx1c2hDYWxsYmFja3MoKSB7CiAgcGVuZGluZyA9IGZhbHNlOwogIHZhciBjb3BpZXMgPSBjYWxsYmFja3Muc2xpY2UoMCk7CiAgY2FsbGJhY2tzLmxlbmd0aCA9IDA7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgY29waWVzLmxlbmd0aDsgaSsrKSB7CiAgICBjb3BpZXNbaV0oKTsKICB9Cn0gLy8gSGVyZSB3ZSBoYXZlIGFzeW5jIGRlZmVycmluZyB3cmFwcGVycyB1c2luZyBtaWNyb3Rhc2tzLgovLyBJbiAyLjUgd2UgdXNlZCAobWFjcm8pIHRhc2tzIChpbiBjb21iaW5hdGlvbiB3aXRoIG1pY3JvdGFza3MpLgovLyBIb3dldmVyLCBpdCBoYXMgc3VidGxlIHByb2JsZW1zIHdoZW4gc3RhdGUgaXMgY2hhbmdlZCByaWdodCBiZWZvcmUgcmVwYWludAovLyAoZS5nLiAjNjgxMywgb3V0LWluIHRyYW5zaXRpb25zKS4KLy8gQWxzbywgdXNpbmcgKG1hY3JvKSB0YXNrcyBpbiBldmVudCBoYW5kbGVyIHdvdWxkIGNhdXNlIHNvbWUgd2VpcmQgYmVoYXZpb3JzCi8vIHRoYXQgY2Fubm90IGJlIGNpcmN1bXZlbnRlZCAoZS5nLiAjNzEwOSwgIzcxNTMsICM3NTQ2LCAjNzgzNCwgIzgxMDkpLgovLyBTbyB3ZSBub3cgdXNlIG1pY3JvdGFza3MgZXZlcnl3aGVyZSwgYWdhaW4uCi8vIEEgbWFqb3IgZHJhd2JhY2sgb2YgdGhpcyB0cmFkZW9mZiBpcyB0aGF0IHRoZXJlIGFyZSBzb21lIHNjZW5hcmlvcwovLyB3aGVyZSBtaWNyb3Rhc2tzIGhhdmUgdG9vIGhpZ2ggYSBwcmlvcml0eSBhbmQgZmlyZSBpbiBiZXR3ZWVuIHN1cHBvc2VkbHkKLy8gc2VxdWVudGlhbCBldmVudHMgKGUuZy4gIzQ1MjEsICM2NjkwLCB3aGljaCBoYXZlIHdvcmthcm91bmRzKQovLyBvciBldmVuIGJldHdlZW4gYnViYmxpbmcgb2YgdGhlIHNhbWUgZXZlbnQgKCM2NTY2KS4KCgp2YXIgdGltZXJGdW5jOyAvLyBUaGUgbmV4dFRpY2sgYmVoYXZpb3IgbGV2ZXJhZ2VzIHRoZSBtaWNyb3Rhc2sgcXVldWUsIHdoaWNoIGNhbiBiZSBhY2Nlc3NlZAovLyB2aWEgZWl0aGVyIG5hdGl2ZSBQcm9taXNlLnRoZW4gb3IgTXV0YXRpb25PYnNlcnZlci4KLy8gTXV0YXRpb25PYnNlcnZlciBoYXMgd2lkZXIgc3VwcG9ydCwgaG93ZXZlciBpdCBpcyBzZXJpb3VzbHkgYnVnZ2VkIGluCi8vIFVJV2ViVmlldyBpbiBpT1MgPj0gOS4zLjMgd2hlbiB0cmlnZ2VyZWQgaW4gdG91Y2ggZXZlbnQgaGFuZGxlcnMuIEl0Ci8vIGNvbXBsZXRlbHkgc3RvcHMgd29ya2luZyBhZnRlciB0cmlnZ2VyaW5nIGEgZmV3IHRpbWVzLi4uIHNvLCBpZiBuYXRpdmUKLy8gUHJvbWlzZSBpcyBhdmFpbGFibGUsIHdlIHdpbGwgdXNlIGl0OgoKLyogaXN0YW5idWwgaWdub3JlIG5leHQsICRmbG93LWRpc2FibGUtbGluZSAqLwoKaWYgKHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShQcm9taXNlKSkgewogIHZhciBwID0gUHJvbWlzZS5yZXNvbHZlKCk7CgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHAudGhlbihmbHVzaENhbGxiYWNrcyk7IC8vIEluIHByb2JsZW1hdGljIFVJV2ViVmlld3MsIFByb21pc2UudGhlbiBkb2Vzbid0IGNvbXBsZXRlbHkgYnJlYWssIGJ1dAogICAgLy8gaXQgY2FuIGdldCBzdHVjayBpbiBhIHdlaXJkIHN0YXRlIHdoZXJlIGNhbGxiYWNrcyBhcmUgcHVzaGVkIGludG8gdGhlCiAgICAvLyBtaWNyb3Rhc2sgcXVldWUgYnV0IHRoZSBxdWV1ZSBpc24ndCBiZWluZyBmbHVzaGVkLCB1bnRpbCB0aGUgYnJvd3NlcgogICAgLy8gbmVlZHMgdG8gZG8gc29tZSBvdGhlciB3b3JrLCBlLmcuIGhhbmRsZSBhIHRpbWVyLiBUaGVyZWZvcmUgd2UgY2FuCiAgICAvLyAiZm9yY2UiIHRoZSBtaWNyb3Rhc2sgcXVldWUgdG8gYmUgZmx1c2hlZCBieSBhZGRpbmcgYW4gZW1wdHkgdGltZXIuCgogICAgaWYgKGlzSU9TKSB7CiAgICAgIHNldFRpbWVvdXQobm9vcCk7CiAgICB9CiAgfTsKCiAgaXNVc2luZ01pY3JvVGFzayA9IHRydWU7Cn0gZWxzZSBpZiAoIWlzSUUgJiYgdHlwZW9mIE11dGF0aW9uT2JzZXJ2ZXIgIT09ICd1bmRlZmluZWQnICYmIChpc05hdGl2ZShNdXRhdGlvbk9ic2VydmVyKSB8fCAvLyBQaGFudG9tSlMgYW5kIGlPUyA3LngKTXV0YXRpb25PYnNlcnZlci50b1N0cmluZygpID09PSAnW29iamVjdCBNdXRhdGlvbk9ic2VydmVyQ29uc3RydWN0b3JdJykpIHsKICAvLyBVc2UgTXV0YXRpb25PYnNlcnZlciB3aGVyZSBuYXRpdmUgUHJvbWlzZSBpcyBub3QgYXZhaWxhYmxlLAogIC8vIGUuZy4gUGhhbnRvbUpTLCBpT1M3LCBBbmRyb2lkIDQuNAogIC8vICgjNjQ2NiBNdXRhdGlvbk9ic2VydmVyIGlzIHVucmVsaWFibGUgaW4gSUUxMSkKICB2YXIgY291bnRlciA9IDE7CiAgdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZmx1c2hDYWxsYmFja3MpOwogIHZhciB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKFN0cmluZyhjb3VudGVyKSk7CiAgb2JzZXJ2ZXIub2JzZXJ2ZSh0ZXh0Tm9kZSwgewogICAgY2hhcmFjdGVyRGF0YTogdHJ1ZQogIH0pOwoKICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBjb3VudGVyID0gKGNvdW50ZXIgKyAxKSAlIDI7CiAgICB0ZXh0Tm9kZS5kYXRhID0gU3RyaW5nKGNvdW50ZXIpOwogIH07CgogIGlzVXNpbmdNaWNyb1Rhc2sgPSB0cnVlOwp9IGVsc2UgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKHNldEltbWVkaWF0ZSkpIHsKICAvLyBGYWxsYmFjayB0byBzZXRJbW1lZGlhdGUuCiAgLy8gVGVjaGluaWNhbGx5IGl0IGxldmVyYWdlcyB0aGUgKG1hY3JvKSB0YXNrIHF1ZXVlLAogIC8vIGJ1dCBpdCBpcyBzdGlsbCBhIGJldHRlciBjaG9pY2UgdGhhbiBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHNldEltbWVkaWF0ZShmbHVzaENhbGxiYWNrcyk7CiAgfTsKfSBlbHNlIHsKICAvLyBGYWxsYmFjayB0byBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHNldFRpbWVvdXQoZmx1c2hDYWxsYmFja3MsIDApOwogIH07Cn0KCmZ1bmN0aW9uIG5leHRUaWNrKGNiLCBjdHgpIHsKICB2YXIgX3Jlc29sdmU7CgogIGNhbGxiYWNrcy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgIGlmIChjYikgewogICAgICB0cnkgewogICAgICAgIGNiLmNhbGwoY3R4KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGhhbmRsZUVycm9yKGUsIGN0eCwgJ25leHRUaWNrJyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoX3Jlc29sdmUpIHsKICAgICAgX3Jlc29sdmUoY3R4KTsKICAgIH0KICB9KTsKCiAgaWYgKCFwZW5kaW5nKSB7CiAgICBwZW5kaW5nID0gdHJ1ZTsKICAgIHRpbWVyRnVuYygpOwogIH0gLy8gJGZsb3ctZGlzYWJsZS1saW5lCgoKICBpZiAoIWNiICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgIF9yZXNvbHZlID0gcmVzb2x2ZTsKICAgIH0pOwogIH0KfQovKiAgKi8KCi8qIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aCBQcm94eSAqLwoKCnZhciBpbml0UHJveHk7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBhbGxvd2VkR2xvYmFscyA9IG1ha2VNYXAoJ0luZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4sJyArICdwYXJzZUZsb2F0LHBhcnNlSW50LGRlY29kZVVSSSxkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCwnICsgJ01hdGgsTnVtYmVyLERhdGUsQXJyYXksT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCwnICsgJ3JlcXVpcmUnIC8vIGZvciBXZWJwYWNrL0Jyb3dzZXJpZnkKICApOwoKICB2YXIgd2Fybk5vblByZXNlbnQgPSBmdW5jdGlvbiB3YXJuTm9uUHJlc2VudCh0YXJnZXQsIGtleSkgewogICAgd2FybigiUHJvcGVydHkgb3IgbWV0aG9kIFwiIiArIGtleSArICJcIiBpcyBub3QgZGVmaW5lZCBvbiB0aGUgaW5zdGFuY2UgYnV0ICIgKyAncmVmZXJlbmNlZCBkdXJpbmcgcmVuZGVyLiBNYWtlIHN1cmUgdGhhdCB0aGlzIHByb3BlcnR5IGlzIHJlYWN0aXZlLCAnICsgJ2VpdGhlciBpbiB0aGUgZGF0YSBvcHRpb24sIG9yIGZvciBjbGFzcy1iYXNlZCBjb21wb25lbnRzLCBieSAnICsgJ2luaXRpYWxpemluZyB0aGUgcHJvcGVydHkuICcgKyAnU2VlOiBodHRwczovL3Z1ZWpzLm9yZy92Mi9ndWlkZS9yZWFjdGl2aXR5Lmh0bWwjRGVjbGFyaW5nLVJlYWN0aXZlLVByb3BlcnRpZXMuJywgdGFyZ2V0KTsKICB9OwoKICB2YXIgd2FyblJlc2VydmVkUHJlZml4ID0gZnVuY3Rpb24gd2FyblJlc2VydmVkUHJlZml4KHRhcmdldCwga2V5KSB7CiAgICB3YXJuKCJQcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgbXVzdCBiZSBhY2Nlc3NlZCB3aXRoIFwiJGRhdGEuIiArIGtleSArICJcIiBiZWNhdXNlICIgKyAncHJvcGVydGllcyBzdGFydGluZyB3aXRoICIkIiBvciAiXyIgYXJlIG5vdCBwcm94aWVkIGluIHRoZSBWdWUgaW5zdGFuY2UgdG8gJyArICdwcmV2ZW50IGNvbmZsaWN0cyB3aXRoIFZ1ZSBpbnRlcm5hbHMnICsgJ1NlZTogaHR0cHM6Ly92dWVqcy5vcmcvdjIvYXBpLyNkYXRhJywgdGFyZ2V0KTsKICB9OwoKICB2YXIgaGFzUHJveHkgPSB0eXBlb2YgUHJveHkgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFByb3h5KTsKCiAgaWYgKGhhc1Byb3h5KSB7CiAgICB2YXIgaXNCdWlsdEluTW9kaWZpZXIgPSBtYWtlTWFwKCdzdG9wLHByZXZlbnQsc2VsZixjdHJsLHNoaWZ0LGFsdCxtZXRhLGV4YWN0Jyk7CiAgICBjb25maWcua2V5Q29kZXMgPSBuZXcgUHJveHkoY29uZmlnLmtleUNvZGVzLCB7CiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChpc0J1aWx0SW5Nb2RpZmllcihrZXkpKSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBvdmVyd3JpdGluZyBidWlsdC1pbiBtb2RpZmllciBpbiBjb25maWcua2V5Q29kZXM6IC4iICsga2V5KTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGFyZ2V0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICB2YXIgaGFzSGFuZGxlciA9IHsKICAgIGhhczogZnVuY3Rpb24gaGFzKHRhcmdldCwga2V5KSB7CiAgICAgIHZhciBoYXMgPSBrZXkgaW4gdGFyZ2V0OwogICAgICB2YXIgaXNBbGxvd2VkID0gYWxsb3dlZEdsb2JhbHMoa2V5KSB8fCB0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkuY2hhckF0KDApID09PSAnXycgJiYgIShrZXkgaW4gdGFyZ2V0LiRkYXRhKTsKCiAgICAgIGlmICghaGFzICYmICFpc0FsbG93ZWQpIHsKICAgICAgICBpZiAoa2V5IGluIHRhcmdldC4kZGF0YSkgewogICAgICAgICAgd2FyblJlc2VydmVkUHJlZml4KHRhcmdldCwga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2Fybk5vblByZXNlbnQodGFyZ2V0LCBrZXkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGhhcyB8fCAhaXNBbGxvd2VkOwogICAgfQogIH07CiAgdmFyIGdldEhhbmRsZXIgPSB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCh0YXJnZXQsIGtleSkgewogICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgIShrZXkgaW4gdGFyZ2V0KSkgewogICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0LiRkYXRhKSB7CiAgICAgICAgICB3YXJuUmVzZXJ2ZWRQcmVmaXgodGFyZ2V0LCBrZXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3YXJuTm9uUHJlc2VudCh0YXJnZXQsIGtleSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0W2tleV07CiAgICB9CiAgfTsKCiAgaW5pdFByb3h5ID0gZnVuY3Rpb24gaW5pdFByb3h5KHZtKSB7CiAgICBpZiAoaGFzUHJveHkpIHsKICAgICAgLy8gZGV0ZXJtaW5lIHdoaWNoIHByb3h5IGhhbmRsZXIgdG8gdXNlCiAgICAgIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CiAgICAgIHZhciBoYW5kbGVycyA9IG9wdGlvbnMucmVuZGVyICYmIG9wdGlvbnMucmVuZGVyLl93aXRoU3RyaXBwZWQgPyBnZXRIYW5kbGVyIDogaGFzSGFuZGxlcjsKICAgICAgdm0uX3JlbmRlclByb3h5ID0gbmV3IFByb3h5KHZtLCBoYW5kbGVycyk7CiAgICB9IGVsc2UgewogICAgICB2bS5fcmVuZGVyUHJveHkgPSB2bTsKICAgIH0KICB9Owp9Ci8qICAqLwoKCnZhciBzZWVuT2JqZWN0cyA9IG5ldyBfU2V0KCk7Ci8qKgogKiBSZWN1cnNpdmVseSB0cmF2ZXJzZSBhbiBvYmplY3QgdG8gZXZva2UgYWxsIGNvbnZlcnRlZAogKiBnZXR0ZXJzLCBzbyB0aGF0IGV2ZXJ5IG5lc3RlZCBwcm9wZXJ0eSBpbnNpZGUgdGhlIG9iamVjdAogKiBpcyBjb2xsZWN0ZWQgYXMgYSAiZGVlcCIgZGVwZW5kZW5jeS4KICovCgpmdW5jdGlvbiB0cmF2ZXJzZSh2YWwpIHsKICBfdHJhdmVyc2UodmFsLCBzZWVuT2JqZWN0cyk7CgogIHNlZW5PYmplY3RzLmNsZWFyKCk7Cn0KCmZ1bmN0aW9uIF90cmF2ZXJzZSh2YWwsIHNlZW4pIHsKICB2YXIgaSwga2V5czsKICB2YXIgaXNBID0gQXJyYXkuaXNBcnJheSh2YWwpOwoKICBpZiAoIWlzQSAmJiAhaXNPYmplY3QodmFsKSB8fCBPYmplY3QuaXNGcm96ZW4odmFsKSB8fCB2YWwgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKHZhbC5fX29iX18pIHsKICAgIHZhciBkZXBJZCA9IHZhbC5fX29iX18uZGVwLmlkOwoKICAgIGlmIChzZWVuLmhhcyhkZXBJZCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHNlZW4uYWRkKGRlcElkKTsKICB9CgogIGlmIChpc0EpIHsKICAgIGkgPSB2YWwubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgX3RyYXZlcnNlKHZhbFtpXSwgc2Vlbik7CiAgICB9CiAgfSBlbHNlIHsKICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgaSA9IGtleXMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgX3RyYXZlcnNlKHZhbFtrZXlzW2ldXSwgc2Vlbik7CiAgICB9CiAgfQp9Cgp2YXIgbWFyazsKdmFyIG1lYXN1cmU7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBwZXJmID0gaW5Ccm93c2VyICYmIHdpbmRvdy5wZXJmb3JtYW5jZTsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgaWYgKHBlcmYgJiYgcGVyZi5tYXJrICYmIHBlcmYubWVhc3VyZSAmJiBwZXJmLmNsZWFyTWFya3MgJiYgcGVyZi5jbGVhck1lYXN1cmVzKSB7CiAgICBtYXJrID0gZnVuY3Rpb24gbWFyayh0YWcpIHsKICAgICAgcmV0dXJuIHBlcmYubWFyayh0YWcpOwogICAgfTsKCiAgICBtZWFzdXJlID0gZnVuY3Rpb24gbWVhc3VyZShuYW1lLCBzdGFydFRhZywgZW5kVGFnKSB7CiAgICAgIHBlcmYubWVhc3VyZShuYW1lLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgcGVyZi5jbGVhck1hcmtzKHN0YXJ0VGFnKTsKICAgICAgcGVyZi5jbGVhck1hcmtzKGVuZFRhZyk7IC8vIHBlcmYuY2xlYXJNZWFzdXJlcyhuYW1lKQogICAgfTsKICB9Cn0KLyogICovCgoKdmFyIG5vcm1hbGl6ZUV2ZW50ID0gY2FjaGVkKGZ1bmN0aW9uIChuYW1lKSB7CiAgdmFyIHBhc3NpdmUgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJyYnOwogIG5hbWUgPSBwYXNzaXZlID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgdmFyIG9uY2UkJDEgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJ34nOyAvLyBQcmVmaXhlZCBsYXN0LCBjaGVja2VkIGZpcnN0CgogIG5hbWUgPSBvbmNlJCQxID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgdmFyIGNhcHR1cmUgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJyEnOwogIG5hbWUgPSBjYXB0dXJlID8gbmFtZS5zbGljZSgxKSA6IG5hbWU7CiAgcmV0dXJuIHsKICAgIG5hbWU6IG5hbWUsCiAgICBvbmNlOiBvbmNlJCQxLAogICAgY2FwdHVyZTogY2FwdHVyZSwKICAgIHBhc3NpdmU6IHBhc3NpdmUKICB9Owp9KTsKCmZ1bmN0aW9uIGNyZWF0ZUZuSW52b2tlcihmbnMsIHZtKSB7CiAgZnVuY3Rpb24gaW52b2tlcigpIHsKICAgIHZhciBhcmd1bWVudHMkMSA9IGFyZ3VtZW50czsKICAgIHZhciBmbnMgPSBpbnZva2VyLmZuczsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShmbnMpKSB7CiAgICAgIHZhciBjbG9uZWQgPSBmbnMuc2xpY2UoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xvbmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoY2xvbmVkW2ldLCBudWxsLCBhcmd1bWVudHMkMSwgdm0sICJ2LW9uIGhhbmRsZXIiKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gcmV0dXJuIGhhbmRsZXIgcmV0dXJuIHZhbHVlIGZvciBzaW5nbGUgaGFuZGxlcnMKICAgICAgcmV0dXJuIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGZucywgbnVsbCwgYXJndW1lbnRzLCB2bSwgInYtb24gaGFuZGxlciIpOwogICAgfQogIH0KCiAgaW52b2tlci5mbnMgPSBmbnM7CiAgcmV0dXJuIGludm9rZXI7Cn0KCmZ1bmN0aW9uIHVwZGF0ZUxpc3RlbmVycyhvbiwgb2xkT24sIGFkZCwgcmVtb3ZlJCQxLCBjcmVhdGVPbmNlSGFuZGxlciwgdm0pIHsKICB2YXIgbmFtZSwgZGVmJCQxLCBjdXIsIG9sZCwgZXZlbnQ7CgogIGZvciAobmFtZSBpbiBvbikgewogICAgZGVmJCQxID0gY3VyID0gb25bbmFtZV07CiAgICBvbGQgPSBvbGRPbltuYW1lXTsKICAgIGV2ZW50ID0gbm9ybWFsaXplRXZlbnQobmFtZSk7CgogICAgaWYgKGlzVW5kZWYoY3VyKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkludmFsaWQgaGFuZGxlciBmb3IgZXZlbnQgXCIiICsgZXZlbnQubmFtZSArICJcIjogZ290ICIgKyBTdHJpbmcoY3VyKSwgdm0pOwogICAgfSBlbHNlIGlmIChpc1VuZGVmKG9sZCkpIHsKICAgICAgaWYgKGlzVW5kZWYoY3VyLmZucykpIHsKICAgICAgICBjdXIgPSBvbltuYW1lXSA9IGNyZWF0ZUZuSW52b2tlcihjdXIsIHZtKTsKICAgICAgfQoKICAgICAgaWYgKGlzVHJ1ZShldmVudC5vbmNlKSkgewogICAgICAgIGN1ciA9IG9uW25hbWVdID0gY3JlYXRlT25jZUhhbmRsZXIoZXZlbnQubmFtZSwgY3VyLCBldmVudC5jYXB0dXJlKTsKICAgICAgfQoKICAgICAgYWRkKGV2ZW50Lm5hbWUsIGN1ciwgZXZlbnQuY2FwdHVyZSwgZXZlbnQucGFzc2l2ZSwgZXZlbnQucGFyYW1zKTsKICAgIH0gZWxzZSBpZiAoY3VyICE9PSBvbGQpIHsKICAgICAgb2xkLmZucyA9IGN1cjsKICAgICAgb25bbmFtZV0gPSBvbGQ7CiAgICB9CiAgfQoKICBmb3IgKG5hbWUgaW4gb2xkT24pIHsKICAgIGlmIChpc1VuZGVmKG9uW25hbWVdKSkgewogICAgICBldmVudCA9IG5vcm1hbGl6ZUV2ZW50KG5hbWUpOwogICAgICByZW1vdmUkJDEoZXZlbnQubmFtZSwgb2xkT25bbmFtZV0sIGV2ZW50LmNhcHR1cmUpOwogICAgfQogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBtZXJnZVZOb2RlSG9vayhkZWYsIGhvb2tLZXksIGhvb2spIHsKICBpZiAoZGVmIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIGRlZiA9IGRlZi5kYXRhLmhvb2sgfHwgKGRlZi5kYXRhLmhvb2sgPSB7fSk7CiAgfQoKICB2YXIgaW52b2tlcjsKICB2YXIgb2xkSG9vayA9IGRlZltob29rS2V5XTsKCiAgZnVuY3Rpb24gd3JhcHBlZEhvb2soKSB7CiAgICBob29rLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIGltcG9ydGFudDogcmVtb3ZlIG1lcmdlZCBob29rIHRvIGVuc3VyZSBpdCdzIGNhbGxlZCBvbmx5IG9uY2UKICAgIC8vIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrCgogICAgcmVtb3ZlKGludm9rZXIuZm5zLCB3cmFwcGVkSG9vayk7CiAgfQoKICBpZiAoaXNVbmRlZihvbGRIb29rKSkgewogICAgLy8gbm8gZXhpc3RpbmcgaG9vawogICAgaW52b2tlciA9IGNyZWF0ZUZuSW52b2tlcihbd3JhcHBlZEhvb2tdKTsKICB9IGVsc2UgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoaXNEZWYob2xkSG9vay5mbnMpICYmIGlzVHJ1ZShvbGRIb29rLm1lcmdlZCkpIHsKICAgICAgLy8gYWxyZWFkeSBhIG1lcmdlZCBpbnZva2VyCiAgICAgIGludm9rZXIgPSBvbGRIb29rOwogICAgICBpbnZva2VyLmZucy5wdXNoKHdyYXBwZWRIb29rKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGV4aXN0aW5nIHBsYWluIGhvb2sKICAgICAgaW52b2tlciA9IGNyZWF0ZUZuSW52b2tlcihbb2xkSG9vaywgd3JhcHBlZEhvb2tdKTsKICAgIH0KICB9CgogIGludm9rZXIubWVyZ2VkID0gdHJ1ZTsKICBkZWZbaG9va0tleV0gPSBpbnZva2VyOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGV4dHJhY3RQcm9wc0Zyb21WTm9kZURhdGEoZGF0YSwgQ3RvciwgdGFnKSB7CiAgLy8gd2UgYXJlIG9ubHkgZXh0cmFjdGluZyByYXcgdmFsdWVzIGhlcmUuCiAgLy8gdmFsaWRhdGlvbiBhbmQgZGVmYXVsdCB2YWx1ZXMgYXJlIGhhbmRsZWQgaW4gdGhlIGNoaWxkCiAgLy8gY29tcG9uZW50IGl0c2VsZi4KICB2YXIgcHJvcE9wdGlvbnMgPSBDdG9yLm9wdGlvbnMucHJvcHM7CgogIGlmIChpc1VuZGVmKHByb3BPcHRpb25zKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHJlcyA9IHt9OwogIHZhciBhdHRycyA9IGRhdGEuYXR0cnM7CiAgdmFyIHByb3BzID0gZGF0YS5wcm9wczsKCiAgaWYgKGlzRGVmKGF0dHJzKSB8fCBpc0RlZihwcm9wcykpIHsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICB2YXIgYWx0S2V5ID0gaHlwaGVuYXRlKGtleSk7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIHZhciBrZXlJbkxvd2VyQ2FzZSA9IGtleS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICBpZiAoa2V5ICE9PSBrZXlJbkxvd2VyQ2FzZSAmJiBhdHRycyAmJiBoYXNPd24oYXR0cnMsIGtleUluTG93ZXJDYXNlKSkgewogICAgICAgICAgdGlwKCJQcm9wIFwiIiArIGtleUluTG93ZXJDYXNlICsgIlwiIGlzIHBhc3NlZCB0byBjb21wb25lbnQgIiArIGZvcm1hdENvbXBvbmVudE5hbWUodGFnIHx8IEN0b3IpICsgIiwgYnV0IHRoZSBkZWNsYXJlZCBwcm9wIG5hbWUgaXMiICsgIiBcIiIgKyBrZXkgKyAiXCIuICIgKyAiTm90ZSB0aGF0IEhUTUwgYXR0cmlidXRlcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZSBhbmQgY2FtZWxDYXNlZCAiICsgInByb3BzIG5lZWQgdG8gdXNlIHRoZWlyIGtlYmFiLWNhc2UgZXF1aXZhbGVudHMgd2hlbiB1c2luZyBpbi1ET00gIiArICJ0ZW1wbGF0ZXMuIFlvdSBzaG91bGQgcHJvYmFibHkgdXNlIFwiIiArIGFsdEtleSArICJcIiBpbnN0ZWFkIG9mIFwiIiArIGtleSArICJcIi4iKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNoZWNrUHJvcChyZXMsIHByb3BzLCBrZXksIGFsdEtleSwgdHJ1ZSkgfHwgY2hlY2tQcm9wKHJlcywgYXR0cnMsIGtleSwgYWx0S2V5LCBmYWxzZSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBjaGVja1Byb3AocmVzLCBoYXNoLCBrZXksIGFsdEtleSwgcHJlc2VydmUpIHsKICBpZiAoaXNEZWYoaGFzaCkpIHsKICAgIGlmIChoYXNPd24oaGFzaCwga2V5KSkgewogICAgICByZXNba2V5XSA9IGhhc2hba2V5XTsKCiAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICBkZWxldGUgaGFzaFtrZXldOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoaGFzT3duKGhhc2gsIGFsdEtleSkpIHsKICAgICAgcmVzW2tleV0gPSBoYXNoW2FsdEtleV07CgogICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgZGVsZXRlIGhhc2hbYWx0S2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQoKICByZXR1cm4gZmFsc2U7Cn0KLyogICovCi8vIFRoZSB0ZW1wbGF0ZSBjb21waWxlciBhdHRlbXB0cyB0byBtaW5pbWl6ZSB0aGUgbmVlZCBmb3Igbm9ybWFsaXphdGlvbiBieQovLyBzdGF0aWNhbGx5IGFuYWx5emluZyB0aGUgdGVtcGxhdGUgYXQgY29tcGlsZSB0aW1lLgovLwovLyBGb3IgcGxhaW4gSFRNTCBtYXJrdXAsIG5vcm1hbGl6YXRpb24gY2FuIGJlIGNvbXBsZXRlbHkgc2tpcHBlZCBiZWNhdXNlIHRoZQovLyBnZW5lcmF0ZWQgcmVuZGVyIGZ1bmN0aW9uIGlzIGd1YXJhbnRlZWQgdG8gcmV0dXJuIEFycmF5PFZOb2RlPi4gVGhlcmUgYXJlCi8vIHR3byBjYXNlcyB3aGVyZSBleHRyYSBub3JtYWxpemF0aW9uIGlzIG5lZWRlZDoKLy8gMS4gV2hlbiB0aGUgY2hpbGRyZW4gY29udGFpbnMgY29tcG9uZW50cyAtIGJlY2F1c2UgYSBmdW5jdGlvbmFsIGNvbXBvbmVudAovLyBtYXkgcmV0dXJuIGFuIEFycmF5IGluc3RlYWQgb2YgYSBzaW5nbGUgcm9vdC4gSW4gdGhpcyBjYXNlLCBqdXN0IGEgc2ltcGxlCi8vIG5vcm1hbGl6YXRpb24gaXMgbmVlZGVkIC0gaWYgYW55IGNoaWxkIGlzIGFuIEFycmF5LCB3ZSBmbGF0dGVuIHRoZSB3aG9sZQovLyB0aGluZyB3aXRoIEFycmF5LnByb3RvdHlwZS5jb25jYXQuIEl0IGlzIGd1YXJhbnRlZWQgdG8gYmUgb25seSAxLWxldmVsIGRlZXAKLy8gYmVjYXVzZSBmdW5jdGlvbmFsIGNvbXBvbmVudHMgYWxyZWFkeSBub3JtYWxpemUgdGhlaXIgb3duIGNoaWxkcmVuLgoKCmZ1bmN0aW9uIHNpbXBsZU5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW5baV0pKSB7CiAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuY29uY2F0LmFwcGx5KFtdLCBjaGlsZHJlbik7CiAgICB9CiAgfQoKICByZXR1cm4gY2hpbGRyZW47Cn0gLy8gMi4gV2hlbiB0aGUgY2hpbGRyZW4gY29udGFpbnMgY29uc3RydWN0cyB0aGF0IGFsd2F5cyBnZW5lcmF0ZWQgbmVzdGVkIEFycmF5cywKLy8gZS5nLiA8dGVtcGxhdGU+LCA8c2xvdD4sIHYtZm9yLCBvciB3aGVuIHRoZSBjaGlsZHJlbiBpcyBwcm92aWRlZCBieSB1c2VyCi8vIHdpdGggaGFuZC13cml0dGVuIHJlbmRlciBmdW5jdGlvbnMgLyBKU1guIEluIHN1Y2ggY2FzZXMgYSBmdWxsIG5vcm1hbGl6YXRpb24KLy8gaXMgbmVlZGVkIHRvIGNhdGVyIHRvIGFsbCBwb3NzaWJsZSB0eXBlcyBvZiBjaGlsZHJlbiB2YWx1ZXMuCgoKZnVuY3Rpb24gbm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pIHsKICByZXR1cm4gaXNQcmltaXRpdmUoY2hpbGRyZW4pID8gW2NyZWF0ZVRleHRWTm9kZShjaGlsZHJlbildIDogQXJyYXkuaXNBcnJheShjaGlsZHJlbikgPyBub3JtYWxpemVBcnJheUNoaWxkcmVuKGNoaWxkcmVuKSA6IHVuZGVmaW5lZDsKfQoKZnVuY3Rpb24gaXNUZXh0Tm9kZShub2RlKSB7CiAgcmV0dXJuIGlzRGVmKG5vZGUpICYmIGlzRGVmKG5vZGUudGV4dCkgJiYgaXNGYWxzZShub2RlLmlzQ29tbWVudCk7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4oY2hpbGRyZW4sIG5lc3RlZEluZGV4KSB7CiAgdmFyIHJlcyA9IFtdOwogIHZhciBpLCBjLCBsYXN0SW5kZXgsIGxhc3Q7CgogIGZvciAoaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgYyA9IGNoaWxkcmVuW2ldOwoKICAgIGlmIChpc1VuZGVmKGMpIHx8IHR5cGVvZiBjID09PSAnYm9vbGVhbicpIHsKICAgICAgY29udGludWU7CiAgICB9CgogICAgbGFzdEluZGV4ID0gcmVzLmxlbmd0aCAtIDE7CiAgICBsYXN0ID0gcmVzW2xhc3RJbmRleF07IC8vICBuZXN0ZWQKCiAgICBpZiAoQXJyYXkuaXNBcnJheShjKSkgewogICAgICBpZiAoYy5sZW5ndGggPiAwKSB7CiAgICAgICAgYyA9IG5vcm1hbGl6ZUFycmF5Q2hpbGRyZW4oYywgKG5lc3RlZEluZGV4IHx8ICcnKSArICJfIiArIGkpOyAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCgogICAgICAgIGlmIChpc1RleHROb2RlKGNbMF0pICYmIGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGNbMF0udGV4dCk7CiAgICAgICAgICBjLnNoaWZ0KCk7CiAgICAgICAgfQoKICAgICAgICByZXMucHVzaC5hcHBseShyZXMsIGMpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzUHJpbWl0aXZlKGMpKSB7CiAgICAgIGlmIChpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwogICAgICAgIC8vIHRoaXMgaXMgbmVjZXNzYXJ5IGZvciBTU1IgaHlkcmF0aW9uIGJlY2F1c2UgdGV4dCBub2RlcyBhcmUKICAgICAgICAvLyBlc3NlbnRpYWxseSBtZXJnZWQgd2hlbiByZW5kZXJlZCB0byBIVE1MIHN0cmluZ3MKICAgICAgICByZXNbbGFzdEluZGV4XSA9IGNyZWF0ZVRleHRWTm9kZShsYXN0LnRleHQgKyBjKTsKICAgICAgfSBlbHNlIGlmIChjICE9PSAnJykgewogICAgICAgIC8vIGNvbnZlcnQgcHJpbWl0aXZlIHRvIHZub2RlCiAgICAgICAgcmVzLnB1c2goY3JlYXRlVGV4dFZOb2RlKGMpKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGlzVGV4dE5vZGUoYykgJiYgaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgIC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMKICAgICAgICByZXNbbGFzdEluZGV4XSA9IGNyZWF0ZVRleHRWTm9kZShsYXN0LnRleHQgKyBjLnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGRlZmF1bHQga2V5IGZvciBuZXN0ZWQgYXJyYXkgY2hpbGRyZW4gKGxpa2VseSBnZW5lcmF0ZWQgYnkgdi1mb3IpCiAgICAgICAgaWYgKGlzVHJ1ZShjaGlsZHJlbi5faXNWTGlzdCkgJiYgaXNEZWYoYy50YWcpICYmIGlzVW5kZWYoYy5rZXkpICYmIGlzRGVmKG5lc3RlZEluZGV4KSkgewogICAgICAgICAgYy5rZXkgPSAiX192bGlzdCIgKyBuZXN0ZWRJbmRleCArICJfIiArIGkgKyAiX18iOwogICAgICAgIH0KCiAgICAgICAgcmVzLnB1c2goYyk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKZnVuY3Rpb24gaW5pdFByb3ZpZGUodm0pIHsKICB2YXIgcHJvdmlkZSA9IHZtLiRvcHRpb25zLnByb3ZpZGU7CgogIGlmIChwcm92aWRlKSB7CiAgICB2bS5fcHJvdmlkZWQgPSB0eXBlb2YgcHJvdmlkZSA9PT0gJ2Z1bmN0aW9uJyA/IHByb3ZpZGUuY2FsbCh2bSkgOiBwcm92aWRlOwogIH0KfQoKZnVuY3Rpb24gaW5pdEluamVjdGlvbnModm0pIHsKICB2YXIgcmVzdWx0ID0gcmVzb2x2ZUluamVjdCh2bS4kb3B0aW9ucy5pbmplY3QsIHZtKTsKCiAgaWYgKHJlc3VsdCkgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICAgIE9iamVjdC5rZXlzKHJlc3VsdCkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sIGtleSwgcmVzdWx0W2tleV0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHdhcm4oIkF2b2lkIG11dGF0aW5nIGFuIGluamVjdGVkIHZhbHVlIGRpcmVjdGx5IHNpbmNlIHRoZSBjaGFuZ2VzIHdpbGwgYmUgIiArICJvdmVyd3JpdHRlbiB3aGVuZXZlciB0aGUgcHJvdmlkZWQgY29tcG9uZW50IHJlLXJlbmRlcnMuICIgKyAiaW5qZWN0aW9uIGJlaW5nIG11dGF0ZWQ6IFwiIiArIGtleSArICJcIiIsIHZtKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwga2V5LCByZXN1bHRba2V5XSk7CiAgICAgIH0KICAgIH0pOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZUluamVjdChpbmplY3QsIHZtKSB7CiAgaWYgKGluamVjdCkgewogICAgLy8gaW5qZWN0IGlzIDphbnkgYmVjYXVzZSBmbG93IGlzIG5vdCBzbWFydCBlbm91Z2ggdG8gZmlndXJlIG91dCBjYWNoZWQKICAgIHZhciByZXN1bHQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoaW5qZWN0KSA6IE9iamVjdC5rZXlzKGluamVjdCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOyAvLyAjNjU3NCBpbiBjYXNlIHRoZSBpbmplY3Qgb2JqZWN0IGlzIG9ic2VydmVkLi4uCgogICAgICBpZiAoa2V5ID09PSAnX19vYl9fJykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICB2YXIgcHJvdmlkZUtleSA9IGluamVjdFtrZXldLmZyb207CiAgICAgIHZhciBzb3VyY2UgPSB2bTsKCiAgICAgIHdoaWxlIChzb3VyY2UpIHsKICAgICAgICBpZiAoc291cmNlLl9wcm92aWRlZCAmJiBoYXNPd24oc291cmNlLl9wcm92aWRlZCwgcHJvdmlkZUtleSkpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gc291cmNlLl9wcm92aWRlZFtwcm92aWRlS2V5XTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgc291cmNlID0gc291cmNlLiRwYXJlbnQ7CiAgICAgIH0KCiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgaWYgKCdkZWZhdWx0JyBpbiBpbmplY3Rba2V5XSkgewogICAgICAgICAgdmFyIHByb3ZpZGVEZWZhdWx0ID0gaW5qZWN0W2tleV1bImRlZmF1bHQiXTsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdHlwZW9mIHByb3ZpZGVEZWZhdWx0ID09PSAnZnVuY3Rpb24nID8gcHJvdmlkZURlZmF1bHQuY2FsbCh2bSkgOiBwcm92aWRlRGVmYXVsdDsKICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIHdhcm4oIkluamVjdGlvbiBcIiIgKyBrZXkgKyAiXCIgbm90IGZvdW5kIiwgdm0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXN1bHQ7CiAgfQp9Ci8qICAqLwoKLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZXNvbHZpbmcgcmF3IGNoaWxkcmVuIFZOb2RlcyBpbnRvIGEgc2xvdCBvYmplY3QuCiAqLwoKCmZ1bmN0aW9uIHJlc29sdmVTbG90cyhjaGlsZHJlbiwgY29udGV4dCkgewogIGlmICghY2hpbGRyZW4gfHwgIWNoaWxkcmVuLmxlbmd0aCkgewogICAgcmV0dXJuIHt9OwogIH0KCiAgdmFyIHNsb3RzID0ge307CgogIGZvciAodmFyIGkgPSAwLCBsID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgIHZhciBkYXRhID0gY2hpbGQuZGF0YTsgLy8gcmVtb3ZlIHNsb3QgYXR0cmlidXRlIGlmIHRoZSBub2RlIGlzIHJlc29sdmVkIGFzIGEgVnVlIHNsb3Qgbm9kZQoKICAgIGlmIChkYXRhICYmIGRhdGEuYXR0cnMgJiYgZGF0YS5hdHRycy5zbG90KSB7CiAgICAgIGRlbGV0ZSBkYXRhLmF0dHJzLnNsb3Q7CiAgICB9IC8vIG5hbWVkIHNsb3RzIHNob3VsZCBvbmx5IGJlIHJlc3BlY3RlZCBpZiB0aGUgdm5vZGUgd2FzIHJlbmRlcmVkIGluIHRoZQogICAgLy8gc2FtZSBjb250ZXh0LgoKCiAgICBpZiAoKGNoaWxkLmNvbnRleHQgPT09IGNvbnRleHQgfHwgY2hpbGQuZm5Db250ZXh0ID09PSBjb250ZXh0KSAmJiBkYXRhICYmIGRhdGEuc2xvdCAhPSBudWxsKSB7CiAgICAgIHZhciBuYW1lID0gZGF0YS5zbG90OwogICAgICB2YXIgc2xvdCA9IHNsb3RzW25hbWVdIHx8IChzbG90c1tuYW1lXSA9IFtdKTsKCiAgICAgIGlmIChjaGlsZC50YWcgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICBzbG90LnB1c2guYXBwbHkoc2xvdCwgY2hpbGQuY2hpbGRyZW4gfHwgW10pOwogICAgICB9IGVsc2UgewogICAgICAgIHNsb3QucHVzaChjaGlsZCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIChzbG90c1siZGVmYXVsdCJdIHx8IChzbG90c1siZGVmYXVsdCJdID0gW10pKS5wdXNoKGNoaWxkKTsKICAgIH0KICB9IC8vIGlnbm9yZSBzbG90cyB0aGF0IGNvbnRhaW5zIG9ubHkgd2hpdGVzcGFjZQoKCiAgZm9yICh2YXIgbmFtZSQxIGluIHNsb3RzKSB7CiAgICBpZiAoc2xvdHNbbmFtZSQxXS5ldmVyeShpc1doaXRlc3BhY2UpKSB7CiAgICAgIGRlbGV0ZSBzbG90c1tuYW1lJDFdOwogICAgfQogIH0KCiAgcmV0dXJuIHNsb3RzOwp9CgpmdW5jdGlvbiBpc1doaXRlc3BhY2Uobm9kZSkgewogIHJldHVybiBub2RlLmlzQ29tbWVudCAmJiAhbm9kZS5hc3luY0ZhY3RvcnkgfHwgbm9kZS50ZXh0ID09PSAnICc7Cn0KLyogICovCgoKZnVuY3Rpb24gbm9ybWFsaXplU2NvcGVkU2xvdHMoc2xvdHMsIG5vcm1hbFNsb3RzLCBwcmV2U2xvdHMpIHsKICB2YXIgcmVzOwogIHZhciBoYXNOb3JtYWxTbG90cyA9IE9iamVjdC5rZXlzKG5vcm1hbFNsb3RzKS5sZW5ndGggPiAwOwogIHZhciBpc1N0YWJsZSA9IHNsb3RzID8gISFzbG90cy4kc3RhYmxlIDogIWhhc05vcm1hbFNsb3RzOwogIHZhciBrZXkgPSBzbG90cyAmJiBzbG90cy4ka2V5OwoKICBpZiAoIXNsb3RzKSB7CiAgICByZXMgPSB7fTsKICB9IGVsc2UgaWYgKHNsb3RzLl9ub3JtYWxpemVkKSB7CiAgICAvLyBmYXN0IHBhdGggMTogY2hpbGQgY29tcG9uZW50IHJlLXJlbmRlciBvbmx5LCBwYXJlbnQgZGlkIG5vdCBjaGFuZ2UKICAgIHJldHVybiBzbG90cy5fbm9ybWFsaXplZDsKICB9IGVsc2UgaWYgKGlzU3RhYmxlICYmIHByZXZTbG90cyAmJiBwcmV2U2xvdHMgIT09IGVtcHR5T2JqZWN0ICYmIGtleSA9PT0gcHJldlNsb3RzLiRrZXkgJiYgIWhhc05vcm1hbFNsb3RzICYmICFwcmV2U2xvdHMuJGhhc05vcm1hbCkgewogICAgLy8gZmFzdCBwYXRoIDI6IHN0YWJsZSBzY29wZWQgc2xvdHMgdy8gbm8gbm9ybWFsIHNsb3RzIHRvIHByb3h5LAogICAgLy8gb25seSBuZWVkIHRvIG5vcm1hbGl6ZSBvbmNlCiAgICByZXR1cm4gcHJldlNsb3RzOwogIH0gZWxzZSB7CiAgICByZXMgPSB7fTsKCiAgICBmb3IgKHZhciBrZXkkMSBpbiBzbG90cykgewogICAgICBpZiAoc2xvdHNba2V5JDFdICYmIGtleSQxWzBdICE9PSAnJCcpIHsKICAgICAgICByZXNba2V5JDFdID0gbm9ybWFsaXplU2NvcGVkU2xvdChub3JtYWxTbG90cywga2V5JDEsIHNsb3RzW2tleSQxXSk7CiAgICAgIH0KICAgIH0KICB9IC8vIGV4cG9zZSBub3JtYWwgc2xvdHMgb24gc2NvcGVkU2xvdHMKCgogIGZvciAodmFyIGtleSQyIGluIG5vcm1hbFNsb3RzKSB7CiAgICBpZiAoIShrZXkkMiBpbiByZXMpKSB7CiAgICAgIHJlc1trZXkkMl0gPSBwcm94eU5vcm1hbFNsb3Qobm9ybWFsU2xvdHMsIGtleSQyKTsKICAgIH0KICB9IC8vIGF2b3JpYXogc2VlbXMgdG8gbW9jayBhIG5vbi1leHRlbnNpYmxlICRzY29wZWRTbG90cyBvYmplY3QKICAvLyBhbmQgd2hlbiB0aGF0IGlzIHBhc3NlZCBkb3duIHRoaXMgd291bGQgY2F1c2UgYW4gZXJyb3IKCgogIGlmIChzbG90cyAmJiBPYmplY3QuaXNFeHRlbnNpYmxlKHNsb3RzKSkgewogICAgc2xvdHMuX25vcm1hbGl6ZWQgPSByZXM7CiAgfQoKICBkZWYocmVzLCAnJHN0YWJsZScsIGlzU3RhYmxlKTsKICBkZWYocmVzLCAnJGtleScsIGtleSk7CiAgZGVmKHJlcywgJyRoYXNOb3JtYWwnLCBoYXNOb3JtYWxTbG90cyk7CiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbm9ybWFsaXplU2NvcGVkU2xvdChub3JtYWxTbG90cywga2V5LCBmbikgewogIHZhciBub3JtYWxpemVkID0gZnVuY3Rpb24gbm9ybWFsaXplZCgpIHsKICAgIHZhciByZXMgPSBhcmd1bWVudHMubGVuZ3RoID8gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKSA6IGZuKHt9KTsKICAgIHJlcyA9IHJlcyAmJiBfdHlwZW9mKHJlcykgPT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHJlcykgPyBbcmVzXSAvLyBzaW5nbGUgdm5vZGUKICAgIDogbm9ybWFsaXplQ2hpbGRyZW4ocmVzKTsKICAgIHJldHVybiByZXMgJiYgKHJlcy5sZW5ndGggPT09IDAgfHwgcmVzLmxlbmd0aCA9PT0gMSAmJiByZXNbMF0uaXNDb21tZW50IC8vICM5NjU4CiAgICApID8gdW5kZWZpbmVkIDogcmVzOwogIH07IC8vIHRoaXMgaXMgYSBzbG90IHVzaW5nIHRoZSBuZXcgdi1zbG90IHN5bnRheCB3aXRob3V0IHNjb3BlLiBhbHRob3VnaCBpdCBpcwogIC8vIGNvbXBpbGVkIGFzIGEgc2NvcGVkIHNsb3QsIHJlbmRlciBmbiB1c2VycyB3b3VsZCBleHBlY3QgaXQgdG8gYmUgcHJlc2VudAogIC8vIG9uIHRoaXMuJHNsb3RzIGJlY2F1c2UgdGhlIHVzYWdlIGlzIHNlbWFudGljYWxseSBhIG5vcm1hbCBzbG90LgoKCiAgaWYgKGZuLnByb3h5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9ybWFsU2xvdHMsIGtleSwgewogICAgICBnZXQ6IG5vcm1hbGl6ZWQsCiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CiAgfQoKICByZXR1cm4gbm9ybWFsaXplZDsKfQoKZnVuY3Rpb24gcHJveHlOb3JtYWxTbG90KHNsb3RzLCBrZXkpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHNsb3RzW2tleV07CiAgfTsKfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHYtZm9yIGxpc3RzLgogKi8KCgpmdW5jdGlvbiByZW5kZXJMaXN0KHZhbCwgcmVuZGVyKSB7CiAgdmFyIHJldCwgaSwgbCwga2V5cywga2V5OwoKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpIHx8IHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICByZXQgPSBuZXcgQXJyYXkodmFsLmxlbmd0aCk7CgogICAgZm9yIChpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcmV0W2ldID0gcmVuZGVyKHZhbFtpXSwgaSk7CiAgICB9CiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgcmV0ID0gbmV3IEFycmF5KHZhbCk7CgogICAgZm9yIChpID0gMDsgaSA8IHZhbDsgaSsrKSB7CiAgICAgIHJldFtpXSA9IHJlbmRlcihpICsgMSwgaSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdCh2YWwpKSB7CiAgICBpZiAoaGFzU3ltYm9sICYmIHZhbFtTeW1ib2wuaXRlcmF0b3JdKSB7CiAgICAgIHJldCA9IFtdOwogICAgICB2YXIgaXRlcmF0b3IgPSB2YWxbU3ltYm9sLml0ZXJhdG9yXSgpOwogICAgICB2YXIgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwoKICAgICAgd2hpbGUgKCFyZXN1bHQuZG9uZSkgewogICAgICAgIHJldC5wdXNoKHJlbmRlcihyZXN1bHQudmFsdWUsIHJldC5sZW5ndGgpKTsKICAgICAgICByZXN1bHQgPSBpdGVyYXRvci5uZXh0KCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICByZXQgPSBuZXcgQXJyYXkoa2V5cy5sZW5ndGgpOwoKICAgICAgZm9yIChpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgICByZXRbaV0gPSByZW5kZXIodmFsW2tleV0sIGtleSwgaSk7CiAgICAgIH0KICAgIH0KICB9CgogIGlmICghaXNEZWYocmV0KSkgewogICAgcmV0ID0gW107CiAgfQoKICByZXQuX2lzVkxpc3QgPSB0cnVlOwogIHJldHVybiByZXQ7Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyA8c2xvdD4KICovCgoKZnVuY3Rpb24gcmVuZGVyU2xvdChuYW1lLCBmYWxsYmFjaywgcHJvcHMsIGJpbmRPYmplY3QpIHsKICB2YXIgc2NvcGVkU2xvdEZuID0gdGhpcy4kc2NvcGVkU2xvdHNbbmFtZV07CiAgdmFyIG5vZGVzOwoKICBpZiAoc2NvcGVkU2xvdEZuKSB7CiAgICAvLyBzY29wZWQgc2xvdAogICAgcHJvcHMgPSBwcm9wcyB8fCB7fTsKCiAgICBpZiAoYmluZE9iamVjdCkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhaXNPYmplY3QoYmluZE9iamVjdCkpIHsKICAgICAgICB3YXJuKCdzbG90IHYtYmluZCB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0JywgdGhpcyk7CiAgICAgIH0KCiAgICAgIHByb3BzID0gZXh0ZW5kKGV4dGVuZCh7fSwgYmluZE9iamVjdCksIHByb3BzKTsKICAgIH0KCiAgICBub2RlcyA9IHNjb3BlZFNsb3RGbihwcm9wcykgfHwgZmFsbGJhY2s7CiAgfSBlbHNlIHsKICAgIG5vZGVzID0gdGhpcy4kc2xvdHNbbmFtZV0gfHwgZmFsbGJhY2s7CiAgfQoKICB2YXIgdGFyZ2V0ID0gcHJvcHMgJiYgcHJvcHMuc2xvdDsKCiAgaWYgKHRhcmdldCkgewogICAgcmV0dXJuIHRoaXMuJGNyZWF0ZUVsZW1lbnQoJ3RlbXBsYXRlJywgewogICAgICBzbG90OiB0YXJnZXQKICAgIH0sIG5vZGVzKTsKICB9IGVsc2UgewogICAgcmV0dXJuIG5vZGVzOwogIH0KfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIGZpbHRlcnMKICovCgoKZnVuY3Rpb24gcmVzb2x2ZUZpbHRlcihpZCkgewogIHJldHVybiByZXNvbHZlQXNzZXQodGhpcy4kb3B0aW9ucywgJ2ZpbHRlcnMnLCBpZCwgdHJ1ZSkgfHwgaWRlbnRpdHk7Cn0KLyogICovCgoKZnVuY3Rpb24gaXNLZXlOb3RNYXRjaChleHBlY3QsIGFjdHVhbCkgewogIGlmIChBcnJheS5pc0FycmF5KGV4cGVjdCkpIHsKICAgIHJldHVybiBleHBlY3QuaW5kZXhPZihhY3R1YWwpID09PSAtMTsKICB9IGVsc2UgewogICAgcmV0dXJuIGV4cGVjdCAhPT0gYWN0dWFsOwogIH0KfQovKioKICogUnVudGltZSBoZWxwZXIgZm9yIGNoZWNraW5nIGtleUNvZGVzIGZyb20gY29uZmlnLgogKiBleHBvc2VkIGFzIFZ1ZS5wcm90b3R5cGUuX2sKICogcGFzc2luZyBpbiBldmVudEtleU5hbWUgYXMgbGFzdCBhcmd1bWVudCBzZXBhcmF0ZWx5IGZvciBiYWNrd2FyZHMgY29tcGF0CiAqLwoKCmZ1bmN0aW9uIGNoZWNrS2V5Q29kZXMoZXZlbnRLZXlDb2RlLCBrZXksIGJ1aWx0SW5LZXlDb2RlLCBldmVudEtleU5hbWUsIGJ1aWx0SW5LZXlOYW1lKSB7CiAgdmFyIG1hcHBlZEtleUNvZGUgPSBjb25maWcua2V5Q29kZXNba2V5XSB8fCBidWlsdEluS2V5Q29kZTsKCiAgaWYgKGJ1aWx0SW5LZXlOYW1lICYmIGV2ZW50S2V5TmFtZSAmJiAhY29uZmlnLmtleUNvZGVzW2tleV0pIHsKICAgIHJldHVybiBpc0tleU5vdE1hdGNoKGJ1aWx0SW5LZXlOYW1lLCBldmVudEtleU5hbWUpOwogIH0gZWxzZSBpZiAobWFwcGVkS2V5Q29kZSkgewogICAgcmV0dXJuIGlzS2V5Tm90TWF0Y2gobWFwcGVkS2V5Q29kZSwgZXZlbnRLZXlDb2RlKTsKICB9IGVsc2UgaWYgKGV2ZW50S2V5TmFtZSkgewogICAgcmV0dXJuIGh5cGhlbmF0ZShldmVudEtleU5hbWUpICE9PSBrZXk7CiAgfQp9Ci8qICAqLwoKLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciBtZXJnaW5nIHYtYmluZD0ib2JqZWN0IiBpbnRvIGEgVk5vZGUncyBkYXRhLgogKi8KCgpmdW5jdGlvbiBiaW5kT2JqZWN0UHJvcHMoZGF0YSwgdGFnLCB2YWx1ZSwgYXNQcm9wLCBpc1N5bmMpIHsKICBpZiAodmFsdWUpIHsKICAgIGlmICghaXNPYmplY3QodmFsdWUpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2Fybigndi1iaW5kIHdpdGhvdXQgYXJndW1lbnQgZXhwZWN0cyBhbiBPYmplY3Qgb3IgQXJyYXkgdmFsdWUnLCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gdG9PYmplY3QodmFsdWUpOwogICAgICB9CgogICAgICB2YXIgaGFzaDsKCiAgICAgIHZhciBsb29wID0gZnVuY3Rpb24gbG9vcChrZXkpIHsKICAgICAgICBpZiAoa2V5ID09PSAnY2xhc3MnIHx8IGtleSA9PT0gJ3N0eWxlJyB8fCBpc1Jlc2VydmVkQXR0cmlidXRlKGtleSkpIHsKICAgICAgICAgIGhhc2ggPSBkYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGRhdGEuYXR0cnMgJiYgZGF0YS5hdHRycy50eXBlOwogICAgICAgICAgaGFzaCA9IGFzUHJvcCB8fCBjb25maWcubXVzdFVzZVByb3AodGFnLCB0eXBlLCBrZXkpID8gZGF0YS5kb21Qcm9wcyB8fCAoZGF0YS5kb21Qcm9wcyA9IHt9KSA6IGRhdGEuYXR0cnMgfHwgKGRhdGEuYXR0cnMgPSB7fSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2FtZWxpemVkS2V5ID0gY2FtZWxpemUoa2V5KTsKICAgICAgICB2YXIgaHlwaGVuYXRlZEtleSA9IGh5cGhlbmF0ZShrZXkpOwoKICAgICAgICBpZiAoIShjYW1lbGl6ZWRLZXkgaW4gaGFzaCkgJiYgIShoeXBoZW5hdGVkS2V5IGluIGhhc2gpKSB7CiAgICAgICAgICBoYXNoW2tleV0gPSB2YWx1ZVtrZXldOwoKICAgICAgICAgIGlmIChpc1N5bmMpIHsKICAgICAgICAgICAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKCiAgICAgICAgICAgIG9uWyJ1cGRhdGU6IiArIGtleV0gPSBmdW5jdGlvbiAoJGV2ZW50KSB7CiAgICAgICAgICAgICAgdmFsdWVba2V5XSA9ICRldmVudDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgICBsb29wKGtleSk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBkYXRhOwp9Ci8qICAqLwoKLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZW5kZXJpbmcgc3RhdGljIHRyZWVzLgogKi8KCgpmdW5jdGlvbiByZW5kZXJTdGF0aWMoaW5kZXgsIGlzSW5Gb3IpIHsKICB2YXIgY2FjaGVkID0gdGhpcy5fc3RhdGljVHJlZXMgfHwgKHRoaXMuX3N0YXRpY1RyZWVzID0gW10pOwogIHZhciB0cmVlID0gY2FjaGVkW2luZGV4XTsgLy8gaWYgaGFzIGFscmVhZHktcmVuZGVyZWQgc3RhdGljIHRyZWUgYW5kIG5vdCBpbnNpZGUgdi1mb3IsCiAgLy8gd2UgY2FuIHJldXNlIHRoZSBzYW1lIHRyZWUuCgogIGlmICh0cmVlICYmICFpc0luRm9yKSB7CiAgICByZXR1cm4gdHJlZTsKICB9IC8vIG90aGVyd2lzZSwgcmVuZGVyIGEgZnJlc2ggdHJlZS4KCgogIHRyZWUgPSBjYWNoZWRbaW5kZXhdID0gdGhpcy4kb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnNbaW5kZXhdLmNhbGwodGhpcy5fcmVuZGVyUHJveHksIG51bGwsIHRoaXMgLy8gZm9yIHJlbmRlciBmbnMgZ2VuZXJhdGVkIGZvciBmdW5jdGlvbmFsIGNvbXBvbmVudCB0ZW1wbGF0ZXMKICApOwogIG1hcmtTdGF0aWModHJlZSwgIl9fc3RhdGljX18iICsgaW5kZXgsIGZhbHNlKTsKICByZXR1cm4gdHJlZTsKfQovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHYtb25jZS4KICogRWZmZWN0aXZlbHkgaXQgbWVhbnMgbWFya2luZyB0aGUgbm9kZSBhcyBzdGF0aWMgd2l0aCBhIHVuaXF1ZSBrZXkuCiAqLwoKCmZ1bmN0aW9uIG1hcmtPbmNlKHRyZWUsIGluZGV4LCBrZXkpIHsKICBtYXJrU3RhdGljKHRyZWUsICJfX29uY2VfXyIgKyBpbmRleCArIChrZXkgPyAiXyIgKyBrZXkgOiAiIiksIHRydWUpOwogIHJldHVybiB0cmVlOwp9CgpmdW5jdGlvbiBtYXJrU3RhdGljKHRyZWUsIGtleSwgaXNPbmNlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodHJlZSkpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJlZS5sZW5ndGg7IGkrKykgewogICAgICBpZiAodHJlZVtpXSAmJiB0eXBlb2YgdHJlZVtpXSAhPT0gJ3N0cmluZycpIHsKICAgICAgICBtYXJrU3RhdGljTm9kZSh0cmVlW2ldLCBrZXkgKyAiXyIgKyBpLCBpc09uY2UpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIG1hcmtTdGF0aWNOb2RlKHRyZWUsIGtleSwgaXNPbmNlKTsKICB9Cn0KCmZ1bmN0aW9uIG1hcmtTdGF0aWNOb2RlKG5vZGUsIGtleSwgaXNPbmNlKSB7CiAgbm9kZS5pc1N0YXRpYyA9IHRydWU7CiAgbm9kZS5rZXkgPSBrZXk7CiAgbm9kZS5pc09uY2UgPSBpc09uY2U7Cn0KLyogICovCgoKZnVuY3Rpb24gYmluZE9iamVjdExpc3RlbmVycyhkYXRhLCB2YWx1ZSkgewogIGlmICh2YWx1ZSkgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ3Ytb24gd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCB2YWx1ZScsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9uID0gZGF0YS5vbiA9IGRhdGEub24gPyBleHRlbmQoe30sIGRhdGEub24pIDoge307CgogICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgICAgICB2YXIgZXhpc3RpbmcgPSBvbltrZXldOwogICAgICAgIHZhciBvdXJzID0gdmFsdWVba2V5XTsKICAgICAgICBvbltrZXldID0gZXhpc3RpbmcgPyBbXS5jb25jYXQoZXhpc3RpbmcsIG91cnMpIDogb3VyczsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIGRhdGE7Cn0KLyogICovCgoKZnVuY3Rpb24gcmVzb2x2ZVNjb3BlZFNsb3RzKGZucywgLy8gc2VlIGZsb3cvdm5vZGUKcmVzLCAvLyB0aGUgZm9sbG93aW5nIGFyZSBhZGRlZCBpbiAyLjYKaGFzRHluYW1pY0tleXMsIGNvbnRlbnRIYXNoS2V5KSB7CiAgcmVzID0gcmVzIHx8IHsKICAgICRzdGFibGU6ICFoYXNEeW5hbWljS2V5cwogIH07CgogIGZvciAodmFyIGkgPSAwOyBpIDwgZm5zLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgc2xvdCA9IGZuc1tpXTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShzbG90KSkgewogICAgICByZXNvbHZlU2NvcGVkU2xvdHMoc2xvdCwgcmVzLCBoYXNEeW5hbWljS2V5cyk7CiAgICB9IGVsc2UgaWYgKHNsb3QpIHsKICAgICAgLy8gbWFya2VyIGZvciByZXZlcnNlIHByb3h5aW5nIHYtc2xvdCB3aXRob3V0IHNjb3BlIG9uIHRoaXMuJHNsb3RzCiAgICAgIGlmIChzbG90LnByb3h5KSB7CiAgICAgICAgc2xvdC5mbi5wcm94eSA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJlc1tzbG90LmtleV0gPSBzbG90LmZuOwogICAgfQogIH0KCiAgaWYgKGNvbnRlbnRIYXNoS2V5KSB7CiAgICByZXMuJGtleSA9IGNvbnRlbnRIYXNoS2V5OwogIH0KCiAgcmV0dXJuIHJlczsKfQovKiAgKi8KCgpmdW5jdGlvbiBiaW5kRHluYW1pY0tleXMoYmFzZU9iaiwgdmFsdWVzKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgIHZhciBrZXkgPSB2YWx1ZXNbaV07CgogICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmIGtleSkgewogICAgICBiYXNlT2JqW3ZhbHVlc1tpXV0gPSB2YWx1ZXNbaSArIDFdOwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGtleSAhPT0gJycgJiYga2V5ICE9PSBudWxsKSB7CiAgICAgIC8vIG51bGwgaXMgYSBzcGVpY2FsIHZhbHVlIGZvciBleHBsaWNpdGx5IHJlbW92aW5nIGEgYmluZGluZwogICAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBkeW5hbWljIGRpcmVjdGl2ZSBhcmd1bWVudCAoZXhwZWN0ZWQgc3RyaW5nIG9yIG51bGwpOiAiICsga2V5LCB0aGlzKTsKICAgIH0KICB9CgogIHJldHVybiBiYXNlT2JqOwp9IC8vIGhlbHBlciB0byBkeW5hbWljYWxseSBhcHBlbmQgbW9kaWZpZXIgcnVudGltZSBtYXJrZXJzIHRvIGV2ZW50IG5hbWVzLgovLyBlbnN1cmUgb25seSBhcHBlbmQgd2hlbiB2YWx1ZSBpcyBhbHJlYWR5IHN0cmluZywgb3RoZXJ3aXNlIGl0IHdpbGwgYmUgY2FzdAovLyB0byBzdHJpbmcgYW5kIGNhdXNlIHRoZSB0eXBlIGNoZWNrIHRvIG1pc3MuCgoKZnVuY3Rpb24gcHJlcGVuZE1vZGlmaWVyKHZhbHVlLCBzeW1ib2wpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHN5bWJvbCArIHZhbHVlIDogdmFsdWU7Cn0KLyogICovCgoKZnVuY3Rpb24gaW5zdGFsbFJlbmRlckhlbHBlcnModGFyZ2V0KSB7CiAgdGFyZ2V0Ll9vID0gbWFya09uY2U7CiAgdGFyZ2V0Ll9uID0gdG9OdW1iZXI7CiAgdGFyZ2V0Ll9zID0gdG9TdHJpbmc7CiAgdGFyZ2V0Ll9sID0gcmVuZGVyTGlzdDsKICB0YXJnZXQuX3QgPSByZW5kZXJTbG90OwogIHRhcmdldC5fcSA9IGxvb3NlRXF1YWw7CiAgdGFyZ2V0Ll9pID0gbG9vc2VJbmRleE9mOwogIHRhcmdldC5fbSA9IHJlbmRlclN0YXRpYzsKICB0YXJnZXQuX2YgPSByZXNvbHZlRmlsdGVyOwogIHRhcmdldC5fayA9IGNoZWNrS2V5Q29kZXM7CiAgdGFyZ2V0Ll9iID0gYmluZE9iamVjdFByb3BzOwogIHRhcmdldC5fdiA9IGNyZWF0ZVRleHRWTm9kZTsKICB0YXJnZXQuX2UgPSBjcmVhdGVFbXB0eVZOb2RlOwogIHRhcmdldC5fdSA9IHJlc29sdmVTY29wZWRTbG90czsKICB0YXJnZXQuX2cgPSBiaW5kT2JqZWN0TGlzdGVuZXJzOwogIHRhcmdldC5fZCA9IGJpbmREeW5hbWljS2V5czsKICB0YXJnZXQuX3AgPSBwcmVwZW5kTW9kaWZpZXI7Cn0KLyogICovCgoKZnVuY3Rpb24gRnVuY3Rpb25hbFJlbmRlckNvbnRleHQoZGF0YSwgcHJvcHMsIGNoaWxkcmVuLCBwYXJlbnQsIEN0b3IpIHsKICB2YXIgdGhpcyQxID0gdGhpczsKICB2YXIgb3B0aW9ucyA9IEN0b3Iub3B0aW9uczsgLy8gZW5zdXJlIHRoZSBjcmVhdGVFbGVtZW50IGZ1bmN0aW9uIGluIGZ1bmN0aW9uYWwgY29tcG9uZW50cwogIC8vIGdldHMgYSB1bmlxdWUgY29udGV4dCAtIHRoaXMgaXMgbmVjZXNzYXJ5IGZvciBjb3JyZWN0IG5hbWVkIHNsb3QgY2hlY2sKCiAgdmFyIGNvbnRleHRWbTsKCiAgaWYgKGhhc093bihwYXJlbnQsICdfdWlkJykpIHsKICAgIGNvbnRleHRWbSA9IE9iamVjdC5jcmVhdGUocGFyZW50KTsgLy8gJGZsb3ctZGlzYWJsZS1saW5lCgogICAgY29udGV4dFZtLl9vcmlnaW5hbCA9IHBhcmVudDsKICB9IGVsc2UgewogICAgLy8gdGhlIGNvbnRleHQgdm0gcGFzc2VkIGluIGlzIGEgZnVuY3Rpb25hbCBjb250ZXh0IGFzIHdlbGwuCiAgICAvLyBpbiB0aGlzIGNhc2Ugd2Ugd2FudCB0byBtYWtlIHN1cmUgd2UgYXJlIGFibGUgdG8gZ2V0IGEgaG9sZCB0byB0aGUKICAgIC8vIHJlYWwgY29udGV4dCBpbnN0YW5jZS4KICAgIGNvbnRleHRWbSA9IHBhcmVudDsgLy8gJGZsb3ctZGlzYWJsZS1saW5lCgogICAgcGFyZW50ID0gcGFyZW50Ll9vcmlnaW5hbDsKICB9CgogIHZhciBpc0NvbXBpbGVkID0gaXNUcnVlKG9wdGlvbnMuX2NvbXBpbGVkKTsKICB2YXIgbmVlZE5vcm1hbGl6YXRpb24gPSAhaXNDb21waWxlZDsKICB0aGlzLmRhdGEgPSBkYXRhOwogIHRoaXMucHJvcHMgPSBwcm9wczsKICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgdGhpcy5saXN0ZW5lcnMgPSBkYXRhLm9uIHx8IGVtcHR5T2JqZWN0OwogIHRoaXMuaW5qZWN0aW9ucyA9IHJlc29sdmVJbmplY3Qob3B0aW9ucy5pbmplY3QsIHBhcmVudCk7CgogIHRoaXMuc2xvdHMgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMkMS4kc2xvdHMpIHsKICAgICAgbm9ybWFsaXplU2NvcGVkU2xvdHMoZGF0YS5zY29wZWRTbG90cywgdGhpcyQxLiRzbG90cyA9IHJlc29sdmVTbG90cyhjaGlsZHJlbiwgcGFyZW50KSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMkMS4kc2xvdHM7CiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdzY29wZWRTbG90cycsIHsKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMuc2xvdHMoKSk7CiAgICB9CiAgfSk7IC8vIHN1cHBvcnQgZm9yIGNvbXBpbGVkIGZ1bmN0aW9uYWwgdGVtcGxhdGUKCiAgaWYgKGlzQ29tcGlsZWQpIHsKICAgIC8vIGV4cG9zaW5nICRvcHRpb25zIGZvciByZW5kZXJTdGF0aWMoKQogICAgdGhpcy4kb3B0aW9ucyA9IG9wdGlvbnM7IC8vIHByZS1yZXNvbHZlIHNsb3RzIGZvciByZW5kZXJTbG90KCkKCiAgICB0aGlzLiRzbG90cyA9IHRoaXMuc2xvdHMoKTsKICAgIHRoaXMuJHNjb3BlZFNsb3RzID0gbm9ybWFsaXplU2NvcGVkU2xvdHMoZGF0YS5zY29wZWRTbG90cywgdGhpcy4kc2xvdHMpOwogIH0KCiAgaWYgKG9wdGlvbnMuX3Njb3BlSWQpIHsKICAgIHRoaXMuX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgICB2YXIgdm5vZGUgPSBjcmVhdGVFbGVtZW50KGNvbnRleHRWbSwgYSwgYiwgYywgZCwgbmVlZE5vcm1hbGl6YXRpb24pOwoKICAgICAgaWYgKHZub2RlICYmICFBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgICAgIHZub2RlLmZuU2NvcGVJZCA9IG9wdGlvbnMuX3Njb3BlSWQ7CiAgICAgICAgdm5vZGUuZm5Db250ZXh0ID0gcGFyZW50OwogICAgICB9CgogICAgICByZXR1cm4gdm5vZGU7CiAgICB9OwogIH0gZWxzZSB7CiAgICB0aGlzLl9jID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQoY29udGV4dFZtLCBhLCBiLCBjLCBkLCBuZWVkTm9ybWFsaXphdGlvbik7CiAgICB9OwogIH0KfQoKaW5zdGFsbFJlbmRlckhlbHBlcnMoRnVuY3Rpb25hbFJlbmRlckNvbnRleHQucHJvdG90eXBlKTsKCmZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0Vm0sIGNoaWxkcmVuKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgdmFyIHByb3BzID0ge307CiAgdmFyIHByb3BPcHRpb25zID0gb3B0aW9ucy5wcm9wczsKCiAgaWYgKGlzRGVmKHByb3BPcHRpb25zKSkgewogICAgZm9yICh2YXIga2V5IGluIHByb3BPcHRpb25zKSB7CiAgICAgIHByb3BzW2tleV0gPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhIHx8IGVtcHR5T2JqZWN0KTsKICAgIH0KICB9IGVsc2UgewogICAgaWYgKGlzRGVmKGRhdGEuYXR0cnMpKSB7CiAgICAgIG1lcmdlUHJvcHMocHJvcHMsIGRhdGEuYXR0cnMpOwogICAgfQoKICAgIGlmIChpc0RlZihkYXRhLnByb3BzKSkgewogICAgICBtZXJnZVByb3BzKHByb3BzLCBkYXRhLnByb3BzKTsKICAgIH0KICB9CgogIHZhciByZW5kZXJDb250ZXh0ID0gbmV3IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0KGRhdGEsIHByb3BzLCBjaGlsZHJlbiwgY29udGV4dFZtLCBDdG9yKTsKICB2YXIgdm5vZGUgPSBvcHRpb25zLnJlbmRlci5jYWxsKG51bGwsIHJlbmRlckNvbnRleHQuX2MsIHJlbmRlckNvbnRleHQpOwoKICBpZiAodm5vZGUgaW5zdGFuY2VvZiBWTm9kZSkgewogICAgcmV0dXJuIGNsb25lQW5kTWFya0Z1bmN0aW9uYWxSZXN1bHQodm5vZGUsIGRhdGEsIHJlbmRlckNvbnRleHQucGFyZW50LCBvcHRpb25zLCByZW5kZXJDb250ZXh0KTsKICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICB2YXIgdm5vZGVzID0gbm9ybWFsaXplQ2hpbGRyZW4odm5vZGUpIHx8IFtdOwogICAgdmFyIHJlcyA9IG5ldyBBcnJheSh2bm9kZXMubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICByZXNbaV0gPSBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2Rlc1tpXSwgZGF0YSwgcmVuZGVyQ29udGV4dC5wYXJlbnQsIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpOwogICAgfQoKICAgIHJldHVybiByZXM7CiAgfQp9CgpmdW5jdGlvbiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCBjb250ZXh0Vm0sIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpIHsKICAvLyAjNzgxNyBjbG9uZSBub2RlIGJlZm9yZSBzZXR0aW5nIGZuQ29udGV4dCwgb3RoZXJ3aXNlIGlmIHRoZSBub2RlIGlzIHJldXNlZAogIC8vIChlLmcuIGl0IHdhcyBmcm9tIGEgY2FjaGVkIG5vcm1hbCBzbG90KSB0aGUgZm5Db250ZXh0IGNhdXNlcyBuYW1lZCBzbG90cwogIC8vIHRoYXQgc2hvdWxkIG5vdCBiZSBtYXRjaGVkIHRvIG1hdGNoLgogIHZhciBjbG9uZSA9IGNsb25lVk5vZGUodm5vZGUpOwogIGNsb25lLmZuQ29udGV4dCA9IGNvbnRleHRWbTsKICBjbG9uZS5mbk9wdGlvbnMgPSBvcHRpb25zOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgKGNsb25lLmRldnRvb2xzTWV0YSA9IGNsb25lLmRldnRvb2xzTWV0YSB8fCB7fSkucmVuZGVyQ29udGV4dCA9IHJlbmRlckNvbnRleHQ7CiAgfQoKICBpZiAoZGF0YS5zbG90KSB7CiAgICAoY2xvbmUuZGF0YSB8fCAoY2xvbmUuZGF0YSA9IHt9KSkuc2xvdCA9IGRhdGEuc2xvdDsKICB9CgogIHJldHVybiBjbG9uZTsKfQoKZnVuY3Rpb24gbWVyZ2VQcm9wcyh0bywgZnJvbSkgewogIGZvciAodmFyIGtleSBpbiBmcm9tKSB7CiAgICB0b1tjYW1lbGl6ZShrZXkpXSA9IGZyb21ba2V5XTsKICB9Cn0KLyogICovCgovKiAgKi8KCi8qICAqLwoKLyogICovCi8vIGlubGluZSBob29rcyB0byBiZSBpbnZva2VkIG9uIGNvbXBvbmVudCBWTm9kZXMgZHVyaW5nIHBhdGNoCgoKdmFyIGNvbXBvbmVudFZOb2RlSG9va3MgPSB7CiAgaW5pdDogZnVuY3Rpb24gaW5pdCh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICBpZiAodm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgIXZub2RlLmNvbXBvbmVudEluc3RhbmNlLl9pc0Rlc3Ryb3llZCAmJiB2bm9kZS5kYXRhLmtlZXBBbGl2ZSkgewogICAgICAvLyBrZXB0LWFsaXZlIGNvbXBvbmVudHMsIHRyZWF0IGFzIGEgcGF0Y2gKICAgICAgdmFyIG1vdW50ZWROb2RlID0gdm5vZGU7IC8vIHdvcmsgYXJvdW5kIGZsb3cKCiAgICAgIGNvbXBvbmVudFZOb2RlSG9va3MucHJlcGF0Y2gobW91bnRlZE5vZGUsIG1vdW50ZWROb2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gY3JlYXRlQ29tcG9uZW50SW5zdGFuY2VGb3JWbm9kZSh2bm9kZSwgYWN0aXZlSW5zdGFuY2UpOwogICAgICBjaGlsZC4kbW91bnQoaHlkcmF0aW5nID8gdm5vZGUuZWxtIDogdW5kZWZpbmVkLCBoeWRyYXRpbmcpOwogICAgfQogIH0sCiAgcHJlcGF0Y2g6IGZ1bmN0aW9uIHByZXBhdGNoKG9sZFZub2RlLCB2bm9kZSkgewogICAgdmFyIG9wdGlvbnMgPSB2bm9kZS5jb21wb25lbnRPcHRpb25zOwogICAgdmFyIGNoaWxkID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBvbGRWbm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgIHVwZGF0ZUNoaWxkQ29tcG9uZW50KGNoaWxkLCBvcHRpb25zLnByb3BzRGF0YSwgLy8gdXBkYXRlZCBwcm9wcwogICAgb3B0aW9ucy5saXN0ZW5lcnMsIC8vIHVwZGF0ZWQgbGlzdGVuZXJzCiAgICB2bm9kZSwgLy8gbmV3IHBhcmVudCB2bm9kZQogICAgb3B0aW9ucy5jaGlsZHJlbiAvLyBuZXcgY2hpbGRyZW4KICAgICk7CiAgfSwKICBpbnNlcnQ6IGZ1bmN0aW9uIGluc2VydCh2bm9kZSkgewogICAgdmFyIGNvbnRleHQgPSB2bm9kZS5jb250ZXh0OwogICAgdmFyIGNvbXBvbmVudEluc3RhbmNlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CgogICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkKSB7CiAgICAgIGNvbXBvbmVudEluc3RhbmNlLl9pc01vdW50ZWQgPSB0cnVlOwogICAgICBjYWxsSG9vayhjb21wb25lbnRJbnN0YW5jZSwgJ21vdW50ZWQnKTsKICAgIH0KCiAgICBpZiAodm5vZGUuZGF0YS5rZWVwQWxpdmUpIHsKICAgICAgaWYgKGNvbnRleHQuX2lzTW91bnRlZCkgewogICAgICAgIC8vIHZ1ZS1yb3V0ZXIjMTIxMgogICAgICAgIC8vIER1cmluZyB1cGRhdGVzLCBhIGtlcHQtYWxpdmUgY29tcG9uZW50J3MgY2hpbGQgY29tcG9uZW50cyBtYXkKICAgICAgICAvLyBjaGFuZ2UsIHNvIGRpcmVjdGx5IHdhbGtpbmcgdGhlIHRyZWUgaGVyZSBtYXkgY2FsbCBhY3RpdmF0ZWQgaG9va3MKICAgICAgICAvLyBvbiBpbmNvcnJlY3QgY2hpbGRyZW4uIEluc3RlYWQgd2UgcHVzaCB0aGVtIGludG8gYSBxdWV1ZSB3aGljaCB3aWxsCiAgICAgICAgLy8gYmUgcHJvY2Vzc2VkIGFmdGVyIHRoZSB3aG9sZSBwYXRjaCBwcm9jZXNzIGVuZGVkLgogICAgICAgIHF1ZXVlQWN0aXZhdGVkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlLCB0cnVlCiAgICAgICAgLyogZGlyZWN0ICovCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0sCiAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSh2bm9kZSkgewogICAgdmFyIGNvbXBvbmVudEluc3RhbmNlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CgogICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNEZXN0cm95ZWQpIHsKICAgICAgaWYgKCF2bm9kZS5kYXRhLmtlZXBBbGl2ZSkgewogICAgICAgIGNvbXBvbmVudEluc3RhbmNlLiRkZXN0cm95KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlLCB0cnVlCiAgICAgICAgLyogZGlyZWN0ICovCiAgICAgICAgKTsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIGhvb2tzVG9NZXJnZSA9IE9iamVjdC5rZXlzKGNvbXBvbmVudFZOb2RlSG9va3MpOwoKZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpIHsKICBpZiAoaXNVbmRlZihDdG9yKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGJhc2VDdG9yID0gY29udGV4dC4kb3B0aW9ucy5fYmFzZTsgLy8gcGxhaW4gb3B0aW9ucyBvYmplY3Q6IHR1cm4gaXQgaW50byBhIGNvbnN0cnVjdG9yCgogIGlmIChpc09iamVjdChDdG9yKSkgewogICAgQ3RvciA9IGJhc2VDdG9yLmV4dGVuZChDdG9yKTsKICB9IC8vIGlmIGF0IHRoaXMgc3RhZ2UgaXQncyBub3QgYSBjb25zdHJ1Y3RvciBvciBhbiBhc3luYyBjb21wb25lbnQgZmFjdG9yeSwKICAvLyByZWplY3QuCgoKICBpZiAodHlwZW9mIEN0b3IgIT09ICdmdW5jdGlvbicpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oIkludmFsaWQgQ29tcG9uZW50IGRlZmluaXRpb246ICIgKyBTdHJpbmcoQ3RvciksIGNvbnRleHQpOwogICAgfQoKICAgIHJldHVybjsKICB9IC8vIGFzeW5jIGNvbXBvbmVudAoKCiAgdmFyIGFzeW5jRmFjdG9yeTsKCiAgaWYgKGlzVW5kZWYoQ3Rvci5jaWQpKSB7CiAgICBhc3luY0ZhY3RvcnkgPSBDdG9yOwogICAgQ3RvciA9IHJlc29sdmVBc3luY0NvbXBvbmVudChhc3luY0ZhY3RvcnksIGJhc2VDdG9yKTsKCiAgICBpZiAoQ3RvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIHJldHVybiBhIHBsYWNlaG9sZGVyIG5vZGUgZm9yIGFzeW5jIGNvbXBvbmVudCwgd2hpY2ggaXMgcmVuZGVyZWQKICAgICAgLy8gYXMgYSBjb21tZW50IG5vZGUgYnV0IHByZXNlcnZlcyBhbGwgdGhlIHJhdyBpbmZvcm1hdGlvbiBmb3IgdGhlIG5vZGUuCiAgICAgIC8vIHRoZSBpbmZvcm1hdGlvbiB3aWxsIGJlIHVzZWQgZm9yIGFzeW5jIHNlcnZlci1yZW5kZXJpbmcgYW5kIGh5ZHJhdGlvbi4KICAgICAgcmV0dXJuIGNyZWF0ZUFzeW5jUGxhY2Vob2xkZXIoYXN5bmNGYWN0b3J5LCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbiwgdGFnKTsKICAgIH0KICB9CgogIGRhdGEgPSBkYXRhIHx8IHt9OyAvLyByZXNvbHZlIGNvbnN0cnVjdG9yIG9wdGlvbnMgaW4gY2FzZSBnbG9iYWwgbWl4aW5zIGFyZSBhcHBsaWVkIGFmdGVyCiAgLy8gY29tcG9uZW50IGNvbnN0cnVjdG9yIGNyZWF0aW9uCgogIHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMoQ3Rvcik7IC8vIHRyYW5zZm9ybSBjb21wb25lbnQgdi1tb2RlbCBkYXRhIGludG8gcHJvcHMgJiBldmVudHMKCiAgaWYgKGlzRGVmKGRhdGEubW9kZWwpKSB7CiAgICB0cmFuc2Zvcm1Nb2RlbChDdG9yLm9wdGlvbnMsIGRhdGEpOwogIH0gLy8gZXh0cmFjdCBwcm9wcwoKCiAgdmFyIHByb3BzRGF0YSA9IGV4dHJhY3RQcm9wc0Zyb21WTm9kZURhdGEoZGF0YSwgQ3RvciwgdGFnKTsgLy8gZnVuY3Rpb25hbCBjb21wb25lbnQKCiAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnMuZnVuY3Rpb25hbCkpIHsKICAgIHJldHVybiBjcmVhdGVGdW5jdGlvbmFsQ29tcG9uZW50KEN0b3IsIHByb3BzRGF0YSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogIH0gLy8gZXh0cmFjdCBsaXN0ZW5lcnMsIHNpbmNlIHRoZXNlIG5lZWRzIHRvIGJlIHRyZWF0ZWQgYXMKICAvLyBjaGlsZCBjb21wb25lbnQgbGlzdGVuZXJzIGluc3RlYWQgb2YgRE9NIGxpc3RlbmVycwoKCiAgdmFyIGxpc3RlbmVycyA9IGRhdGEub247IC8vIHJlcGxhY2Ugd2l0aCBsaXN0ZW5lcnMgd2l0aCAubmF0aXZlIG1vZGlmaWVyCiAgLy8gc28gaXQgZ2V0cyBwcm9jZXNzZWQgZHVyaW5nIHBhcmVudCBjb21wb25lbnQgcGF0Y2guCgogIGRhdGEub24gPSBkYXRhLm5hdGl2ZU9uOwoKICBpZiAoaXNUcnVlKEN0b3Iub3B0aW9uc1siYWJzdHJhY3QiXSkpIHsKICAgIC8vIGFic3RyYWN0IGNvbXBvbmVudHMgZG8gbm90IGtlZXAgYW55dGhpbmcKICAgIC8vIG90aGVyIHRoYW4gcHJvcHMgJiBsaXN0ZW5lcnMgJiBzbG90CiAgICAvLyB3b3JrIGFyb3VuZCBmbG93CiAgICB2YXIgc2xvdCA9IGRhdGEuc2xvdDsKICAgIGRhdGEgPSB7fTsKCiAgICBpZiAoc2xvdCkgewogICAgICBkYXRhLnNsb3QgPSBzbG90OwogICAgfQogIH0gLy8gaW5zdGFsbCBjb21wb25lbnQgbWFuYWdlbWVudCBob29rcyBvbnRvIHRoZSBwbGFjZWhvbGRlciBub2RlCgoKICBpbnN0YWxsQ29tcG9uZW50SG9va3MoZGF0YSk7IC8vIHJldHVybiBhIHBsYWNlaG9sZGVyIHZub2RlCgogIHZhciBuYW1lID0gQ3Rvci5vcHRpb25zLm5hbWUgfHwgdGFnOwogIHZhciB2bm9kZSA9IG5ldyBWTm9kZSgidnVlLWNvbXBvbmVudC0iICsgQ3Rvci5jaWQgKyAobmFtZSA/ICItIiArIG5hbWUgOiAnJyksIGRhdGEsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQsIHsKICAgIEN0b3I6IEN0b3IsCiAgICBwcm9wc0RhdGE6IHByb3BzRGF0YSwKICAgIGxpc3RlbmVyczogbGlzdGVuZXJzLAogICAgdGFnOiB0YWcsCiAgICBjaGlsZHJlbjogY2hpbGRyZW4KICB9LCBhc3luY0ZhY3RvcnkpOwogIHJldHVybiB2bm9kZTsKfQoKZnVuY3Rpb24gY3JlYXRlQ29tcG9uZW50SW5zdGFuY2VGb3JWbm9kZSh2bm9kZSwgLy8gd2Uga25vdyBpdCdzIE1vdW50ZWRDb21wb25lbnRWTm9kZSBidXQgZmxvdyBkb2Vzbid0CnBhcmVudCAvLyBhY3RpdmVJbnN0YW5jZSBpbiBsaWZlY3ljbGUgc3RhdGUKKSB7CiAgdmFyIG9wdGlvbnMgPSB7CiAgICBfaXNDb21wb25lbnQ6IHRydWUsCiAgICBfcGFyZW50Vm5vZGU6IHZub2RlLAogICAgcGFyZW50OiBwYXJlbnQKICB9OyAvLyBjaGVjayBpbmxpbmUtdGVtcGxhdGUgcmVuZGVyIGZ1bmN0aW9ucwoKICB2YXIgaW5saW5lVGVtcGxhdGUgPSB2bm9kZS5kYXRhLmlubGluZVRlbXBsYXRlOwoKICBpZiAoaXNEZWYoaW5saW5lVGVtcGxhdGUpKSB7CiAgICBvcHRpb25zLnJlbmRlciA9IGlubGluZVRlbXBsYXRlLnJlbmRlcjsKICAgIG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zID0gaW5saW5lVGVtcGxhdGUuc3RhdGljUmVuZGVyRm5zOwogIH0KCiAgcmV0dXJuIG5ldyB2bm9kZS5jb21wb25lbnRPcHRpb25zLkN0b3Iob3B0aW9ucyk7Cn0KCmZ1bmN0aW9uIGluc3RhbGxDb21wb25lbnRIb29rcyhkYXRhKSB7CiAgdmFyIGhvb2tzID0gZGF0YS5ob29rIHx8IChkYXRhLmhvb2sgPSB7fSk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3NUb01lcmdlLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIga2V5ID0gaG9va3NUb01lcmdlW2ldOwogICAgdmFyIGV4aXN0aW5nID0gaG9va3Nba2V5XTsKICAgIHZhciB0b01lcmdlID0gY29tcG9uZW50Vk5vZGVIb29rc1trZXldOwoKICAgIGlmIChleGlzdGluZyAhPT0gdG9NZXJnZSAmJiAhKGV4aXN0aW5nICYmIGV4aXN0aW5nLl9tZXJnZWQpKSB7CiAgICAgIGhvb2tzW2tleV0gPSBleGlzdGluZyA/IG1lcmdlSG9vayQxKHRvTWVyZ2UsIGV4aXN0aW5nKSA6IHRvTWVyZ2U7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBtZXJnZUhvb2skMShmMSwgZjIpIHsKICB2YXIgbWVyZ2VkID0gZnVuY3Rpb24gbWVyZ2VkKGEsIGIpIHsKICAgIC8vIGZsb3cgY29tcGxhaW5zIGFib3V0IGV4dHJhIGFyZ3Mgd2hpY2ggaXMgd2h5IHdlIHVzZSBhbnkKICAgIGYxKGEsIGIpOwogICAgZjIoYSwgYik7CiAgfTsKCiAgbWVyZ2VkLl9tZXJnZWQgPSB0cnVlOwogIHJldHVybiBtZXJnZWQ7Cn0gLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGluZm8gKHZhbHVlIGFuZCBjYWxsYmFjaykgaW50bwovLyBwcm9wIGFuZCBldmVudCBoYW5kbGVyIHJlc3BlY3RpdmVseS4KCgpmdW5jdGlvbiB0cmFuc2Zvcm1Nb2RlbChvcHRpb25zLCBkYXRhKSB7CiAgdmFyIHByb3AgPSBvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwucHJvcCB8fCAndmFsdWUnOwogIHZhciBldmVudCA9IG9wdGlvbnMubW9kZWwgJiYgb3B0aW9ucy5tb2RlbC5ldmVudCB8fCAnaW5wdXQnOwogIChkYXRhLmF0dHJzIHx8IChkYXRhLmF0dHJzID0ge30pKVtwcm9wXSA9IGRhdGEubW9kZWwudmFsdWU7CiAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKICB2YXIgZXhpc3RpbmcgPSBvbltldmVudF07CiAgdmFyIGNhbGxiYWNrID0gZGF0YS5tb2RlbC5jYWxsYmFjazsKCiAgaWYgKGlzRGVmKGV4aXN0aW5nKSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZXhpc3RpbmcpID8gZXhpc3RpbmcuaW5kZXhPZihjYWxsYmFjaykgPT09IC0xIDogZXhpc3RpbmcgIT09IGNhbGxiYWNrKSB7CiAgICAgIG9uW2V2ZW50XSA9IFtjYWxsYmFja10uY29uY2F0KGV4aXN0aW5nKTsKICAgIH0KICB9IGVsc2UgewogICAgb25bZXZlbnRdID0gY2FsbGJhY2s7CiAgfQp9Ci8qICAqLwoKCnZhciBTSU1QTEVfTk9STUFMSVpFID0gMTsKdmFyIEFMV0FZU19OT1JNQUxJWkUgPSAyOyAvLyB3cmFwcGVyIGZ1bmN0aW9uIGZvciBwcm92aWRpbmcgYSBtb3JlIGZsZXhpYmxlIGludGVyZmFjZQovLyB3aXRob3V0IGdldHRpbmcgeWVsbGVkIGF0IGJ5IGZsb3cKCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUsIGFsd2F5c05vcm1hbGl6ZSkgewogIGlmIChBcnJheS5pc0FycmF5KGRhdGEpIHx8IGlzUHJpbWl0aXZlKGRhdGEpKSB7CiAgICBub3JtYWxpemF0aW9uVHlwZSA9IGNoaWxkcmVuOwogICAgY2hpbGRyZW4gPSBkYXRhOwogICAgZGF0YSA9IHVuZGVmaW5lZDsKICB9CgogIGlmIChpc1RydWUoYWx3YXlzTm9ybWFsaXplKSkgewogICAgbm9ybWFsaXphdGlvblR5cGUgPSBBTFdBWVNfTk9STUFMSVpFOwogIH0KCiAgcmV0dXJuIF9jcmVhdGVFbGVtZW50KGNvbnRleHQsIHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlKTsKfQoKZnVuY3Rpb24gX2NyZWF0ZUVsZW1lbnQoY29udGV4dCwgdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUpIHsKICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5fX29iX18pKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkF2b2lkIHVzaW5nIG9ic2VydmVkIGRhdGEgb2JqZWN0IGFzIHZub2RlIGRhdGE6ICIgKyBKU09OLnN0cmluZ2lmeShkYXRhKSArICJcbiIgKyAnQWx3YXlzIGNyZWF0ZSBmcmVzaCB2bm9kZSBkYXRhIG9iamVjdHMgaW4gZWFjaCByZW5kZXIhJywgY29udGV4dCk7CiAgICByZXR1cm4gY3JlYXRlRW1wdHlWTm9kZSgpOwogIH0gLy8gb2JqZWN0IHN5bnRheCBpbiB2LWJpbmQKCgogIGlmIChpc0RlZihkYXRhKSAmJiBpc0RlZihkYXRhLmlzKSkgewogICAgdGFnID0gZGF0YS5pczsKICB9CgogIGlmICghdGFnKSB7CiAgICAvLyBpbiBjYXNlIG9mIGNvbXBvbmVudCA6aXMgc2V0IHRvIGZhbHN5IHZhbHVlCiAgICByZXR1cm4gY3JlYXRlRW1wdHlWTm9kZSgpOwogIH0gLy8gd2FybiBhZ2FpbnN0IG5vbi1wcmltaXRpdmUga2V5CgoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc0RlZihkYXRhKSAmJiBpc0RlZihkYXRhLmtleSkgJiYgIWlzUHJpbWl0aXZlKGRhdGEua2V5KSkgewogICAgewogICAgICB3YXJuKCdBdm9pZCB1c2luZyBub24tcHJpbWl0aXZlIHZhbHVlIGFzIGtleSwgJyArICd1c2Ugc3RyaW5nL251bWJlciB2YWx1ZSBpbnN0ZWFkLicsIGNvbnRleHQpOwogICAgfQogIH0gLy8gc3VwcG9ydCBzaW5nbGUgZnVuY3Rpb24gY2hpbGRyZW4gYXMgZGVmYXVsdCBzY29wZWQgc2xvdAoKCiAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pICYmIHR5cGVvZiBjaGlsZHJlblswXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgZGF0YSA9IGRhdGEgfHwge307CiAgICBkYXRhLnNjb3BlZFNsb3RzID0gewogICAgICAiZGVmYXVsdCI6IGNoaWxkcmVuWzBdCiAgICB9OwogICAgY2hpbGRyZW4ubGVuZ3RoID0gMDsKICB9CgogIGlmIChub3JtYWxpemF0aW9uVHlwZSA9PT0gQUxXQVlTX05PUk1BTElaRSkgewogICAgY2hpbGRyZW4gPSBub3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbik7CiAgfSBlbHNlIGlmIChub3JtYWxpemF0aW9uVHlwZSA9PT0gU0lNUExFX05PUk1BTElaRSkgewogICAgY2hpbGRyZW4gPSBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbik7CiAgfQoKICB2YXIgdm5vZGUsIG5zOwoKICBpZiAodHlwZW9mIHRhZyA9PT0gJ3N0cmluZycpIHsKICAgIHZhciBDdG9yOwogICAgbnMgPSBjb250ZXh0LiR2bm9kZSAmJiBjb250ZXh0LiR2bm9kZS5ucyB8fCBjb25maWcuZ2V0VGFnTmFtZXNwYWNlKHRhZyk7CgogICAgaWYgKGNvbmZpZy5pc1Jlc2VydmVkVGFnKHRhZykpIHsKICAgICAgLy8gcGxhdGZvcm0gYnVpbHQtaW4gZWxlbWVudHMKICAgICAgdm5vZGUgPSBuZXcgVk5vZGUoY29uZmlnLnBhcnNlUGxhdGZvcm1UYWdOYW1lKHRhZyksIGRhdGEsIGNoaWxkcmVuLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGV4dCk7CiAgICB9IGVsc2UgaWYgKCghZGF0YSB8fCAhZGF0YS5wcmUpICYmIGlzRGVmKEN0b3IgPSByZXNvbHZlQXNzZXQoY29udGV4dC4kb3B0aW9ucywgJ2NvbXBvbmVudHMnLCB0YWcpKSkgewogICAgICAvLyBjb21wb25lbnQKICAgICAgdm5vZGUgPSBjcmVhdGVDb21wb25lbnQoQ3RvciwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZyk7CiAgICB9IGVsc2UgewogICAgICAvLyB1bmtub3duIG9yIHVubGlzdGVkIG5hbWVzcGFjZWQgZWxlbWVudHMKICAgICAgLy8gY2hlY2sgYXQgcnVudGltZSBiZWNhdXNlIGl0IG1heSBnZXQgYXNzaWduZWQgYSBuYW1lc3BhY2Ugd2hlbiBpdHMKICAgICAgLy8gcGFyZW50IG5vcm1hbGl6ZXMgY2hpbGRyZW4KICAgICAgdm5vZGUgPSBuZXcgVk5vZGUodGFnLCBkYXRhLCBjaGlsZHJlbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQpOwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBkaXJlY3QgY29tcG9uZW50IG9wdGlvbnMgLyBjb25zdHJ1Y3RvcgogICAgdm5vZGUgPSBjcmVhdGVDb21wb25lbnQodGFnLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbik7CiAgfQoKICBpZiAoQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgIHJldHVybiB2bm9kZTsKICB9IGVsc2UgaWYgKGlzRGVmKHZub2RlKSkgewogICAgaWYgKGlzRGVmKG5zKSkgewogICAgICBhcHBseU5TKHZub2RlLCBucyk7CiAgICB9CgogICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgIHJlZ2lzdGVyRGVlcEJpbmRpbmdzKGRhdGEpOwogICAgfQoKICAgIHJldHVybiB2bm9kZTsKICB9IGVsc2UgewogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9Cn0KCmZ1bmN0aW9uIGFwcGx5TlModm5vZGUsIG5zLCBmb3JjZSkgewogIHZub2RlLm5zID0gbnM7CgogIGlmICh2bm9kZS50YWcgPT09ICdmb3JlaWduT2JqZWN0JykgewogICAgLy8gdXNlIGRlZmF1bHQgbmFtZXNwYWNlIGluc2lkZSBmb3JlaWduT2JqZWN0CiAgICBucyA9IHVuZGVmaW5lZDsKICAgIGZvcmNlID0gdHJ1ZTsKICB9CgogIGlmIChpc0RlZih2bm9kZS5jaGlsZHJlbikpIHsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBjaGlsZCA9IHZub2RlLmNoaWxkcmVuW2ldOwoKICAgICAgaWYgKGlzRGVmKGNoaWxkLnRhZykgJiYgKGlzVW5kZWYoY2hpbGQubnMpIHx8IGlzVHJ1ZShmb3JjZSkgJiYgY2hpbGQudGFnICE9PSAnc3ZnJykpIHsKICAgICAgICBhcHBseU5TKGNoaWxkLCBucywgZm9yY2UpOwogICAgICB9CiAgICB9CiAgfQp9IC8vIHJlZiAjNTMxOAovLyBuZWNlc3NhcnkgdG8gZW5zdXJlIHBhcmVudCByZS1yZW5kZXIgd2hlbiBkZWVwIGJpbmRpbmdzIGxpa2UgOnN0eWxlIGFuZAovLyA6Y2xhc3MgYXJlIHVzZWQgb24gc2xvdCBub2RlcwoKCmZ1bmN0aW9uIHJlZ2lzdGVyRGVlcEJpbmRpbmdzKGRhdGEpIHsKICBpZiAoaXNPYmplY3QoZGF0YS5zdHlsZSkpIHsKICAgIHRyYXZlcnNlKGRhdGEuc3R5bGUpOwogIH0KCiAgaWYgKGlzT2JqZWN0KGRhdGFbImNsYXNzIl0pKSB7CiAgICB0cmF2ZXJzZShkYXRhWyJjbGFzcyJdKTsKICB9Cn0KLyogICovCgoKZnVuY3Rpb24gaW5pdFJlbmRlcih2bSkgewogIHZtLl92bm9kZSA9IG51bGw7IC8vIHRoZSByb290IG9mIHRoZSBjaGlsZCB0cmVlCgogIHZtLl9zdGF0aWNUcmVlcyA9IG51bGw7IC8vIHYtb25jZSBjYWNoZWQgdHJlZXMKCiAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICB2YXIgcGFyZW50Vm5vZGUgPSB2bS4kdm5vZGUgPSBvcHRpb25zLl9wYXJlbnRWbm9kZTsgLy8gdGhlIHBsYWNlaG9sZGVyIG5vZGUgaW4gcGFyZW50IHRyZWUKCiAgdmFyIHJlbmRlckNvbnRleHQgPSBwYXJlbnRWbm9kZSAmJiBwYXJlbnRWbm9kZS5jb250ZXh0OwogIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiwgcmVuZGVyQ29udGV4dCk7CiAgdm0uJHNjb3BlZFNsb3RzID0gZW1wdHlPYmplY3Q7IC8vIGJpbmQgdGhlIGNyZWF0ZUVsZW1lbnQgZm4gdG8gdGhpcyBpbnN0YW5jZQogIC8vIHNvIHRoYXQgd2UgZ2V0IHByb3BlciByZW5kZXIgY29udGV4dCBpbnNpZGUgaXQuCiAgLy8gYXJncyBvcmRlcjogdGFnLCBkYXRhLCBjaGlsZHJlbiwgbm9ybWFsaXphdGlvblR5cGUsIGFsd2F5c05vcm1hbGl6ZQogIC8vIGludGVybmFsIHZlcnNpb24gaXMgdXNlZCBieSByZW5kZXIgZnVuY3Rpb25zIGNvbXBpbGVkIGZyb20gdGVtcGxhdGVzCgogIHZtLl9jID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgIHJldHVybiBjcmVhdGVFbGVtZW50KHZtLCBhLCBiLCBjLCBkLCBmYWxzZSk7CiAgfTsgLy8gbm9ybWFsaXphdGlvbiBpcyBhbHdheXMgYXBwbGllZCBmb3IgdGhlIHB1YmxpYyB2ZXJzaW9uLCB1c2VkIGluCiAgLy8gdXNlci13cml0dGVuIHJlbmRlciBmdW5jdGlvbnMuCgoKICB2bS4kY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICByZXR1cm4gY3JlYXRlRWxlbWVudCh2bSwgYSwgYiwgYywgZCwgdHJ1ZSk7CiAgfTsgLy8gJGF0dHJzICYgJGxpc3RlbmVycyBhcmUgZXhwb3NlZCBmb3IgZWFzaWVyIEhPQyBjcmVhdGlvbi4KICAvLyB0aGV5IG5lZWQgdG8gYmUgcmVhY3RpdmUgc28gdGhhdCBIT0NzIHVzaW5nIHRoZW0gYXJlIGFsd2F5cyB1cGRhdGVkCgoKICB2YXIgcGFyZW50RGF0YSA9IHBhcmVudFZub2RlICYmIHBhcmVudFZub2RlLmRhdGE7CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGF0dHJzJywgcGFyZW50RGF0YSAmJiBwYXJlbnREYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0LCBmdW5jdGlvbiAoKSB7CiAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGF0dHJzIGlzIHJlYWRvbmx5LiIsIHZtKTsKICAgIH0sIHRydWUpOwogICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sICckbGlzdGVuZXJzJywgb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0LCBmdW5jdGlvbiAoKSB7CiAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGxpc3RlbmVycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICB9LCB0cnVlKTsKICB9IGVsc2UgewogICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sICckYXR0cnMnLCBwYXJlbnREYXRhICYmIHBhcmVudERhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3QsIG51bGwsIHRydWUpOwogICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sICckbGlzdGVuZXJzJywgb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0LCBudWxsLCB0cnVlKTsKICB9Cn0KCnZhciBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPSBudWxsOwoKZnVuY3Rpb24gcmVuZGVyTWl4aW4oVnVlKSB7CiAgLy8gaW5zdGFsbCBydW50aW1lIGNvbnZlbmllbmNlIGhlbHBlcnMKICBpbnN0YWxsUmVuZGVySGVscGVycyhWdWUucHJvdG90eXBlKTsKCiAgVnVlLnByb3RvdHlwZS4kbmV4dFRpY2sgPSBmdW5jdGlvbiAoZm4pIHsKICAgIHJldHVybiBuZXh0VGljayhmbiwgdGhpcyk7CiAgfTsKCiAgVnVlLnByb3RvdHlwZS5fcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKICAgIHZhciByZWYgPSB2bS4kb3B0aW9uczsKICAgIHZhciByZW5kZXIgPSByZWYucmVuZGVyOwogICAgdmFyIF9wYXJlbnRWbm9kZSA9IHJlZi5fcGFyZW50Vm5vZGU7CgogICAgaWYgKF9wYXJlbnRWbm9kZSkgewogICAgICB2bS4kc2NvcGVkU2xvdHMgPSBub3JtYWxpemVTY29wZWRTbG90cyhfcGFyZW50Vm5vZGUuZGF0YS5zY29wZWRTbG90cywgdm0uJHNsb3RzLCB2bS4kc2NvcGVkU2xvdHMpOwogICAgfSAvLyBzZXQgcGFyZW50IHZub2RlLiB0aGlzIGFsbG93cyByZW5kZXIgZnVuY3Rpb25zIHRvIGhhdmUgYWNjZXNzCiAgICAvLyB0byB0aGUgZGF0YSBvbiB0aGUgcGxhY2Vob2xkZXIgbm9kZS4KCgogICAgdm0uJHZub2RlID0gX3BhcmVudFZub2RlOyAvLyByZW5kZXIgc2VsZgoKICAgIHZhciB2bm9kZTsKCiAgICB0cnkgewogICAgICAvLyBUaGVyZSdzIG5vIG5lZWQgdG8gbWFpbnRhaW4gYSBzdGFjayBiZWNhdWVzIGFsbCByZW5kZXIgZm5zIGFyZSBjYWxsZWQKICAgICAgLy8gc2VwYXJhdGVseSBmcm9tIG9uZSBhbm90aGVyLiBOZXN0ZWQgY29tcG9uZW50J3MgcmVuZGVyIGZucyBhcmUgY2FsbGVkCiAgICAgIC8vIHdoZW4gcGFyZW50IGNvbXBvbmVudCBpcyBwYXRjaGVkLgogICAgICBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPSB2bTsKICAgICAgdm5vZGUgPSByZW5kZXIuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJyZW5kZXIiKTsgLy8gcmV0dXJuIGVycm9yIHJlbmRlciByZXN1bHQsCiAgICAgIC8vIG9yIHByZXZpb3VzIHZub2RlIHRvIHByZXZlbnQgcmVuZGVyIGVycm9yIGNhdXNpbmcgYmxhbmsgY29tcG9uZW50CgogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdm0uJG9wdGlvbnMucmVuZGVyRXJyb3IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdm5vZGUgPSB2bS4kb3B0aW9ucy5yZW5kZXJFcnJvci5jYWxsKHZtLl9yZW5kZXJQcm94eSwgdm0uJGNyZWF0ZUVsZW1lbnQsIGUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAicmVuZGVyRXJyb3IiKTsKICAgICAgICAgIHZub2RlID0gdm0uX3Zub2RlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gbnVsbDsKICAgIH0gLy8gaWYgdGhlIHJldHVybmVkIGFycmF5IGNvbnRhaW5zIG9ubHkgYSBzaW5nbGUgbm9kZSwgYWxsb3cgaXQKCgogICAgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpICYmIHZub2RlLmxlbmd0aCA9PT0gMSkgewogICAgICB2bm9kZSA9IHZub2RlWzBdOwogICAgfSAvLyByZXR1cm4gZW1wdHkgdm5vZGUgaW4gY2FzZSB0aGUgcmVuZGVyIGZ1bmN0aW9uIGVycm9yZWQgb3V0CgoKICAgIGlmICghKHZub2RlIGluc3RhbmNlb2YgVk5vZGUpKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIEFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICAgICAgd2FybignTXVsdGlwbGUgcm9vdCBub2RlcyByZXR1cm5lZCBmcm9tIHJlbmRlciBmdW5jdGlvbi4gUmVuZGVyIGZ1bmN0aW9uICcgKyAnc2hvdWxkIHJldHVybiBhIHNpbmdsZSByb290IG5vZGUuJywgdm0pOwogICAgICB9CgogICAgICB2bm9kZSA9IGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICAgIH0gLy8gc2V0IHBhcmVudAoKCiAgICB2bm9kZS5wYXJlbnQgPSBfcGFyZW50Vm5vZGU7CiAgICByZXR1cm4gdm5vZGU7CiAgfTsKfQovKiAgKi8KCgpmdW5jdGlvbiBlbnN1cmVDdG9yKGNvbXAsIGJhc2UpIHsKICBpZiAoY29tcC5fX2VzTW9kdWxlIHx8IGhhc1N5bWJvbCAmJiBjb21wW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICdNb2R1bGUnKSB7CiAgICBjb21wID0gY29tcFsiZGVmYXVsdCJdOwogIH0KCiAgcmV0dXJuIGlzT2JqZWN0KGNvbXApID8gYmFzZS5leHRlbmQoY29tcCkgOiBjb21wOwp9CgpmdW5jdGlvbiBjcmVhdGVBc3luY1BsYWNlaG9sZGVyKGZhY3RvcnksIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpIHsKICB2YXIgbm9kZSA9IGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICBub2RlLmFzeW5jRmFjdG9yeSA9IGZhY3Rvcnk7CiAgbm9kZS5hc3luY01ldGEgPSB7CiAgICBkYXRhOiBkYXRhLAogICAgY29udGV4dDogY29udGV4dCwKICAgIGNoaWxkcmVuOiBjaGlsZHJlbiwKICAgIHRhZzogdGFnCiAgfTsKICByZXR1cm4gbm9kZTsKfQoKZnVuY3Rpb24gcmVzb2x2ZUFzeW5jQ29tcG9uZW50KGZhY3RvcnksIGJhc2VDdG9yKSB7CiAgaWYgKGlzVHJ1ZShmYWN0b3J5LmVycm9yKSAmJiBpc0RlZihmYWN0b3J5LmVycm9yQ29tcCkpIHsKICAgIHJldHVybiBmYWN0b3J5LmVycm9yQ29tcDsKICB9CgogIGlmIChpc0RlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgcmV0dXJuIGZhY3RvcnkucmVzb2x2ZWQ7CiAgfQoKICB2YXIgb3duZXIgPSBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2U7CgogIGlmIChvd25lciAmJiBpc0RlZihmYWN0b3J5Lm93bmVycykgJiYgZmFjdG9yeS5vd25lcnMuaW5kZXhPZihvd25lcikgPT09IC0xKSB7CiAgICAvLyBhbHJlYWR5IHBlbmRpbmcKICAgIGZhY3Rvcnkub3duZXJzLnB1c2gob3duZXIpOwogIH0KCiAgaWYgKGlzVHJ1ZShmYWN0b3J5LmxvYWRpbmcpICYmIGlzRGVmKGZhY3RvcnkubG9hZGluZ0NvbXApKSB7CiAgICByZXR1cm4gZmFjdG9yeS5sb2FkaW5nQ29tcDsKICB9CgogIGlmIChvd25lciAmJiAhaXNEZWYoZmFjdG9yeS5vd25lcnMpKSB7CiAgICB2YXIgb3duZXJzID0gZmFjdG9yeS5vd25lcnMgPSBbb3duZXJdOwogICAgdmFyIHN5bmMgPSB0cnVlOwogICAgdmFyIHRpbWVyTG9hZGluZyA9IG51bGw7CiAgICB2YXIgdGltZXJUaW1lb3V0ID0gbnVsbDsKICAgIG93bmVyLiRvbignaG9vazpkZXN0cm95ZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiByZW1vdmUob3duZXJzLCBvd25lcik7CiAgICB9KTsKCiAgICB2YXIgZm9yY2VSZW5kZXIgPSBmdW5jdGlvbiBmb3JjZVJlbmRlcihyZW5kZXJDb21wbGV0ZWQpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvd25lcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb3duZXJzW2ldLiRmb3JjZVVwZGF0ZSgpOwogICAgICB9CgogICAgICBpZiAocmVuZGVyQ29tcGxldGVkKSB7CiAgICAgICAgb3duZXJzLmxlbmd0aCA9IDA7CgogICAgICAgIGlmICh0aW1lckxvYWRpbmcgIT09IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lckxvYWRpbmcpOwogICAgICAgICAgdGltZXJMb2FkaW5nID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh0aW1lclRpbWVvdXQgIT09IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lclRpbWVvdXQpOwogICAgICAgICAgdGltZXJUaW1lb3V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdmFyIHJlc29sdmUgPSBvbmNlKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgLy8gY2FjaGUgcmVzb2x2ZWQKICAgICAgZmFjdG9yeS5yZXNvbHZlZCA9IGVuc3VyZUN0b3IocmVzLCBiYXNlQ3Rvcik7IC8vIGludm9rZSBjYWxsYmFja3Mgb25seSBpZiB0aGlzIGlzIG5vdCBhIHN5bmNocm9ub3VzIHJlc29sdmUKICAgICAgLy8gKGFzeW5jIHJlc29sdmVzIGFyZSBzaGltbWVkIGFzIHN5bmNocm9ub3VzIGR1cmluZyBTU1IpCgogICAgICBpZiAoIXN5bmMpIHsKICAgICAgICBmb3JjZVJlbmRlcih0cnVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvd25lcnMubGVuZ3RoID0gMDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVqZWN0ID0gb25jZShmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiRmFpbGVkIHRvIHJlc29sdmUgYXN5bmMgY29tcG9uZW50OiAiICsgU3RyaW5nKGZhY3RvcnkpICsgKHJlYXNvbiA/ICJcblJlYXNvbjogIiArIHJlYXNvbiA6ICcnKSk7CgogICAgICBpZiAoaXNEZWYoZmFjdG9yeS5lcnJvckNvbXApKSB7CiAgICAgICAgZmFjdG9yeS5lcnJvciA9IHRydWU7CiAgICAgICAgZm9yY2VSZW5kZXIodHJ1ZSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlcyA9IGZhY3RvcnkocmVzb2x2ZSwgcmVqZWN0KTsKCiAgICBpZiAoaXNPYmplY3QocmVzKSkgewogICAgICBpZiAoaXNQcm9taXNlKHJlcykpIHsKICAgICAgICAvLyAoKSA9PiBQcm9taXNlCiAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICAgIHJlcy50aGVuKHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzUHJvbWlzZShyZXMuY29tcG9uZW50KSkgewogICAgICAgIHJlcy5jb21wb25lbnQudGhlbihyZXNvbHZlLCByZWplY3QpOwoKICAgICAgICBpZiAoaXNEZWYocmVzLmVycm9yKSkgewogICAgICAgICAgZmFjdG9yeS5lcnJvckNvbXAgPSBlbnN1cmVDdG9yKHJlcy5lcnJvciwgYmFzZUN0b3IpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKHJlcy5sb2FkaW5nKSkgewogICAgICAgICAgZmFjdG9yeS5sb2FkaW5nQ29tcCA9IGVuc3VyZUN0b3IocmVzLmxvYWRpbmcsIGJhc2VDdG9yKTsKCiAgICAgICAgICBpZiAocmVzLmRlbGF5ID09PSAwKSB7CiAgICAgICAgICAgIGZhY3RvcnkubG9hZGluZyA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aW1lckxvYWRpbmcgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICB0aW1lckxvYWRpbmcgPSBudWxsOwoKICAgICAgICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSAmJiBpc1VuZGVmKGZhY3RvcnkuZXJyb3IpKSB7CiAgICAgICAgICAgICAgICBmYWN0b3J5LmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgZm9yY2VSZW5kZXIoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgcmVzLmRlbGF5IHx8IDIwMCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWYocmVzLnRpbWVvdXQpKSB7CiAgICAgICAgICB0aW1lclRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGltZXJUaW1lb3V0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChpc1VuZGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgICAgICAgcmVqZWN0KHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyAidGltZW91dCAoIiArIHJlcy50aW1lb3V0ICsgIm1zKSIgOiBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgcmVzLnRpbWVvdXQpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHN5bmMgPSBmYWxzZTsgLy8gcmV0dXJuIGluIGNhc2UgcmVzb2x2ZWQgc3luY2hyb25vdXNseQoKICAgIHJldHVybiBmYWN0b3J5LmxvYWRpbmcgPyBmYWN0b3J5LmxvYWRpbmdDb21wIDogZmFjdG9yeS5yZXNvbHZlZDsKICB9Cn0KLyogICovCgoKZnVuY3Rpb24gaXNBc3luY1BsYWNlaG9sZGVyKG5vZGUpIHsKICByZXR1cm4gbm9kZS5pc0NvbW1lbnQgJiYgbm9kZS5hc3luY0ZhY3Rvcnk7Cn0KLyogICovCgoKZnVuY3Rpb24gZ2V0Rmlyc3RDb21wb25lbnRDaGlsZChjaGlsZHJlbikgewogIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgYyA9IGNoaWxkcmVuW2ldOwoKICAgICAgaWYgKGlzRGVmKGMpICYmIChpc0RlZihjLmNvbXBvbmVudE9wdGlvbnMpIHx8IGlzQXN5bmNQbGFjZWhvbGRlcihjKSkpIHsKICAgICAgICByZXR1cm4gYzsKICAgICAgfQogICAgfQogIH0KfQovKiAgKi8KCi8qICAqLwoKCmZ1bmN0aW9uIGluaXRFdmVudHModm0pIHsKICB2bS5fZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB2bS5faGFzSG9va0V2ZW50ID0gZmFsc2U7IC8vIGluaXQgcGFyZW50IGF0dGFjaGVkIGV2ZW50cwoKICB2YXIgbGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKCiAgaWYgKGxpc3RlbmVycykgewogICAgdXBkYXRlQ29tcG9uZW50TGlzdGVuZXJzKHZtLCBsaXN0ZW5lcnMpOwogIH0KfQoKdmFyIHRhcmdldDsKCmZ1bmN0aW9uIGFkZChldmVudCwgZm4pIHsKICB0YXJnZXQuJG9uKGV2ZW50LCBmbik7Cn0KCmZ1bmN0aW9uIHJlbW92ZSQxKGV2ZW50LCBmbikgewogIHRhcmdldC4kb2ZmKGV2ZW50LCBmbik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZU9uY2VIYW5kbGVyKGV2ZW50LCBmbikgewogIHZhciBfdGFyZ2V0ID0gdGFyZ2V0OwogIHJldHVybiBmdW5jdGlvbiBvbmNlSGFuZGxlcigpIHsKICAgIHZhciByZXMgPSBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpOwoKICAgIGlmIChyZXMgIT09IG51bGwpIHsKICAgICAgX3RhcmdldC4kb2ZmKGV2ZW50LCBvbmNlSGFuZGxlcik7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gdXBkYXRlQ29tcG9uZW50TGlzdGVuZXJzKHZtLCBsaXN0ZW5lcnMsIG9sZExpc3RlbmVycykgewogIHRhcmdldCA9IHZtOwogIHVwZGF0ZUxpc3RlbmVycyhsaXN0ZW5lcnMsIG9sZExpc3RlbmVycyB8fCB7fSwgYWRkLCByZW1vdmUkMSwgY3JlYXRlT25jZUhhbmRsZXIsIHZtKTsKICB0YXJnZXQgPSB1bmRlZmluZWQ7Cn0KCmZ1bmN0aW9uIGV2ZW50c01peGluKFZ1ZSkgewogIHZhciBob29rUkUgPSAvXmhvb2s6LzsKCiAgVnVlLnByb3RvdHlwZS4kb24gPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmIChBcnJheS5pc0FycmF5KGV2ZW50KSkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGV2ZW50Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZtLiRvbihldmVudFtpXSwgZm4pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAodm0uX2V2ZW50c1tldmVudF0gfHwgKHZtLl9ldmVudHNbZXZlbnRdID0gW10pKS5wdXNoKGZuKTsgLy8gb3B0aW1pemUgaG9vazpldmVudCBjb3N0IGJ5IHVzaW5nIGEgYm9vbGVhbiBmbGFnIG1hcmtlZCBhdCByZWdpc3RyYXRpb24KICAgICAgLy8gaW5zdGVhZCBvZiBhIGhhc2ggbG9va3VwCgogICAgICBpZiAoaG9va1JFLnRlc3QoZXZlbnQpKSB7CiAgICAgICAgdm0uX2hhc0hvb2tFdmVudCA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdm07CiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kb25jZSA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgZnVuY3Rpb24gb24oKSB7CiAgICAgIHZtLiRvZmYoZXZlbnQsIG9uKTsKICAgICAgZm4uYXBwbHkodm0sIGFyZ3VtZW50cyk7CiAgICB9CgogICAgb24uZm4gPSBmbjsKICAgIHZtLiRvbihldmVudCwgb24pOwogICAgcmV0dXJuIHZtOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuJG9mZiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIHZhciB2bSA9IHRoaXM7IC8vIGFsbAoKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICB2bS5fZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgcmV0dXJuIHZtOwogICAgfSAvLyBhcnJheSBvZiBldmVudHMKCgogICAgaWYgKEFycmF5LmlzQXJyYXkoZXZlbnQpKSB7CiAgICAgIGZvciAodmFyIGkkMSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGkkMSA8IGw7IGkkMSsrKSB7CiAgICAgICAgdm0uJG9mZihldmVudFtpJDFdLCBmbik7CiAgICAgIH0KCiAgICAgIHJldHVybiB2bTsKICAgIH0gLy8gc3BlY2lmaWMgZXZlbnQKCgogICAgdmFyIGNicyA9IHZtLl9ldmVudHNbZXZlbnRdOwoKICAgIGlmICghY2JzKSB7CiAgICAgIHJldHVybiB2bTsKICAgIH0KCiAgICBpZiAoIWZuKSB7CiAgICAgIHZtLl9ldmVudHNbZXZlbnRdID0gbnVsbDsKICAgICAgcmV0dXJuIHZtOwogICAgfSAvLyBzcGVjaWZpYyBoYW5kbGVyCgoKICAgIHZhciBjYjsKICAgIHZhciBpID0gY2JzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIGNiID0gY2JzW2ldOwoKICAgICAgaWYgKGNiID09PSBmbiB8fCBjYi5mbiA9PT0gZm4pIHsKICAgICAgICBjYnMuc3BsaWNlKGksIDEpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZtOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuJGVtaXQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgdmFyIGxvd2VyQ2FzZUV2ZW50ID0gZXZlbnQudG9Mb3dlckNhc2UoKTsKCiAgICAgIGlmIChsb3dlckNhc2VFdmVudCAhPT0gZXZlbnQgJiYgdm0uX2V2ZW50c1tsb3dlckNhc2VFdmVudF0pIHsKICAgICAgICB0aXAoIkV2ZW50IFwiIiArIGxvd2VyQ2FzZUV2ZW50ICsgIlwiIGlzIGVtaXR0ZWQgaW4gY29tcG9uZW50ICIgKyBmb3JtYXRDb21wb25lbnROYW1lKHZtKSArICIgYnV0IHRoZSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQgZm9yIFwiIiArIGV2ZW50ICsgIlwiLiAiICsgIk5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIHlvdSBjYW5ub3QgdXNlICIgKyAidi1vbiB0byBsaXN0ZW4gdG8gY2FtZWxDYXNlIGV2ZW50cyB3aGVuIHVzaW5nIGluLURPTSB0ZW1wbGF0ZXMuICIgKyAiWW91IHNob3VsZCBwcm9iYWJseSB1c2UgXCIiICsgaHlwaGVuYXRlKGV2ZW50KSArICJcIiBpbnN0ZWFkIG9mIFwiIiArIGV2ZW50ICsgIlwiLiIpOwogICAgICB9CiAgICB9CgogICAgdmFyIGNicyA9IHZtLl9ldmVudHNbZXZlbnRdOwoKICAgIGlmIChjYnMpIHsKICAgICAgY2JzID0gY2JzLmxlbmd0aCA+IDEgPyB0b0FycmF5KGNicykgOiBjYnM7CiAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgICB2YXIgaW5mbyA9ICJldmVudCBoYW5kbGVyIGZvciBcIiIgKyBldmVudCArICJcIiI7CgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNicy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhjYnNbaV0sIHZtLCBhcmdzLCB2bSwgaW5mbyk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdm07CiAgfTsKfQovKiAgKi8KCgp2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwp2YXIgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gZmFsc2U7CgpmdW5jdGlvbiBzZXRBY3RpdmVJbnN0YW5jZSh2bSkgewogIHZhciBwcmV2QWN0aXZlSW5zdGFuY2UgPSBhY3RpdmVJbnN0YW5jZTsKICBhY3RpdmVJbnN0YW5jZSA9IHZtOwogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICBhY3RpdmVJbnN0YW5jZSA9IHByZXZBY3RpdmVJbnN0YW5jZTsKICB9Owp9CgpmdW5jdGlvbiBpbml0TGlmZWN5Y2xlKHZtKSB7CiAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsgLy8gbG9jYXRlIGZpcnN0IG5vbi1hYnN0cmFjdCBwYXJlbnQKCiAgdmFyIHBhcmVudCA9IG9wdGlvbnMucGFyZW50OwoKICBpZiAocGFyZW50ICYmICFvcHRpb25zWyJhYnN0cmFjdCJdKSB7CiAgICB3aGlsZSAocGFyZW50LiRvcHRpb25zWyJhYnN0cmFjdCJdICYmIHBhcmVudC4kcGFyZW50KSB7CiAgICAgIHBhcmVudCA9IHBhcmVudC4kcGFyZW50OwogICAgfQoKICAgIHBhcmVudC4kY2hpbGRyZW4ucHVzaCh2bSk7CiAgfQoKICB2bS4kcGFyZW50ID0gcGFyZW50OwogIHZtLiRyb290ID0gcGFyZW50ID8gcGFyZW50LiRyb290IDogdm07CiAgdm0uJGNoaWxkcmVuID0gW107CiAgdm0uJHJlZnMgPSB7fTsKICB2bS5fd2F0Y2hlciA9IG51bGw7CiAgdm0uX2luYWN0aXZlID0gbnVsbDsKICB2bS5fZGlyZWN0SW5hY3RpdmUgPSBmYWxzZTsKICB2bS5faXNNb3VudGVkID0gZmFsc2U7CiAgdm0uX2lzRGVzdHJveWVkID0gZmFsc2U7CiAgdm0uX2lzQmVpbmdEZXN0cm95ZWQgPSBmYWxzZTsKfQoKZnVuY3Rpb24gbGlmZWN5Y2xlTWl4aW4oVnVlKSB7CiAgVnVlLnByb3RvdHlwZS5fdXBkYXRlID0gZnVuY3Rpb24gKHZub2RlLCBoeWRyYXRpbmcpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgcHJldkVsID0gdm0uJGVsOwogICAgdmFyIHByZXZWbm9kZSA9IHZtLl92bm9kZTsKICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh2bSk7CiAgICB2bS5fdm5vZGUgPSB2bm9kZTsgLy8gVnVlLnByb3RvdHlwZS5fX3BhdGNoX18gaXMgaW5qZWN0ZWQgaW4gZW50cnkgcG9pbnRzCiAgICAvLyBiYXNlZCBvbiB0aGUgcmVuZGVyaW5nIGJhY2tlbmQgdXNlZC4KCiAgICBpZiAoIXByZXZWbm9kZSkgewogICAgICAvLyBpbml0aWFsIHJlbmRlcgogICAgICB2bS4kZWwgPSB2bS5fX3BhdGNoX18odm0uJGVsLCB2bm9kZSwgaHlkcmF0aW5nLCBmYWxzZQogICAgICAvKiByZW1vdmVPbmx5ICovCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICAvLyB1cGRhdGVzCiAgICAgIHZtLiRlbCA9IHZtLl9fcGF0Y2hfXyhwcmV2Vm5vZGUsIHZub2RlKTsKICAgIH0KCiAgICByZXN0b3JlQWN0aXZlSW5zdGFuY2UoKTsgLy8gdXBkYXRlIF9fdnVlX18gcmVmZXJlbmNlCgogICAgaWYgKHByZXZFbCkgewogICAgICBwcmV2RWwuX192dWVfXyA9IG51bGw7CiAgICB9CgogICAgaWYgKHZtLiRlbCkgewogICAgICB2bS4kZWwuX192dWVfXyA9IHZtOwogICAgfSAvLyBpZiBwYXJlbnQgaXMgYW4gSE9DLCB1cGRhdGUgaXRzICRlbCBhcyB3ZWxsCgoKICAgIGlmICh2bS4kdm5vZGUgJiYgdm0uJHBhcmVudCAmJiB2bS4kdm5vZGUgPT09IHZtLiRwYXJlbnQuX3Zub2RlKSB7CiAgICAgIHZtLiRwYXJlbnQuJGVsID0gdm0uJGVsOwogICAgfSAvLyB1cGRhdGVkIGhvb2sgaXMgY2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIgdG8gZW5zdXJlIHRoYXQgY2hpbGRyZW4gYXJlCiAgICAvLyB1cGRhdGVkIGluIGEgcGFyZW50J3MgdXBkYXRlZCBob29rLgoKICB9OwoKICBWdWUucHJvdG90eXBlLiRmb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgaWYgKHZtLl93YXRjaGVyKSB7CiAgICAgIHZtLl93YXRjaGVyLnVwZGF0ZSgpOwogICAgfQogIH07CgogIFZ1ZS5wcm90b3R5cGUuJGRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmICh2bS5faXNCZWluZ0Rlc3Ryb3llZCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgY2FsbEhvb2sodm0sICdiZWZvcmVEZXN0cm95Jyk7CiAgICB2bS5faXNCZWluZ0Rlc3Ryb3llZCA9IHRydWU7IC8vIHJlbW92ZSBzZWxmIGZyb20gcGFyZW50CgogICAgdmFyIHBhcmVudCA9IHZtLiRwYXJlbnQ7CgogICAgaWYgKHBhcmVudCAmJiAhcGFyZW50Ll9pc0JlaW5nRGVzdHJveWVkICYmICF2bS4kb3B0aW9uc1siYWJzdHJhY3QiXSkgewogICAgICByZW1vdmUocGFyZW50LiRjaGlsZHJlbiwgdm0pOwogICAgfSAvLyB0ZWFyZG93biB3YXRjaGVycwoKCiAgICBpZiAodm0uX3dhdGNoZXIpIHsKICAgICAgdm0uX3dhdGNoZXIudGVhcmRvd24oKTsKICAgIH0KCiAgICB2YXIgaSA9IHZtLl93YXRjaGVycy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICB2bS5fd2F0Y2hlcnNbaV0udGVhcmRvd24oKTsKICAgIH0gLy8gcmVtb3ZlIHJlZmVyZW5jZSBmcm9tIGRhdGEgb2IKICAgIC8vIGZyb3plbiBvYmplY3QgbWF5IG5vdCBoYXZlIG9ic2VydmVyLgoKCiAgICBpZiAodm0uX2RhdGEuX19vYl9fKSB7CiAgICAgIHZtLl9kYXRhLl9fb2JfXy52bUNvdW50LS07CiAgICB9IC8vIGNhbGwgdGhlIGxhc3QgaG9vay4uLgoKCiAgICB2bS5faXNEZXN0cm95ZWQgPSB0cnVlOyAvLyBpbnZva2UgZGVzdHJveSBob29rcyBvbiBjdXJyZW50IHJlbmRlcmVkIHRyZWUKCiAgICB2bS5fX3BhdGNoX18odm0uX3Zub2RlLCBudWxsKTsgLy8gZmlyZSBkZXN0cm95ZWQgaG9vawoKCiAgICBjYWxsSG9vayh2bSwgJ2Rlc3Ryb3llZCcpOyAvLyB0dXJuIG9mZiBhbGwgaW5zdGFuY2UgbGlzdGVuZXJzLgoKICAgIHZtLiRvZmYoKTsgLy8gcmVtb3ZlIF9fdnVlX18gcmVmZXJlbmNlCgogICAgaWYgKHZtLiRlbCkgewogICAgICB2bS4kZWwuX192dWVfXyA9IG51bGw7CiAgICB9IC8vIHJlbGVhc2UgY2lyY3VsYXIgcmVmZXJlbmNlICgjNjc1OSkKCgogICAgaWYgKHZtLiR2bm9kZSkgewogICAgICB2bS4kdm5vZGUucGFyZW50ID0gbnVsbDsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBtb3VudENvbXBvbmVudCh2bSwgZWwsIGh5ZHJhdGluZykgewogIHZtLiRlbCA9IGVsOwoKICBpZiAoIXZtLiRvcHRpb25zLnJlbmRlcikgewogICAgdm0uJG9wdGlvbnMucmVuZGVyID0gY3JlYXRlRW1wdHlWTm9kZTsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKHZtLiRvcHRpb25zLnRlbXBsYXRlICYmIHZtLiRvcHRpb25zLnRlbXBsYXRlLmNoYXJBdCgwKSAhPT0gJyMnIHx8IHZtLiRvcHRpb25zLmVsIHx8IGVsKSB7CiAgICAgICAgd2FybignWW91IGFyZSB1c2luZyB0aGUgcnVudGltZS1vbmx5IGJ1aWxkIG9mIFZ1ZSB3aGVyZSB0aGUgdGVtcGxhdGUgJyArICdjb21waWxlciBpcyBub3QgYXZhaWxhYmxlLiBFaXRoZXIgcHJlLWNvbXBpbGUgdGhlIHRlbXBsYXRlcyBpbnRvICcgKyAncmVuZGVyIGZ1bmN0aW9ucywgb3IgdXNlIHRoZSBjb21waWxlci1pbmNsdWRlZCBidWlsZC4nLCB2bSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2FybignRmFpbGVkIHRvIG1vdW50IGNvbXBvbmVudDogdGVtcGxhdGUgb3IgcmVuZGVyIGZ1bmN0aW9uIG5vdCBkZWZpbmVkLicsIHZtKTsKICAgICAgfQogICAgfQogIH0KCiAgY2FsbEhvb2sodm0sICdiZWZvcmVNb3VudCcpOwogIHZhciB1cGRhdGVDb21wb25lbnQ7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICB1cGRhdGVDb21wb25lbnQgPSBmdW5jdGlvbiB1cGRhdGVDb21wb25lbnQoKSB7CiAgICAgIHZhciBuYW1lID0gdm0uX25hbWU7CiAgICAgIHZhciBpZCA9IHZtLl91aWQ7CiAgICAgIHZhciBzdGFydFRhZyA9ICJ2dWUtcGVyZi1zdGFydDoiICsgaWQ7CiAgICAgIHZhciBlbmRUYWcgPSAidnVlLXBlcmYtZW5kOiIgKyBpZDsKICAgICAgbWFyayhzdGFydFRhZyk7CgogICAgICB2YXIgdm5vZGUgPSB2bS5fcmVuZGVyKCk7CgogICAgICBtYXJrKGVuZFRhZyk7CiAgICAgIG1lYXN1cmUoInZ1ZSAiICsgbmFtZSArICIgcmVuZGVyIiwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwoKICAgICAgdm0uX3VwZGF0ZSh2bm9kZSwgaHlkcmF0aW5nKTsKCiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIgKyBuYW1lICsgIiBwYXRjaCIsIHN0YXJ0VGFnLCBlbmRUYWcpOwogICAgfTsKICB9IGVsc2UgewogICAgdXBkYXRlQ29tcG9uZW50ID0gZnVuY3Rpb24gdXBkYXRlQ29tcG9uZW50KCkgewogICAgICB2bS5fdXBkYXRlKHZtLl9yZW5kZXIoKSwgaHlkcmF0aW5nKTsKICAgIH07CiAgfSAvLyB3ZSBzZXQgdGhpcyB0byB2bS5fd2F0Y2hlciBpbnNpZGUgdGhlIHdhdGNoZXIncyBjb25zdHJ1Y3RvcgogIC8vIHNpbmNlIHRoZSB3YXRjaGVyJ3MgaW5pdGlhbCBwYXRjaCBtYXkgY2FsbCAkZm9yY2VVcGRhdGUgKGUuZy4gaW5zaWRlIGNoaWxkCiAgLy8gY29tcG9uZW50J3MgbW91bnRlZCBob29rKSwgd2hpY2ggcmVsaWVzIG9uIHZtLl93YXRjaGVyIGJlaW5nIGFscmVhZHkgZGVmaW5lZAoKCiAgbmV3IFdhdGNoZXIodm0sIHVwZGF0ZUNvbXBvbmVudCwgbm9vcCwgewogICAgYmVmb3JlOiBmdW5jdGlvbiBiZWZvcmUoKSB7CiAgICAgIGlmICh2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgICBjYWxsSG9vayh2bSwgJ2JlZm9yZVVwZGF0ZScpOwogICAgICB9CiAgICB9CiAgfSwgdHJ1ZQogIC8qIGlzUmVuZGVyV2F0Y2hlciAqLwogICk7CiAgaHlkcmF0aW5nID0gZmFsc2U7IC8vIG1hbnVhbGx5IG1vdW50ZWQgaW5zdGFuY2UsIGNhbGwgbW91bnRlZCBvbiBzZWxmCiAgLy8gbW91bnRlZCBpcyBjYWxsZWQgZm9yIHJlbmRlci1jcmVhdGVkIGNoaWxkIGNvbXBvbmVudHMgaW4gaXRzIGluc2VydGVkIGhvb2sKCiAgaWYgKHZtLiR2bm9kZSA9PSBudWxsKSB7CiAgICB2bS5faXNNb3VudGVkID0gdHJ1ZTsKICAgIGNhbGxIb29rKHZtLCAnbW91bnRlZCcpOwogIH0KCiAgcmV0dXJuIHZtOwp9CgpmdW5jdGlvbiB1cGRhdGVDaGlsZENvbXBvbmVudCh2bSwgcHJvcHNEYXRhLCBsaXN0ZW5lcnMsIHBhcmVudFZub2RlLCByZW5kZXJDaGlsZHJlbikgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSB0cnVlOwogIH0gLy8gZGV0ZXJtaW5lIHdoZXRoZXIgY29tcG9uZW50IGhhcyBzbG90IGNoaWxkcmVuCiAgLy8gd2UgbmVlZCB0byBkbyB0aGlzIGJlZm9yZSBvdmVyd3JpdGluZyAkb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4uCiAgLy8gY2hlY2sgaWYgdGhlcmUgYXJlIGR5bmFtaWMgc2NvcGVkU2xvdHMgKGhhbmQtd3JpdHRlbiBvciBjb21waWxlZCBidXQgd2l0aAogIC8vIGR5bmFtaWMgc2xvdCBuYW1lcykuIFN0YXRpYyBzY29wZWQgc2xvdHMgY29tcGlsZWQgZnJvbSB0ZW1wbGF0ZSBoYXMgdGhlCiAgLy8gIiRzdGFibGUiIG1hcmtlci4KCgogIHZhciBuZXdTY29wZWRTbG90cyA9IHBhcmVudFZub2RlLmRhdGEuc2NvcGVkU2xvdHM7CiAgdmFyIG9sZFNjb3BlZFNsb3RzID0gdm0uJHNjb3BlZFNsb3RzOwogIHZhciBoYXNEeW5hbWljU2NvcGVkU2xvdCA9ICEhKG5ld1Njb3BlZFNsb3RzICYmICFuZXdTY29wZWRTbG90cy4kc3RhYmxlIHx8IG9sZFNjb3BlZFNsb3RzICE9PSBlbXB0eU9iamVjdCAmJiAhb2xkU2NvcGVkU2xvdHMuJHN0YWJsZSB8fCBuZXdTY29wZWRTbG90cyAmJiB2bS4kc2NvcGVkU2xvdHMuJGtleSAhPT0gbmV3U2NvcGVkU2xvdHMuJGtleSk7IC8vIEFueSBzdGF0aWMgc2xvdCBjaGlsZHJlbiBmcm9tIHRoZSBwYXJlbnQgbWF5IGhhdmUgY2hhbmdlZCBkdXJpbmcgcGFyZW50J3MKICAvLyB1cGRhdGUuIER5bmFtaWMgc2NvcGVkIHNsb3RzIG1heSBhbHNvIGhhdmUgY2hhbmdlZC4gSW4gc3VjaCBjYXNlcywgYSBmb3JjZWQKICAvLyB1cGRhdGUgaXMgbmVjZXNzYXJ5IHRvIGVuc3VyZSBjb3JyZWN0bmVzcy4KCiAgdmFyIG5lZWRzRm9yY2VVcGRhdGUgPSAhIShyZW5kZXJDaGlsZHJlbiB8fCAvLyBoYXMgbmV3IHN0YXRpYyBzbG90cwogIHZtLiRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiB8fCAvLyBoYXMgb2xkIHN0YXRpYyBzbG90cwogIGhhc0R5bmFtaWNTY29wZWRTbG90KTsKICB2bS4kb3B0aW9ucy5fcGFyZW50Vm5vZGUgPSBwYXJlbnRWbm9kZTsKICB2bS4kdm5vZGUgPSBwYXJlbnRWbm9kZTsgLy8gdXBkYXRlIHZtJ3MgcGxhY2Vob2xkZXIgbm9kZSB3aXRob3V0IHJlLXJlbmRlcgoKICBpZiAodm0uX3Zub2RlKSB7CiAgICAvLyB1cGRhdGUgY2hpbGQgdHJlZSdzIHBhcmVudAogICAgdm0uX3Zub2RlLnBhcmVudCA9IHBhcmVudFZub2RlOwogIH0KCiAgdm0uJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuID0gcmVuZGVyQ2hpbGRyZW47IC8vIHVwZGF0ZSAkYXR0cnMgYW5kICRsaXN0ZW5lcnMgaGFzaAogIC8vIHRoZXNlIGFyZSBhbHNvIHJlYWN0aXZlIHNvIHRoZXkgbWF5IHRyaWdnZXIgY2hpbGQgdXBkYXRlIGlmIHRoZSBjaGlsZAogIC8vIHVzZWQgdGhlbSBkdXJpbmcgcmVuZGVyCgogIHZtLiRhdHRycyA9IHBhcmVudFZub2RlLmRhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3Q7CiAgdm0uJGxpc3RlbmVycyA9IGxpc3RlbmVycyB8fCBlbXB0eU9iamVjdDsgLy8gdXBkYXRlIHByb3BzCgogIGlmIChwcm9wc0RhdGEgJiYgdm0uJG9wdGlvbnMucHJvcHMpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICB2YXIgcHJvcHMgPSB2bS5fcHJvcHM7CiAgICB2YXIgcHJvcEtleXMgPSB2bS4kb3B0aW9ucy5fcHJvcEtleXMgfHwgW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wS2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0gcHJvcEtleXNbaV07CiAgICAgIHZhciBwcm9wT3B0aW9ucyA9IHZtLiRvcHRpb25zLnByb3BzOyAvLyB3dGYgZmxvdz8KCiAgICAgIHByb3BzW2tleV0gPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhLCB2bSk7CiAgICB9CgogICAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOyAvLyBrZWVwIGEgY29weSBvZiByYXcgcHJvcHNEYXRhCgogICAgdm0uJG9wdGlvbnMucHJvcHNEYXRhID0gcHJvcHNEYXRhOwogIH0gLy8gdXBkYXRlIGxpc3RlbmVycwoKCiAgbGlzdGVuZXJzID0gbGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0OwogIHZhciBvbGRMaXN0ZW5lcnMgPSB2bS4kb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzOwogIHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnMgPSBsaXN0ZW5lcnM7CiAgdXBkYXRlQ29tcG9uZW50TGlzdGVuZXJzKHZtLCBsaXN0ZW5lcnMsIG9sZExpc3RlbmVycyk7IC8vIHJlc29sdmUgc2xvdHMgKyBmb3JjZSB1cGRhdGUgaWYgaGFzIGNoaWxkcmVuCgogIGlmIChuZWVkc0ZvcmNlVXBkYXRlKSB7CiAgICB2bS4kc2xvdHMgPSByZXNvbHZlU2xvdHMocmVuZGVyQ2hpbGRyZW4sIHBhcmVudFZub2RlLmNvbnRleHQpOwogICAgdm0uJGZvcmNlVXBkYXRlKCk7CiAgfQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gZmFsc2U7CiAgfQp9CgpmdW5jdGlvbiBpc0luSW5hY3RpdmVUcmVlKHZtKSB7CiAgd2hpbGUgKHZtICYmICh2bSA9IHZtLiRwYXJlbnQpKSB7CiAgICBpZiAodm0uX2luYWN0aXZlKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KCiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLCBkaXJlY3QpIHsKICBpZiAoZGlyZWN0KSB7CiAgICB2bS5fZGlyZWN0SW5hY3RpdmUgPSBmYWxzZTsKCiAgICBpZiAoaXNJbkluYWN0aXZlVHJlZSh2bSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogIH0gZWxzZSBpZiAodm0uX2RpcmVjdEluYWN0aXZlKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAodm0uX2luYWN0aXZlIHx8IHZtLl9pbmFjdGl2ZSA9PT0gbnVsbCkgewogICAgdm0uX2luYWN0aXZlID0gZmFsc2U7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bS4kY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bS4kY2hpbGRyZW5baV0pOwogICAgfQoKICAgIGNhbGxIb29rKHZtLCAnYWN0aXZhdGVkJyk7CiAgfQp9CgpmdW5jdGlvbiBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0sIGRpcmVjdCkgewogIGlmIChkaXJlY3QpIHsKICAgIHZtLl9kaXJlY3RJbmFjdGl2ZSA9IHRydWU7CgogICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgIHJldHVybjsKICAgIH0KICB9CgogIGlmICghdm0uX2luYWN0aXZlKSB7CiAgICB2bS5faW5hY3RpdmUgPSB0cnVlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm0uJGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGRlYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bS4kY2hpbGRyZW5baV0pOwogICAgfQoKICAgIGNhbGxIb29rKHZtLCAnZGVhY3RpdmF0ZWQnKTsKICB9Cn0KCmZ1bmN0aW9uIGNhbGxIb29rKHZtLCBob29rKSB7CiAgLy8gIzc1NzMgZGlzYWJsZSBkZXAgY29sbGVjdGlvbiB3aGVuIGludm9raW5nIGxpZmVjeWNsZSBob29rcwogIHB1c2hUYXJnZXQoKTsKICB2YXIgaGFuZGxlcnMgPSB2bS4kb3B0aW9uc1tob29rXTsKICB2YXIgaW5mbyA9IGhvb2sgKyAiIGhvb2siOwoKICBpZiAoaGFuZGxlcnMpIHsKICAgIGZvciAodmFyIGkgPSAwLCBqID0gaGFuZGxlcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGhhbmRsZXJzW2ldLCB2bSwgbnVsbCwgdm0sIGluZm8pOwogICAgfQogIH0KCiAgaWYgKHZtLl9oYXNIb29rRXZlbnQpIHsKICAgIHZtLiRlbWl0KCdob29rOicgKyBob29rKTsKICB9CgogIHBvcFRhcmdldCgpOwp9Ci8qICAqLwoKCnZhciBNQVhfVVBEQVRFX0NPVU5UID0gMTAwOwp2YXIgcXVldWUgPSBbXTsKdmFyIGFjdGl2YXRlZENoaWxkcmVuID0gW107CnZhciBoYXMgPSB7fTsKdmFyIGNpcmN1bGFyID0ge307CnZhciB3YWl0aW5nID0gZmFsc2U7CnZhciBmbHVzaGluZyA9IGZhbHNlOwp2YXIgaW5kZXggPSAwOwovKioKICogUmVzZXQgdGhlIHNjaGVkdWxlcidzIHN0YXRlLgogKi8KCmZ1bmN0aW9uIHJlc2V0U2NoZWR1bGVyU3RhdGUoKSB7CiAgaW5kZXggPSBxdWV1ZS5sZW5ndGggPSBhY3RpdmF0ZWRDaGlsZHJlbi5sZW5ndGggPSAwOwogIGhhcyA9IHt9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgY2lyY3VsYXIgPSB7fTsKICB9CgogIHdhaXRpbmcgPSBmbHVzaGluZyA9IGZhbHNlOwp9IC8vIEFzeW5jIGVkZ2UgY2FzZSAjNjU2NiByZXF1aXJlcyBzYXZpbmcgdGhlIHRpbWVzdGFtcCB3aGVuIGV2ZW50IGxpc3RlbmVycyBhcmUKLy8gYXR0YWNoZWQuIEhvd2V2ZXIsIGNhbGxpbmcgcGVyZm9ybWFuY2Uubm93KCkgaGFzIGEgcGVyZiBvdmVyaGVhZCBlc3BlY2lhbGx5Ci8vIGlmIHRoZSBwYWdlIGhhcyB0aG91c2FuZHMgb2YgZXZlbnQgbGlzdGVuZXJzLiBJbnN0ZWFkLCB3ZSB0YWtlIGEgdGltZXN0YW1wCi8vIGV2ZXJ5IHRpbWUgdGhlIHNjaGVkdWxlciBmbHVzaGVzIGFuZCB1c2UgdGhhdCBmb3IgYWxsIGV2ZW50IGxpc3RlbmVycwovLyBhdHRhY2hlZCBkdXJpbmcgdGhhdCBmbHVzaC4KCgp2YXIgY3VycmVudEZsdXNoVGltZXN0YW1wID0gMDsgLy8gQXN5bmMgZWRnZSBjYXNlIGZpeCByZXF1aXJlcyBzdG9yaW5nIGFuIGV2ZW50IGxpc3RlbmVyJ3MgYXR0YWNoIHRpbWVzdGFtcC4KCnZhciBnZXROb3cgPSBEYXRlLm5vdzsgLy8gRGV0ZXJtaW5lIHdoYXQgZXZlbnQgdGltZXN0YW1wIHRoZSBicm93c2VyIGlzIHVzaW5nLiBBbm5veWluZ2x5LCB0aGUKLy8gdGltZXN0YW1wIGNhbiBlaXRoZXIgYmUgaGktcmVzIChyZWxhdGl2ZSB0byBwYWdlIGxvYWQpIG9yIGxvdy1yZXMKLy8gKHJlbGF0aXZlIHRvIFVOSVggZXBvY2gpLCBzbyBpbiBvcmRlciB0byBjb21wYXJlIHRpbWUgd2UgaGF2ZSB0byB1c2UgdGhlCi8vIHNhbWUgdGltZXN0YW1wIHR5cGUgd2hlbiBzYXZpbmcgdGhlIGZsdXNoIHRpbWVzdGFtcC4KLy8gQWxsIElFIHZlcnNpb25zIHVzZSBsb3ctcmVzIGV2ZW50IHRpbWVzdGFtcHMsIGFuZCBoYXZlIHByb2JsZW1hdGljIGNsb2NrCi8vIGltcGxlbWVudGF0aW9ucyAoIzk2MzIpCgppZiAoaW5Ccm93c2VyICYmICFpc0lFKSB7CiAgdmFyIHBlcmZvcm1hbmNlID0gd2luZG93LnBlcmZvcm1hbmNlOwoKICBpZiAocGVyZm9ybWFuY2UgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gJ2Z1bmN0aW9uJyAmJiBnZXROb3coKSA+IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdFdmVudCcpLnRpbWVTdGFtcCkgewogICAgLy8gaWYgdGhlIGV2ZW50IHRpbWVzdGFtcCwgYWx0aG91Z2ggZXZhbHVhdGVkIEFGVEVSIHRoZSBEYXRlLm5vdygpLCBpcwogICAgLy8gc21hbGxlciB0aGFuIGl0LCBpdCBtZWFucyB0aGUgZXZlbnQgaXMgdXNpbmcgYSBoaS1yZXMgdGltZXN0YW1wLAogICAgLy8gYW5kIHdlIG5lZWQgdG8gdXNlIHRoZSBoaS1yZXMgdmVyc2lvbiBmb3IgZXZlbnQgbGlzdGVuZXIgdGltZXN0YW1wcyBhcwogICAgLy8gd2VsbC4KICAgIGdldE5vdyA9IGZ1bmN0aW9uIGdldE5vdygpIHsKICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpOwogICAgfTsKICB9Cn0KLyoqCiAqIEZsdXNoIGJvdGggcXVldWVzIGFuZCBydW4gdGhlIHdhdGNoZXJzLgogKi8KCgpmdW5jdGlvbiBmbHVzaFNjaGVkdWxlclF1ZXVlKCkgewogIGN1cnJlbnRGbHVzaFRpbWVzdGFtcCA9IGdldE5vdygpOwogIGZsdXNoaW5nID0gdHJ1ZTsKICB2YXIgd2F0Y2hlciwgaWQ7IC8vIFNvcnQgcXVldWUgYmVmb3JlIGZsdXNoLgogIC8vIFRoaXMgZW5zdXJlcyB0aGF0OgogIC8vIDEuIENvbXBvbmVudHMgYXJlIHVwZGF0ZWQgZnJvbSBwYXJlbnQgdG8gY2hpbGQuIChiZWNhdXNlIHBhcmVudCBpcyBhbHdheXMKICAvLyAgICBjcmVhdGVkIGJlZm9yZSB0aGUgY2hpbGQpCiAgLy8gMi4gQSBjb21wb25lbnQncyB1c2VyIHdhdGNoZXJzIGFyZSBydW4gYmVmb3JlIGl0cyByZW5kZXIgd2F0Y2hlciAoYmVjYXVzZQogIC8vICAgIHVzZXIgd2F0Y2hlcnMgYXJlIGNyZWF0ZWQgYmVmb3JlIHRoZSByZW5kZXIgd2F0Y2hlcikKICAvLyAzLiBJZiBhIGNvbXBvbmVudCBpcyBkZXN0cm95ZWQgZHVyaW5nIGEgcGFyZW50IGNvbXBvbmVudCdzIHdhdGNoZXIgcnVuLAogIC8vICAgIGl0cyB3YXRjaGVycyBjYW4gYmUgc2tpcHBlZC4KCiAgcXVldWUuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIGEuaWQgLSBiLmlkOwogIH0pOyAvLyBkbyBub3QgY2FjaGUgbGVuZ3RoIGJlY2F1c2UgbW9yZSB3YXRjaGVycyBtaWdodCBiZSBwdXNoZWQKICAvLyBhcyB3ZSBydW4gZXhpc3Rpbmcgd2F0Y2hlcnMKCiAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgcXVldWUubGVuZ3RoOyBpbmRleCsrKSB7CiAgICB3YXRjaGVyID0gcXVldWVbaW5kZXhdOwoKICAgIGlmICh3YXRjaGVyLmJlZm9yZSkgewogICAgICB3YXRjaGVyLmJlZm9yZSgpOwogICAgfQoKICAgIGlkID0gd2F0Y2hlci5pZDsKICAgIGhhc1tpZF0gPSBudWxsOwogICAgd2F0Y2hlci5ydW4oKTsgLy8gaW4gZGV2IGJ1aWxkLCBjaGVjayBhbmQgc3RvcCBjaXJjdWxhciB1cGRhdGVzLgoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGhhc1tpZF0gIT0gbnVsbCkgewogICAgICBjaXJjdWxhcltpZF0gPSAoY2lyY3VsYXJbaWRdIHx8IDApICsgMTsKCiAgICAgIGlmIChjaXJjdWxhcltpZF0gPiBNQVhfVVBEQVRFX0NPVU5UKSB7CiAgICAgICAgd2FybignWW91IG1heSBoYXZlIGFuIGluZmluaXRlIHVwZGF0ZSBsb29wICcgKyAod2F0Y2hlci51c2VyID8gImluIHdhdGNoZXIgd2l0aCBleHByZXNzaW9uIFwiIiArIHdhdGNoZXIuZXhwcmVzc2lvbiArICJcIiIgOiAiaW4gYSBjb21wb25lbnQgcmVuZGVyIGZ1bmN0aW9uLiIpLCB3YXRjaGVyLnZtKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0gLy8ga2VlcCBjb3BpZXMgb2YgcG9zdCBxdWV1ZXMgYmVmb3JlIHJlc2V0dGluZyBzdGF0ZQoKCiAgdmFyIGFjdGl2YXRlZFF1ZXVlID0gYWN0aXZhdGVkQ2hpbGRyZW4uc2xpY2UoKTsKICB2YXIgdXBkYXRlZFF1ZXVlID0gcXVldWUuc2xpY2UoKTsKICByZXNldFNjaGVkdWxlclN0YXRlKCk7IC8vIGNhbGwgY29tcG9uZW50IHVwZGF0ZWQgYW5kIGFjdGl2YXRlZCBob29rcwoKICBjYWxsQWN0aXZhdGVkSG9va3MoYWN0aXZhdGVkUXVldWUpOwogIGNhbGxVcGRhdGVkSG9va3ModXBkYXRlZFF1ZXVlKTsgLy8gZGV2dG9vbCBob29rCgogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAoZGV2dG9vbHMgJiYgY29uZmlnLmRldnRvb2xzKSB7CiAgICBkZXZ0b29scy5lbWl0KCdmbHVzaCcpOwogIH0KfQoKZnVuY3Rpb24gY2FsbFVwZGF0ZWRIb29rcyhxdWV1ZSkgewogIHZhciBpID0gcXVldWUubGVuZ3RoOwoKICB3aGlsZSAoaS0tKSB7CiAgICB2YXIgd2F0Y2hlciA9IHF1ZXVlW2ldOwogICAgdmFyIHZtID0gd2F0Y2hlci52bTsKCiAgICBpZiAodm0uX3dhdGNoZXIgPT09IHdhdGNoZXIgJiYgdm0uX2lzTW91bnRlZCAmJiAhdm0uX2lzRGVzdHJveWVkKSB7CiAgICAgIGNhbGxIb29rKHZtLCAndXBkYXRlZCcpOwogICAgfQogIH0KfQovKioKICogUXVldWUgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCB0aGF0IHdhcyBhY3RpdmF0ZWQgZHVyaW5nIHBhdGNoLgogKiBUaGUgcXVldWUgd2lsbCBiZSBwcm9jZXNzZWQgYWZ0ZXIgdGhlIGVudGlyZSB0cmVlIGhhcyBiZWVuIHBhdGNoZWQuCiAqLwoKCmZ1bmN0aW9uIHF1ZXVlQWN0aXZhdGVkQ29tcG9uZW50KHZtKSB7CiAgLy8gc2V0dGluZyBfaW5hY3RpdmUgdG8gZmFsc2UgaGVyZSBzbyB0aGF0IGEgcmVuZGVyIGZ1bmN0aW9uIGNhbgogIC8vIHJlbHkgb24gY2hlY2tpbmcgd2hldGhlciBpdCdzIGluIGFuIGluYWN0aXZlIHRyZWUgKGUuZy4gcm91dGVyLXZpZXcpCiAgdm0uX2luYWN0aXZlID0gZmFsc2U7CiAgYWN0aXZhdGVkQ2hpbGRyZW4ucHVzaCh2bSk7Cn0KCmZ1bmN0aW9uIGNhbGxBY3RpdmF0ZWRIb29rcyhxdWV1ZSkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgIHF1ZXVlW2ldLl9pbmFjdGl2ZSA9IHRydWU7CiAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHF1ZXVlW2ldLCB0cnVlCiAgICAvKiB0cnVlICovCiAgICApOwogIH0KfQovKioKICogUHVzaCBhIHdhdGNoZXIgaW50byB0aGUgd2F0Y2hlciBxdWV1ZS4KICogSm9icyB3aXRoIGR1cGxpY2F0ZSBJRHMgd2lsbCBiZSBza2lwcGVkIHVubGVzcyBpdCdzCiAqIHB1c2hlZCB3aGVuIHRoZSBxdWV1ZSBpcyBiZWluZyBmbHVzaGVkLgogKi8KCgpmdW5jdGlvbiBxdWV1ZVdhdGNoZXIod2F0Y2hlcikgewogIHZhciBpZCA9IHdhdGNoZXIuaWQ7CgogIGlmIChoYXNbaWRdID09IG51bGwpIHsKICAgIGhhc1tpZF0gPSB0cnVlOwoKICAgIGlmICghZmx1c2hpbmcpIHsKICAgICAgcXVldWUucHVzaCh3YXRjaGVyKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGlmIGFscmVhZHkgZmx1c2hpbmcsIHNwbGljZSB0aGUgd2F0Y2hlciBiYXNlZCBvbiBpdHMgaWQKICAgICAgLy8gaWYgYWxyZWFkeSBwYXN0IGl0cyBpZCwgaXQgd2lsbCBiZSBydW4gbmV4dCBpbW1lZGlhdGVseS4KICAgICAgdmFyIGkgPSBxdWV1ZS5sZW5ndGggLSAxOwoKICAgICAgd2hpbGUgKGkgPiBpbmRleCAmJiBxdWV1ZVtpXS5pZCA+IHdhdGNoZXIuaWQpIHsKICAgICAgICBpLS07CiAgICAgIH0KCiAgICAgIHF1ZXVlLnNwbGljZShpICsgMSwgMCwgd2F0Y2hlcik7CiAgICB9IC8vIHF1ZXVlIHRoZSBmbHVzaAoKCiAgICBpZiAoIXdhaXRpbmcpIHsKICAgICAgd2FpdGluZyA9IHRydWU7CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhY29uZmlnLmFzeW5jKSB7CiAgICAgICAgZmx1c2hTY2hlZHVsZXJRdWV1ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbmV4dFRpY2soZmx1c2hTY2hlZHVsZXJRdWV1ZSk7CiAgICB9CiAgfQp9Ci8qICAqLwoKCnZhciB1aWQkMiA9IDA7Ci8qKgogKiBBIHdhdGNoZXIgcGFyc2VzIGFuIGV4cHJlc3Npb24sIGNvbGxlY3RzIGRlcGVuZGVuY2llcywKICogYW5kIGZpcmVzIGNhbGxiYWNrIHdoZW4gdGhlIGV4cHJlc3Npb24gdmFsdWUgY2hhbmdlcy4KICogVGhpcyBpcyB1c2VkIGZvciBib3RoIHRoZSAkd2F0Y2goKSBhcGkgYW5kIGRpcmVjdGl2ZXMuCiAqLwoKdmFyIFdhdGNoZXIgPSBmdW5jdGlvbiBXYXRjaGVyKHZtLCBleHBPckZuLCBjYiwgb3B0aW9ucywgaXNSZW5kZXJXYXRjaGVyKSB7CiAgdGhpcy52bSA9IHZtOwoKICBpZiAoaXNSZW5kZXJXYXRjaGVyKSB7CiAgICB2bS5fd2F0Y2hlciA9IHRoaXM7CiAgfQoKICB2bS5fd2F0Y2hlcnMucHVzaCh0aGlzKTsgLy8gb3B0aW9ucwoKCiAgaWYgKG9wdGlvbnMpIHsKICAgIHRoaXMuZGVlcCA9ICEhb3B0aW9ucy5kZWVwOwogICAgdGhpcy51c2VyID0gISFvcHRpb25zLnVzZXI7CiAgICB0aGlzLmxhenkgPSAhIW9wdGlvbnMubGF6eTsKICAgIHRoaXMuc3luYyA9ICEhb3B0aW9ucy5zeW5jOwogICAgdGhpcy5iZWZvcmUgPSBvcHRpb25zLmJlZm9yZTsKICB9IGVsc2UgewogICAgdGhpcy5kZWVwID0gdGhpcy51c2VyID0gdGhpcy5sYXp5ID0gdGhpcy5zeW5jID0gZmFsc2U7CiAgfQoKICB0aGlzLmNiID0gY2I7CiAgdGhpcy5pZCA9ICsrdWlkJDI7IC8vIHVpZCBmb3IgYmF0Y2hpbmcKCiAgdGhpcy5hY3RpdmUgPSB0cnVlOwogIHRoaXMuZGlydHkgPSB0aGlzLmxhenk7IC8vIGZvciBsYXp5IHdhdGNoZXJzCgogIHRoaXMuZGVwcyA9IFtdOwogIHRoaXMubmV3RGVwcyA9IFtdOwogIHRoaXMuZGVwSWRzID0gbmV3IF9TZXQoKTsKICB0aGlzLm5ld0RlcElkcyA9IG5ldyBfU2V0KCk7CiAgdGhpcy5leHByZXNzaW9uID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IGV4cE9yRm4udG9TdHJpbmcoKSA6ICcnOyAvLyBwYXJzZSBleHByZXNzaW9uIGZvciBnZXR0ZXIKCiAgaWYgKHR5cGVvZiBleHBPckZuID09PSAnZnVuY3Rpb24nKSB7CiAgICB0aGlzLmdldHRlciA9IGV4cE9yRm47CiAgfSBlbHNlIHsKICAgIHRoaXMuZ2V0dGVyID0gcGFyc2VQYXRoKGV4cE9yRm4pOwoKICAgIGlmICghdGhpcy5nZXR0ZXIpIHsKICAgICAgdGhpcy5nZXR0ZXIgPSBub29wOwogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkZhaWxlZCB3YXRjaGluZyBwYXRoOiBcIiIgKyBleHBPckZuICsgIlwiICIgKyAnV2F0Y2hlciBvbmx5IGFjY2VwdHMgc2ltcGxlIGRvdC1kZWxpbWl0ZWQgcGF0aHMuICcgKyAnRm9yIGZ1bGwgY29udHJvbCwgdXNlIGEgZnVuY3Rpb24gaW5zdGVhZC4nLCB2bSk7CiAgICB9CiAgfQoKICB0aGlzLnZhbHVlID0gdGhpcy5sYXp5ID8gdW5kZWZpbmVkIDogdGhpcy5nZXQoKTsKfTsKLyoqCiAqIEV2YWx1YXRlIHRoZSBnZXR0ZXIsIGFuZCByZS1jb2xsZWN0IGRlcGVuZGVuY2llcy4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gZ2V0KCkgewogIHB1c2hUYXJnZXQodGhpcyk7CiAgdmFyIHZhbHVlOwogIHZhciB2bSA9IHRoaXMudm07CgogIHRyeSB7CiAgICB2YWx1ZSA9IHRoaXMuZ2V0dGVyLmNhbGwodm0sIHZtKTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAodGhpcy51c2VyKSB7CiAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAiZ2V0dGVyIGZvciB3YXRjaGVyIFwiIiArIHRoaXMuZXhwcmVzc2lvbiArICJcIiIpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgZTsKICAgIH0KICB9IGZpbmFsbHkgewogICAgLy8gInRvdWNoIiBldmVyeSBwcm9wZXJ0eSBzbyB0aGV5IGFyZSBhbGwgdHJhY2tlZCBhcwogICAgLy8gZGVwZW5kZW5jaWVzIGZvciBkZWVwIHdhdGNoaW5nCiAgICBpZiAodGhpcy5kZWVwKSB7CiAgICAgIHRyYXZlcnNlKHZhbHVlKTsKICAgIH0KCiAgICBwb3BUYXJnZXQoKTsKICAgIHRoaXMuY2xlYW51cERlcHMoKTsKICB9CgogIHJldHVybiB2YWx1ZTsKfTsKLyoqCiAqIEFkZCBhIGRlcGVuZGVuY3kgdG8gdGhpcyBkaXJlY3RpdmUuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLmFkZERlcCA9IGZ1bmN0aW9uIGFkZERlcChkZXApIHsKICB2YXIgaWQgPSBkZXAuaWQ7CgogIGlmICghdGhpcy5uZXdEZXBJZHMuaGFzKGlkKSkgewogICAgdGhpcy5uZXdEZXBJZHMuYWRkKGlkKTsKICAgIHRoaXMubmV3RGVwcy5wdXNoKGRlcCk7CgogICAgaWYgKCF0aGlzLmRlcElkcy5oYXMoaWQpKSB7CiAgICAgIGRlcC5hZGRTdWIodGhpcyk7CiAgICB9CiAgfQp9OwovKioKICogQ2xlYW4gdXAgZm9yIGRlcGVuZGVuY3kgY29sbGVjdGlvbi4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUuY2xlYW51cERlcHMgPSBmdW5jdGlvbiBjbGVhbnVwRGVwcygpIHsKICB2YXIgaSA9IHRoaXMuZGVwcy5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHZhciBkZXAgPSB0aGlzLmRlcHNbaV07CgogICAgaWYgKCF0aGlzLm5ld0RlcElkcy5oYXMoZGVwLmlkKSkgewogICAgICBkZXAucmVtb3ZlU3ViKHRoaXMpOwogICAgfQogIH0KCiAgdmFyIHRtcCA9IHRoaXMuZGVwSWRzOwogIHRoaXMuZGVwSWRzID0gdGhpcy5uZXdEZXBJZHM7CiAgdGhpcy5uZXdEZXBJZHMgPSB0bXA7CiAgdGhpcy5uZXdEZXBJZHMuY2xlYXIoKTsKICB0bXAgPSB0aGlzLmRlcHM7CiAgdGhpcy5kZXBzID0gdGhpcy5uZXdEZXBzOwogIHRoaXMubmV3RGVwcyA9IHRtcDsKICB0aGlzLm5ld0RlcHMubGVuZ3RoID0gMDsKfTsKLyoqCiAqIFN1YnNjcmliZXIgaW50ZXJmYWNlLgogKiBXaWxsIGJlIGNhbGxlZCB3aGVuIGEgZGVwZW5kZW5jeSBjaGFuZ2VzLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICBpZiAodGhpcy5sYXp5KSB7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICB9IGVsc2UgaWYgKHRoaXMuc3luYykgewogICAgdGhpcy5ydW4oKTsKICB9IGVsc2UgewogICAgcXVldWVXYXRjaGVyKHRoaXMpOwogIH0KfTsKLyoqCiAqIFNjaGVkdWxlciBqb2IgaW50ZXJmYWNlLgogKiBXaWxsIGJlIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiBydW4oKSB7CiAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICB2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwoKICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSB8fCAvLyBEZWVwIHdhdGNoZXJzIGFuZCB3YXRjaGVycyBvbiBPYmplY3QvQXJyYXlzIHNob3VsZCBmaXJlIGV2ZW4KICAgIC8vIHdoZW4gdGhlIHZhbHVlIGlzIHRoZSBzYW1lLCBiZWNhdXNlIHRoZSB2YWx1ZSBtYXkKICAgIC8vIGhhdmUgbXV0YXRlZC4KICAgIGlzT2JqZWN0KHZhbHVlKSB8fCB0aGlzLmRlZXApIHsKICAgICAgLy8gc2V0IG5ldyB2YWx1ZQogICAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CgogICAgICBpZiAodGhpcy51c2VyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuY2IuY2FsbCh0aGlzLnZtLCB2YWx1ZSwgb2xkVmFsdWUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGhhbmRsZUVycm9yKGUsIHRoaXMudm0sICJjYWxsYmFjayBmb3Igd2F0Y2hlciBcIiIgKyB0aGlzLmV4cHJlc3Npb24gKyAiXCIiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5jYi5jYWxsKHRoaXMudm0sIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgIH0KICAgIH0KICB9Cn07Ci8qKgogKiBFdmFsdWF0ZSB0aGUgdmFsdWUgb2YgdGhlIHdhdGNoZXIuCiAqIFRoaXMgb25seSBnZXRzIGNhbGxlZCBmb3IgbGF6eSB3YXRjaGVycy4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUuZXZhbHVhdGUgPSBmdW5jdGlvbiBldmFsdWF0ZSgpIHsKICB0aGlzLnZhbHVlID0gdGhpcy5nZXQoKTsKICB0aGlzLmRpcnR5ID0gZmFsc2U7Cn07Ci8qKgogKiBEZXBlbmQgb24gYWxsIGRlcHMgY29sbGVjdGVkIGJ5IHRoaXMgd2F0Y2hlci4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gZGVwZW5kKCkgewogIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgdGhpcy5kZXBzW2ldLmRlcGVuZCgpOwogIH0KfTsKLyoqCiAqIFJlbW92ZSBzZWxmIGZyb20gYWxsIGRlcGVuZGVuY2llcycgc3Vic2NyaWJlciBsaXN0LgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS50ZWFyZG93biA9IGZ1bmN0aW9uIHRlYXJkb3duKCkgewogIGlmICh0aGlzLmFjdGl2ZSkgewogICAgLy8gcmVtb3ZlIHNlbGYgZnJvbSB2bSdzIHdhdGNoZXIgbGlzdAogICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IGV4cGVuc2l2ZSBvcGVyYXRpb24gc28gd2Ugc2tpcCBpdAogICAgLy8gaWYgdGhlIHZtIGlzIGJlaW5nIGRlc3Ryb3llZC4KICAgIGlmICghdGhpcy52bS5faXNCZWluZ0Rlc3Ryb3llZCkgewogICAgICByZW1vdmUodGhpcy52bS5fd2F0Y2hlcnMsIHRoaXMpOwogICAgfQoKICAgIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRoaXMuZGVwc1tpXS5yZW1vdmVTdWIodGhpcyk7CiAgICB9CgogICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICB9Cn07Ci8qICAqLwoKCnZhciBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24gPSB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBjb25maWd1cmFibGU6IHRydWUsCiAgZ2V0OiBub29wLAogIHNldDogbm9vcAp9OwoKZnVuY3Rpb24gcHJveHkodGFyZ2V0LCBzb3VyY2VLZXksIGtleSkgewogIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSBmdW5jdGlvbiBwcm94eUdldHRlcigpIHsKICAgIHJldHVybiB0aGlzW3NvdXJjZUtleV1ba2V5XTsKICB9OwoKICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gZnVuY3Rpb24gcHJveHlTZXR0ZXIodmFsKSB7CiAgICB0aGlzW3NvdXJjZUtleV1ba2V5XSA9IHZhbDsKICB9OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIGluaXRTdGF0ZSh2bSkgewogIHZtLl93YXRjaGVycyA9IFtdOwogIHZhciBvcHRzID0gdm0uJG9wdGlvbnM7CgogIGlmIChvcHRzLnByb3BzKSB7CiAgICBpbml0UHJvcHModm0sIG9wdHMucHJvcHMpOwogIH0KCiAgaWYgKG9wdHMubWV0aG9kcykgewogICAgaW5pdE1ldGhvZHModm0sIG9wdHMubWV0aG9kcyk7CiAgfQoKICBpZiAob3B0cy5kYXRhKSB7CiAgICBpbml0RGF0YSh2bSk7CiAgfSBlbHNlIHsKICAgIG9ic2VydmUodm0uX2RhdGEgPSB7fSwgdHJ1ZQogICAgLyogYXNSb290RGF0YSAqLwogICAgKTsKICB9CgogIGlmIChvcHRzLmNvbXB1dGVkKSB7CiAgICBpbml0Q29tcHV0ZWQodm0sIG9wdHMuY29tcHV0ZWQpOwogIH0KCiAgaWYgKG9wdHMud2F0Y2ggJiYgb3B0cy53YXRjaCAhPT0gbmF0aXZlV2F0Y2gpIHsKICAgIGluaXRXYXRjaCh2bSwgb3B0cy53YXRjaCk7CiAgfQp9CgpmdW5jdGlvbiBpbml0UHJvcHModm0sIHByb3BzT3B0aW9ucykgewogIHZhciBwcm9wc0RhdGEgPSB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgfHwge307CiAgdmFyIHByb3BzID0gdm0uX3Byb3BzID0ge307IC8vIGNhY2hlIHByb3Aga2V5cyBzbyB0aGF0IGZ1dHVyZSBwcm9wcyB1cGRhdGVzIGNhbiBpdGVyYXRlIHVzaW5nIEFycmF5CiAgLy8gaW5zdGVhZCBvZiBkeW5hbWljIG9iamVjdCBrZXkgZW51bWVyYXRpb24uCgogIHZhciBrZXlzID0gdm0uJG9wdGlvbnMuX3Byb3BLZXlzID0gW107CiAgdmFyIGlzUm9vdCA9ICF2bS4kcGFyZW50OyAvLyByb290IGluc3RhbmNlIHByb3BzIHNob3VsZCBiZSBjb252ZXJ0ZWQKCiAgaWYgKCFpc1Jvb3QpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgfQoKICB2YXIgbG9vcCA9IGZ1bmN0aW9uIGxvb3Aoa2V5KSB7CiAgICBrZXlzLnB1c2goa2V5KTsKICAgIHZhciB2YWx1ZSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BzT3B0aW9ucywgcHJvcHNEYXRhLCB2bSk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHZhciBoeXBoZW5hdGVkS2V5ID0gaHlwaGVuYXRlKGtleSk7CgogICAgICBpZiAoaXNSZXNlcnZlZEF0dHJpYnV0ZShoeXBoZW5hdGVkS2V5KSB8fCBjb25maWcuaXNSZXNlcnZlZEF0dHIoaHlwaGVuYXRlZEtleSkpIHsKICAgICAgICB3YXJuKCJcIiIgKyBoeXBoZW5hdGVkS2V5ICsgIlwiIGlzIGEgcmVzZXJ2ZWQgYXR0cmlidXRlIGFuZCBjYW5ub3QgYmUgdXNlZCBhcyBjb21wb25lbnQgcHJvcC4iLCB2bSk7CiAgICAgIH0KCiAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHByb3BzLCBrZXksIHZhbHVlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKCFpc1Jvb3QgJiYgIWlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCkgewogICAgICAgICAgd2FybigiQXZvaWQgbXV0YXRpbmcgYSBwcm9wIGRpcmVjdGx5IHNpbmNlIHRoZSB2YWx1ZSB3aWxsIGJlICIgKyAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHBhcmVudCBjb21wb25lbnQgcmUtcmVuZGVycy4gIiArICJJbnN0ZWFkLCB1c2UgYSBkYXRhIG9yIGNvbXB1dGVkIHByb3BlcnR5IGJhc2VkIG9uIHRoZSBwcm9wJ3MgIiArICJ2YWx1ZS4gUHJvcCBiZWluZyBtdXRhdGVkOiBcIiIgKyBrZXkgKyAiXCIiLCB2bSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHByb3BzLCBrZXksIHZhbHVlKTsKICAgIH0gLy8gc3RhdGljIHByb3BzIGFyZSBhbHJlYWR5IHByb3hpZWQgb24gdGhlIGNvbXBvbmVudCdzIHByb3RvdHlwZQogICAgLy8gZHVyaW5nIFZ1ZS5leHRlbmQoKS4gV2Ugb25seSBuZWVkIHRvIHByb3h5IHByb3BzIGRlZmluZWQgYXQKICAgIC8vIGluc3RhbnRpYXRpb24gaGVyZS4KCgogICAgaWYgKCEoa2V5IGluIHZtKSkgewogICAgICBwcm94eSh2bSwgIl9wcm9wcyIsIGtleSk7CiAgICB9CiAgfTsKCiAgZm9yICh2YXIga2V5IGluIHByb3BzT3B0aW9ucykgewogICAgbG9vcChrZXkpOwogIH0KCiAgdG9nZ2xlT2JzZXJ2aW5nKHRydWUpOwp9CgpmdW5jdGlvbiBpbml0RGF0YSh2bSkgewogIHZhciBkYXRhID0gdm0uJG9wdGlvbnMuZGF0YTsKICBkYXRhID0gdm0uX2RhdGEgPSB0eXBlb2YgZGF0YSA9PT0gJ2Z1bmN0aW9uJyA/IGdldERhdGEoZGF0YSwgdm0pIDogZGF0YSB8fCB7fTsKCiAgaWYgKCFpc1BsYWluT2JqZWN0KGRhdGEpKSB7CiAgICBkYXRhID0ge307CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ2RhdGEgZnVuY3Rpb25zIHNob3VsZCByZXR1cm4gYW4gb2JqZWN0OlxuJyArICdodHRwczovL3Z1ZWpzLm9yZy92Mi9ndWlkZS9jb21wb25lbnRzLmh0bWwjZGF0YS1NdXN0LUJlLWEtRnVuY3Rpb24nLCB2bSk7CiAgfSAvLyBwcm94eSBkYXRhIG9uIGluc3RhbmNlCgoKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRhdGEpOwogIHZhciBwcm9wcyA9IHZtLiRvcHRpb25zLnByb3BzOwogIHZhciBtZXRob2RzID0gdm0uJG9wdGlvbnMubWV0aG9kczsKICB2YXIgaSA9IGtleXMubGVuZ3RoOwoKICB3aGlsZSAoaS0tKSB7CiAgICB2YXIga2V5ID0ga2V5c1tpXTsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAobWV0aG9kcyAmJiBoYXNPd24obWV0aG9kcywga2V5KSkgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGFzIGEgZGF0YSBwcm9wZXJ0eS4iLCB2bSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocHJvcHMgJiYgaGFzT3duKHByb3BzLCBrZXkpKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiVGhlIGRhdGEgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIGlzIGFscmVhZHkgZGVjbGFyZWQgYXMgYSBwcm9wLiAiICsgIlVzZSBwcm9wIGRlZmF1bHQgdmFsdWUgaW5zdGVhZC4iLCB2bSk7CiAgICB9IGVsc2UgaWYgKCFpc1Jlc2VydmVkKGtleSkpIHsKICAgICAgcHJveHkodm0sICJfZGF0YSIsIGtleSk7CiAgICB9CiAgfSAvLyBvYnNlcnZlIGRhdGEKCgogIG9ic2VydmUoZGF0YSwgdHJ1ZQogIC8qIGFzUm9vdERhdGEgKi8KICApOwp9CgpmdW5jdGlvbiBnZXREYXRhKGRhdGEsIHZtKSB7CiAgLy8gIzc1NzMgZGlzYWJsZSBkZXAgY29sbGVjdGlvbiB3aGVuIGludm9raW5nIGRhdGEgZ2V0dGVycwogIHB1c2hUYXJnZXQoKTsKCiAgdHJ5IHsKICAgIHJldHVybiBkYXRhLmNhbGwodm0sIHZtKTsKICB9IGNhdGNoIChlKSB7CiAgICBoYW5kbGVFcnJvcihlLCB2bSwgImRhdGEoKSIpOwogICAgcmV0dXJuIHt9OwogIH0gZmluYWxseSB7CiAgICBwb3BUYXJnZXQoKTsKICB9Cn0KCnZhciBjb21wdXRlZFdhdGNoZXJPcHRpb25zID0gewogIGxhenk6IHRydWUKfTsKCmZ1bmN0aW9uIGluaXRDb21wdXRlZCh2bSwgY29tcHV0ZWQpIHsKICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICB2YXIgd2F0Y2hlcnMgPSB2bS5fY29tcHV0ZWRXYXRjaGVycyA9IE9iamVjdC5jcmVhdGUobnVsbCk7IC8vIGNvbXB1dGVkIHByb3BlcnRpZXMgYXJlIGp1c3QgZ2V0dGVycyBkdXJpbmcgU1NSCgogIHZhciBpc1NTUiA9IGlzU2VydmVyUmVuZGVyaW5nKCk7CgogIGZvciAodmFyIGtleSBpbiBjb21wdXRlZCkgewogICAgdmFyIHVzZXJEZWYgPSBjb21wdXRlZFtrZXldOwogICAgdmFyIGdldHRlciA9IHR5cGVvZiB1c2VyRGVmID09PSAnZnVuY3Rpb24nID8gdXNlckRlZiA6IHVzZXJEZWYuZ2V0OwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGdldHRlciA9PSBudWxsKSB7CiAgICAgIHdhcm4oIkdldHRlciBpcyBtaXNzaW5nIGZvciBjb21wdXRlZCBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIuIiwgdm0pOwogICAgfQoKICAgIGlmICghaXNTU1IpIHsKICAgICAgLy8gY3JlYXRlIGludGVybmFsIHdhdGNoZXIgZm9yIHRoZSBjb21wdXRlZCBwcm9wZXJ0eS4KICAgICAgd2F0Y2hlcnNba2V5XSA9IG5ldyBXYXRjaGVyKHZtLCBnZXR0ZXIgfHwgbm9vcCwgbm9vcCwgY29tcHV0ZWRXYXRjaGVyT3B0aW9ucyk7CiAgICB9IC8vIGNvbXBvbmVudC1kZWZpbmVkIGNvbXB1dGVkIHByb3BlcnRpZXMgYXJlIGFscmVhZHkgZGVmaW5lZCBvbiB0aGUKICAgIC8vIGNvbXBvbmVudCBwcm90b3R5cGUuIFdlIG9ubHkgbmVlZCB0byBkZWZpbmUgY29tcHV0ZWQgcHJvcGVydGllcyBkZWZpbmVkCiAgICAvLyBhdCBpbnN0YW50aWF0aW9uIGhlcmUuCgoKICAgIGlmICghKGtleSBpbiB2bSkpIHsKICAgICAgZGVmaW5lQ29tcHV0ZWQodm0sIGtleSwgdXNlckRlZik7CiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKGtleSBpbiB2bS4kZGF0YSkgewogICAgICAgIHdhcm4oIlRoZSBjb21wdXRlZCBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgaXMgYWxyZWFkeSBkZWZpbmVkIGluIGRhdGEuIiwgdm0pOwogICAgICB9IGVsc2UgaWYgKHZtLiRvcHRpb25zLnByb3BzICYmIGtleSBpbiB2bS4kb3B0aW9ucy5wcm9wcykgewogICAgICAgIHdhcm4oIlRoZSBjb21wdXRlZCBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgaXMgYWxyZWFkeSBkZWZpbmVkIGFzIGEgcHJvcC4iLCB2bSk7CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGRlZmluZUNvbXB1dGVkKHRhcmdldCwga2V5LCB1c2VyRGVmKSB7CiAgdmFyIHNob3VsZENhY2hlID0gIWlzU2VydmVyUmVuZGVyaW5nKCk7CgogIGlmICh0eXBlb2YgdXNlckRlZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IHNob3VsZENhY2hlID8gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIoa2V5KSA6IGNyZWF0ZUdldHRlckludm9rZXIodXNlckRlZik7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gbm9vcDsKICB9IGVsc2UgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IHVzZXJEZWYuZ2V0ID8gc2hvdWxkQ2FjaGUgJiYgdXNlckRlZi5jYWNoZSAhPT0gZmFsc2UgPyBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpIDogY3JlYXRlR2V0dGVySW52b2tlcih1c2VyRGVmLmdldCkgOiBub29wOwogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IHVzZXJEZWYuc2V0IHx8IG5vb3A7CiAgfQoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID09PSBub29wKSB7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCJDb21wdXRlZCBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgd2FzIGFzc2lnbmVkIHRvIGJ1dCBpdCBoYXMgbm8gc2V0dGVyLiIsIHRoaXMpOwogICAgfTsKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uKTsKfQoKZnVuY3Rpb24gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIoa2V5KSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyKCkgewogICAgdmFyIHdhdGNoZXIgPSB0aGlzLl9jb21wdXRlZFdhdGNoZXJzICYmIHRoaXMuX2NvbXB1dGVkV2F0Y2hlcnNba2V5XTsKCiAgICBpZiAod2F0Y2hlcikgewogICAgICBpZiAod2F0Y2hlci5kaXJ0eSkgewogICAgICAgIHdhdGNoZXIuZXZhbHVhdGUoKTsKICAgICAgfQoKICAgICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgICB3YXRjaGVyLmRlcGVuZCgpOwogICAgICB9CgogICAgICByZXR1cm4gd2F0Y2hlci52YWx1ZTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVHZXR0ZXJJbnZva2VyKGZuKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyKCkgewogICAgcmV0dXJuIGZuLmNhbGwodGhpcywgdGhpcyk7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdE1ldGhvZHModm0sIG1ldGhvZHMpIHsKICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKCiAgZm9yICh2YXIga2V5IGluIG1ldGhvZHMpIHsKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmICh0eXBlb2YgbWV0aG9kc1trZXldICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIiArIGtleSArICJcIiBoYXMgdHlwZSBcIiIgKyBfdHlwZW9mKG1ldGhvZHNba2V5XSkgKyAiXCIgaW4gdGhlIGNvbXBvbmVudCBkZWZpbml0aW9uLiAiICsgIkRpZCB5b3UgcmVmZXJlbmNlIHRoZSBmdW5jdGlvbiBjb3JyZWN0bHk/Iiwgdm0pOwogICAgICB9CgogICAgICBpZiAocHJvcHMgJiYgaGFzT3duKHByb3BzLCBrZXkpKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIiArIGtleSArICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBwcm9wLiIsIHZtKTsKICAgICAgfQoKICAgICAgaWYgKGtleSBpbiB2bSAmJiBpc1Jlc2VydmVkKGtleSkpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiICsga2V5ICsgIlwiIGNvbmZsaWN0cyB3aXRoIGFuIGV4aXN0aW5nIFZ1ZSBpbnN0YW5jZSBtZXRob2QuICIgKyAiQXZvaWQgZGVmaW5pbmcgY29tcG9uZW50IG1ldGhvZHMgdGhhdCBzdGFydCB3aXRoIF8gb3IgJC4iKTsKICAgICAgfQogICAgfQoKICAgIHZtW2tleV0gPSB0eXBlb2YgbWV0aG9kc1trZXldICE9PSAnZnVuY3Rpb24nID8gbm9vcCA6IGJpbmQobWV0aG9kc1trZXldLCB2bSk7CiAgfQp9CgpmdW5jdGlvbiBpbml0V2F0Y2godm0sIHdhdGNoKSB7CiAgZm9yICh2YXIga2V5IGluIHdhdGNoKSB7CiAgICB2YXIgaGFuZGxlciA9IHdhdGNoW2tleV07CgogICAgaWYgKEFycmF5LmlzQXJyYXkoaGFuZGxlcikpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYW5kbGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY3JlYXRlV2F0Y2hlcih2bSwga2V5LCBoYW5kbGVyW2ldKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY3JlYXRlV2F0Y2hlcih2bSwga2V5LCBoYW5kbGVyKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGhhbmRsZXIsIG9wdGlvbnMpIHsKICBpZiAoaXNQbGFpbk9iamVjdChoYW5kbGVyKSkgewogICAgb3B0aW9ucyA9IGhhbmRsZXI7CiAgICBoYW5kbGVyID0gaGFuZGxlci5oYW5kbGVyOwogIH0KCiAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnc3RyaW5nJykgewogICAgaGFuZGxlciA9IHZtW2hhbmRsZXJdOwogIH0KCiAgcmV0dXJuIHZtLiR3YXRjaChleHBPckZuLCBoYW5kbGVyLCBvcHRpb25zKTsKfQoKZnVuY3Rpb24gc3RhdGVNaXhpbihWdWUpIHsKICAvLyBmbG93IHNvbWVob3cgaGFzIHByb2JsZW1zIHdpdGggZGlyZWN0bHkgZGVjbGFyZWQgZGVmaW5pdGlvbiBvYmplY3QKICAvLyB3aGVuIHVzaW5nIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwgc28gd2UgaGF2ZSB0byBwcm9jZWR1cmFsbHkgYnVpbGQgdXAKICAvLyB0aGUgb2JqZWN0IGhlcmUuCiAgdmFyIGRhdGFEZWYgPSB7fTsKCiAgZGF0YURlZi5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZGF0YTsKICB9OwoKICB2YXIgcHJvcHNEZWYgPSB7fTsKCiAgcHJvcHNEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3Byb3BzOwogIH07CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBkYXRhRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybignQXZvaWQgcmVwbGFjaW5nIGluc3RhbmNlIHJvb3QgJGRhdGEuICcgKyAnVXNlIG5lc3RlZCBkYXRhIHByb3BlcnRpZXMgaW5zdGVhZC4nLCB0aGlzKTsKICAgIH07CgogICAgcHJvcHNEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCIkcHJvcHMgaXMgcmVhZG9ubHkuIiwgdGhpcyk7CiAgICB9OwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckZGF0YScsIGRhdGFEZWYpOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHByb3BzJywgcHJvcHNEZWYpOwogIFZ1ZS5wcm90b3R5cGUuJHNldCA9IHNldDsKICBWdWUucHJvdG90eXBlLiRkZWxldGUgPSBkZWw7CgogIFZ1ZS5wcm90b3R5cGUuJHdhdGNoID0gZnVuY3Rpb24gKGV4cE9yRm4sIGNiLCBvcHRpb25zKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmIChpc1BsYWluT2JqZWN0KGNiKSkgewogICAgICByZXR1cm4gY3JlYXRlV2F0Y2hlcih2bSwgZXhwT3JGbiwgY2IsIG9wdGlvbnMpOwogICAgfQoKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgb3B0aW9ucy51c2VyID0gdHJ1ZTsKICAgIHZhciB3YXRjaGVyID0gbmV3IFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy5pbW1lZGlhdGUpIHsKICAgICAgdHJ5IHsKICAgICAgICBjYi5jYWxsKHZtLCB3YXRjaGVyLnZhbHVlKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBoYW5kbGVFcnJvcihlcnJvciwgdm0sICJjYWxsYmFjayBmb3IgaW1tZWRpYXRlIHdhdGNoZXIgXCIiICsgd2F0Y2hlci5leHByZXNzaW9uICsgIlwiIik7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gdW53YXRjaEZuKCkgewogICAgICB3YXRjaGVyLnRlYXJkb3duKCk7CiAgICB9OwogIH07Cn0KLyogICovCgoKdmFyIHVpZCQzID0gMDsKCmZ1bmN0aW9uIGluaXRNaXhpbihWdWUpIHsKICBWdWUucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgIHZhciB2bSA9IHRoaXM7IC8vIGEgdWlkCgogICAgdm0uX3VpZCA9IHVpZCQzKys7CiAgICB2YXIgc3RhcnRUYWcsIGVuZFRhZzsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgIHN0YXJ0VGFnID0gInZ1ZS1wZXJmLXN0YXJ0OiIgKyB2bS5fdWlkOwogICAgICBlbmRUYWcgPSAidnVlLXBlcmYtZW5kOiIgKyB2bS5fdWlkOwogICAgICBtYXJrKHN0YXJ0VGFnKTsKICAgIH0gLy8gYSBmbGFnIHRvIGF2b2lkIHRoaXMgYmVpbmcgb2JzZXJ2ZWQKCgogICAgdm0uX2lzVnVlID0gdHJ1ZTsgLy8gbWVyZ2Ugb3B0aW9ucwoKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuX2lzQ29tcG9uZW50KSB7CiAgICAgIC8vIG9wdGltaXplIGludGVybmFsIGNvbXBvbmVudCBpbnN0YW50aWF0aW9uCiAgICAgIC8vIHNpbmNlIGR5bmFtaWMgb3B0aW9ucyBtZXJnaW5nIGlzIHByZXR0eSBzbG93LCBhbmQgbm9uZSBvZiB0aGUKICAgICAgLy8gaW50ZXJuYWwgY29tcG9uZW50IG9wdGlvbnMgbmVlZHMgc3BlY2lhbCB0cmVhdG1lbnQuCiAgICAgIGluaXRJbnRlcm5hbENvbXBvbmVudCh2bSwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICB2bS4kb3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhyZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKHZtLmNvbnN0cnVjdG9yKSwgb3B0aW9ucyB8fCB7fSwgdm0pOwogICAgfQogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaW5pdFByb3h5KHZtKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLl9yZW5kZXJQcm94eSA9IHZtOwogICAgfSAvLyBleHBvc2UgcmVhbCBzZWxmCgoKICAgIHZtLl9zZWxmID0gdm07CiAgICBpbml0TGlmZWN5Y2xlKHZtKTsKICAgIGluaXRFdmVudHModm0pOwogICAgaW5pdFJlbmRlcih2bSk7CiAgICBjYWxsSG9vayh2bSwgJ2JlZm9yZUNyZWF0ZScpOwogICAgaW5pdEluamVjdGlvbnModm0pOyAvLyByZXNvbHZlIGluamVjdGlvbnMgYmVmb3JlIGRhdGEvcHJvcHMKCiAgICBpbml0U3RhdGUodm0pOwogICAgaW5pdFByb3ZpZGUodm0pOyAvLyByZXNvbHZlIHByb3ZpZGUgYWZ0ZXIgZGF0YS9wcm9wcwoKICAgIGNhbGxIb29rKHZtLCAnY3JlYXRlZCcpOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgdm0uX25hbWUgPSBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBmYWxzZSk7CiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIgKyB2bS5fbmFtZSArICIgaW5pdCIsIHN0YXJ0VGFnLCBlbmRUYWcpOwogICAgfQoKICAgIGlmICh2bS4kb3B0aW9ucy5lbCkgewogICAgICB2bS4kbW91bnQodm0uJG9wdGlvbnMuZWwpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGluaXRJbnRlcm5hbENvbXBvbmVudCh2bSwgb3B0aW9ucykgewogIHZhciBvcHRzID0gdm0uJG9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKHZtLmNvbnN0cnVjdG9yLm9wdGlvbnMpOyAvLyBkb2luZyB0aGlzIGJlY2F1c2UgaXQncyBmYXN0ZXIgdGhhbiBkeW5hbWljIGVudW1lcmF0aW9uLgoKICB2YXIgcGFyZW50Vm5vZGUgPSBvcHRpb25zLl9wYXJlbnRWbm9kZTsKICBvcHRzLnBhcmVudCA9IG9wdGlvbnMucGFyZW50OwogIG9wdHMuX3BhcmVudFZub2RlID0gcGFyZW50Vm5vZGU7CiAgdmFyIHZub2RlQ29tcG9uZW50T3B0aW9ucyA9IHBhcmVudFZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgb3B0cy5wcm9wc0RhdGEgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMucHJvcHNEYXRhOwogIG9wdHMuX3BhcmVudExpc3RlbmVycyA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5saXN0ZW5lcnM7CiAgb3B0cy5fcmVuZGVyQ2hpbGRyZW4gPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMuY2hpbGRyZW47CiAgb3B0cy5fY29tcG9uZW50VGFnID0gdm5vZGVDb21wb25lbnRPcHRpb25zLnRhZzsKCiAgaWYgKG9wdGlvbnMucmVuZGVyKSB7CiAgICBvcHRzLnJlbmRlciA9IG9wdGlvbnMucmVuZGVyOwogICAgb3B0cy5zdGF0aWNSZW5kZXJGbnMgPSBvcHRpb25zLnN0YXRpY1JlbmRlckZuczsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMoQ3RvcikgewogIHZhciBvcHRpb25zID0gQ3Rvci5vcHRpb25zOwoKICBpZiAoQ3Rvclsic3VwZXIiXSkgewogICAgdmFyIHN1cGVyT3B0aW9ucyA9IHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMoQ3Rvclsic3VwZXIiXSk7CiAgICB2YXIgY2FjaGVkU3VwZXJPcHRpb25zID0gQ3Rvci5zdXBlck9wdGlvbnM7CgogICAgaWYgKHN1cGVyT3B0aW9ucyAhPT0gY2FjaGVkU3VwZXJPcHRpb25zKSB7CiAgICAgIC8vIHN1cGVyIG9wdGlvbiBjaGFuZ2VkLAogICAgICAvLyBuZWVkIHRvIHJlc29sdmUgbmV3IG9wdGlvbnMuCiAgICAgIEN0b3Iuc3VwZXJPcHRpb25zID0gc3VwZXJPcHRpb25zOyAvLyBjaGVjayBpZiB0aGVyZSBhcmUgYW55IGxhdGUtbW9kaWZpZWQvYXR0YWNoZWQgb3B0aW9ucyAoIzQ5NzYpCgogICAgICB2YXIgbW9kaWZpZWRPcHRpb25zID0gcmVzb2x2ZU1vZGlmaWVkT3B0aW9ucyhDdG9yKTsgLy8gdXBkYXRlIGJhc2UgZXh0ZW5kIG9wdGlvbnMKCiAgICAgIGlmIChtb2RpZmllZE9wdGlvbnMpIHsKICAgICAgICBleHRlbmQoQ3Rvci5leHRlbmRPcHRpb25zLCBtb2RpZmllZE9wdGlvbnMpOwogICAgICB9CgogICAgICBvcHRpb25zID0gQ3Rvci5vcHRpb25zID0gbWVyZ2VPcHRpb25zKHN1cGVyT3B0aW9ucywgQ3Rvci5leHRlbmRPcHRpb25zKTsKCiAgICAgIGlmIChvcHRpb25zLm5hbWUpIHsKICAgICAgICBvcHRpb25zLmNvbXBvbmVudHNbb3B0aW9ucy5uYW1lXSA9IEN0b3I7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBvcHRpb25zOwp9CgpmdW5jdGlvbiByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpIHsKICB2YXIgbW9kaWZpZWQ7CiAgdmFyIGxhdGVzdCA9IEN0b3Iub3B0aW9uczsKICB2YXIgc2VhbGVkID0gQ3Rvci5zZWFsZWRPcHRpb25zOwoKICBmb3IgKHZhciBrZXkgaW4gbGF0ZXN0KSB7CiAgICBpZiAobGF0ZXN0W2tleV0gIT09IHNlYWxlZFtrZXldKSB7CiAgICAgIGlmICghbW9kaWZpZWQpIHsKICAgICAgICBtb2RpZmllZCA9IHt9OwogICAgICB9CgogICAgICBtb2RpZmllZFtrZXldID0gbGF0ZXN0W2tleV07CiAgICB9CiAgfQoKICByZXR1cm4gbW9kaWZpZWQ7Cn0KCmZ1bmN0aW9uIFZ1ZShvcHRpb25zKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgISh0aGlzIGluc3RhbmNlb2YgVnVlKSkgewogICAgd2FybignVnVlIGlzIGEgY29uc3RydWN0b3IgYW5kIHNob3VsZCBiZSBjYWxsZWQgd2l0aCB0aGUgYG5ld2Aga2V5d29yZCcpOwogIH0KCiAgdGhpcy5faW5pdChvcHRpb25zKTsKfQoKaW5pdE1peGluKFZ1ZSk7CnN0YXRlTWl4aW4oVnVlKTsKZXZlbnRzTWl4aW4oVnVlKTsKbGlmZWN5Y2xlTWl4aW4oVnVlKTsKcmVuZGVyTWl4aW4oVnVlKTsKLyogICovCgpmdW5jdGlvbiBpbml0VXNlKFZ1ZSkgewogIFZ1ZS51c2UgPSBmdW5jdGlvbiAocGx1Z2luKSB7CiAgICB2YXIgaW5zdGFsbGVkUGx1Z2lucyA9IHRoaXMuX2luc3RhbGxlZFBsdWdpbnMgfHwgKHRoaXMuX2luc3RhbGxlZFBsdWdpbnMgPSBbXSk7CgogICAgaWYgKGluc3RhbGxlZFBsdWdpbnMuaW5kZXhPZihwbHVnaW4pID4gLTEpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IC8vIGFkZGl0aW9uYWwgcGFyYW1ldGVycwoKCiAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzLCAxKTsKICAgIGFyZ3MudW5zaGlmdCh0aGlzKTsKCiAgICBpZiAodHlwZW9mIHBsdWdpbi5pbnN0YWxsID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHBsdWdpbi5pbnN0YWxsLmFwcGx5KHBsdWdpbiwgYXJncyk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwbHVnaW4gPT09ICdmdW5jdGlvbicpIHsKICAgICAgcGx1Z2luLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgfQoKICAgIGluc3RhbGxlZFBsdWdpbnMucHVzaChwbHVnaW4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0TWl4aW4kMShWdWUpIHsKICBWdWUubWl4aW4gPSBmdW5jdGlvbiAobWl4aW4pIHsKICAgIHRoaXMub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyh0aGlzLm9wdGlvbnMsIG1peGluKTsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KLyogICovCgoKZnVuY3Rpb24gaW5pdEV4dGVuZChWdWUpIHsKICAvKioKICAgKiBFYWNoIGluc3RhbmNlIGNvbnN0cnVjdG9yLCBpbmNsdWRpbmcgVnVlLCBoYXMgYSB1bmlxdWUKICAgKiBjaWQuIFRoaXMgZW5hYmxlcyB1cyB0byBjcmVhdGUgd3JhcHBlZCAiY2hpbGQKICAgKiBjb25zdHJ1Y3RvcnMiIGZvciBwcm90b3R5cGFsIGluaGVyaXRhbmNlIGFuZCBjYWNoZSB0aGVtLgogICAqLwogIFZ1ZS5jaWQgPSAwOwogIHZhciBjaWQgPSAxOwogIC8qKgogICAqIENsYXNzIGluaGVyaXRhbmNlCiAgICovCgogIFZ1ZS5leHRlbmQgPSBmdW5jdGlvbiAoZXh0ZW5kT3B0aW9ucykgewogICAgZXh0ZW5kT3B0aW9ucyA9IGV4dGVuZE9wdGlvbnMgfHwge307CiAgICB2YXIgU3VwZXIgPSB0aGlzOwogICAgdmFyIFN1cGVySWQgPSBTdXBlci5jaWQ7CiAgICB2YXIgY2FjaGVkQ3RvcnMgPSBleHRlbmRPcHRpb25zLl9DdG9yIHx8IChleHRlbmRPcHRpb25zLl9DdG9yID0ge30pOwoKICAgIGlmIChjYWNoZWRDdG9yc1tTdXBlcklkXSkgewogICAgICByZXR1cm4gY2FjaGVkQ3RvcnNbU3VwZXJJZF07CiAgICB9CgogICAgdmFyIG5hbWUgPSBleHRlbmRPcHRpb25zLm5hbWUgfHwgU3VwZXIub3B0aW9ucy5uYW1lOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIG5hbWUpIHsKICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKG5hbWUpOwogICAgfQoKICAgIHZhciBTdWIgPSBmdW5jdGlvbiBWdWVDb21wb25lbnQob3B0aW9ucykgewogICAgICB0aGlzLl9pbml0KG9wdGlvbnMpOwogICAgfTsKCiAgICBTdWIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdXBlci5wcm90b3R5cGUpOwogICAgU3ViLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFN1YjsKICAgIFN1Yi5jaWQgPSBjaWQrKzsKICAgIFN1Yi5vcHRpb25zID0gbWVyZ2VPcHRpb25zKFN1cGVyLm9wdGlvbnMsIGV4dGVuZE9wdGlvbnMpOwogICAgU3ViWydzdXBlciddID0gU3VwZXI7IC8vIEZvciBwcm9wcyBhbmQgY29tcHV0ZWQgcHJvcGVydGllcywgd2UgZGVmaW5lIHRoZSBwcm94eSBnZXR0ZXJzIG9uCiAgICAvLyB0aGUgVnVlIGluc3RhbmNlcyBhdCBleHRlbnNpb24gdGltZSwgb24gdGhlIGV4dGVuZGVkIHByb3RvdHlwZS4gVGhpcwogICAgLy8gYXZvaWRzIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSBjYWxscyBmb3IgZWFjaCBpbnN0YW5jZSBjcmVhdGVkLgoKICAgIGlmIChTdWIub3B0aW9ucy5wcm9wcykgewogICAgICBpbml0UHJvcHMkMShTdWIpOwogICAgfQoKICAgIGlmIChTdWIub3B0aW9ucy5jb21wdXRlZCkgewogICAgICBpbml0Q29tcHV0ZWQkMShTdWIpOwogICAgfSAvLyBhbGxvdyBmdXJ0aGVyIGV4dGVuc2lvbi9taXhpbi9wbHVnaW4gdXNhZ2UKCgogICAgU3ViLmV4dGVuZCA9IFN1cGVyLmV4dGVuZDsKICAgIFN1Yi5taXhpbiA9IFN1cGVyLm1peGluOwogICAgU3ViLnVzZSA9IFN1cGVyLnVzZTsgLy8gY3JlYXRlIGFzc2V0IHJlZ2lzdGVycywgc28gZXh0ZW5kZWQgY2xhc3NlcwogICAgLy8gY2FuIGhhdmUgdGhlaXIgcHJpdmF0ZSBhc3NldHMgdG9vLgoKICAgIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgU3ViW3R5cGVdID0gU3VwZXJbdHlwZV07CiAgICB9KTsgLy8gZW5hYmxlIHJlY3Vyc2l2ZSBzZWxmLWxvb2t1cAoKICAgIGlmIChuYW1lKSB7CiAgICAgIFN1Yi5vcHRpb25zLmNvbXBvbmVudHNbbmFtZV0gPSBTdWI7CiAgICB9IC8vIGtlZXAgYSByZWZlcmVuY2UgdG8gdGhlIHN1cGVyIG9wdGlvbnMgYXQgZXh0ZW5zaW9uIHRpbWUuCiAgICAvLyBsYXRlciBhdCBpbnN0YW50aWF0aW9uIHdlIGNhbiBjaGVjayBpZiBTdXBlcidzIG9wdGlvbnMgaGF2ZQogICAgLy8gYmVlbiB1cGRhdGVkLgoKCiAgICBTdWIuc3VwZXJPcHRpb25zID0gU3VwZXIub3B0aW9uczsKICAgIFN1Yi5leHRlbmRPcHRpb25zID0gZXh0ZW5kT3B0aW9uczsKICAgIFN1Yi5zZWFsZWRPcHRpb25zID0gZXh0ZW5kKHt9LCBTdWIub3B0aW9ucyk7IC8vIGNhY2hlIGNvbnN0cnVjdG9yCgogICAgY2FjaGVkQ3RvcnNbU3VwZXJJZF0gPSBTdWI7CiAgICByZXR1cm4gU3ViOwogIH07Cn0KCmZ1bmN0aW9uIGluaXRQcm9wcyQxKENvbXApIHsKICB2YXIgcHJvcHMgPSBDb21wLm9wdGlvbnMucHJvcHM7CgogIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgcHJveHkoQ29tcC5wcm90b3R5cGUsICJfcHJvcHMiLCBrZXkpOwogIH0KfQoKZnVuY3Rpb24gaW5pdENvbXB1dGVkJDEoQ29tcCkgewogIHZhciBjb21wdXRlZCA9IENvbXAub3B0aW9ucy5jb21wdXRlZDsKCiAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICBkZWZpbmVDb21wdXRlZChDb21wLnByb3RvdHlwZSwga2V5LCBjb21wdXRlZFtrZXldKTsKICB9Cn0KLyogICovCgoKZnVuY3Rpb24gaW5pdEFzc2V0UmVnaXN0ZXJzKFZ1ZSkgewogIC8qKgogICAqIENyZWF0ZSBhc3NldCByZWdpc3RyYXRpb24gbWV0aG9kcy4KICAgKi8KICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICBWdWVbdHlwZV0gPSBmdW5jdGlvbiAoaWQsIGRlZmluaXRpb24pIHsKICAgICAgaWYgKCFkZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9uc1t0eXBlICsgJ3MnXVtpZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZSA9PT0gJ2NvbXBvbmVudCcpIHsKICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShpZCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZSA9PT0gJ2NvbXBvbmVudCcgJiYgaXNQbGFpbk9iamVjdChkZWZpbml0aW9uKSkgewogICAgICAgICAgZGVmaW5pdGlvbi5uYW1lID0gZGVmaW5pdGlvbi5uYW1lIHx8IGlkOwogICAgICAgICAgZGVmaW5pdGlvbiA9IHRoaXMub3B0aW9ucy5fYmFzZS5leHRlbmQoZGVmaW5pdGlvbik7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZSA9PT0gJ2RpcmVjdGl2ZScgJiYgdHlwZW9mIGRlZmluaXRpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGRlZmluaXRpb24gPSB7CiAgICAgICAgICAgIGJpbmQ6IGRlZmluaXRpb24sCiAgICAgICAgICAgIHVwZGF0ZTogZGVmaW5pdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHRoaXMub3B0aW9uc1t0eXBlICsgJ3MnXVtpZF0gPSBkZWZpbml0aW9uOwogICAgICAgIHJldHVybiBkZWZpbml0aW9uOwogICAgICB9CiAgICB9OwogIH0pOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWUob3B0cykgewogIHJldHVybiBvcHRzICYmIChvcHRzLkN0b3Iub3B0aW9ucy5uYW1lIHx8IG9wdHMudGFnKTsKfQoKZnVuY3Rpb24gbWF0Y2hlcyhwYXR0ZXJuLCBuYW1lKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkocGF0dGVybikpIHsKICAgIHJldHVybiBwYXR0ZXJuLmluZGV4T2YobmFtZSkgPiAtMTsKICB9IGVsc2UgaWYgKHR5cGVvZiBwYXR0ZXJuID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIHBhdHRlcm4uc3BsaXQoJywnKS5pbmRleE9mKG5hbWUpID4gLTE7CiAgfSBlbHNlIGlmIChpc1JlZ0V4cChwYXR0ZXJuKSkgewogICAgcmV0dXJuIHBhdHRlcm4udGVzdChuYW1lKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gcHJ1bmVDYWNoZShrZWVwQWxpdmVJbnN0YW5jZSwgZmlsdGVyKSB7CiAgdmFyIGNhY2hlID0ga2VlcEFsaXZlSW5zdGFuY2UuY2FjaGU7CiAgdmFyIGtleXMgPSBrZWVwQWxpdmVJbnN0YW5jZS5rZXlzOwogIHZhciBfdm5vZGUgPSBrZWVwQWxpdmVJbnN0YW5jZS5fdm5vZGU7CgogIGZvciAodmFyIGtleSBpbiBjYWNoZSkgewogICAgdmFyIGNhY2hlZE5vZGUgPSBjYWNoZVtrZXldOwoKICAgIGlmIChjYWNoZWROb2RlKSB7CiAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShjYWNoZWROb2RlLmNvbXBvbmVudE9wdGlvbnMpOwoKICAgICAgaWYgKG5hbWUgJiYgIWZpbHRlcihuYW1lKSkgewogICAgICAgIHBydW5lQ2FjaGVFbnRyeShjYWNoZSwga2V5LCBrZXlzLCBfdm5vZGUpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBwcnVuZUNhY2hlRW50cnkoY2FjaGUsIGtleSwga2V5cywgY3VycmVudCkgewogIHZhciBjYWNoZWQkJDEgPSBjYWNoZVtrZXldOwoKICBpZiAoY2FjaGVkJCQxICYmICghY3VycmVudCB8fCBjYWNoZWQkJDEudGFnICE9PSBjdXJyZW50LnRhZykpIHsKICAgIGNhY2hlZCQkMS5jb21wb25lbnRJbnN0YW5jZS4kZGVzdHJveSgpOwogIH0KCiAgY2FjaGVba2V5XSA9IG51bGw7CiAgcmVtb3ZlKGtleXMsIGtleSk7Cn0KCnZhciBwYXR0ZXJuVHlwZXMgPSBbU3RyaW5nLCBSZWdFeHAsIEFycmF5XTsKdmFyIEtlZXBBbGl2ZSA9IHsKICBuYW1lOiAna2VlcC1hbGl2ZScsCiAgImFic3RyYWN0IjogdHJ1ZSwKICBwcm9wczogewogICAgaW5jbHVkZTogcGF0dGVyblR5cGVzLAogICAgZXhjbHVkZTogcGF0dGVyblR5cGVzLAogICAgbWF4OiBbU3RyaW5nLCBOdW1iZXJdCiAgfSwKICBjcmVhdGVkOiBmdW5jdGlvbiBjcmVhdGVkKCkgewogICAgdGhpcy5jYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB0aGlzLmtleXMgPSBbXTsKICB9LAogIGRlc3Ryb3llZDogZnVuY3Rpb24gZGVzdHJveWVkKCkgewogICAgZm9yICh2YXIga2V5IGluIHRoaXMuY2FjaGUpIHsKICAgICAgcHJ1bmVDYWNoZUVudHJ5KHRoaXMuY2FjaGUsIGtleSwgdGhpcy5rZXlzKTsKICAgIH0KICB9LAogIG1vdW50ZWQ6IGZ1bmN0aW9uIG1vdW50ZWQoKSB7CiAgICB2YXIgdGhpcyQxID0gdGhpczsKICAgIHRoaXMuJHdhdGNoKCdpbmNsdWRlJywgZnVuY3Rpb24gKHZhbCkgewogICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gbWF0Y2hlcyh2YWwsIG5hbWUpOwogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy4kd2F0Y2goJ2V4Y2x1ZGUnLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHBydW5lQ2FjaGUodGhpcyQxLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiAhbWF0Y2hlcyh2YWwsIG5hbWUpOwogICAgICB9KTsKICAgIH0pOwogIH0sCiAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7CiAgICB2YXIgc2xvdCA9IHRoaXMuJHNsb3RzWyJkZWZhdWx0Il07CiAgICB2YXIgdm5vZGUgPSBnZXRGaXJzdENvbXBvbmVudENoaWxkKHNsb3QpOwogICAgdmFyIGNvbXBvbmVudE9wdGlvbnMgPSB2bm9kZSAmJiB2bm9kZS5jb21wb25lbnRPcHRpb25zOwoKICAgIGlmIChjb21wb25lbnRPcHRpb25zKSB7CiAgICAgIC8vIGNoZWNrIHBhdHRlcm4KICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGNvbXBvbmVudE9wdGlvbnMpOwogICAgICB2YXIgcmVmID0gdGhpczsKICAgICAgdmFyIGluY2x1ZGUgPSByZWYuaW5jbHVkZTsKICAgICAgdmFyIGV4Y2x1ZGUgPSByZWYuZXhjbHVkZTsKCiAgICAgIGlmICggLy8gbm90IGluY2x1ZGVkCiAgICAgIGluY2x1ZGUgJiYgKCFuYW1lIHx8ICFtYXRjaGVzKGluY2x1ZGUsIG5hbWUpKSB8fCAvLyBleGNsdWRlZAogICAgICBleGNsdWRlICYmIG5hbWUgJiYgbWF0Y2hlcyhleGNsdWRlLCBuYW1lKSkgewogICAgICAgIHJldHVybiB2bm9kZTsKICAgICAgfQoKICAgICAgdmFyIHJlZiQxID0gdGhpczsKICAgICAgdmFyIGNhY2hlID0gcmVmJDEuY2FjaGU7CiAgICAgIHZhciBrZXlzID0gcmVmJDEua2V5czsKICAgICAgdmFyIGtleSA9IHZub2RlLmtleSA9PSBudWxsIC8vIHNhbWUgY29uc3RydWN0b3IgbWF5IGdldCByZWdpc3RlcmVkIGFzIGRpZmZlcmVudCBsb2NhbCBjb21wb25lbnRzCiAgICAgIC8vIHNvIGNpZCBhbG9uZSBpcyBub3QgZW5vdWdoICgjMzI2OSkKICAgICAgPyBjb21wb25lbnRPcHRpb25zLkN0b3IuY2lkICsgKGNvbXBvbmVudE9wdGlvbnMudGFnID8gIjo6IiArIGNvbXBvbmVudE9wdGlvbnMudGFnIDogJycpIDogdm5vZGUua2V5OwoKICAgICAgaWYgKGNhY2hlW2tleV0pIHsKICAgICAgICB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IGNhY2hlW2tleV0uY29tcG9uZW50SW5zdGFuY2U7IC8vIG1ha2UgY3VycmVudCBrZXkgZnJlc2hlc3QKCiAgICAgICAgcmVtb3ZlKGtleXMsIGtleSk7CiAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FjaGVba2V5XSA9IHZub2RlOwogICAgICAgIGtleXMucHVzaChrZXkpOyAvLyBwcnVuZSBvbGRlc3QgZW50cnkKCiAgICAgICAgaWYgKHRoaXMubWF4ICYmIGtleXMubGVuZ3RoID4gcGFyc2VJbnQodGhpcy5tYXgpKSB7CiAgICAgICAgICBwcnVuZUNhY2hlRW50cnkoY2FjaGUsIGtleXNbMF0sIGtleXMsIHRoaXMuX3Zub2RlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZub2RlLmRhdGEua2VlcEFsaXZlID0gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gdm5vZGUgfHwgc2xvdCAmJiBzbG90WzBdOwogIH0KfTsKdmFyIGJ1aWx0SW5Db21wb25lbnRzID0gewogIEtlZXBBbGl2ZTogS2VlcEFsaXZlCn07Ci8qICAqLwoKZnVuY3Rpb24gaW5pdEdsb2JhbEFQSShWdWUpIHsKICAvLyBjb25maWcKICB2YXIgY29uZmlnRGVmID0ge307CgogIGNvbmZpZ0RlZi5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29uZmlnOwogIH07CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBjb25maWdEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCdEbyBub3QgcmVwbGFjZSB0aGUgVnVlLmNvbmZpZyBvYmplY3QsIHNldCBpbmRpdmlkdWFsIGZpZWxkcyBpbnN0ZWFkLicpOwogICAgfTsKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUsICdjb25maWcnLCBjb25maWdEZWYpOyAvLyBleHBvc2VkIHV0aWwgbWV0aG9kcy4KICAvLyBOT1RFOiB0aGVzZSBhcmUgbm90IGNvbnNpZGVyZWQgcGFydCBvZiB0aGUgcHVibGljIEFQSSAtIGF2b2lkIHJlbHlpbmcgb24KICAvLyB0aGVtIHVubGVzcyB5b3UgYXJlIGF3YXJlIG9mIHRoZSByaXNrLgoKICBWdWUudXRpbCA9IHsKICAgIHdhcm46IHdhcm4sCiAgICBleHRlbmQ6IGV4dGVuZCwKICAgIG1lcmdlT3B0aW9uczogbWVyZ2VPcHRpb25zLAogICAgZGVmaW5lUmVhY3RpdmU6IGRlZmluZVJlYWN0aXZlJCQxCiAgfTsKICBWdWUuc2V0ID0gc2V0OwogIFZ1ZVsiZGVsZXRlIl0gPSBkZWw7CiAgVnVlLm5leHRUaWNrID0gbmV4dFRpY2s7IC8vIDIuNiBleHBsaWNpdCBvYnNlcnZhYmxlIEFQSQoKICBWdWUub2JzZXJ2YWJsZSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIG9ic2VydmUob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgVnVlLm9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgIFZ1ZS5vcHRpb25zW3R5cGUgKyAncyddID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9KTsgLy8gdGhpcyBpcyB1c2VkIHRvIGlkZW50aWZ5IHRoZSAiYmFzZSIgY29uc3RydWN0b3IgdG8gZXh0ZW5kIGFsbCBwbGFpbi1vYmplY3QKICAvLyBjb21wb25lbnRzIHdpdGggaW4gV2VleCdzIG11bHRpLWluc3RhbmNlIHNjZW5hcmlvcy4KCiAgVnVlLm9wdGlvbnMuX2Jhc2UgPSBWdWU7CiAgZXh0ZW5kKFZ1ZS5vcHRpb25zLmNvbXBvbmVudHMsIGJ1aWx0SW5Db21wb25lbnRzKTsKICBpbml0VXNlKFZ1ZSk7CiAgaW5pdE1peGluJDEoVnVlKTsKICBpbml0RXh0ZW5kKFZ1ZSk7CiAgaW5pdEFzc2V0UmVnaXN0ZXJzKFZ1ZSk7Cn0KCmluaXRHbG9iYWxBUEkoVnVlKTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckaXNTZXJ2ZXInLCB7CiAgZ2V0OiBpc1NlcnZlclJlbmRlcmluZwp9KTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckc3NyQ29udGV4dCcsIHsKICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICByZXR1cm4gdGhpcy4kdm5vZGUgJiYgdGhpcy4kdm5vZGUuc3NyQ29udGV4dDsKICB9Cn0pOyAvLyBleHBvc2UgRnVuY3Rpb25hbFJlbmRlckNvbnRleHQgZm9yIHNzciBydW50aW1lIGhlbHBlciBpbnN0YWxsYXRpb24KCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUsICdGdW5jdGlvbmFsUmVuZGVyQ29udGV4dCcsIHsKICB2YWx1ZTogRnVuY3Rpb25hbFJlbmRlckNvbnRleHQKfSk7ClZ1ZS52ZXJzaW9uID0gJzIuNi4xMCc7Ci8qICAqLwovLyB0aGVzZSBhcmUgcmVzZXJ2ZWQgZm9yIHdlYiBiZWNhdXNlIHRoZXkgYXJlIGRpcmVjdGx5IGNvbXBpbGVkIGF3YXkKLy8gZHVyaW5nIHRlbXBsYXRlIGNvbXBpbGF0aW9uCgp2YXIgaXNSZXNlcnZlZEF0dHIgPSBtYWtlTWFwKCdzdHlsZSxjbGFzcycpOyAvLyBhdHRyaWJ1dGVzIHRoYXQgc2hvdWxkIGJlIHVzaW5nIHByb3BzIGZvciBiaW5kaW5nCgp2YXIgYWNjZXB0VmFsdWUgPSBtYWtlTWFwKCdpbnB1dCx0ZXh0YXJlYSxvcHRpb24sc2VsZWN0LHByb2dyZXNzJyk7Cgp2YXIgbXVzdFVzZVByb3AgPSBmdW5jdGlvbiBtdXN0VXNlUHJvcCh0YWcsIHR5cGUsIGF0dHIpIHsKICByZXR1cm4gYXR0ciA9PT0gJ3ZhbHVlJyAmJiBhY2NlcHRWYWx1ZSh0YWcpICYmIHR5cGUgIT09ICdidXR0b24nIHx8IGF0dHIgPT09ICdzZWxlY3RlZCcgJiYgdGFnID09PSAnb3B0aW9uJyB8fCBhdHRyID09PSAnY2hlY2tlZCcgJiYgdGFnID09PSAnaW5wdXQnIHx8IGF0dHIgPT09ICdtdXRlZCcgJiYgdGFnID09PSAndmlkZW8nOwp9OwoKdmFyIGlzRW51bWVyYXRlZEF0dHIgPSBtYWtlTWFwKCdjb250ZW50ZWRpdGFibGUsZHJhZ2dhYmxlLHNwZWxsY2hlY2snKTsKdmFyIGlzVmFsaWRDb250ZW50RWRpdGFibGVWYWx1ZSA9IG1ha2VNYXAoJ2V2ZW50cyxjYXJldCx0eXBpbmcscGxhaW50ZXh0LW9ubHknKTsKCnZhciBjb252ZXJ0RW51bWVyYXRlZFZhbHVlID0gZnVuY3Rpb24gY29udmVydEVudW1lcmF0ZWRWYWx1ZShrZXksIHZhbHVlKSB7CiAgcmV0dXJuIGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpIHx8IHZhbHVlID09PSAnZmFsc2UnID8gJ2ZhbHNlJyAvLyBhbGxvdyBhcmJpdHJhcnkgc3RyaW5nIHZhbHVlIGZvciBjb250ZW50ZWRpdGFibGUKICA6IGtleSA9PT0gJ2NvbnRlbnRlZGl0YWJsZScgJiYgaXNWYWxpZENvbnRlbnRFZGl0YWJsZVZhbHVlKHZhbHVlKSA/IHZhbHVlIDogJ3RydWUnOwp9OwoKdmFyIGlzQm9vbGVhbkF0dHIgPSBtYWtlTWFwKCdhbGxvd2Z1bGxzY3JlZW4sYXN5bmMsYXV0b2ZvY3VzLGF1dG9wbGF5LGNoZWNrZWQsY29tcGFjdCxjb250cm9scyxkZWNsYXJlLCcgKyAnZGVmYXVsdCxkZWZhdWx0Y2hlY2tlZCxkZWZhdWx0bXV0ZWQsZGVmYXVsdHNlbGVjdGVkLGRlZmVyLGRpc2FibGVkLCcgKyAnZW5hYmxlZCxmb3Jtbm92YWxpZGF0ZSxoaWRkZW4saW5kZXRlcm1pbmF0ZSxpbmVydCxpc21hcCxpdGVtc2NvcGUsbG9vcCxtdWx0aXBsZSwnICsgJ211dGVkLG5vaHJlZixub3Jlc2l6ZSxub3NoYWRlLG5vdmFsaWRhdGUsbm93cmFwLG9wZW4scGF1c2VvbmV4aXQscmVhZG9ubHksJyArICdyZXF1aXJlZCxyZXZlcnNlZCxzY29wZWQsc2VhbWxlc3Msc2VsZWN0ZWQsc29ydGFibGUsdHJhbnNsYXRlLCcgKyAndHJ1ZXNwZWVkLHR5cGVtdXN0bWF0Y2gsdmlzaWJsZScpOwp2YXIgeGxpbmtOUyA9ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJzsKCnZhciBpc1hsaW5rID0gZnVuY3Rpb24gaXNYbGluayhuYW1lKSB7CiAgcmV0dXJuIG5hbWUuY2hhckF0KDUpID09PSAnOicgJiYgbmFtZS5zbGljZSgwLCA1KSA9PT0gJ3hsaW5rJzsKfTsKCnZhciBnZXRYbGlua1Byb3AgPSBmdW5jdGlvbiBnZXRYbGlua1Byb3AobmFtZSkgewogIHJldHVybiBpc1hsaW5rKG5hbWUpID8gbmFtZS5zbGljZSg2LCBuYW1lLmxlbmd0aCkgOiAnJzsKfTsKCnZhciBpc0ZhbHN5QXR0clZhbHVlID0gZnVuY3Rpb24gaXNGYWxzeUF0dHJWYWx1ZSh2YWwpIHsKICByZXR1cm4gdmFsID09IG51bGwgfHwgdmFsID09PSBmYWxzZTsKfTsKLyogICovCgoKZnVuY3Rpb24gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgcGFyZW50Tm9kZSA9IHZub2RlOwogIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKCiAgd2hpbGUgKGlzRGVmKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CgogICAgaWYgKGNoaWxkTm9kZSAmJiBjaGlsZE5vZGUuZGF0YSkgewogICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoY2hpbGROb2RlLmRhdGEsIGRhdGEpOwogICAgfQogIH0KCiAgd2hpbGUgKGlzRGVmKHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudCkpIHsKICAgIGlmIChwYXJlbnROb2RlICYmIHBhcmVudE5vZGUuZGF0YSkgewogICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoZGF0YSwgcGFyZW50Tm9kZS5kYXRhKTsKICAgIH0KICB9CgogIHJldHVybiByZW5kZXJDbGFzcyhkYXRhLnN0YXRpY0NsYXNzLCBkYXRhWyJjbGFzcyJdKTsKfQoKZnVuY3Rpb24gbWVyZ2VDbGFzc0RhdGEoY2hpbGQsIHBhcmVudCkgewogIHJldHVybiB7CiAgICBzdGF0aWNDbGFzczogY29uY2F0KGNoaWxkLnN0YXRpY0NsYXNzLCBwYXJlbnQuc3RhdGljQ2xhc3MpLAogICAgImNsYXNzIjogaXNEZWYoY2hpbGRbImNsYXNzIl0pID8gW2NoaWxkWyJjbGFzcyJdLCBwYXJlbnRbImNsYXNzIl1dIDogcGFyZW50WyJjbGFzcyJdCiAgfTsKfQoKZnVuY3Rpb24gcmVuZGVyQ2xhc3Moc3RhdGljQ2xhc3MsIGR5bmFtaWNDbGFzcykgewogIGlmIChpc0RlZihzdGF0aWNDbGFzcykgfHwgaXNEZWYoZHluYW1pY0NsYXNzKSkgewogICAgcmV0dXJuIGNvbmNhdChzdGF0aWNDbGFzcywgc3RyaW5naWZ5Q2xhc3MoZHluYW1pY0NsYXNzKSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKICByZXR1cm4gJyc7Cn0KCmZ1bmN0aW9uIGNvbmNhdChhLCBiKSB7CiAgcmV0dXJuIGEgPyBiID8gYSArICcgJyArIGIgOiBhIDogYiB8fCAnJzsKfQoKZnVuY3Rpb24gc3RyaW5naWZ5Q2xhc3ModmFsdWUpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgIHJldHVybiBzdHJpbmdpZnlBcnJheSh2YWx1ZSk7CiAgfQoKICBpZiAoaXNPYmplY3QodmFsdWUpKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5T2JqZWN0KHZhbHVlKTsKICB9CgogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKICByZXR1cm4gJyc7Cn0KCmZ1bmN0aW9uIHN0cmluZ2lmeUFycmF5KHZhbHVlKSB7CiAgdmFyIHJlcyA9ICcnOwogIHZhciBzdHJpbmdpZmllZDsKCiAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGlmIChpc0RlZihzdHJpbmdpZmllZCA9IHN0cmluZ2lmeUNsYXNzKHZhbHVlW2ldKSkgJiYgc3RyaW5naWZpZWQgIT09ICcnKSB7CiAgICAgIGlmIChyZXMpIHsKICAgICAgICByZXMgKz0gJyAnOwogICAgICB9CgogICAgICByZXMgKz0gc3RyaW5naWZpZWQ7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlPYmplY3QodmFsdWUpIHsKICB2YXIgcmVzID0gJyc7CgogIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgaWYgKHZhbHVlW2tleV0pIHsKICAgICAgaWYgKHJlcykgewogICAgICAgIHJlcyArPSAnICc7CiAgICAgIH0KCiAgICAgIHJlcyArPSBrZXk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCnZhciBuYW1lc3BhY2VNYXAgPSB7CiAgc3ZnOiAnaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnLAogIG1hdGg6ICdodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MJwp9Owp2YXIgaXNIVE1MVGFnID0gbWFrZU1hcCgnaHRtbCxib2R5LGJhc2UsaGVhZCxsaW5rLG1ldGEsc3R5bGUsdGl0bGUsJyArICdhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoMSxoMixoMyxoNCxoNSxoNixoZ3JvdXAsbmF2LHNlY3Rpb24sJyArICdkaXYsZGQsZGwsZHQsZmlnY2FwdGlvbixmaWd1cmUscGljdHVyZSxocixpbWcsbGksbWFpbixvbCxwLHByZSx1bCwnICsgJ2EsYixhYmJyLGJkaSxiZG8sYnIsY2l0ZSxjb2RlLGRhdGEsZGZuLGVtLGksa2JkLG1hcmsscSxycCxydCxydGMscnVieSwnICsgJ3Msc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLCcgKyAnZW1iZWQsb2JqZWN0LHBhcmFtLHNvdXJjZSxjYW52YXMsc2NyaXB0LG5vc2NyaXB0LGRlbCxpbnMsJyArICdjYXB0aW9uLGNvbCxjb2xncm91cCx0YWJsZSx0aGVhZCx0Ym9keSx0ZCx0aCx0ciwnICsgJ2J1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sJyArICdvdXRwdXQscHJvZ3Jlc3Msc2VsZWN0LHRleHRhcmVhLCcgKyAnZGV0YWlscyxkaWFsb2csbWVudSxtZW51aXRlbSxzdW1tYXJ5LCcgKyAnY29udGVudCxlbGVtZW50LHNoYWRvdyx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCcpOyAvLyB0aGlzIG1hcCBpcyBpbnRlbnRpb25hbGx5IHNlbGVjdGl2ZSwgb25seSBjb3ZlcmluZyBTVkcgZWxlbWVudHMgdGhhdCBtYXkKLy8gY29udGFpbiBjaGlsZCBlbGVtZW50cy4KCnZhciBpc1NWRyA9IG1ha2VNYXAoJ3N2ZyxhbmltYXRlLGNpcmNsZSxjbGlwcGF0aCxjdXJzb3IsZGVmcyxkZXNjLGVsbGlwc2UsZmlsdGVyLGZvbnQtZmFjZSwnICsgJ2ZvcmVpZ25PYmplY3QsZyxnbHlwaCxpbWFnZSxsaW5lLG1hcmtlcixtYXNrLG1pc3NpbmctZ2x5cGgscGF0aCxwYXR0ZXJuLCcgKyAncG9seWdvbixwb2x5bGluZSxyZWN0LHN3aXRjaCxzeW1ib2wsdGV4dCx0ZXh0cGF0aCx0c3Bhbix1c2UsdmlldycsIHRydWUpOwoKdmFyIGlzUmVzZXJ2ZWRUYWcgPSBmdW5jdGlvbiBpc1Jlc2VydmVkVGFnKHRhZykgewogIHJldHVybiBpc0hUTUxUYWcodGFnKSB8fCBpc1NWRyh0YWcpOwp9OwoKZnVuY3Rpb24gZ2V0VGFnTmFtZXNwYWNlKHRhZykgewogIGlmIChpc1NWRyh0YWcpKSB7CiAgICByZXR1cm4gJ3N2Zyc7CiAgfSAvLyBiYXNpYyBzdXBwb3J0IGZvciBNYXRoTUwKICAvLyBub3RlIGl0IGRvZXNuJ3Qgc3VwcG9ydCBvdGhlciBNYXRoTUwgZWxlbWVudHMgYmVpbmcgY29tcG9uZW50IHJvb3RzCgoKICBpZiAodGFnID09PSAnbWF0aCcpIHsKICAgIHJldHVybiAnbWF0aCc7CiAgfQp9Cgp2YXIgdW5rbm93bkVsZW1lbnRDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgpmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50KHRhZykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICghaW5Ccm93c2VyKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGlmIChpc1Jlc2VydmVkVGFnKHRhZykpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHRhZyA9IHRhZy50b0xvd2VyQ2FzZSgpOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAodW5rbm93bkVsZW1lbnRDYWNoZVt0YWddICE9IG51bGwpIHsKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ107CiAgfQoKICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7CgogIGlmICh0YWcuaW5kZXhPZignLScpID4gLTEpIHsKICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI4MjEwMzY0LzEwNzAyNDQKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxVbmtub3duRWxlbWVudCB8fCBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxFbGVtZW50OwogIH0gZWxzZSB7CiAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddID0gL0hUTUxVbmtub3duRWxlbWVudC8udGVzdChlbC50b1N0cmluZygpKTsKICB9Cn0KCnZhciBpc1RleHRJbnB1dFR5cGUgPSBtYWtlTWFwKCd0ZXh0LG51bWJlcixwYXNzd29yZCxzZWFyY2gsZW1haWwsdGVsLHVybCcpOwovKiAgKi8KCi8qKgogKiBRdWVyeSBhbiBlbGVtZW50IHNlbGVjdG9yIGlmIGl0J3Mgbm90IGFuIGVsZW1lbnQgYWxyZWFkeS4KICovCgpmdW5jdGlvbiBxdWVyeShlbCkgewogIGlmICh0eXBlb2YgZWwgPT09ICdzdHJpbmcnKSB7CiAgICB2YXIgc2VsZWN0ZWQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGVsKTsKCiAgICBpZiAoIXNlbGVjdGVkKSB7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignQ2Fubm90IGZpbmQgZWxlbWVudDogJyArIGVsKTsKICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgfQoKICAgIHJldHVybiBzZWxlY3RlZDsKICB9IGVsc2UgewogICAgcmV0dXJuIGVsOwogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50JDEodGFnTmFtZSwgdm5vZGUpIHsKICB2YXIgZWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKCiAgaWYgKHRhZ05hbWUgIT09ICdzZWxlY3QnKSB7CiAgICByZXR1cm4gZWxtOwogIH0gLy8gZmFsc2Ugb3IgbnVsbCB3aWxsIHJlbW92ZSB0aGUgYXR0cmlidXRlIGJ1dCB1bmRlZmluZWQgd2lsbCBub3QKCgogIGlmICh2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEuYXR0cnMgJiYgdm5vZGUuZGF0YS5hdHRycy5tdWx0aXBsZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBlbG0uc2V0QXR0cmlidXRlKCdtdWx0aXBsZScsICdtdWx0aXBsZScpOwogIH0KCiAgcmV0dXJuIGVsbTsKfQoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZSwgdGFnTmFtZSkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlTWFwW25hbWVzcGFjZV0sIHRhZ05hbWUpOwp9CgpmdW5jdGlvbiBjcmVhdGVUZXh0Tm9kZSh0ZXh0KSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwp9CgpmdW5jdGlvbiBjcmVhdGVDb21tZW50KHRleHQpIHsKICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh0ZXh0KTsKfQoKZnVuY3Rpb24gaW5zZXJ0QmVmb3JlKHBhcmVudE5vZGUsIG5ld05vZGUsIHJlZmVyZW5jZU5vZGUpIHsKICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShuZXdOb2RlLCByZWZlcmVuY2VOb2RlKTsKfQoKZnVuY3Rpb24gcmVtb3ZlQ2hpbGQobm9kZSwgY2hpbGQpIHsKICBub2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKfQoKZnVuY3Rpb24gYXBwZW5kQ2hpbGQobm9kZSwgY2hpbGQpIHsKICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKfQoKZnVuY3Rpb24gcGFyZW50Tm9kZShub2RlKSB7CiAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZTsKfQoKZnVuY3Rpb24gbmV4dFNpYmxpbmcobm9kZSkgewogIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwp9CgpmdW5jdGlvbiB0YWdOYW1lKG5vZGUpIHsKICByZXR1cm4gbm9kZS50YWdOYW1lOwp9CgpmdW5jdGlvbiBzZXRUZXh0Q29udGVudChub2RlLCB0ZXh0KSB7CiAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7Cn0KCmZ1bmN0aW9uIHNldFN0eWxlU2NvcGUobm9kZSwgc2NvcGVJZCkgewogIG5vZGUuc2V0QXR0cmlidXRlKHNjb3BlSWQsICcnKTsKfQoKdmFyIG5vZGVPcHMgPQovKiNfX1BVUkVfXyovCk9iamVjdC5mcmVlemUoewogIGNyZWF0ZUVsZW1lbnQ6IGNyZWF0ZUVsZW1lbnQkMSwKICBjcmVhdGVFbGVtZW50TlM6IGNyZWF0ZUVsZW1lbnROUywKICBjcmVhdGVUZXh0Tm9kZTogY3JlYXRlVGV4dE5vZGUsCiAgY3JlYXRlQ29tbWVudDogY3JlYXRlQ29tbWVudCwKICBpbnNlcnRCZWZvcmU6IGluc2VydEJlZm9yZSwKICByZW1vdmVDaGlsZDogcmVtb3ZlQ2hpbGQsCiAgYXBwZW5kQ2hpbGQ6IGFwcGVuZENoaWxkLAogIHBhcmVudE5vZGU6IHBhcmVudE5vZGUsCiAgbmV4dFNpYmxpbmc6IG5leHRTaWJsaW5nLAogIHRhZ05hbWU6IHRhZ05hbWUsCiAgc2V0VGV4dENvbnRlbnQ6IHNldFRleHRDb250ZW50LAogIHNldFN0eWxlU2NvcGU6IHNldFN0eWxlU2NvcGUKfSk7Ci8qICAqLwoKdmFyIHJlZiA9IHsKICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShfLCB2bm9kZSkgewogICAgcmVnaXN0ZXJSZWYodm5vZGUpOwogIH0sCiAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob2xkVm5vZGUsIHZub2RlKSB7CiAgICBpZiAob2xkVm5vZGUuZGF0YS5yZWYgIT09IHZub2RlLmRhdGEucmVmKSB7CiAgICAgIHJlZ2lzdGVyUmVmKG9sZFZub2RlLCB0cnVlKTsKICAgICAgcmVnaXN0ZXJSZWYodm5vZGUpOwogICAgfQogIH0sCiAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSh2bm9kZSkgewogICAgcmVnaXN0ZXJSZWYodm5vZGUsIHRydWUpOwogIH0KfTsKCmZ1bmN0aW9uIHJlZ2lzdGVyUmVmKHZub2RlLCBpc1JlbW92YWwpIHsKICB2YXIga2V5ID0gdm5vZGUuZGF0YS5yZWY7CgogIGlmICghaXNEZWYoa2V5KSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHZtID0gdm5vZGUuY29udGV4dDsKICB2YXIgcmVmID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgfHwgdm5vZGUuZWxtOwogIHZhciByZWZzID0gdm0uJHJlZnM7CgogIGlmIChpc1JlbW92YWwpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHJlZnNba2V5XSkpIHsKICAgICAgcmVtb3ZlKHJlZnNba2V5XSwgcmVmKTsKICAgIH0gZWxzZSBpZiAocmVmc1trZXldID09PSByZWYpIHsKICAgICAgcmVmc1trZXldID0gdW5kZWZpbmVkOwogICAgfQogIH0gZWxzZSB7CiAgICBpZiAodm5vZGUuZGF0YS5yZWZJbkZvcikgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVmc1trZXldKSkgewogICAgICAgIHJlZnNba2V5XSA9IFtyZWZdOwogICAgICB9IGVsc2UgaWYgKHJlZnNba2V5XS5pbmRleE9mKHJlZikgPCAwKSB7CiAgICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgICAgcmVmc1trZXldLnB1c2gocmVmKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmVmc1trZXldID0gcmVmOwogICAgfQogIH0KfQovKioKICogVmlydHVhbCBET00gcGF0Y2hpbmcgYWxnb3JpdGhtIGJhc2VkIG9uIFNuYWJiZG9tIGJ5CiAqIFNpbW9uIEZyaWlzIFZpbmR1bSAoQHBhbGRlcGluZCkKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxkZXBpbmQvc25hYmJkb20vYmxvYi9tYXN0ZXIvTElDRU5TRQogKgogKiBtb2RpZmllZCBieSBFdmFuIFlvdSAoQHl5eDk5MDgwMykKICoKICogTm90IHR5cGUtY2hlY2tpbmcgdGhpcyBiZWNhdXNlIHRoaXMgZmlsZSBpcyBwZXJmLWNyaXRpY2FsIGFuZCB0aGUgY29zdAogKiBvZiBtYWtpbmcgZmxvdyB1bmRlcnN0YW5kIGl0IGlzIG5vdCB3b3J0aCBpdC4KICovCgoKdmFyIGVtcHR5Tm9kZSA9IG5ldyBWTm9kZSgnJywge30sIFtdKTsKdmFyIGhvb2tzID0gWydjcmVhdGUnLCAnYWN0aXZhdGUnLCAndXBkYXRlJywgJ3JlbW92ZScsICdkZXN0cm95J107CgpmdW5jdGlvbiBzYW1lVm5vZGUoYSwgYikgewogIHJldHVybiBhLmtleSA9PT0gYi5rZXkgJiYgKGEudGFnID09PSBiLnRhZyAmJiBhLmlzQ29tbWVudCA9PT0gYi5pc0NvbW1lbnQgJiYgaXNEZWYoYS5kYXRhKSA9PT0gaXNEZWYoYi5kYXRhKSAmJiBzYW1lSW5wdXRUeXBlKGEsIGIpIHx8IGlzVHJ1ZShhLmlzQXN5bmNQbGFjZWhvbGRlcikgJiYgYS5hc3luY0ZhY3RvcnkgPT09IGIuYXN5bmNGYWN0b3J5ICYmIGlzVW5kZWYoYi5hc3luY0ZhY3RvcnkuZXJyb3IpKTsKfQoKZnVuY3Rpb24gc2FtZUlucHV0VHlwZShhLCBiKSB7CiAgaWYgKGEudGFnICE9PSAnaW5wdXQnKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIHZhciBpOwogIHZhciB0eXBlQSA9IGlzRGVmKGkgPSBhLmRhdGEpICYmIGlzRGVmKGkgPSBpLmF0dHJzKSAmJiBpLnR5cGU7CiAgdmFyIHR5cGVCID0gaXNEZWYoaSA9IGIuZGF0YSkgJiYgaXNEZWYoaSA9IGkuYXR0cnMpICYmIGkudHlwZTsKICByZXR1cm4gdHlwZUEgPT09IHR5cGVCIHx8IGlzVGV4dElucHV0VHlwZSh0eXBlQSkgJiYgaXNUZXh0SW5wdXRUeXBlKHR5cGVCKTsKfQoKZnVuY3Rpb24gY3JlYXRlS2V5VG9PbGRJZHgoY2hpbGRyZW4sIGJlZ2luSWR4LCBlbmRJZHgpIHsKICB2YXIgaSwga2V5OwogIHZhciBtYXAgPSB7fTsKCiAgZm9yIChpID0gYmVnaW5JZHg7IGkgPD0gZW5kSWR4OyArK2kpIHsKICAgIGtleSA9IGNoaWxkcmVuW2ldLmtleTsKCiAgICBpZiAoaXNEZWYoa2V5KSkgewogICAgICBtYXBba2V5XSA9IGk7CiAgICB9CiAgfQoKICByZXR1cm4gbWFwOwp9CgpmdW5jdGlvbiBjcmVhdGVQYXRjaEZ1bmN0aW9uKGJhY2tlbmQpIHsKICB2YXIgaSwgajsKICB2YXIgY2JzID0ge307CiAgdmFyIG1vZHVsZXMgPSBiYWNrZW5kLm1vZHVsZXM7CiAgdmFyIG5vZGVPcHMgPSBiYWNrZW5kLm5vZGVPcHM7CgogIGZvciAoaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7ICsraSkgewogICAgY2JzW2hvb2tzW2ldXSA9IFtdOwoKICAgIGZvciAoaiA9IDA7IGogPCBtb2R1bGVzLmxlbmd0aDsgKytqKSB7CiAgICAgIGlmIChpc0RlZihtb2R1bGVzW2pdW2hvb2tzW2ldXSkpIHsKICAgICAgICBjYnNbaG9va3NbaV1dLnB1c2gobW9kdWxlc1tqXVtob29rc1tpXV0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBlbXB0eU5vZGVBdChlbG0pIHsKICAgIHJldHVybiBuZXcgVk5vZGUobm9kZU9wcy50YWdOYW1lKGVsbSkudG9Mb3dlckNhc2UoKSwge30sIFtdLCB1bmRlZmluZWQsIGVsbSk7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVSbUNiKGNoaWxkRWxtLCBsaXN0ZW5lcnMpIHsKICAgIGZ1bmN0aW9uIHJlbW92ZSQkMSgpIHsKICAgICAgaWYgKC0tcmVtb3ZlJCQxLmxpc3RlbmVycyA9PT0gMCkgewogICAgICAgIHJlbW92ZU5vZGUoY2hpbGRFbG0pOwogICAgICB9CiAgICB9CgogICAgcmVtb3ZlJCQxLmxpc3RlbmVycyA9IGxpc3RlbmVyczsKICAgIHJldHVybiByZW1vdmUkJDE7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVOb2RlKGVsKSB7CiAgICB2YXIgcGFyZW50ID0gbm9kZU9wcy5wYXJlbnROb2RlKGVsKTsgLy8gZWxlbWVudCBtYXkgaGF2ZSBhbHJlYWR5IGJlZW4gcmVtb3ZlZCBkdWUgdG8gdi1odG1sIC8gdi10ZXh0CgogICAgaWYgKGlzRGVmKHBhcmVudCkpIHsKICAgICAgbm9kZU9wcy5yZW1vdmVDaGlsZChwYXJlbnQsIGVsKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzVW5rbm93bkVsZW1lbnQkJDEodm5vZGUsIGluVlByZSkgewogICAgcmV0dXJuICFpblZQcmUgJiYgIXZub2RlLm5zICYmICEoY29uZmlnLmlnbm9yZWRFbGVtZW50cy5sZW5ndGggJiYgY29uZmlnLmlnbm9yZWRFbGVtZW50cy5zb21lKGZ1bmN0aW9uIChpZ25vcmUpIHsKICAgICAgcmV0dXJuIGlzUmVnRXhwKGlnbm9yZSkgPyBpZ25vcmUudGVzdCh2bm9kZS50YWcpIDogaWdub3JlID09PSB2bm9kZS50YWc7CiAgICB9KSkgJiYgY29uZmlnLmlzVW5rbm93bkVsZW1lbnQodm5vZGUudGFnKTsKICB9CgogIHZhciBjcmVhdGluZ0VsbUluVlByZSA9IDA7CgogIGZ1bmN0aW9uIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSwgbmVzdGVkLCBvd25lckFycmF5LCBpbmRleCkgewogICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgLy8gVGhpcyB2bm9kZSB3YXMgdXNlZCBpbiBhIHByZXZpb3VzIHJlbmRlciEKICAgICAgLy8gbm93IGl0J3MgdXNlZCBhcyBhIG5ldyBub2RlLCBvdmVyd3JpdGluZyBpdHMgZWxtIHdvdWxkIGNhdXNlCiAgICAgIC8vIHBvdGVudGlhbCBwYXRjaCBlcnJvcnMgZG93biB0aGUgcm9hZCB3aGVuIGl0J3MgdXNlZCBhcyBhbiBpbnNlcnRpb24KICAgICAgLy8gcmVmZXJlbmNlIG5vZGUuIEluc3RlYWQsIHdlIGNsb25lIHRoZSBub2RlIG9uLWRlbWFuZCBiZWZvcmUgY3JlYXRpbmcKICAgICAgLy8gYXNzb2NpYXRlZCBET00gZWxlbWVudCBmb3IgaXQuCiAgICAgIHZub2RlID0gb3duZXJBcnJheVtpbmRleF0gPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgIH0KCiAgICB2bm9kZS5pc1Jvb3RJbnNlcnQgPSAhbmVzdGVkOyAvLyBmb3IgdHJhbnNpdGlvbiBlbnRlciBjaGVjawoKICAgIGlmIChjcmVhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICB2YXIgY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsKICAgIHZhciB0YWcgPSB2bm9kZS50YWc7CgogICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnByZSkgewogICAgICAgICAgY3JlYXRpbmdFbG1JblZQcmUrKzsKICAgICAgICB9CgogICAgICAgIGlmIChpc1Vua25vd25FbGVtZW50JCQxKHZub2RlLCBjcmVhdGluZ0VsbUluVlByZSkpIHsKICAgICAgICAgIHdhcm4oJ1Vua25vd24gY3VzdG9tIGVsZW1lbnQ6IDwnICsgdGFnICsgJz4gLSBkaWQgeW91ICcgKyAncmVnaXN0ZXIgdGhlIGNvbXBvbmVudCBjb3JyZWN0bHk/IEZvciByZWN1cnNpdmUgY29tcG9uZW50cywgJyArICdtYWtlIHN1cmUgdG8gcHJvdmlkZSB0aGUgIm5hbWUiIG9wdGlvbi4nLCB2bm9kZS5jb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZub2RlLmVsbSA9IHZub2RlLm5zID8gbm9kZU9wcy5jcmVhdGVFbGVtZW50TlModm5vZGUubnMsIHRhZykgOiBub2RlT3BzLmNyZWF0ZUVsZW1lbnQodGFnLCB2bm9kZSk7CiAgICAgIHNldFNjb3BlKHZub2RlKTsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgICB7CiAgICAgICAgY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpOwoKICAgICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0KCiAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgICB9CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBkYXRhICYmIGRhdGEucHJlKSB7CiAgICAgICAgY3JlYXRpbmdFbG1JblZQcmUtLTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1RydWUodm5vZGUuaXNDb21tZW50KSkgewogICAgICB2bm9kZS5lbG0gPSBub2RlT3BzLmNyZWF0ZUNvbW1lbnQodm5vZGUudGV4dCk7CiAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgIH0gZWxzZSB7CiAgICAgIHZub2RlLmVsbSA9IG5vZGVPcHMuY3JlYXRlVGV4dE5vZGUodm5vZGUudGV4dCk7CiAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkgewogICAgdmFyIGkgPSB2bm9kZS5kYXRhOwoKICAgIGlmIChpc0RlZihpKSkgewogICAgICB2YXIgaXNSZWFjdGl2YXRlZCA9IGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpLmtlZXBBbGl2ZTsKCiAgICAgIGlmIChpc0RlZihpID0gaS5ob29rKSAmJiBpc0RlZihpID0gaS5pbml0KSkgewogICAgICAgIGkodm5vZGUsIGZhbHNlCiAgICAgICAgLyogaHlkcmF0aW5nICovCiAgICAgICAgKTsKICAgICAgfSAvLyBhZnRlciBjYWxsaW5nIHRoZSBpbml0IGhvb2ssIGlmIHRoZSB2bm9kZSBpcyBhIGNoaWxkIGNvbXBvbmVudAogICAgICAvLyBpdCBzaG91bGQndmUgY3JlYXRlZCBhIGNoaWxkIGluc3RhbmNlIGFuZCBtb3VudGVkIGl0LiB0aGUgY2hpbGQKICAgICAgLy8gY29tcG9uZW50IGFsc28gaGFzIHNldCB0aGUgcGxhY2Vob2xkZXIgdm5vZGUncyBlbG0uCiAgICAgIC8vIGluIHRoYXQgY2FzZSB3ZSBjYW4ganVzdCByZXR1cm4gdGhlIGVsZW1lbnQgYW5kIGJlIGRvbmUuCgoKICAgICAgaWYgKGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgIGluaXRDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwoKICAgICAgICBpZiAoaXNUcnVlKGlzUmVhY3RpdmF0ZWQpKSB7CiAgICAgICAgICByZWFjdGl2YXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgIGlmIChpc0RlZih2bm9kZS5kYXRhLnBlbmRpbmdJbnNlcnQpKSB7CiAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoLmFwcGx5KGluc2VydGVkVm5vZGVRdWV1ZSwgdm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KTsKICAgICAgdm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0ID0gbnVsbDsKICAgIH0KCiAgICB2bm9kZS5lbG0gPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZS4kZWw7CgogICAgaWYgKGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgc2V0U2NvcGUodm5vZGUpOwogICAgfSBlbHNlIHsKICAgICAgLy8gZW1wdHkgY29tcG9uZW50IHJvb3QuCiAgICAgIC8vIHNraXAgYWxsIGVsZW1lbnQtcmVsYXRlZCBtb2R1bGVzIGV4Y2VwdCBmb3IgcmVmICgjMzQ1NSkKICAgICAgcmVnaXN0ZXJSZWYodm5vZGUpOyAvLyBtYWtlIHN1cmUgdG8gaW52b2tlIHRoZSBpbnNlcnQgaG9vawoKICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2godm5vZGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVhY3RpdmF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkgewogICAgdmFyIGk7IC8vIGhhY2sgZm9yICM0MzM5OiBhIHJlYWN0aXZhdGVkIGNvbXBvbmVudCB3aXRoIGlubmVyIHRyYW5zaXRpb24KICAgIC8vIGRvZXMgbm90IHRyaWdnZXIgYmVjYXVzZSB0aGUgaW5uZXIgbm9kZSdzIGNyZWF0ZWQgaG9va3MgYXJlIG5vdCBjYWxsZWQKICAgIC8vIGFnYWluLiBJdCdzIG5vdCBpZGVhbCB0byBpbnZvbHZlIG1vZHVsZS1zcGVjaWZpYyBsb2dpYyBpbiBoZXJlIGJ1dAogICAgLy8gdGhlcmUgZG9lc24ndCBzZWVtIHRvIGJlIGEgYmV0dGVyIHdheSB0byBkbyBpdC4KCiAgICB2YXIgaW5uZXJOb2RlID0gdm5vZGU7CgogICAgd2hpbGUgKGlubmVyTm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICBpbm5lck5vZGUgPSBpbm5lck5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwoKICAgICAgaWYgKGlzRGVmKGkgPSBpbm5lck5vZGUuZGF0YSkgJiYgaXNEZWYoaSA9IGkudHJhbnNpdGlvbikpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLmFjdGl2YXRlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYnMuYWN0aXZhdGVbaV0oZW1wdHlOb2RlLCBpbm5lck5vZGUpOwogICAgICAgIH0KCiAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2goaW5uZXJOb2RlKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfSAvLyB1bmxpa2UgYSBuZXdseSBjcmVhdGVkIGNvbXBvbmVudCwKICAgIC8vIGEgcmVhY3RpdmF0ZWQga2VlcC1hbGl2ZSBjb21wb25lbnQgZG9lc24ndCBpbnNlcnQgaXRzZWxmCgoKICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICB9CgogIGZ1bmN0aW9uIGluc2VydChwYXJlbnQsIGVsbSwgcmVmJCQxKSB7CiAgICBpZiAoaXNEZWYocGFyZW50KSkgewogICAgICBpZiAoaXNEZWYocmVmJCQxKSkgewogICAgICAgIGlmIChub2RlT3BzLnBhcmVudE5vZGUocmVmJCQxKSA9PT0gcGFyZW50KSB7CiAgICAgICAgICBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnQsIGVsbSwgcmVmJCQxKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZU9wcy5hcHBlbmRDaGlsZChwYXJlbnQsIGVsbSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2hpbGRyZW4pOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgKytpKSB7CiAgICAgICAgY3JlYXRlRWxtKGNoaWxkcmVuW2ldLCBpbnNlcnRlZFZub2RlUXVldWUsIHZub2RlLmVsbSwgbnVsbCwgdHJ1ZSwgY2hpbGRyZW4sIGkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzUHJpbWl0aXZlKHZub2RlLnRleHQpKSB7CiAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQodm5vZGUuZWxtLCBub2RlT3BzLmNyZWF0ZVRleHROb2RlKFN0cmluZyh2bm9kZS50ZXh0KSkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNQYXRjaGFibGUodm5vZGUpIHsKICAgIHdoaWxlICh2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICB2bm9kZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKICAgIH0KCiAgICByZXR1cm4gaXNEZWYodm5vZGUudGFnKTsKICB9CgogIGZ1bmN0aW9uIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2kkMSkgewogICAgICBjYnMuY3JlYXRlW2kkMV0oZW1wdHlOb2RlLCB2bm9kZSk7CiAgICB9CgogICAgaSA9IHZub2RlLmRhdGEuaG9vazsgLy8gUmV1c2UgdmFyaWFibGUKCiAgICBpZiAoaXNEZWYoaSkpIHsKICAgICAgaWYgKGlzRGVmKGkuY3JlYXRlKSkgewogICAgICAgIGkuY3JlYXRlKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgICB9CgogICAgICBpZiAoaXNEZWYoaS5pbnNlcnQpKSB7CiAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2godm5vZGUpOwogICAgICB9CiAgICB9CiAgfSAvLyBzZXQgc2NvcGUgaWQgYXR0cmlidXRlIGZvciBzY29wZWQgQ1NTLgogIC8vIHRoaXMgaXMgaW1wbGVtZW50ZWQgYXMgYSBzcGVjaWFsIGNhc2UgdG8gYXZvaWQgdGhlIG92ZXJoZWFkCiAgLy8gb2YgZ29pbmcgdGhyb3VnaCB0aGUgbm9ybWFsIGF0dHJpYnV0ZSBwYXRjaGluZyBwcm9jZXNzLgoKCiAgZnVuY3Rpb24gc2V0U2NvcGUodm5vZGUpIHsKICAgIHZhciBpOwoKICAgIGlmIChpc0RlZihpID0gdm5vZGUuZm5TY29wZUlkKSkgewogICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhbmNlc3RvciA9IHZub2RlOwoKICAgICAgd2hpbGUgKGFuY2VzdG9yKSB7CiAgICAgICAgaWYgKGlzRGVmKGkgPSBhbmNlc3Rvci5jb250ZXh0KSAmJiBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkpIHsKICAgICAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgICAgIH0KCiAgICAgICAgYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnQ7CiAgICAgIH0KICAgIH0gLy8gZm9yIHNsb3QgY29udGVudCB0aGV5IHNob3VsZCBhbHNvIGdldCB0aGUgc2NvcGVJZCBmcm9tIHRoZSBob3N0IGluc3RhbmNlLgoKCiAgICBpZiAoaXNEZWYoaSA9IGFjdGl2ZUluc3RhbmNlKSAmJiBpICE9PSB2bm9kZS5jb250ZXh0ICYmIGkgIT09IHZub2RlLmZuQ29udGV4dCAmJiBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkpIHsKICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGRWbm9kZXMocGFyZW50RWxtLCByZWZFbG0sIHZub2Rlcywgc3RhcnRJZHgsIGVuZElkeCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBmb3IgKDsgc3RhcnRJZHggPD0gZW5kSWR4OyArK3N0YXJ0SWR4KSB7CiAgICAgIGNyZWF0ZUVsbSh2bm9kZXNbc3RhcnRJZHhdLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtLCBmYWxzZSwgdm5vZGVzLCBzdGFydElkeCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbnZva2VEZXN0cm95SG9vayh2bm9kZSkgewogICAgdmFyIGksIGo7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CgogICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5kZXN0cm95KSkgewogICAgICAgIGkodm5vZGUpOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIHsKICAgICAgICBjYnMuZGVzdHJveVtpXSh2bm9kZSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNoaWxkcmVuKSkgewogICAgICBmb3IgKGogPSAwOyBqIDwgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyArK2opIHsKICAgICAgICBpbnZva2VEZXN0cm95SG9vayh2bm9kZS5jaGlsZHJlbltqXSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZVZub2RlcyhwYXJlbnRFbG0sIHZub2Rlcywgc3RhcnRJZHgsIGVuZElkeCkgewogICAgZm9yICg7IHN0YXJ0SWR4IDw9IGVuZElkeDsgKytzdGFydElkeCkgewogICAgICB2YXIgY2ggPSB2bm9kZXNbc3RhcnRJZHhdOwoKICAgICAgaWYgKGlzRGVmKGNoKSkgewogICAgICAgIGlmIChpc0RlZihjaC50YWcpKSB7CiAgICAgICAgICByZW1vdmVBbmRJbnZva2VSZW1vdmVIb29rKGNoKTsKICAgICAgICAgIGludm9rZURlc3Ryb3lIb29rKGNoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVGV4dCBub2RlCiAgICAgICAgICByZW1vdmVOb2RlKGNoLmVsbSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVBbmRJbnZva2VSZW1vdmVIb29rKHZub2RlLCBybSkgewogICAgaWYgKGlzRGVmKHJtKSB8fCBpc0RlZih2bm9kZS5kYXRhKSkgewogICAgICB2YXIgaTsKICAgICAgdmFyIGxpc3RlbmVycyA9IGNicy5yZW1vdmUubGVuZ3RoICsgMTsKCiAgICAgIGlmIChpc0RlZihybSkpIHsKICAgICAgICAvLyB3ZSBoYXZlIGEgcmVjdXJzaXZlbHkgcGFzc2VkIGRvd24gcm0gY2FsbGJhY2sKICAgICAgICAvLyBpbmNyZWFzZSB0aGUgbGlzdGVuZXJzIGNvdW50CiAgICAgICAgcm0ubGlzdGVuZXJzICs9IGxpc3RlbmVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkaXJlY3RseSByZW1vdmluZwogICAgICAgIHJtID0gY3JlYXRlUm1DYih2bm9kZS5lbG0sIGxpc3RlbmVycyk7CiAgICAgIH0gLy8gcmVjdXJzaXZlbHkgaW52b2tlIGhvb2tzIG9uIGNoaWxkIGNvbXBvbmVudCByb290IG5vZGUKCgogICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpc0RlZihpID0gaS5fdm5vZGUpICYmIGlzRGVmKGkuZGF0YSkpIHsKICAgICAgICByZW1vdmVBbmRJbnZva2VSZW1vdmVIb29rKGksIHJtKTsKICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5yZW1vdmUubGVuZ3RoOyArK2kpIHsKICAgICAgICBjYnMucmVtb3ZlW2ldKHZub2RlLCBybSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5yZW1vdmUpKSB7CiAgICAgICAgaSh2bm9kZSwgcm0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJtKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlbW92ZU5vZGUodm5vZGUuZWxtKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUNoaWxkcmVuKHBhcmVudEVsbSwgb2xkQ2gsIG5ld0NoLCBpbnNlcnRlZFZub2RlUXVldWUsIHJlbW92ZU9ubHkpIHsKICAgIHZhciBvbGRTdGFydElkeCA9IDA7CiAgICB2YXIgbmV3U3RhcnRJZHggPSAwOwogICAgdmFyIG9sZEVuZElkeCA9IG9sZENoLmxlbmd0aCAtIDE7CiAgICB2YXIgb2xkU3RhcnRWbm9kZSA9IG9sZENoWzBdOwogICAgdmFyIG9sZEVuZFZub2RlID0gb2xkQ2hbb2xkRW5kSWR4XTsKICAgIHZhciBuZXdFbmRJZHggPSBuZXdDaC5sZW5ndGggLSAxOwogICAgdmFyIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFswXTsKICAgIHZhciBuZXdFbmRWbm9kZSA9IG5ld0NoW25ld0VuZElkeF07CiAgICB2YXIgb2xkS2V5VG9JZHgsIGlkeEluT2xkLCB2bm9kZVRvTW92ZSwgcmVmRWxtOyAvLyByZW1vdmVPbmx5IGlzIGEgc3BlY2lhbCBmbGFnIHVzZWQgb25seSBieSA8dHJhbnNpdGlvbi1ncm91cD4KICAgIC8vIHRvIGVuc3VyZSByZW1vdmVkIGVsZW1lbnRzIHN0YXkgaW4gY29ycmVjdCByZWxhdGl2ZSBwb3NpdGlvbnMKICAgIC8vIGR1cmluZyBsZWF2aW5nIHRyYW5zaXRpb25zCgogICAgdmFyIGNhbk1vdmUgPSAhcmVtb3ZlT25seTsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBjaGVja0R1cGxpY2F0ZUtleXMobmV3Q2gpOwogICAgfQoKICAgIHdoaWxlIChvbGRTdGFydElkeCA8PSBvbGRFbmRJZHggJiYgbmV3U3RhcnRJZHggPD0gbmV3RW5kSWR4KSB7CiAgICAgIGlmIChpc1VuZGVmKG9sZFN0YXJ0Vm5vZGUpKSB7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOyAvLyBWbm9kZSBoYXMgYmVlbiBtb3ZlZCBsZWZ0CiAgICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGRFbmRWbm9kZSkpIHsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICBwYXRjaFZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3RW5kVm5vZGUpKSB7CiAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3RW5kVm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld0VuZElkeCk7CiAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgbmV3RW5kVm5vZGUgPSBuZXdDaFstLW5ld0VuZElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld0VuZFZub2RlKSkgewogICAgICAgIC8vIFZub2RlIG1vdmVkIHJpZ2h0CiAgICAgICAgcGF0Y2hWbm9kZShvbGRTdGFydFZub2RlLCBuZXdFbmRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3RW5kSWR4KTsKICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRW5kVm5vZGUuZWxtKSk7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOwogICAgICAgIG5ld0VuZFZub2RlID0gbmV3Q2hbLS1uZXdFbmRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAvLyBWbm9kZSBtb3ZlZCBsZWZ0CiAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCBvbGRFbmRWbm9kZS5lbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtKTsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzVW5kZWYob2xkS2V5VG9JZHgpKSB7CiAgICAgICAgICBvbGRLZXlUb0lkeCA9IGNyZWF0ZUtleVRvT2xkSWR4KG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgICAgICB9CgogICAgICAgIGlkeEluT2xkID0gaXNEZWYobmV3U3RhcnRWbm9kZS5rZXkpID8gb2xkS2V5VG9JZHhbbmV3U3RhcnRWbm9kZS5rZXldIDogZmluZElkeEluT2xkKG5ld1N0YXJ0Vm5vZGUsIG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKCiAgICAgICAgaWYgKGlzVW5kZWYoaWR4SW5PbGQpKSB7CiAgICAgICAgICAvLyBOZXcgZWxlbWVudAogICAgICAgICAgY3JlYXRlRWxtKG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgZmFsc2UsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZub2RlVG9Nb3ZlID0gb2xkQ2hbaWR4SW5PbGRdOwoKICAgICAgICAgIGlmIChzYW1lVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgICAgIHBhdGNoVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICAgICAgb2xkQ2hbaWR4SW5PbGRdID0gdW5kZWZpbmVkOwogICAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgdm5vZGVUb01vdmUuZWxtLCBvbGRTdGFydFZub2RlLmVsbSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBzYW1lIGtleSBidXQgZGlmZmVyZW50IGVsZW1lbnQuIHRyZWF0IGFzIG5ldyBlbGVtZW50CiAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9CiAgICB9CgogICAgaWYgKG9sZFN0YXJ0SWR4ID4gb2xkRW5kSWR4KSB7CiAgICAgIHJlZkVsbSA9IGlzVW5kZWYobmV3Q2hbbmV3RW5kSWR4ICsgMV0pID8gbnVsbCA6IG5ld0NoW25ld0VuZElkeCArIDFdLmVsbTsKICAgICAgYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCBuZXdDaCwgbmV3U3RhcnRJZHgsIG5ld0VuZElkeCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgIH0gZWxzZSBpZiAobmV3U3RhcnRJZHggPiBuZXdFbmRJZHgpIHsKICAgICAgcmVtb3ZlVm5vZGVzKHBhcmVudEVsbSwgb2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKSB7CiAgICB2YXIgc2VlbktleXMgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciB2bm9kZSA9IGNoaWxkcmVuW2ldOwogICAgICB2YXIga2V5ID0gdm5vZGUua2V5OwoKICAgICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgICBpZiAoc2VlbktleXNba2V5XSkgewogICAgICAgICAgd2FybigiRHVwbGljYXRlIGtleXMgZGV0ZWN0ZWQ6ICciICsga2V5ICsgIicuIFRoaXMgbWF5IGNhdXNlIGFuIHVwZGF0ZSBlcnJvci4iLCB2bm9kZS5jb250ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VlbktleXNba2V5XSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5kSWR4SW5PbGQobm9kZSwgb2xkQ2gsIHN0YXJ0LCBlbmQpIHsKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgaSsrKSB7CiAgICAgIHZhciBjID0gb2xkQ2hbaV07CgogICAgICBpZiAoaXNEZWYoYykgJiYgc2FtZVZub2RlKG5vZGUsIGMpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHBhdGNoVm5vZGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG93bmVyQXJyYXksIGluZGV4LCByZW1vdmVPbmx5KSB7CiAgICBpZiAob2xkVm5vZGUgPT09IHZub2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaXNEZWYodm5vZGUuZWxtKSAmJiBpc0RlZihvd25lckFycmF5KSkgewogICAgICAvLyBjbG9uZSByZXVzZWQgdm5vZGUKICAgICAgdm5vZGUgPSBvd25lckFycmF5W2luZGV4XSA9IGNsb25lVk5vZGUodm5vZGUpOwogICAgfQoKICAgIHZhciBlbG0gPSB2bm9kZS5lbG0gPSBvbGRWbm9kZS5lbG07CgogICAgaWYgKGlzVHJ1ZShvbGRWbm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIpKSB7CiAgICAgIGlmIChpc0RlZih2bm9kZS5hc3luY0ZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgaHlkcmF0ZShvbGRWbm9kZS5lbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHZub2RlLmlzQXN5bmNQbGFjZWhvbGRlciA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0gLy8gcmV1c2UgZWxlbWVudCBmb3Igc3RhdGljIHRyZWVzLgogICAgLy8gbm90ZSB3ZSBvbmx5IGRvIHRoaXMgaWYgdGhlIHZub2RlIGlzIGNsb25lZCAtCiAgICAvLyBpZiB0aGUgbmV3IG5vZGUgaXMgbm90IGNsb25lZCBpdCBtZWFucyB0aGUgcmVuZGVyIGZ1bmN0aW9ucyBoYXZlIGJlZW4KICAgIC8vIHJlc2V0IGJ5IHRoZSBob3QtcmVsb2FkLWFwaSBhbmQgd2UgbmVlZCB0byBkbyBhIHByb3BlciByZS1yZW5kZXIuCgoKICAgIGlmIChpc1RydWUodm5vZGUuaXNTdGF0aWMpICYmIGlzVHJ1ZShvbGRWbm9kZS5pc1N0YXRpYykgJiYgdm5vZGUua2V5ID09PSBvbGRWbm9kZS5rZXkgJiYgKGlzVHJ1ZSh2bm9kZS5pc0Nsb25lZCkgfHwgaXNUcnVlKHZub2RlLmlzT25jZSkpKSB7CiAgICAgIHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgaTsKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKCiAgICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucHJlcGF0Y2gpKSB7CiAgICAgIGkob2xkVm5vZGUsIHZub2RlKTsKICAgIH0KCiAgICB2YXIgb2xkQ2ggPSBvbGRWbm9kZS5jaGlsZHJlbjsKICAgIHZhciBjaCA9IHZub2RlLmNoaWxkcmVuOwoKICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc1BhdGNoYWJsZSh2bm9kZSkpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy51cGRhdGUubGVuZ3RoOyArK2kpIHsKICAgICAgICBjYnMudXBkYXRlW2ldKG9sZFZub2RlLCB2bm9kZSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS51cGRhdGUpKSB7CiAgICAgICAgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzVW5kZWYodm5vZGUudGV4dCkpIHsKICAgICAgaWYgKGlzRGVmKG9sZENoKSAmJiBpc0RlZihjaCkpIHsKICAgICAgICBpZiAob2xkQ2ggIT09IGNoKSB7CiAgICAgICAgICB1cGRhdGVDaGlsZHJlbihlbG0sIG9sZENoLCBjaCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCByZW1vdmVPbmx5KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIGNoZWNrRHVwbGljYXRlS2V5cyhjaCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWYob2xkVm5vZGUudGV4dCkpIHsKICAgICAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCAnJyk7CiAgICAgICAgfQoKICAgICAgICBhZGRWbm9kZXMoZWxtLCBudWxsLCBjaCwgMCwgY2gubGVuZ3RoIC0gMSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRDaCkpIHsKICAgICAgICByZW1vdmVWbm9kZXMoZWxtLCBvbGRDaCwgMCwgb2xkQ2gubGVuZ3RoIC0gMSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkVm5vZGUudGV4dCkpIHsKICAgICAgICBub2RlT3BzLnNldFRleHRDb250ZW50KGVsbSwgJycpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG9sZFZub2RlLnRleHQgIT09IHZub2RlLnRleHQpIHsKICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sIHZub2RlLnRleHQpOwogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucG9zdHBhdGNoKSkgewogICAgICAgIGkob2xkVm5vZGUsIHZub2RlKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgcXVldWUsIGluaXRpYWwpIHsKICAgIC8vIGRlbGF5IGluc2VydCBob29rcyBmb3IgY29tcG9uZW50IHJvb3Qgbm9kZXMsIGludm9rZSB0aGVtIGFmdGVyIHRoZQogICAgLy8gZWxlbWVudCBpcyByZWFsbHkgaW5zZXJ0ZWQKICAgIGlmIChpc1RydWUoaW5pdGlhbCkgJiYgaXNEZWYodm5vZGUucGFyZW50KSkgewogICAgICB2bm9kZS5wYXJlbnQuZGF0YS5wZW5kaW5nSW5zZXJ0ID0gcXVldWU7CiAgICB9IGVsc2UgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcXVldWVbaV0uZGF0YS5ob29rLmluc2VydChxdWV1ZVtpXSk7CiAgICAgIH0KICAgIH0KICB9CgogIHZhciBoeWRyYXRpb25CYWlsZWQgPSBmYWxzZTsgLy8gbGlzdCBvZiBtb2R1bGVzIHRoYXQgY2FuIHNraXAgY3JlYXRlIGhvb2sgZHVyaW5nIGh5ZHJhdGlvbiBiZWNhdXNlIHRoZXkKICAvLyBhcmUgYWxyZWFkeSByZW5kZXJlZCBvbiB0aGUgY2xpZW50IG9yIGhhcyBubyBuZWVkIGZvciBpbml0aWFsaXphdGlvbgogIC8vIE5vdGU6IHN0eWxlIGlzIGV4Y2x1ZGVkIGJlY2F1c2UgaXQgcmVsaWVzIG9uIGluaXRpYWwgY2xvbmUgZm9yIGZ1dHVyZQogIC8vIGRlZXAgdXBkYXRlcyAoIzcwNjMpLgoKICB2YXIgaXNSZW5kZXJlZE1vZHVsZSA9IG1ha2VNYXAoJ2F0dHJzLGNsYXNzLHN0YXRpY0NsYXNzLHN0YXRpY1N0eWxlLGtleScpOyAvLyBOb3RlOiB0aGlzIGlzIGEgYnJvd3Nlci1vbmx5IGZ1bmN0aW9uIHNvIHdlIGNhbiBhc3N1bWUgZWxtcyBhcmUgRE9NIG5vZGVzLgoKICBmdW5jdGlvbiBoeWRyYXRlKGVsbSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgaW5WUHJlKSB7CiAgICB2YXIgaTsKICAgIHZhciB0YWcgPSB2bm9kZS50YWc7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICB2YXIgY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsKICAgIGluVlByZSA9IGluVlByZSB8fCBkYXRhICYmIGRhdGEucHJlOwogICAgdm5vZGUuZWxtID0gZWxtOwoKICAgIGlmIChpc1RydWUodm5vZGUuaXNDb21tZW50KSAmJiBpc0RlZih2bm9kZS5hc3luY0ZhY3RvcnkpKSB7CiAgICAgIHZub2RlLmlzQXN5bmNQbGFjZWhvbGRlciA9IHRydWU7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSAvLyBhc3NlcnQgbm9kZSBtYXRjaAoKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAoIWFzc2VydE5vZGVNYXRjaChlbG0sIHZub2RlLCBpblZQcmUpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5pbml0KSkgewogICAgICAgIGkodm5vZGUsIHRydWUKICAgICAgICAvKiBoeWRyYXRpbmcgKi8KICAgICAgICApOwogICAgICB9CgogICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgIC8vIGNoaWxkIGNvbXBvbmVudC4gaXQgc2hvdWxkIGhhdmUgaHlkcmF0ZWQgaXRzIG93biB0cmVlLgogICAgICAgIGluaXRDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoaXNEZWYodGFnKSkgewogICAgICBpZiAoaXNEZWYoY2hpbGRyZW4pKSB7CiAgICAgICAgLy8gZW1wdHkgZWxlbWVudCwgYWxsb3cgY2xpZW50IHRvIHBpY2sgdXAgYW5kIHBvcHVsYXRlIGNoaWxkcmVuCiAgICAgICAgaWYgKCFlbG0uaGFzQ2hpbGROb2RlcygpKSB7CiAgICAgICAgICBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHYtaHRtbCBhbmQgZG9tUHJvcHM6IGlubmVySFRNTAogICAgICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhKSAmJiBpc0RlZihpID0gaS5kb21Qcm9wcykgJiYgaXNEZWYoaSA9IGkuaW5uZXJIVE1MKSkgewogICAgICAgICAgICBpZiAoaSAhPT0gZWxtLmlubmVySFRNTCkgewogICAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJyAmJiAhaHlkcmF0aW9uQmFpbGVkKSB7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25CYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdQYXJlbnQ6ICcsIGVsbSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ3NlcnZlciBpbm5lckhUTUw6ICcsIGkpOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdjbGllbnQgaW5uZXJIVE1MOiAnLCBlbG0uaW5uZXJIVE1MKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gaXRlcmF0ZSBhbmQgY29tcGFyZSBjaGlsZHJlbiBsaXN0cwogICAgICAgICAgICB2YXIgY2hpbGRyZW5NYXRjaCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE5vZGUgPSBlbG0uZmlyc3RDaGlsZDsKCiAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNoaWxkcmVuLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICAgICAgICBpZiAoIWNoaWxkTm9kZSB8fCAhaHlkcmF0ZShjaGlsZE5vZGUsIGNoaWxkcmVuW2kkMV0sIGluc2VydGVkVm5vZGVRdWV1ZSwgaW5WUHJlKSkgewogICAgICAgICAgICAgICAgY2hpbGRyZW5NYXRjaCA9IGZhbHNlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjaGlsZE5vZGUgPSBjaGlsZE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0gLy8gaWYgY2hpbGROb2RlIGlzIG5vdCBudWxsLCBpdCBtZWFucyB0aGUgYWN0dWFsIGNoaWxkTm9kZXMgbGlzdCBpcwogICAgICAgICAgICAvLyBsb25nZXIgdGhhbiB0aGUgdmlydHVhbCBjaGlsZHJlbiBsaXN0LgoKCiAgICAgICAgICAgIGlmICghY2hpbGRyZW5NYXRjaCB8fCBjaGlsZE5vZGUpIHsKICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWh5ZHJhdGlvbkJhaWxlZCkgewogICAgICAgICAgICAgICAgaHlkcmF0aW9uQmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNtYXRjaGluZyBjaGlsZE5vZGVzIHZzLiBWTm9kZXM6ICcsIGVsbS5jaGlsZE5vZGVzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICAgIHZhciBmdWxsSW52b2tlID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICBpZiAoIWlzUmVuZGVyZWRNb2R1bGUoa2V5KSkgewogICAgICAgICAgICBmdWxsSW52b2tlID0gdHJ1ZTsKICAgICAgICAgICAgaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCFmdWxsSW52b2tlICYmIGRhdGFbJ2NsYXNzJ10pIHsKICAgICAgICAgIC8vIGVuc3VyZSBjb2xsZWN0aW5nIGRlcHMgZm9yIGRlZXAgY2xhc3MgYmluZGluZ3MgZm9yIGZ1dHVyZSB1cGRhdGVzCiAgICAgICAgICB0cmF2ZXJzZShkYXRhWydjbGFzcyddKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZWxtLmRhdGEgIT09IHZub2RlLnRleHQpIHsKICAgICAgZWxtLmRhdGEgPSB2bm9kZS50ZXh0OwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gYXNzZXJ0Tm9kZU1hdGNoKG5vZGUsIHZub2RlLCBpblZQcmUpIHsKICAgIGlmIChpc0RlZih2bm9kZS50YWcpKSB7CiAgICAgIHJldHVybiB2bm9kZS50YWcuaW5kZXhPZigndnVlLWNvbXBvbmVudCcpID09PSAwIHx8ICFpc1Vua25vd25FbGVtZW50JCQxKHZub2RlLCBpblZQcmUpICYmIHZub2RlLnRhZy50b0xvd2VyQ2FzZSgpID09PSAobm9kZS50YWdOYW1lICYmIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAodm5vZGUuaXNDb21tZW50ID8gOCA6IDMpOwogICAgfQogIH0KCiAgcmV0dXJuIGZ1bmN0aW9uIHBhdGNoKG9sZFZub2RlLCB2bm9kZSwgaHlkcmF0aW5nLCByZW1vdmVPbmx5KSB7CiAgICBpZiAoaXNVbmRlZih2bm9kZSkpIHsKICAgICAgaWYgKGlzRGVmKG9sZFZub2RlKSkgewogICAgICAgIGludm9rZURlc3Ryb3lIb29rKG9sZFZub2RlKTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBpc0luaXRpYWxQYXRjaCA9IGZhbHNlOwogICAgdmFyIGluc2VydGVkVm5vZGVRdWV1ZSA9IFtdOwoKICAgIGlmIChpc1VuZGVmKG9sZFZub2RlKSkgewogICAgICAvLyBlbXB0eSBtb3VudCAobGlrZWx5IGFzIGNvbXBvbmVudCksIGNyZWF0ZSBuZXcgcm9vdCBlbGVtZW50CiAgICAgIGlzSW5pdGlhbFBhdGNoID0gdHJ1ZTsKICAgICAgY3JlYXRlRWxtKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGlzUmVhbEVsZW1lbnQgPSBpc0RlZihvbGRWbm9kZS5ub2RlVHlwZSk7CgogICAgICBpZiAoIWlzUmVhbEVsZW1lbnQgJiYgc2FtZVZub2RlKG9sZFZub2RlLCB2bm9kZSkpIHsKICAgICAgICAvLyBwYXRjaCBleGlzdGluZyByb290IG5vZGUKICAgICAgICBwYXRjaFZub2RlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBudWxsLCBudWxsLCByZW1vdmVPbmx5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNSZWFsRWxlbWVudCkgewogICAgICAgICAgLy8gbW91bnRpbmcgdG8gYSByZWFsIGVsZW1lbnQKICAgICAgICAgIC8vIGNoZWNrIGlmIHRoaXMgaXMgc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQgYW5kIGlmIHdlIGNhbiBwZXJmb3JtCiAgICAgICAgICAvLyBhIHN1Y2Nlc3NmdWwgaHlkcmF0aW9uLgogICAgICAgICAgaWYgKG9sZFZub2RlLm5vZGVUeXBlID09PSAxICYmIG9sZFZub2RlLmhhc0F0dHJpYnV0ZShTU1JfQVRUUikpIHsKICAgICAgICAgICAgb2xkVm5vZGUucmVtb3ZlQXR0cmlidXRlKFNTUl9BVFRSKTsKICAgICAgICAgICAgaHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNUcnVlKGh5ZHJhdGluZykpIHsKICAgICAgICAgICAgaWYgKGh5ZHJhdGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpKSB7CiAgICAgICAgICAgICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB0cnVlKTsKICAgICAgICAgICAgICByZXR1cm4gb2xkVm5vZGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgICAgIHdhcm4oJ1RoZSBjbGllbnQtc2lkZSByZW5kZXJlZCB2aXJ0dWFsIERPTSB0cmVlIGlzIG5vdCBtYXRjaGluZyAnICsgJ3NlcnZlci1yZW5kZXJlZCBjb250ZW50LiBUaGlzIGlzIGxpa2VseSBjYXVzZWQgYnkgaW5jb3JyZWN0ICcgKyAnSFRNTCBtYXJrdXAsIGZvciBleGFtcGxlIG5lc3RpbmcgYmxvY2stbGV2ZWwgZWxlbWVudHMgaW5zaWRlICcgKyAnPHA+LCBvciBtaXNzaW5nIDx0Ym9keT4uIEJhaWxpbmcgaHlkcmF0aW9uIGFuZCBwZXJmb3JtaW5nICcgKyAnZnVsbCBjbGllbnQtc2lkZSByZW5kZXIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gLy8gZWl0aGVyIG5vdCBzZXJ2ZXItcmVuZGVyZWQsIG9yIGh5ZHJhdGlvbiBmYWlsZWQuCiAgICAgICAgICAvLyBjcmVhdGUgYW4gZW1wdHkgbm9kZSBhbmQgcmVwbGFjZSBpdAoKCiAgICAgICAgICBvbGRWbm9kZSA9IGVtcHR5Tm9kZUF0KG9sZFZub2RlKTsKICAgICAgICB9IC8vIHJlcGxhY2luZyBleGlzdGluZyBlbGVtZW50CgoKICAgICAgICB2YXIgb2xkRWxtID0gb2xkVm5vZGUuZWxtOwogICAgICAgIHZhciBwYXJlbnRFbG0gPSBub2RlT3BzLnBhcmVudE5vZGUob2xkRWxtKTsgLy8gY3JlYXRlIG5ldyBub2RlCgogICAgICAgIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCAvLyBleHRyZW1lbHkgcmFyZSBlZGdlIGNhc2U6IGRvIG5vdCBpbnNlcnQgaWYgb2xkIGVsZW1lbnQgaXMgaW4gYQogICAgICAgIC8vIGxlYXZpbmcgdHJhbnNpdGlvbi4gT25seSBoYXBwZW5zIHdoZW4gY29tYmluaW5nIHRyYW5zaXRpb24gKwogICAgICAgIC8vIGtlZXAtYWxpdmUgKyBIT0NzLiAoIzQ1OTApCiAgICAgICAgb2xkRWxtLl9sZWF2ZUNiID8gbnVsbCA6IHBhcmVudEVsbSwgbm9kZU9wcy5uZXh0U2libGluZyhvbGRFbG0pKTsgLy8gdXBkYXRlIHBhcmVudCBwbGFjZWhvbGRlciBub2RlIGVsZW1lbnQsIHJlY3Vyc2l2ZWx5CgogICAgICAgIGlmIChpc0RlZih2bm9kZS5wYXJlbnQpKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3IgPSB2bm9kZS5wYXJlbnQ7CiAgICAgICAgICB2YXIgcGF0Y2hhYmxlID0gaXNQYXRjaGFibGUodm5vZGUpOwoKICAgICAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNicy5kZXN0cm95Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgY2JzLmRlc3Ryb3lbaV0oYW5jZXN0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhbmNlc3Rvci5lbG0gPSB2bm9kZS5lbG07CgogICAgICAgICAgICBpZiAocGF0Y2hhYmxlKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgY2JzLmNyZWF0ZS5sZW5ndGg7ICsraSQxKSB7CiAgICAgICAgICAgICAgICBjYnMuY3JlYXRlW2kkMV0oZW1wdHlOb2RlLCBhbmNlc3Rvcik7CiAgICAgICAgICAgICAgfSAvLyAjNjUxMwogICAgICAgICAgICAgIC8vIGludm9rZSBpbnNlcnQgaG9va3MgdGhhdCBtYXkgaGF2ZSBiZWVuIG1lcmdlZCBieSBjcmVhdGUgaG9va3MuCiAgICAgICAgICAgICAgLy8gZS5nLiBmb3IgZGlyZWN0aXZlcyB0aGF0IHVzZXMgdGhlICJpbnNlcnRlZCIgaG9vay4KCgogICAgICAgICAgICAgIHZhciBpbnNlcnQgPSBhbmNlc3Rvci5kYXRhLmhvb2suaW5zZXJ0OwoKICAgICAgICAgICAgICBpZiAoaW5zZXJ0Lm1lcmdlZCkgewogICAgICAgICAgICAgICAgLy8gc3RhcnQgYXQgaW5kZXggMSB0byBhdm9pZCByZS1pbnZva2luZyBjb21wb25lbnQgbW91bnRlZCBob29rCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpJDIgPSAxOyBpJDIgPCBpbnNlcnQuZm5zLmxlbmd0aDsgaSQyKyspIHsKICAgICAgICAgICAgICAgICAgaW5zZXJ0LmZuc1tpJDJdKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZ2lzdGVyUmVmKGFuY2VzdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBkZXN0cm95IG9sZCBub2RlCgoKICAgICAgICBpZiAoaXNEZWYocGFyZW50RWxtKSkgewogICAgICAgICAgcmVtb3ZlVm5vZGVzKHBhcmVudEVsbSwgW29sZFZub2RlXSwgMCwgMCk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRWbm9kZS50YWcpKSB7CiAgICAgICAgICBpbnZva2VEZXN0cm95SG9vayhvbGRWbm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpc0luaXRpYWxQYXRjaCk7CiAgICByZXR1cm4gdm5vZGUuZWxtOwogIH07Cn0KLyogICovCgoKdmFyIGRpcmVjdGl2ZXMgPSB7CiAgY3JlYXRlOiB1cGRhdGVEaXJlY3RpdmVzLAogIHVwZGF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICBkZXN0cm95OiBmdW5jdGlvbiB1bmJpbmREaXJlY3RpdmVzKHZub2RlKSB7CiAgICB1cGRhdGVEaXJlY3RpdmVzKHZub2RlLCBlbXB0eU5vZGUpOwogIH0KfTsKCmZ1bmN0aW9uIHVwZGF0ZURpcmVjdGl2ZXMob2xkVm5vZGUsIHZub2RlKSB7CiAgaWYgKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcyB8fCB2bm9kZS5kYXRhLmRpcmVjdGl2ZXMpIHsKICAgIF91cGRhdGUob2xkVm5vZGUsIHZub2RlKTsKICB9Cn0KCmZ1bmN0aW9uIF91cGRhdGUob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIGlzQ3JlYXRlID0gb2xkVm5vZGUgPT09IGVtcHR5Tm9kZTsKICB2YXIgaXNEZXN0cm95ID0gdm5vZGUgPT09IGVtcHR5Tm9kZTsKICB2YXIgb2xkRGlycyA9IG5vcm1hbGl6ZURpcmVjdGl2ZXMkMShvbGRWbm9kZS5kYXRhLmRpcmVjdGl2ZXMsIG9sZFZub2RlLmNvbnRleHQpOwogIHZhciBuZXdEaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyQxKHZub2RlLmRhdGEuZGlyZWN0aXZlcywgdm5vZGUuY29udGV4dCk7CiAgdmFyIGRpcnNXaXRoSW5zZXJ0ID0gW107CiAgdmFyIGRpcnNXaXRoUG9zdHBhdGNoID0gW107CiAgdmFyIGtleSwgb2xkRGlyLCBkaXI7CgogIGZvciAoa2V5IGluIG5ld0RpcnMpIHsKICAgIG9sZERpciA9IG9sZERpcnNba2V5XTsKICAgIGRpciA9IG5ld0RpcnNba2V5XTsKCiAgICBpZiAoIW9sZERpcikgewogICAgICAvLyBuZXcgZGlyZWN0aXZlLCBiaW5kCiAgICAgIGNhbGxIb29rJDEoZGlyLCAnYmluZCcsIHZub2RlLCBvbGRWbm9kZSk7CgogICAgICBpZiAoZGlyLmRlZiAmJiBkaXIuZGVmLmluc2VydGVkKSB7CiAgICAgICAgZGlyc1dpdGhJbnNlcnQucHVzaChkaXIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBleGlzdGluZyBkaXJlY3RpdmUsIHVwZGF0ZQogICAgICBkaXIub2xkVmFsdWUgPSBvbGREaXIudmFsdWU7CiAgICAgIGRpci5vbGRBcmcgPSBvbGREaXIuYXJnOwogICAgICBjYWxsSG9vayQxKGRpciwgJ3VwZGF0ZScsIHZub2RlLCBvbGRWbm9kZSk7CgogICAgICBpZiAoZGlyLmRlZiAmJiBkaXIuZGVmLmNvbXBvbmVudFVwZGF0ZWQpIHsKICAgICAgICBkaXJzV2l0aFBvc3RwYXRjaC5wdXNoKGRpcik7CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChkaXJzV2l0aEluc2VydC5sZW5ndGgpIHsKICAgIHZhciBjYWxsSW5zZXJ0ID0gZnVuY3Rpb24gY2FsbEluc2VydCgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aEluc2VydC5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxIb29rJDEoZGlyc1dpdGhJbnNlcnRbaV0sICdpbnNlcnRlZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgIH0KICAgIH07CgogICAgaWYgKGlzQ3JlYXRlKSB7CiAgICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgY2FsbEluc2VydCk7CiAgICB9IGVsc2UgewogICAgICBjYWxsSW5zZXJ0KCk7CiAgICB9CiAgfQoKICBpZiAoZGlyc1dpdGhQb3N0cGF0Y2gubGVuZ3RoKSB7CiAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aFBvc3RwYXRjaC5sZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxIb29rJDEoZGlyc1dpdGhQb3N0cGF0Y2hbaV0sICdjb21wb25lbnRVcGRhdGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAoIWlzQ3JlYXRlKSB7CiAgICBmb3IgKGtleSBpbiBvbGREaXJzKSB7CiAgICAgIGlmICghbmV3RGlyc1trZXldKSB7CiAgICAgICAgLy8gbm8gbG9uZ2VyIHByZXNlbnQsIHVuYmluZAogICAgICAgIGNhbGxIb29rJDEob2xkRGlyc1trZXldLCAndW5iaW5kJywgb2xkVm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpOwogICAgICB9CiAgICB9CiAgfQp9Cgp2YXIgZW1wdHlNb2RpZmllcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKZnVuY3Rpb24gbm9ybWFsaXplRGlyZWN0aXZlcyQxKGRpcnMsIHZtKSB7CiAgdmFyIHJlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogIGlmICghZGlycykgewogICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICByZXR1cm4gcmVzOwogIH0KCiAgdmFyIGksIGRpcjsKCiAgZm9yIChpID0gMDsgaSA8IGRpcnMubGVuZ3RoOyBpKyspIHsKICAgIGRpciA9IGRpcnNbaV07CgogICAgaWYgKCFkaXIubW9kaWZpZXJzKSB7CiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICBkaXIubW9kaWZpZXJzID0gZW1wdHlNb2RpZmllcnM7CiAgICB9CgogICAgcmVzW2dldFJhd0Rpck5hbWUoZGlyKV0gPSBkaXI7CiAgICBkaXIuZGVmID0gcmVzb2x2ZUFzc2V0KHZtLiRvcHRpb25zLCAnZGlyZWN0aXZlcycsIGRpci5uYW1lLCB0cnVlKTsKICB9IC8vICRmbG93LWRpc2FibGUtbGluZQoKCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gZ2V0UmF3RGlyTmFtZShkaXIpIHsKICByZXR1cm4gZGlyLnJhd05hbWUgfHwgZGlyLm5hbWUgKyAiLiIgKyBPYmplY3Qua2V5cyhkaXIubW9kaWZpZXJzIHx8IHt9KS5qb2luKCcuJyk7Cn0KCmZ1bmN0aW9uIGNhbGxIb29rJDEoZGlyLCBob29rLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSkgewogIHZhciBmbiA9IGRpci5kZWYgJiYgZGlyLmRlZltob29rXTsKCiAgaWYgKGZuKSB7CiAgICB0cnkgewogICAgICBmbih2bm9kZS5lbG0sIGRpciwgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBoYW5kbGVFcnJvcihlLCB2bm9kZS5jb250ZXh0LCAiZGlyZWN0aXZlICIgKyBkaXIubmFtZSArICIgIiArIGhvb2sgKyAiIGhvb2siKTsKICAgIH0KICB9Cn0KCnZhciBiYXNlTW9kdWxlcyA9IFtyZWYsIGRpcmVjdGl2ZXNdOwovKiAgKi8KCmZ1bmN0aW9uIHVwZGF0ZUF0dHJzKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBvcHRzID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKCiAgaWYgKGlzRGVmKG9wdHMpICYmIG9wdHMuQ3Rvci5vcHRpb25zLmluaGVyaXRBdHRycyA9PT0gZmFsc2UpIHsKICAgIHJldHVybjsKICB9CgogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEuYXR0cnMpICYmIGlzVW5kZWYodm5vZGUuZGF0YS5hdHRycykpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBrZXksIGN1ciwgb2xkOwogIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgdmFyIG9sZEF0dHJzID0gb2xkVm5vZGUuZGF0YS5hdHRycyB8fCB7fTsKICB2YXIgYXR0cnMgPSB2bm9kZS5kYXRhLmF0dHJzIHx8IHt9OyAvLyBjbG9uZSBvYnNlcnZlZCBvYmplY3RzLCBhcyB0aGUgdXNlciBwcm9iYWJseSB3YW50cyB0byBtdXRhdGUgaXQKCiAgaWYgKGlzRGVmKGF0dHJzLl9fb2JfXykpIHsKICAgIGF0dHJzID0gdm5vZGUuZGF0YS5hdHRycyA9IGV4dGVuZCh7fSwgYXR0cnMpOwogIH0KCiAgZm9yIChrZXkgaW4gYXR0cnMpIHsKICAgIGN1ciA9IGF0dHJzW2tleV07CiAgICBvbGQgPSBvbGRBdHRyc1trZXldOwoKICAgIGlmIChvbGQgIT09IGN1cikgewogICAgICBzZXRBdHRyKGVsbSwga2V5LCBjdXIpOwogICAgfQogIH0gLy8gIzQzOTE6IGluIElFOSwgc2V0dGluZyB0eXBlIGNhbiByZXNldCB2YWx1ZSBmb3IgaW5wdXRbdHlwZT1yYWRpb10KICAvLyAjNjY2NjogSUUvRWRnZSBmb3JjZXMgcHJvZ3Jlc3MgdmFsdWUgZG93biB0byAxIGJlZm9yZSBzZXR0aW5nIGEgbWF4CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKChpc0lFIHx8IGlzRWRnZSkgJiYgYXR0cnMudmFsdWUgIT09IG9sZEF0dHJzLnZhbHVlKSB7CiAgICBzZXRBdHRyKGVsbSwgJ3ZhbHVlJywgYXR0cnMudmFsdWUpOwogIH0KCiAgZm9yIChrZXkgaW4gb2xkQXR0cnMpIHsKICAgIGlmIChpc1VuZGVmKGF0dHJzW2tleV0pKSB7CiAgICAgIGlmIChpc1hsaW5rKGtleSkpIHsKICAgICAgICBlbG0ucmVtb3ZlQXR0cmlidXRlTlMoeGxpbmtOUywgZ2V0WGxpbmtQcm9wKGtleSkpOwogICAgICB9IGVsc2UgaWYgKCFpc0VudW1lcmF0ZWRBdHRyKGtleSkpIHsKICAgICAgICBlbG0ucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHNldEF0dHIoZWwsIGtleSwgdmFsdWUpIHsKICBpZiAoZWwudGFnTmFtZS5pbmRleE9mKCctJykgPiAtMSkgewogICAgYmFzZVNldEF0dHIoZWwsIGtleSwgdmFsdWUpOwogIH0gZWxzZSBpZiAoaXNCb29sZWFuQXR0cihrZXkpKSB7CiAgICAvLyBzZXQgYXR0cmlidXRlIGZvciBibGFuayB2YWx1ZQogICAgLy8gZS5nLiA8b3B0aW9uIGRpc2FibGVkPlNlbGVjdCBvbmU8L29wdGlvbj4KICAgIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRlY2huaWNhbGx5IGFsbG93ZnVsbHNjcmVlbiBpcyBhIGJvb2xlYW4gYXR0cmlidXRlIGZvciA8aWZyYW1lPiwKICAgICAgLy8gYnV0IEZsYXNoIGV4cGVjdHMgYSB2YWx1ZSBvZiAidHJ1ZSIgd2hlbiB1c2VkIG9uIDxlbWJlZD4gdGFnCiAgICAgIHZhbHVlID0ga2V5ID09PSAnYWxsb3dmdWxsc2NyZWVuJyAmJiBlbC50YWdOYW1lID09PSAnRU1CRUQnID8gJ3RydWUnIDoga2V5OwogICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc0VudW1lcmF0ZWRBdHRyKGtleSkpIHsKICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUoa2V5LCB2YWx1ZSkpOwogIH0gZWxzZSBpZiAoaXNYbGluayhrZXkpKSB7CiAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlTlMoeGxpbmtOUywgZ2V0WGxpbmtQcm9wKGtleSkpOwogICAgfSBlbHNlIHsKICAgICAgZWwuc2V0QXR0cmlidXRlTlMoeGxpbmtOUywga2V5LCB2YWx1ZSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKTsKICB9Cn0KCmZ1bmN0aW9uIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKSB7CiAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICB9IGVsc2UgewogICAgLy8gIzcxMzg6IElFMTAgJiAxMSBmaXJlcyBpbnB1dCBldmVudCB3aGVuIHNldHRpbmcgcGxhY2Vob2xkZXIgb24KICAgIC8vIDx0ZXh0YXJlYT4uLi4gYmxvY2sgdGhlIGZpcnN0IGlucHV0IGV2ZW50IGFuZCByZW1vdmUgdGhlIGJsb2NrZXIKICAgIC8vIGltbWVkaWF0ZWx5LgoKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzSUUgJiYgIWlzSUU5ICYmIGVsLnRhZ05hbWUgPT09ICdURVhUQVJFQScgJiYga2V5ID09PSAncGxhY2Vob2xkZXInICYmIHZhbHVlICE9PSAnJyAmJiAhZWwuX19pZXBoKSB7CiAgICAgIHZhciBibG9ja2VyID0gZnVuY3Rpb24gYmxvY2tlcihlKSB7CiAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdpbnB1dCcsIGJsb2NrZXIpOwogICAgICB9OwoKICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyKTsgLy8gJGZsb3ctZGlzYWJsZS1saW5lCgogICAgICBlbC5fX2llcGggPSB0cnVlOwogICAgICAvKiBJRSBwbGFjZWhvbGRlciBwYXRjaGVkICovCiAgICB9CgogICAgZWwuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogIH0KfQoKdmFyIGF0dHJzID0gewogIGNyZWF0ZTogdXBkYXRlQXR0cnMsCiAgdXBkYXRlOiB1cGRhdGVBdHRycwp9OwovKiAgKi8KCmZ1bmN0aW9uIHVwZGF0ZUNsYXNzKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBlbCA9IHZub2RlLmVsbTsKICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgdmFyIG9sZERhdGEgPSBvbGRWbm9kZS5kYXRhOwoKICBpZiAoaXNVbmRlZihkYXRhLnN0YXRpY0NsYXNzKSAmJiBpc1VuZGVmKGRhdGFbImNsYXNzIl0pICYmIChpc1VuZGVmKG9sZERhdGEpIHx8IGlzVW5kZWYob2xkRGF0YS5zdGF0aWNDbGFzcykgJiYgaXNVbmRlZihvbGREYXRhWyJjbGFzcyJdKSkpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjbHMgPSBnZW5DbGFzc0ZvclZub2RlKHZub2RlKTsgLy8gaGFuZGxlIHRyYW5zaXRpb24gY2xhc3NlcwoKICB2YXIgdHJhbnNpdGlvbkNsYXNzID0gZWwuX3RyYW5zaXRpb25DbGFzc2VzOwoKICBpZiAoaXNEZWYodHJhbnNpdGlvbkNsYXNzKSkgewogICAgY2xzID0gY29uY2F0KGNscywgc3RyaW5naWZ5Q2xhc3ModHJhbnNpdGlvbkNsYXNzKSk7CiAgfSAvLyBzZXQgdGhlIGNsYXNzCgoKICBpZiAoY2xzICE9PSBlbC5fcHJldkNsYXNzKSB7CiAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgY2xzKTsKICAgIGVsLl9wcmV2Q2xhc3MgPSBjbHM7CiAgfQp9Cgp2YXIga2xhc3MgPSB7CiAgY3JlYXRlOiB1cGRhdGVDbGFzcywKICB1cGRhdGU6IHVwZGF0ZUNsYXNzCn07Ci8qICAqLwoKLyogICovCgovKiAgKi8KCi8qICAqLwovLyBpbiBzb21lIGNhc2VzLCB0aGUgZXZlbnQgdXNlZCBoYXMgdG8gYmUgZGV0ZXJtaW5lZCBhdCBydW50aW1lCi8vIHNvIHdlIHVzZWQgc29tZSByZXNlcnZlZCB0b2tlbnMgZHVyaW5nIGNvbXBpbGUuCgp2YXIgUkFOR0VfVE9LRU4gPSAnX19yJzsKdmFyIENIRUNLQk9YX1JBRElPX1RPS0VOID0gJ19fYyc7Ci8qICAqLwovLyBub3JtYWxpemUgdi1tb2RlbCBldmVudCB0b2tlbnMgdGhhdCBjYW4gb25seSBiZSBkZXRlcm1pbmVkIGF0IHJ1bnRpbWUuCi8vIGl0J3MgaW1wb3J0YW50IHRvIHBsYWNlIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgaW4gdGhlIGFycmF5IGJlY2F1c2UKLy8gdGhlIHdob2xlIHBvaW50IGlzIGVuc3VyaW5nIHRoZSB2LW1vZGVsIGNhbGxiYWNrIGdldHMgY2FsbGVkIGJlZm9yZQovLyB1c2VyLWF0dGFjaGVkIGhhbmRsZXJzLgoKZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzKG9uKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGlzRGVmKG9uW1JBTkdFX1RPS0VOXSkpIHsKICAgIC8vIElFIGlucHV0W3R5cGU9cmFuZ2VdIG9ubHkgc3VwcG9ydHMgYGNoYW5nZWAgZXZlbnQKICAgIHZhciBldmVudCA9IGlzSUUgPyAnY2hhbmdlJyA6ICdpbnB1dCc7CiAgICBvbltldmVudF0gPSBbXS5jb25jYXQob25bUkFOR0VfVE9LRU5dLCBvbltldmVudF0gfHwgW10pOwogICAgZGVsZXRlIG9uW1JBTkdFX1RPS0VOXTsKICB9IC8vIFRoaXMgd2FzIG9yaWdpbmFsbHkgaW50ZW5kZWQgdG8gZml4ICM0NTIxIGJ1dCBubyBsb25nZXIgbmVjZXNzYXJ5CiAgLy8gYWZ0ZXIgMi41LiBLZWVwaW5nIGl0IGZvciBiYWNrd2FyZHMgY29tcGF0IHdpdGggZ2VuZXJhdGVkIGNvZGUgZnJvbSA8IDIuNAoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChpc0RlZihvbltDSEVDS0JPWF9SQURJT19UT0tFTl0pKSB7CiAgICBvbi5jaGFuZ2UgPSBbXS5jb25jYXQob25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dLCBvbi5jaGFuZ2UgfHwgW10pOwogICAgZGVsZXRlIG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXTsKICB9Cn0KCnZhciB0YXJnZXQkMTsKCmZ1bmN0aW9uIGNyZWF0ZU9uY2VIYW5kbGVyJDEoZXZlbnQsIGhhbmRsZXIsIGNhcHR1cmUpIHsKICB2YXIgX3RhcmdldCA9IHRhcmdldCQxOyAvLyBzYXZlIGN1cnJlbnQgdGFyZ2V0IGVsZW1lbnQgaW4gY2xvc3VyZQoKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gaGFuZGxlci5hcHBseShudWxsLCBhcmd1bWVudHMpOwoKICAgIGlmIChyZXMgIT09IG51bGwpIHsKICAgICAgcmVtb3ZlJDIoZXZlbnQsIG9uY2VIYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KTsKICAgIH0KICB9Owp9IC8vICM5NDQ2OiBGaXJlZm94IDw9IDUzIChpbiBwYXJ0aWN1bGFyLCBFU1IgNTIpIGhhcyBpbmNvcnJlY3QgRXZlbnQudGltZVN0YW1wCi8vIGltcGxlbWVudGF0aW9uIGFuZCBkb2VzIG5vdCBmaXJlIG1pY3JvdGFza3MgaW4gYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbiwgc28KLy8gc2FmZSB0byBleGNsdWRlLgoKCnZhciB1c2VNaWNyb3Rhc2tGaXggPSBpc1VzaW5nTWljcm9UYXNrICYmICEoaXNGRiAmJiBOdW1iZXIoaXNGRlsxXSkgPD0gNTMpOwoKZnVuY3Rpb24gYWRkJDEobmFtZSwgaGFuZGxlciwgY2FwdHVyZSwgcGFzc2l2ZSkgewogIC8vIGFzeW5jIGVkZ2UgY2FzZSAjNjU2NjogaW5uZXIgY2xpY2sgZXZlbnQgdHJpZ2dlcnMgcGF0Y2gsIGV2ZW50IGhhbmRsZXIKICAvLyBhdHRhY2hlZCB0byBvdXRlciBlbGVtZW50IGR1cmluZyBwYXRjaCwgYW5kIHRyaWdnZXJlZCBhZ2Fpbi4gVGhpcwogIC8vIGhhcHBlbnMgYmVjYXVzZSBicm93c2VycyBmaXJlIG1pY3JvdGFzayB0aWNrcyBiZXR3ZWVuIGV2ZW50IHByb3BhZ2F0aW9uLgogIC8vIHRoZSBzb2x1dGlvbiBpcyBzaW1wbGU6IHdlIHNhdmUgdGhlIHRpbWVzdGFtcCB3aGVuIGEgaGFuZGxlciBpcyBhdHRhY2hlZCwKICAvLyBhbmQgdGhlIGhhbmRsZXIgd291bGQgb25seSBmaXJlIGlmIHRoZSBldmVudCBwYXNzZWQgdG8gaXQgd2FzIGZpcmVkCiAgLy8gQUZURVIgaXQgd2FzIGF0dGFjaGVkLgogIGlmICh1c2VNaWNyb3Rhc2tGaXgpIHsKICAgIHZhciBhdHRhY2hlZFRpbWVzdGFtcCA9IGN1cnJlbnRGbHVzaFRpbWVzdGFtcDsKICAgIHZhciBvcmlnaW5hbCA9IGhhbmRsZXI7CgogICAgaGFuZGxlciA9IG9yaWdpbmFsLl93cmFwcGVyID0gZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCAvLyBubyBidWJibGluZywgc2hvdWxkIGFsd2F5cyBmaXJlLgogICAgICAvLyB0aGlzIGlzIGp1c3QgYSBzYWZldHkgbmV0IGluIGNhc2UgZXZlbnQudGltZVN0YW1wIGlzIHVucmVsaWFibGUgaW4KICAgICAgLy8gY2VydGFpbiB3ZWlyZCBlbnZpcm9ubWVudHMuLi4KICAgICAgZS50YXJnZXQgPT09IGUuY3VycmVudFRhcmdldCB8fCAvLyBldmVudCBpcyBmaXJlZCBhZnRlciBoYW5kbGVyIGF0dGFjaG1lbnQKICAgICAgZS50aW1lU3RhbXAgPj0gYXR0YWNoZWRUaW1lc3RhbXAgfHwgLy8gYmFpbCBmb3IgZW52aXJvbm1lbnRzIHRoYXQgaGF2ZSBidWdneSBldmVudC50aW1lU3RhbXAgaW1wbGVtZW50YXRpb25zCiAgICAgIC8vICM5NDYyIGlPUyA5IGJ1ZzogZXZlbnQudGltZVN0YW1wIGlzIDAgYWZ0ZXIgaGlzdG9yeS5wdXNoU3RhdGUKICAgICAgLy8gIzk2ODEgUXRXZWJFbmdpbmUgZXZlbnQudGltZVN0YW1wIGlzIG5lZ2F0aXZlIHZhbHVlCiAgICAgIGUudGltZVN0YW1wIDw9IDAgfHwgLy8gIzk0NDggYmFpbCBpZiBldmVudCBpcyBmaXJlZCBpbiBhbm90aGVyIGRvY3VtZW50IGluIGEgbXVsdGktcGFnZQogICAgICAvLyBlbGVjdHJvbi9udy5qcyBhcHAsIHNpbmNlIGV2ZW50LnRpbWVTdGFtcCB3aWxsIGJlIHVzaW5nIGEgZGlmZmVyZW50CiAgICAgIC8vIHN0YXJ0aW5nIHJlZmVyZW5jZQogICAgICBlLnRhcmdldC5vd25lckRvY3VtZW50ICE9PSBkb2N1bWVudCkgewogICAgICAgIHJldHVybiBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9OwogIH0KCiAgdGFyZ2V0JDEuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBoYW5kbGVyLCBzdXBwb3J0c1Bhc3NpdmUgPyB7CiAgICBjYXB0dXJlOiBjYXB0dXJlLAogICAgcGFzc2l2ZTogcGFzc2l2ZQogIH0gOiBjYXB0dXJlKTsKfQoKZnVuY3Rpb24gcmVtb3ZlJDIobmFtZSwgaGFuZGxlciwgY2FwdHVyZSwgX3RhcmdldCkgewogIChfdGFyZ2V0IHx8IHRhcmdldCQxKS5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGhhbmRsZXIuX3dyYXBwZXIgfHwgaGFuZGxlciwgY2FwdHVyZSk7Cn0KCmZ1bmN0aW9uIHVwZGF0ZURPTUxpc3RlbmVycyhvbGRWbm9kZSwgdm5vZGUpIHsKICBpZiAoaXNVbmRlZihvbGRWbm9kZS5kYXRhLm9uKSAmJiBpc1VuZGVmKHZub2RlLmRhdGEub24pKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb24gPSB2bm9kZS5kYXRhLm9uIHx8IHt9OwogIHZhciBvbGRPbiA9IG9sZFZub2RlLmRhdGEub24gfHwge307CiAgdGFyZ2V0JDEgPSB2bm9kZS5lbG07CiAgbm9ybWFsaXplRXZlbnRzKG9uKTsKICB1cGRhdGVMaXN0ZW5lcnMob24sIG9sZE9uLCBhZGQkMSwgcmVtb3ZlJDIsIGNyZWF0ZU9uY2VIYW5kbGVyJDEsIHZub2RlLmNvbnRleHQpOwogIHRhcmdldCQxID0gdW5kZWZpbmVkOwp9Cgp2YXIgZXZlbnRzID0gewogIGNyZWF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzLAogIHVwZGF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzCn07Ci8qICAqLwoKdmFyIHN2Z0NvbnRhaW5lcjsKCmZ1bmN0aW9uIHVwZGF0ZURPTVByb3BzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEuZG9tUHJvcHMpICYmIGlzVW5kZWYodm5vZGUuZGF0YS5kb21Qcm9wcykpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBrZXksIGN1cjsKICB2YXIgZWxtID0gdm5vZGUuZWxtOwogIHZhciBvbGRQcm9wcyA9IG9sZFZub2RlLmRhdGEuZG9tUHJvcHMgfHwge307CiAgdmFyIHByb3BzID0gdm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsgLy8gY2xvbmUgb2JzZXJ2ZWQgb2JqZWN0cywgYXMgdGhlIHVzZXIgcHJvYmFibHkgd2FudHMgdG8gbXV0YXRlIGl0CgogIGlmIChpc0RlZihwcm9wcy5fX29iX18pKSB7CiAgICBwcm9wcyA9IHZub2RlLmRhdGEuZG9tUHJvcHMgPSBleHRlbmQoe30sIHByb3BzKTsKICB9CgogIGZvciAoa2V5IGluIG9sZFByb3BzKSB7CiAgICBpZiAoIShrZXkgaW4gcHJvcHMpKSB7CiAgICAgIGVsbVtrZXldID0gJyc7CiAgICB9CiAgfQoKICBmb3IgKGtleSBpbiBwcm9wcykgewogICAgY3VyID0gcHJvcHNba2V5XTsgLy8gaWdub3JlIGNoaWxkcmVuIGlmIHRoZSBub2RlIGhhcyB0ZXh0Q29udGVudCBvciBpbm5lckhUTUwsCiAgICAvLyBhcyB0aGVzZSB3aWxsIHRocm93IGF3YXkgZXhpc3RpbmcgRE9NIG5vZGVzIGFuZCBjYXVzZSByZW1vdmFsIGVycm9ycwogICAgLy8gb24gc3Vic2VxdWVudCBwYXRjaGVzICgjMzM2MCkKCiAgICBpZiAoa2V5ID09PSAndGV4dENvbnRlbnQnIHx8IGtleSA9PT0gJ2lubmVySFRNTCcpIHsKICAgICAgaWYgKHZub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoID0gMDsKICAgICAgfQoKICAgICAgaWYgKGN1ciA9PT0gb2xkUHJvcHNba2V5XSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9IC8vICM2NjAxIHdvcmsgYXJvdW5kIENocm9tZSB2ZXJzaW9uIDw9IDU1IGJ1ZyB3aGVyZSBzaW5nbGUgdGV4dE5vZGUKICAgICAgLy8gcmVwbGFjZWQgYnkgaW5uZXJIVE1ML3RleHRDb250ZW50IHJldGFpbnMgaXRzIHBhcmVudE5vZGUgcHJvcGVydHkKCgogICAgICBpZiAoZWxtLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgZWxtLnJlbW92ZUNoaWxkKGVsbS5jaGlsZE5vZGVzWzBdKTsKICAgICAgfQogICAgfQoKICAgIGlmIChrZXkgPT09ICd2YWx1ZScgJiYgZWxtLnRhZ05hbWUgIT09ICdQUk9HUkVTUycpIHsKICAgICAgLy8gc3RvcmUgdmFsdWUgYXMgX3ZhbHVlIGFzIHdlbGwgc2luY2UKICAgICAgLy8gbm9uLXN0cmluZyB2YWx1ZXMgd2lsbCBiZSBzdHJpbmdpZmllZAogICAgICBlbG0uX3ZhbHVlID0gY3VyOyAvLyBhdm9pZCByZXNldHRpbmcgY3Vyc29yIHBvc2l0aW9uIHdoZW4gdmFsdWUgaXMgdGhlIHNhbWUKCiAgICAgIHZhciBzdHJDdXIgPSBpc1VuZGVmKGN1cikgPyAnJyA6IFN0cmluZyhjdXIpOwoKICAgICAgaWYgKHNob3VsZFVwZGF0ZVZhbHVlKGVsbSwgc3RyQ3VyKSkgewogICAgICAgIGVsbS52YWx1ZSA9IHN0ckN1cjsKICAgICAgfQogICAgfSBlbHNlIGlmIChrZXkgPT09ICdpbm5lckhUTUwnICYmIGlzU1ZHKGVsbS50YWdOYW1lKSAmJiBpc1VuZGVmKGVsbS5pbm5lckhUTUwpKSB7CiAgICAgIC8vIElFIGRvZXNuJ3Qgc3VwcG9ydCBpbm5lckhUTUwgZm9yIFNWRyBlbGVtZW50cwogICAgICBzdmdDb250YWluZXIgPSBzdmdDb250YWluZXIgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgIHN2Z0NvbnRhaW5lci5pbm5lckhUTUwgPSAiPHN2Zz4iICsgY3VyICsgIjwvc3ZnPiI7CiAgICAgIHZhciBzdmcgPSBzdmdDb250YWluZXIuZmlyc3RDaGlsZDsKCiAgICAgIHdoaWxlIChlbG0uZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5yZW1vdmVDaGlsZChlbG0uZmlyc3RDaGlsZCk7CiAgICAgIH0KCiAgICAgIHdoaWxlIChzdmcuZmlyc3RDaGlsZCkgewogICAgICAgIGVsbS5hcHBlbmRDaGlsZChzdmcuZmlyc3RDaGlsZCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIC8vIHNraXAgdGhlIHVwZGF0ZSBpZiBvbGQgYW5kIG5ldyBWRE9NIHN0YXRlIGlzIHRoZSBzYW1lLgogICAgLy8gYHZhbHVlYCBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgYmVjYXVzZSB0aGUgRE9NIHZhbHVlIG1heSBiZSB0ZW1wb3JhcmlseQogICAgLy8gb3V0IG9mIHN5bmMgd2l0aCBWRE9NIHN0YXRlIGR1ZSB0byBmb2N1cywgY29tcG9zaXRpb24gYW5kIG1vZGlmaWVycy4KICAgIC8vIFRoaXMgICM0NTIxIGJ5IHNraXBwaW5nIHRoZSB1bm5lY2VzYXJyeSBgY2hlY2tlZGAgdXBkYXRlLgogICAgY3VyICE9PSBvbGRQcm9wc1trZXldKSB7CiAgICAgIC8vIHNvbWUgcHJvcGVydHkgdXBkYXRlcyBjYW4gdGhyb3cKICAgICAgLy8gZS5nLiBgdmFsdWVgIG9uIDxwcm9ncmVzcz4gdy8gbm9uLWZpbml0ZSB2YWx1ZQogICAgICB0cnkgewogICAgICAgIGVsbVtrZXldID0gY3VyOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfQogIH0KfSAvLyBjaGVjayBwbGF0Zm9ybXMvd2ViL3V0aWwvYXR0cnMuanMgYWNjZXB0VmFsdWUKCgpmdW5jdGlvbiBzaG91bGRVcGRhdGVWYWx1ZShlbG0sIGNoZWNrVmFsKSB7CiAgcmV0dXJuICFlbG0uY29tcG9zaW5nICYmIChlbG0udGFnTmFtZSA9PT0gJ09QVElPTicgfHwgaXNOb3RJbkZvY3VzQW5kRGlydHkoZWxtLCBjaGVja1ZhbCkgfHwgaXNEaXJ0eVdpdGhNb2RpZmllcnMoZWxtLCBjaGVja1ZhbCkpOwp9CgpmdW5jdGlvbiBpc05vdEluRm9jdXNBbmREaXJ0eShlbG0sIGNoZWNrVmFsKSB7CiAgLy8gcmV0dXJuIHRydWUgd2hlbiB0ZXh0Ym94ICgubnVtYmVyIGFuZCAudHJpbSkgbG9zZXMgZm9jdXMgYW5kIGl0cyB2YWx1ZSBpcwogIC8vIG5vdCBlcXVhbCB0byB0aGUgdXBkYXRlZCB2YWx1ZQogIHZhciBub3RJbkZvY3VzID0gdHJ1ZTsgLy8gIzYxNTcKICAvLyB3b3JrIGFyb3VuZCBJRSBidWcgd2hlbiBhY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpbiBhbiBpZnJhbWUKCiAgdHJ5IHsKICAgIG5vdEluRm9jdXMgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBlbG07CiAgfSBjYXRjaCAoZSkge30KCiAgcmV0dXJuIG5vdEluRm9jdXMgJiYgZWxtLnZhbHVlICE9PSBjaGVja1ZhbDsKfQoKZnVuY3Rpb24gaXNEaXJ0eVdpdGhNb2RpZmllcnMoZWxtLCBuZXdWYWwpIHsKICB2YXIgdmFsdWUgPSBlbG0udmFsdWU7CiAgdmFyIG1vZGlmaWVycyA9IGVsbS5fdk1vZGlmaWVyczsgLy8gaW5qZWN0ZWQgYnkgdi1tb2RlbCBydW50aW1lCgogIGlmIChpc0RlZihtb2RpZmllcnMpKSB7CiAgICBpZiAobW9kaWZpZXJzLm51bWJlcikgewogICAgICByZXR1cm4gdG9OdW1iZXIodmFsdWUpICE9PSB0b051bWJlcihuZXdWYWwpOwogICAgfQoKICAgIGlmIChtb2RpZmllcnMudHJpbSkgewogICAgICByZXR1cm4gdmFsdWUudHJpbSgpICE9PSBuZXdWYWwudHJpbSgpOwogICAgfQogIH0KCiAgcmV0dXJuIHZhbHVlICE9PSBuZXdWYWw7Cn0KCnZhciBkb21Qcm9wcyA9IHsKICBjcmVhdGU6IHVwZGF0ZURPTVByb3BzLAogIHVwZGF0ZTogdXBkYXRlRE9NUHJvcHMKfTsKLyogICovCgp2YXIgcGFyc2VTdHlsZVRleHQgPSBjYWNoZWQoZnVuY3Rpb24gKGNzc1RleHQpIHsKICB2YXIgcmVzID0ge307CiAgdmFyIGxpc3REZWxpbWl0ZXIgPSAvOyg/IVteKF0qXCkpL2c7CiAgdmFyIHByb3BlcnR5RGVsaW1pdGVyID0gLzooLispLzsKICBjc3NUZXh0LnNwbGl0KGxpc3REZWxpbWl0ZXIpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgIGlmIChpdGVtKSB7CiAgICAgIHZhciB0bXAgPSBpdGVtLnNwbGl0KHByb3BlcnR5RGVsaW1pdGVyKTsKICAgICAgdG1wLmxlbmd0aCA+IDEgJiYgKHJlc1t0bXBbMF0udHJpbSgpXSA9IHRtcFsxXS50cmltKCkpOwogICAgfQogIH0pOwogIHJldHVybiByZXM7Cn0pOyAvLyBtZXJnZSBzdGF0aWMgYW5kIGR5bmFtaWMgc3R5bGUgZGF0YSBvbiB0aGUgc2FtZSB2bm9kZQoKZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVEYXRhKGRhdGEpIHsKICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcoZGF0YS5zdHlsZSk7IC8vIHN0YXRpYyBzdHlsZSBpcyBwcmUtcHJvY2Vzc2VkIGludG8gYW4gb2JqZWN0IGR1cmluZyBjb21waWxhdGlvbgogIC8vIGFuZCBpcyBhbHdheXMgYSBmcmVzaCBvYmplY3QsIHNvIGl0J3Mgc2FmZSB0byBtZXJnZSBpbnRvIGl0CgogIHJldHVybiBkYXRhLnN0YXRpY1N0eWxlID8gZXh0ZW5kKGRhdGEuc3RhdGljU3R5bGUsIHN0eWxlKSA6IHN0eWxlOwp9IC8vIG5vcm1hbGl6ZSBwb3NzaWJsZSBhcnJheSAvIHN0cmluZyB2YWx1ZXMgaW50byBPYmplY3QKCgpmdW5jdGlvbiBub3JtYWxpemVTdHlsZUJpbmRpbmcoYmluZGluZ1N0eWxlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYmluZGluZ1N0eWxlKSkgewogICAgcmV0dXJuIHRvT2JqZWN0KGJpbmRpbmdTdHlsZSk7CiAgfQoKICBpZiAodHlwZW9mIGJpbmRpbmdTdHlsZSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBwYXJzZVN0eWxlVGV4dChiaW5kaW5nU3R5bGUpOwogIH0KCiAgcmV0dXJuIGJpbmRpbmdTdHlsZTsKfQovKioKICogcGFyZW50IGNvbXBvbmVudCBzdHlsZSBzaG91bGQgYmUgYWZ0ZXIgY2hpbGQncwogKiBzbyB0aGF0IHBhcmVudCBjb21wb25lbnQncyBzdHlsZSBjb3VsZCBvdmVycmlkZSBpdAogKi8KCgpmdW5jdGlvbiBnZXRTdHlsZSh2bm9kZSwgY2hlY2tDaGlsZCkgewogIHZhciByZXMgPSB7fTsKICB2YXIgc3R5bGVEYXRhOwoKICBpZiAoY2hlY2tDaGlsZCkgewogICAgdmFyIGNoaWxkTm9kZSA9IHZub2RlOwoKICAgIHdoaWxlIChjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgY2hpbGROb2RlID0gY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKCiAgICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEgJiYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YShjaGlsZE5vZGUuZGF0YSkpKSB7CiAgICAgICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YSh2bm9kZS5kYXRhKSkgewogICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICB9CgogIHZhciBwYXJlbnROb2RlID0gdm5vZGU7CgogIHdoaWxlIChwYXJlbnROb2RlID0gcGFyZW50Tm9kZS5wYXJlbnQpIHsKICAgIGlmIChwYXJlbnROb2RlLmRhdGEgJiYgKHN0eWxlRGF0YSA9IG5vcm1hbGl6ZVN0eWxlRGF0YShwYXJlbnROb2RlLmRhdGEpKSkgewogICAgICBleHRlbmQocmVzLCBzdHlsZURhdGEpOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQovKiAgKi8KCgp2YXIgY3NzVmFyUkUgPSAvXi0tLzsKdmFyIGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsKCnZhciBzZXRQcm9wID0gZnVuY3Rpb24gc2V0UHJvcChlbCwgbmFtZSwgdmFsKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGNzc1ZhclJFLnRlc3QobmFtZSkpIHsKICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbCk7CiAgfSBlbHNlIGlmIChpbXBvcnRhbnRSRS50ZXN0KHZhbCkpIHsKICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KGh5cGhlbmF0ZShuYW1lKSwgdmFsLnJlcGxhY2UoaW1wb3J0YW50UkUsICcnKSwgJ2ltcG9ydGFudCcpOwogIH0gZWxzZSB7CiAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSBub3JtYWxpemUobmFtZSk7CgogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAvLyBTdXBwb3J0IHZhbHVlcyBhcnJheSBjcmVhdGVkIGJ5IGF1dG9wcmVmaXhlciwgZS5nLgogICAgICAvLyB7ZGlzcGxheTogWyItd2Via2l0LWJveCIsICItbXMtZmxleGJveCIsICJmbGV4Il19CiAgICAgIC8vIFNldCB0aGVtIG9uZSBieSBvbmUsIGFuZCB0aGUgYnJvd3NlciB3aWxsIG9ubHkgc2V0IHRob3NlIGl0IGNhbiByZWNvZ25pemUKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHZhbC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGVsLnN0eWxlW25vcm1hbGl6ZWROYW1lXSA9IHZhbFtpXTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWwuc3R5bGVbbm9ybWFsaXplZE5hbWVdID0gdmFsOwogICAgfQogIH0KfTsKCnZhciB2ZW5kb3JOYW1lcyA9IFsnV2Via2l0JywgJ01veicsICdtcyddOwp2YXIgZW1wdHlTdHlsZTsKdmFyIG5vcm1hbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAocHJvcCkgewogIGVtcHR5U3R5bGUgPSBlbXB0eVN0eWxlIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnN0eWxlOwogIHByb3AgPSBjYW1lbGl6ZShwcm9wKTsKCiAgaWYgKHByb3AgIT09ICdmaWx0ZXInICYmIHByb3AgaW4gZW1wdHlTdHlsZSkgewogICAgcmV0dXJuIHByb3A7CiAgfQoKICB2YXIgY2FwTmFtZSA9IHByb3AuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnNsaWNlKDEpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHZlbmRvck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgbmFtZSA9IHZlbmRvck5hbWVzW2ldICsgY2FwTmFtZTsKCiAgICBpZiAobmFtZSBpbiBlbXB0eVN0eWxlKSB7CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogIH0KfSk7CgpmdW5jdGlvbiB1cGRhdGVTdHlsZShvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgdmFyIG9sZERhdGEgPSBvbGRWbm9kZS5kYXRhOwoKICBpZiAoaXNVbmRlZihkYXRhLnN0YXRpY1N0eWxlKSAmJiBpc1VuZGVmKGRhdGEuc3R5bGUpICYmIGlzVW5kZWYob2xkRGF0YS5zdGF0aWNTdHlsZSkgJiYgaXNVbmRlZihvbGREYXRhLnN0eWxlKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGN1ciwgbmFtZTsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgdmFyIG9sZFN0YXRpY1N0eWxlID0gb2xkRGF0YS5zdGF0aWNTdHlsZTsKICB2YXIgb2xkU3R5bGVCaW5kaW5nID0gb2xkRGF0YS5ub3JtYWxpemVkU3R5bGUgfHwgb2xkRGF0YS5zdHlsZSB8fCB7fTsgLy8gaWYgc3RhdGljIHN0eWxlIGV4aXN0cywgc3R5bGViaW5kaW5nIGFscmVhZHkgbWVyZ2VkIGludG8gaXQgd2hlbiBkb2luZyBub3JtYWxpemVTdHlsZURhdGEKCiAgdmFyIG9sZFN0eWxlID0gb2xkU3RhdGljU3R5bGUgfHwgb2xkU3R5bGVCaW5kaW5nOwogIHZhciBzdHlsZSA9IG5vcm1hbGl6ZVN0eWxlQmluZGluZyh2bm9kZS5kYXRhLnN0eWxlKSB8fCB7fTsgLy8gc3RvcmUgbm9ybWFsaXplZCBzdHlsZSB1bmRlciBhIGRpZmZlcmVudCBrZXkgZm9yIG5leHQgZGlmZgogIC8vIG1ha2Ugc3VyZSB0byBjbG9uZSBpdCBpZiBpdCdzIHJlYWN0aXZlLCBzaW5jZSB0aGUgdXNlciBsaWtlbHkgd2FudHMKICAvLyB0byBtdXRhdGUgaXQuCgogIHZub2RlLmRhdGEubm9ybWFsaXplZFN0eWxlID0gaXNEZWYoc3R5bGUuX19vYl9fKSA/IGV4dGVuZCh7fSwgc3R5bGUpIDogc3R5bGU7CiAgdmFyIG5ld1N0eWxlID0gZ2V0U3R5bGUodm5vZGUsIHRydWUpOwoKICBmb3IgKG5hbWUgaW4gb2xkU3R5bGUpIHsKICAgIGlmIChpc1VuZGVmKG5ld1N0eWxlW25hbWVdKSkgewogICAgICBzZXRQcm9wKGVsLCBuYW1lLCAnJyk7CiAgICB9CiAgfQoKICBmb3IgKG5hbWUgaW4gbmV3U3R5bGUpIHsKICAgIGN1ciA9IG5ld1N0eWxlW25hbWVdOwoKICAgIGlmIChjdXIgIT09IG9sZFN0eWxlW25hbWVdKSB7CiAgICAgIC8vIGllOSBzZXR0aW5nIHRvIG51bGwgaGFzIG5vIGVmZmVjdCwgbXVzdCB1c2UgZW1wdHkgc3RyaW5nCiAgICAgIHNldFByb3AoZWwsIG5hbWUsIGN1ciA9PSBudWxsID8gJycgOiBjdXIpOwogICAgfQogIH0KfQoKdmFyIHN0eWxlID0gewogIGNyZWF0ZTogdXBkYXRlU3R5bGUsCiAgdXBkYXRlOiB1cGRhdGVTdHlsZQp9OwovKiAgKi8KCnZhciB3aGl0ZXNwYWNlUkUgPSAvXHMrLzsKLyoqCiAqIEFkZCBjbGFzcyB3aXRoIGNvbXBhdGliaWxpdHkgZm9yIFNWRyBzaW5jZSBjbGFzc0xpc3QgaXMgbm90IHN1cHBvcnRlZCBvbgogKiBTVkcgZWxlbWVudHMgaW4gSUUKICovCgpmdW5jdGlvbiBhZGRDbGFzcyhlbCwgY2xzKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5hZGQoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LmFkZChjbHMpOwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgY3VyID0gIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICI7CgogICAgaWYgKGN1ci5pbmRleE9mKCcgJyArIGNscyArICcgJykgPCAwKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAoY3VyICsgY2xzKS50cmltKCkpOwogICAgfQogIH0KfQovKioKICogUmVtb3ZlIGNsYXNzIHdpdGggY29tcGF0aWJpbGl0eSBmb3IgU1ZHIHNpbmNlIGNsYXNzTGlzdCBpcyBub3Qgc3VwcG9ydGVkIG9uCiAqIFNWRyBlbGVtZW50cyBpbiBJRQogKi8KCgpmdW5jdGlvbiByZW1vdmVDbGFzcyhlbCwgY2xzKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICBjbHMuc3BsaXQod2hpdGVzcGFjZVJFKS5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgcmV0dXJuIGVsLmNsYXNzTGlzdC5yZW1vdmUoYyk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbHMpOwogICAgfQoKICAgIGlmICghZWwuY2xhc3NMaXN0Lmxlbmd0aCkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjdXIgPSAiICIgKyAoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIjsKICAgIHZhciB0YXIgPSAnICcgKyBjbHMgKyAnICc7CgogICAgd2hpbGUgKGN1ci5pbmRleE9mKHRhcikgPj0gMCkgewogICAgICBjdXIgPSBjdXIucmVwbGFjZSh0YXIsICcgJyk7CiAgICB9CgogICAgY3VyID0gY3VyLnRyaW0oKTsKCiAgICBpZiAoY3VyKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjdXIpOwogICAgfSBlbHNlIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpOwogICAgfQogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiByZXNvbHZlVHJhbnNpdGlvbihkZWYkJDEpIHsKICBpZiAoIWRlZiQkMSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgaWYgKF90eXBlb2YoZGVmJCQxKSA9PT0gJ29iamVjdCcpIHsKICAgIHZhciByZXMgPSB7fTsKCiAgICBpZiAoZGVmJCQxLmNzcyAhPT0gZmFsc2UpIHsKICAgICAgZXh0ZW5kKHJlcywgYXV0b0Nzc1RyYW5zaXRpb24oZGVmJCQxLm5hbWUgfHwgJ3YnKSk7CiAgICB9CgogICAgZXh0ZW5kKHJlcywgZGVmJCQxKTsKICAgIHJldHVybiByZXM7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmJCQxID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIGF1dG9Dc3NUcmFuc2l0aW9uKGRlZiQkMSk7CiAgfQp9Cgp2YXIgYXV0b0Nzc1RyYW5zaXRpb24gPSBjYWNoZWQoZnVuY3Rpb24gKG5hbWUpIHsKICByZXR1cm4gewogICAgZW50ZXJDbGFzczogbmFtZSArICItZW50ZXIiLAogICAgZW50ZXJUb0NsYXNzOiBuYW1lICsgIi1lbnRlci10byIsCiAgICBlbnRlckFjdGl2ZUNsYXNzOiBuYW1lICsgIi1lbnRlci1hY3RpdmUiLAogICAgbGVhdmVDbGFzczogbmFtZSArICItbGVhdmUiLAogICAgbGVhdmVUb0NsYXNzOiBuYW1lICsgIi1sZWF2ZS10byIsCiAgICBsZWF2ZUFjdGl2ZUNsYXNzOiBuYW1lICsgIi1sZWF2ZS1hY3RpdmUiCiAgfTsKfSk7CnZhciBoYXNUcmFuc2l0aW9uID0gaW5Ccm93c2VyICYmICFpc0lFOTsKdmFyIFRSQU5TSVRJT04gPSAndHJhbnNpdGlvbic7CnZhciBBTklNQVRJT04gPSAnYW5pbWF0aW9uJzsgLy8gVHJhbnNpdGlvbiBwcm9wZXJ0eS9ldmVudCBzbmlmZmluZwoKdmFyIHRyYW5zaXRpb25Qcm9wID0gJ3RyYW5zaXRpb24nOwp2YXIgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3RyYW5zaXRpb25lbmQnOwp2YXIgYW5pbWF0aW9uUHJvcCA9ICdhbmltYXRpb24nOwp2YXIgYW5pbWF0aW9uRW5kRXZlbnQgPSAnYW5pbWF0aW9uZW5kJzsKCmlmIChoYXNUcmFuc2l0aW9uKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKHdpbmRvdy5vbnRyYW5zaXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXR0cmFuc2l0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgIHRyYW5zaXRpb25Qcm9wID0gJ1dlYmtpdFRyYW5zaXRpb24nOwogICAgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3dlYmtpdFRyYW5zaXRpb25FbmQnOwogIH0KCiAgaWYgKHdpbmRvdy5vbmFuaW1hdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICBhbmltYXRpb25Qcm9wID0gJ1dlYmtpdEFuaW1hdGlvbic7CiAgICBhbmltYXRpb25FbmRFdmVudCA9ICd3ZWJraXRBbmltYXRpb25FbmQnOwogIH0KfSAvLyBiaW5kaW5nIHRvIHdpbmRvdyBpcyBuZWNlc3NhcnkgdG8gbWFrZSBob3QgcmVsb2FkIHdvcmsgaW4gSUUgaW4gc3RyaWN0IG1vZGUKCgp2YXIgcmFmID0gaW5Ccm93c2VyID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA/IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUuYmluZCh3aW5kb3cpIDogc2V0VGltZW91dCA6Ci8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCmZ1bmN0aW9uIChmbikgewogIHJldHVybiBmbigpOwp9OwoKZnVuY3Rpb24gbmV4dEZyYW1lKGZuKSB7CiAgcmFmKGZ1bmN0aW9uICgpIHsKICAgIHJhZihmbik7CiAgfSk7Cn0KCmZ1bmN0aW9uIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgdmFyIHRyYW5zaXRpb25DbGFzc2VzID0gZWwuX3RyYW5zaXRpb25DbGFzc2VzIHx8IChlbC5fdHJhbnNpdGlvbkNsYXNzZXMgPSBbXSk7CgogIGlmICh0cmFuc2l0aW9uQ2xhc3Nlcy5pbmRleE9mKGNscykgPCAwKSB7CiAgICB0cmFuc2l0aW9uQ2xhc3Nlcy5wdXNoKGNscyk7CiAgICBhZGRDbGFzcyhlbCwgY2xzKTsKICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgcmVtb3ZlKGVsLl90cmFuc2l0aW9uQ2xhc3NlcywgY2xzKTsKICB9CgogIHJlbW92ZUNsYXNzKGVsLCBjbHMpOwp9CgpmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIGV4cGVjdGVkVHlwZSwgY2IpIHsKICB2YXIgcmVmID0gZ2V0VHJhbnNpdGlvbkluZm8oZWwsIGV4cGVjdGVkVHlwZSk7CiAgdmFyIHR5cGUgPSByZWYudHlwZTsKICB2YXIgdGltZW91dCA9IHJlZi50aW1lb3V0OwogIHZhciBwcm9wQ291bnQgPSByZWYucHJvcENvdW50OwoKICBpZiAoIXR5cGUpIHsKICAgIHJldHVybiBjYigpOwogIH0KCiAgdmFyIGV2ZW50ID0gdHlwZSA9PT0gVFJBTlNJVElPTiA/IHRyYW5zaXRpb25FbmRFdmVudCA6IGFuaW1hdGlvbkVuZEV2ZW50OwogIHZhciBlbmRlZCA9IDA7CgogIHZhciBlbmQgPSBmdW5jdGlvbiBlbmQoKSB7CiAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50LCBvbkVuZCk7CiAgICBjYigpOwogIH07CgogIHZhciBvbkVuZCA9IGZ1bmN0aW9uIG9uRW5kKGUpIHsKICAgIGlmIChlLnRhcmdldCA9PT0gZWwpIHsKICAgICAgaWYgKCsrZW5kZWQgPj0gcHJvcENvdW50KSB7CiAgICAgICAgZW5kKCk7CiAgICAgIH0KICAgIH0KICB9OwoKICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIGlmIChlbmRlZCA8IHByb3BDb3VudCkgewogICAgICBlbmQoKTsKICAgIH0KICB9LCB0aW1lb3V0ICsgMSk7CiAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwp9Cgp2YXIgdHJhbnNmb3JtUkUgPSAvXGIodHJhbnNmb3JtfGFsbCkoLHwkKS87CgpmdW5jdGlvbiBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKSB7CiAgdmFyIHN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKTsgLy8gSlNET00gbWF5IHJldHVybiB1bmRlZmluZWQgZm9yIHRyYW5zaXRpb24gcHJvcGVydGllcwoKICB2YXIgdHJhbnNpdGlvbkRlbGF5cyA9IChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnRGVsYXknXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbnMgPSAoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ0R1cmF0aW9uJ10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7CiAgdmFyIGFuaW1hdGlvbkRlbGF5cyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEZWxheSddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgYW5pbWF0aW9uRHVyYXRpb25zID0gKHN0eWxlc1thbmltYXRpb25Qcm9wICsgJ0R1cmF0aW9uJ10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7CiAgdmFyIHR5cGU7CiAgdmFyIHRpbWVvdXQgPSAwOwogIHZhciBwcm9wQ291bnQgPSAwOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAoZXhwZWN0ZWRUeXBlID09PSBUUkFOU0lUSU9OKSB7CiAgICBpZiAodHJhbnNpdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgIHR5cGUgPSBUUkFOU0lUSU9OOwogICAgICB0aW1lb3V0ID0gdHJhbnNpdGlvblRpbWVvdXQ7CiAgICAgIHByb3BDb3VudCA9IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgfQogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSBBTklNQVRJT04pIHsKICAgIGlmIChhbmltYXRpb25UaW1lb3V0ID4gMCkgewogICAgICB0eXBlID0gQU5JTUFUSU9OOwogICAgICB0aW1lb3V0ID0gYW5pbWF0aW9uVGltZW91dDsKICAgICAgcHJvcENvdW50ID0gYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgIH0KICB9IGVsc2UgewogICAgdGltZW91dCA9IE1hdGgubWF4KHRyYW5zaXRpb25UaW1lb3V0LCBhbmltYXRpb25UaW1lb3V0KTsKICAgIHR5cGUgPSB0aW1lb3V0ID4gMCA/IHRyYW5zaXRpb25UaW1lb3V0ID4gYW5pbWF0aW9uVGltZW91dCA/IFRSQU5TSVRJT04gOiBBTklNQVRJT04gOiBudWxsOwogICAgcHJvcENvdW50ID0gdHlwZSA/IHR5cGUgPT09IFRSQU5TSVRJT04gPyB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aCA6IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGggOiAwOwogIH0KCiAgdmFyIGhhc1RyYW5zZm9ybSA9IHR5cGUgPT09IFRSQU5TSVRJT04gJiYgdHJhbnNmb3JtUkUudGVzdChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnUHJvcGVydHknXSk7CiAgcmV0dXJuIHsKICAgIHR5cGU6IHR5cGUsCiAgICB0aW1lb3V0OiB0aW1lb3V0LAogICAgcHJvcENvdW50OiBwcm9wQ291bnQsCiAgICBoYXNUcmFuc2Zvcm06IGhhc1RyYW5zZm9ybQogIH07Cn0KCmZ1bmN0aW9uIGdldFRpbWVvdXQoZGVsYXlzLCBkdXJhdGlvbnMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIHdoaWxlIChkZWxheXMubGVuZ3RoIDwgZHVyYXRpb25zLmxlbmd0aCkgewogICAgZGVsYXlzID0gZGVsYXlzLmNvbmNhdChkZWxheXMpOwogIH0KCiAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KG51bGwsIGR1cmF0aW9ucy5tYXAoZnVuY3Rpb24gKGQsIGkpIHsKICAgIHJldHVybiB0b01zKGQpICsgdG9NcyhkZWxheXNbaV0pOwogIH0pKTsKfSAvLyBPbGQgdmVyc2lvbnMgb2YgQ2hyb21pdW0gKGJlbG93IDYxLjAuMzE2My4xMDApIGZvcm1hdHMgZmxvYXRpbmcgcG9pbnRlciBudW1iZXJzCi8vIGluIGEgbG9jYWxlLWRlcGVuZGVudCB3YXksIHVzaW5nIGEgY29tbWEgaW5zdGVhZCBvZiBhIGRvdC4KLy8gSWYgY29tbWEgaXMgbm90IHJlcGxhY2VkIHdpdGggYSBkb3QsIHRoZSBpbnB1dCB3aWxsIGJlIHJvdW5kZWQgZG93biAoaS5lLiBhY3RpbmcKLy8gYXMgYSBmbG9vciBmdW5jdGlvbikgY2F1c2luZyB1bmV4cGVjdGVkIGJlaGF2aW9ycwoKCmZ1bmN0aW9uIHRvTXMocykgewogIHJldHVybiBOdW1iZXIocy5zbGljZSgwLCAtMSkucmVwbGFjZSgnLCcsICcuJykpICogMTAwMDsKfQovKiAgKi8KCgpmdW5jdGlvbiBlbnRlcih2bm9kZSwgdG9nZ2xlRGlzcGxheSkgewogIHZhciBlbCA9IHZub2RlLmVsbTsgLy8gY2FsbCBsZWF2ZSBjYWxsYmFjayBub3cKCiAgaWYgKGlzRGVmKGVsLl9sZWF2ZUNiKSkgewogICAgZWwuX2xlYXZlQ2IuY2FuY2VsbGVkID0gdHJ1ZTsKCiAgICBlbC5fbGVhdmVDYigpOwogIH0KCiAgdmFyIGRhdGEgPSByZXNvbHZlVHJhbnNpdGlvbih2bm9kZS5kYXRhLnRyYW5zaXRpb24pOwoKICBpZiAoaXNVbmRlZihkYXRhKSkgewogICAgcmV0dXJuOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChpc0RlZihlbC5fZW50ZXJDYikgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjc3MgPSBkYXRhLmNzczsKICB2YXIgdHlwZSA9IGRhdGEudHlwZTsKICB2YXIgZW50ZXJDbGFzcyA9IGRhdGEuZW50ZXJDbGFzczsKICB2YXIgZW50ZXJUb0NsYXNzID0gZGF0YS5lbnRlclRvQ2xhc3M7CiAgdmFyIGVudGVyQWN0aXZlQ2xhc3MgPSBkYXRhLmVudGVyQWN0aXZlQ2xhc3M7CiAgdmFyIGFwcGVhckNsYXNzID0gZGF0YS5hcHBlYXJDbGFzczsKICB2YXIgYXBwZWFyVG9DbGFzcyA9IGRhdGEuYXBwZWFyVG9DbGFzczsKICB2YXIgYXBwZWFyQWN0aXZlQ2xhc3MgPSBkYXRhLmFwcGVhckFjdGl2ZUNsYXNzOwogIHZhciBiZWZvcmVFbnRlciA9IGRhdGEuYmVmb3JlRW50ZXI7CiAgdmFyIGVudGVyID0gZGF0YS5lbnRlcjsKICB2YXIgYWZ0ZXJFbnRlciA9IGRhdGEuYWZ0ZXJFbnRlcjsKICB2YXIgZW50ZXJDYW5jZWxsZWQgPSBkYXRhLmVudGVyQ2FuY2VsbGVkOwogIHZhciBiZWZvcmVBcHBlYXIgPSBkYXRhLmJlZm9yZUFwcGVhcjsKICB2YXIgYXBwZWFyID0gZGF0YS5hcHBlYXI7CiAgdmFyIGFmdGVyQXBwZWFyID0gZGF0YS5hZnRlckFwcGVhcjsKICB2YXIgYXBwZWFyQ2FuY2VsbGVkID0gZGF0YS5hcHBlYXJDYW5jZWxsZWQ7CiAgdmFyIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsgLy8gYWN0aXZlSW5zdGFuY2Ugd2lsbCBhbHdheXMgYmUgdGhlIDx0cmFuc2l0aW9uPiBjb21wb25lbnQgbWFuYWdpbmcgdGhpcwogIC8vIHRyYW5zaXRpb24uIE9uZSBlZGdlIGNhc2UgdG8gY2hlY2sgaXMgd2hlbiB0aGUgPHRyYW5zaXRpb24+IGlzIHBsYWNlZAogIC8vIGFzIHRoZSByb290IG5vZGUgb2YgYSBjaGlsZCBjb21wb25lbnQuIEluIHRoYXQgY2FzZSB3ZSBuZWVkIHRvIGNoZWNrCiAgLy8gPHRyYW5zaXRpb24+J3MgcGFyZW50IGZvciBhcHBlYXIgY2hlY2suCgogIHZhciBjb250ZXh0ID0gYWN0aXZlSW5zdGFuY2U7CiAgdmFyIHRyYW5zaXRpb25Ob2RlID0gYWN0aXZlSW5zdGFuY2UuJHZub2RlOwoKICB3aGlsZSAodHJhbnNpdGlvbk5vZGUgJiYgdHJhbnNpdGlvbk5vZGUucGFyZW50KSB7CiAgICBjb250ZXh0ID0gdHJhbnNpdGlvbk5vZGUuY29udGV4dDsKICAgIHRyYW5zaXRpb25Ob2RlID0gdHJhbnNpdGlvbk5vZGUucGFyZW50OwogIH0KCiAgdmFyIGlzQXBwZWFyID0gIWNvbnRleHQuX2lzTW91bnRlZCB8fCAhdm5vZGUuaXNSb290SW5zZXJ0OwoKICBpZiAoaXNBcHBlYXIgJiYgIWFwcGVhciAmJiBhcHBlYXIgIT09ICcnKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc3RhcnRDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckNsYXNzID8gYXBwZWFyQ2xhc3MgOiBlbnRlckNsYXNzOwogIHZhciBhY3RpdmVDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckFjdGl2ZUNsYXNzID8gYXBwZWFyQWN0aXZlQ2xhc3MgOiBlbnRlckFjdGl2ZUNsYXNzOwogIHZhciB0b0NsYXNzID0gaXNBcHBlYXIgJiYgYXBwZWFyVG9DbGFzcyA/IGFwcGVhclRvQ2xhc3MgOiBlbnRlclRvQ2xhc3M7CiAgdmFyIGJlZm9yZUVudGVySG9vayA9IGlzQXBwZWFyID8gYmVmb3JlQXBwZWFyIHx8IGJlZm9yZUVudGVyIDogYmVmb3JlRW50ZXI7CiAgdmFyIGVudGVySG9vayA9IGlzQXBwZWFyID8gdHlwZW9mIGFwcGVhciA9PT0gJ2Z1bmN0aW9uJyA/IGFwcGVhciA6IGVudGVyIDogZW50ZXI7CiAgdmFyIGFmdGVyRW50ZXJIb29rID0gaXNBcHBlYXIgPyBhZnRlckFwcGVhciB8fCBhZnRlckVudGVyIDogYWZ0ZXJFbnRlcjsKICB2YXIgZW50ZXJDYW5jZWxsZWRIb29rID0gaXNBcHBlYXIgPyBhcHBlYXJDYW5jZWxsZWQgfHwgZW50ZXJDYW5jZWxsZWQgOiBlbnRlckNhbmNlbGxlZDsKICB2YXIgZXhwbGljaXRFbnRlckR1cmF0aW9uID0gdG9OdW1iZXIoaXNPYmplY3QoZHVyYXRpb24pID8gZHVyYXRpb24uZW50ZXIgOiBkdXJhdGlvbik7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGV4cGxpY2l0RW50ZXJEdXJhdGlvbiAhPSBudWxsKSB7CiAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0RW50ZXJEdXJhdGlvbiwgJ2VudGVyJywgdm5vZGUpOwogIH0KCiAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZW50ZXJIb29rKTsKICB2YXIgY2IgPSBlbC5fZW50ZXJDYiA9IG9uY2UoZnVuY3Rpb24gKCkgewogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCB0b0NsYXNzKTsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICB9CgogICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICAgIH0KCiAgICAgIGVudGVyQ2FuY2VsbGVkSG9vayAmJiBlbnRlckNhbmNlbGxlZEhvb2soZWwpOwogICAgfSBlbHNlIHsKICAgICAgYWZ0ZXJFbnRlckhvb2sgJiYgYWZ0ZXJFbnRlckhvb2soZWwpOwogICAgfQoKICAgIGVsLl9lbnRlckNiID0gbnVsbDsKICB9KTsKCiAgaWYgKCF2bm9kZS5kYXRhLnNob3cpIHsKICAgIC8vIHJlbW92ZSBwZW5kaW5nIGxlYXZlIGVsZW1lbnQgb24gZW50ZXIgYnkgaW5qZWN0aW5nIGFuIGluc2VydCBob29rCiAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ2luc2VydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHBhcmVudCA9IGVsLnBhcmVudE5vZGU7CiAgICAgIHZhciBwZW5kaW5nTm9kZSA9IHBhcmVudCAmJiBwYXJlbnQuX3BlbmRpbmcgJiYgcGFyZW50Ll9wZW5kaW5nW3Zub2RlLmtleV07CgogICAgICBpZiAocGVuZGluZ05vZGUgJiYgcGVuZGluZ05vZGUudGFnID09PSB2bm9kZS50YWcgJiYgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiKSB7CiAgICAgICAgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiKCk7CiAgICAgIH0KCiAgICAgIGVudGVySG9vayAmJiBlbnRlckhvb2soZWwsIGNiKTsKICAgIH0pOwogIH0gLy8gc3RhcnQgZW50ZXIgdHJhbnNpdGlvbgoKCiAgYmVmb3JlRW50ZXJIb29rICYmIGJlZm9yZUVudGVySG9vayhlbCk7CgogIGlmIChleHBlY3RzQ1NTKSB7CiAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwogICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhY3RpdmVDbGFzcyk7CiAgICBuZXh0RnJhbWUoZnVuY3Rpb24gKCkgewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwoKICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIHRvQ2xhc3MpOwoKICAgICAgICBpZiAoIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgICAgIGlmIChpc1ZhbGlkRHVyYXRpb24oZXhwbGljaXRFbnRlckR1cmF0aW9uKSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGNiLCBleHBsaWNpdEVudGVyRHVyYXRpb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBjYik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIGlmICh2bm9kZS5kYXRhLnNob3cpIHsKICAgIHRvZ2dsZURpc3BsYXkgJiYgdG9nZ2xlRGlzcGxheSgpOwogICAgZW50ZXJIb29rICYmIGVudGVySG9vayhlbCwgY2IpOwogIH0KCiAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICBjYigpOwogIH0KfQoKZnVuY3Rpb24gbGVhdmUodm5vZGUsIHJtKSB7CiAgdmFyIGVsID0gdm5vZGUuZWxtOyAvLyBjYWxsIGVudGVyIGNhbGxiYWNrIG5vdwoKICBpZiAoaXNEZWYoZWwuX2VudGVyQ2IpKSB7CiAgICBlbC5fZW50ZXJDYi5jYW5jZWxsZWQgPSB0cnVlOwoKICAgIGVsLl9lbnRlckNiKCk7CiAgfQoKICB2YXIgZGF0YSA9IHJlc29sdmVUcmFuc2l0aW9uKHZub2RlLmRhdGEudHJhbnNpdGlvbik7CgogIGlmIChpc1VuZGVmKGRhdGEpIHx8IGVsLm5vZGVUeXBlICE9PSAxKSB7CiAgICByZXR1cm4gcm0oKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoaXNEZWYoZWwuX2xlYXZlQ2IpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY3NzID0gZGF0YS5jc3M7CiAgdmFyIHR5cGUgPSBkYXRhLnR5cGU7CiAgdmFyIGxlYXZlQ2xhc3MgPSBkYXRhLmxlYXZlQ2xhc3M7CiAgdmFyIGxlYXZlVG9DbGFzcyA9IGRhdGEubGVhdmVUb0NsYXNzOwogIHZhciBsZWF2ZUFjdGl2ZUNsYXNzID0gZGF0YS5sZWF2ZUFjdGl2ZUNsYXNzOwogIHZhciBiZWZvcmVMZWF2ZSA9IGRhdGEuYmVmb3JlTGVhdmU7CiAgdmFyIGxlYXZlID0gZGF0YS5sZWF2ZTsKICB2YXIgYWZ0ZXJMZWF2ZSA9IGRhdGEuYWZ0ZXJMZWF2ZTsKICB2YXIgbGVhdmVDYW5jZWxsZWQgPSBkYXRhLmxlYXZlQ2FuY2VsbGVkOwogIHZhciBkZWxheUxlYXZlID0gZGF0YS5kZWxheUxlYXZlOwogIHZhciBkdXJhdGlvbiA9IGRhdGEuZHVyYXRpb247CiAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICB2YXIgdXNlcldhbnRzQ29udHJvbCA9IGdldEhvb2tBcmd1bWVudHNMZW5ndGgobGVhdmUpOwogIHZhciBleHBsaWNpdExlYXZlRHVyYXRpb24gPSB0b051bWJlcihpc09iamVjdChkdXJhdGlvbikgPyBkdXJhdGlvbi5sZWF2ZSA6IGR1cmF0aW9uKTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgY2hlY2tEdXJhdGlvbihleHBsaWNpdExlYXZlRHVyYXRpb24sICdsZWF2ZScsIHZub2RlKTsKICB9CgogIHZhciBjYiA9IGVsLl9sZWF2ZUNiID0gb25jZShmdW5jdGlvbiAoKSB7CiAgICBpZiAoZWwucGFyZW50Tm9kZSAmJiBlbC5wYXJlbnROb2RlLl9wZW5kaW5nKSB7CiAgICAgIGVsLnBhcmVudE5vZGUuX3BlbmRpbmdbdm5vZGUua2V5XSA9IG51bGw7CiAgICB9CgogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOwogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgfQoKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICB9CgogICAgICBsZWF2ZUNhbmNlbGxlZCAmJiBsZWF2ZUNhbmNlbGxlZChlbCk7CiAgICB9IGVsc2UgewogICAgICBybSgpOwogICAgICBhZnRlckxlYXZlICYmIGFmdGVyTGVhdmUoZWwpOwogICAgfQoKICAgIGVsLl9sZWF2ZUNiID0gbnVsbDsKICB9KTsKCiAgaWYgKGRlbGF5TGVhdmUpIHsKICAgIGRlbGF5TGVhdmUocGVyZm9ybUxlYXZlKTsKICB9IGVsc2UgewogICAgcGVyZm9ybUxlYXZlKCk7CiAgfQoKICBmdW5jdGlvbiBwZXJmb3JtTGVhdmUoKSB7CiAgICAvLyB0aGUgZGVsYXllZCBsZWF2ZSBtYXkgaGF2ZSBhbHJlYWR5IGJlZW4gY2FuY2VsbGVkCiAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gcmVjb3JkIGxlYXZpbmcgZWxlbWVudAoKCiAgICBpZiAoIXZub2RlLmRhdGEuc2hvdyAmJiBlbC5wYXJlbnROb2RlKSB7CiAgICAgIChlbC5wYXJlbnROb2RlLl9wZW5kaW5nIHx8IChlbC5wYXJlbnROb2RlLl9wZW5kaW5nID0ge30pKVt2bm9kZS5rZXldID0gdm5vZGU7CiAgICB9CgogICAgYmVmb3JlTGVhdmUgJiYgYmVmb3JlTGVhdmUoZWwpOwoKICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CiAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICAgIG5leHRGcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKCiAgICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVUb0NsYXNzKTsKCiAgICAgICAgICBpZiAoIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGlzVmFsaWREdXJhdGlvbihleHBsaWNpdExlYXZlRHVyYXRpb24pKSB7CiAgICAgICAgICAgICAgc2V0VGltZW91dChjYiwgZXhwbGljaXRMZWF2ZUR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGNiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgbGVhdmUgJiYgbGVhdmUoZWwsIGNiKTsKCiAgICBpZiAoIWV4cGVjdHNDU1MgJiYgIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgY2IoKTsKICAgIH0KICB9Cn0gLy8gb25seSB1c2VkIGluIGRldiBtb2RlCgoKZnVuY3Rpb24gY2hlY2tEdXJhdGlvbih2YWwsIG5hbWUsIHZub2RlKSB7CiAgaWYgKHR5cGVvZiB2YWwgIT09ICdudW1iZXInKSB7CiAgICB3YXJuKCI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIiArIG5hbWUgKyAiIGR1cmF0aW9uIGlzIG5vdCBhIHZhbGlkIG51bWJlciAtICIgKyAiZ290ICIgKyBKU09OLnN0cmluZ2lmeSh2YWwpICsgIi4iLCB2bm9kZS5jb250ZXh0KTsKICB9IGVsc2UgaWYgKGlzTmFOKHZhbCkpIHsKICAgIHdhcm4oIjx0cmFuc2l0aW9uPiBleHBsaWNpdCAiICsgbmFtZSArICIgZHVyYXRpb24gaXMgTmFOIC0gIiArICd0aGUgZHVyYXRpb24gZXhwcmVzc2lvbiBtaWdodCBiZSBpbmNvcnJlY3QuJywgdm5vZGUuY29udGV4dCk7CiAgfQp9CgpmdW5jdGlvbiBpc1ZhbGlkRHVyYXRpb24odmFsKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWwgPT09ICdudW1iZXInICYmICFpc05hTih2YWwpOwp9Ci8qKgogKiBOb3JtYWxpemUgYSB0cmFuc2l0aW9uIGhvb2sncyBhcmd1bWVudCBsZW5ndGguIFRoZSBob29rIG1heSBiZToKICogLSBhIG1lcmdlZCBob29rIChpbnZva2VyKSB3aXRoIHRoZSBvcmlnaW5hbCBpbiAuZm5zCiAqIC0gYSB3cmFwcGVkIGNvbXBvbmVudCBtZXRob2QgKGNoZWNrIC5fbGVuZ3RoKQogKiAtIGEgcGxhaW4gZnVuY3Rpb24gKC5sZW5ndGgpCiAqLwoKCmZ1bmN0aW9uIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoZm4pIHsKICBpZiAoaXNVbmRlZihmbikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciBpbnZva2VyRm5zID0gZm4uZm5zOwoKICBpZiAoaXNEZWYoaW52b2tlckZucykpIHsKICAgIC8vIGludm9rZXIKICAgIHJldHVybiBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKEFycmF5LmlzQXJyYXkoaW52b2tlckZucykgPyBpbnZva2VyRm5zWzBdIDogaW52b2tlckZucyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAoZm4uX2xlbmd0aCB8fCBmbi5sZW5ndGgpID4gMTsKICB9Cn0KCmZ1bmN0aW9uIF9lbnRlcihfLCB2bm9kZSkgewogIGlmICh2bm9kZS5kYXRhLnNob3cgIT09IHRydWUpIHsKICAgIGVudGVyKHZub2RlKTsKICB9Cn0KCnZhciB0cmFuc2l0aW9uID0gaW5Ccm93c2VyID8gewogIGNyZWF0ZTogX2VudGVyLAogIGFjdGl2YXRlOiBfZW50ZXIsCiAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUkJDEodm5vZGUsIHJtKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgICBsZWF2ZSh2bm9kZSwgcm0pOwogICAgfSBlbHNlIHsKICAgICAgcm0oKTsKICAgIH0KICB9Cn0gOiB7fTsKdmFyIHBsYXRmb3JtTW9kdWxlcyA9IFthdHRycywga2xhc3MsIGV2ZW50cywgZG9tUHJvcHMsIHN0eWxlLCB0cmFuc2l0aW9uXTsKLyogICovCi8vIHRoZSBkaXJlY3RpdmUgbW9kdWxlIHNob3VsZCBiZSBhcHBsaWVkIGxhc3QsIGFmdGVyIGFsbAovLyBidWlsdC1pbiBtb2R1bGVzIGhhdmUgYmVlbiBhcHBsaWVkLgoKdmFyIG1vZHVsZXMgPSBwbGF0Zm9ybU1vZHVsZXMuY29uY2F0KGJhc2VNb2R1bGVzKTsKdmFyIHBhdGNoID0gY3JlYXRlUGF0Y2hGdW5jdGlvbih7CiAgbm9kZU9wczogbm9kZU9wcywKICBtb2R1bGVzOiBtb2R1bGVzCn0pOwovKioKICogTm90IHR5cGUgY2hlY2tpbmcgdGhpcyBmaWxlIGJlY2F1c2UgZmxvdyBkb2Vzbid0IGxpa2UgYXR0YWNoaW5nCiAqIHByb3BlcnRpZXMgdG8gRWxlbWVudHMuCiAqLwoKLyogaXN0YW5idWwgaWdub3JlIGlmICovCgppZiAoaXNJRTkpIHsKICAvLyBodHRwOi8vd3d3Lm1hdHRzNDExLmNvbS9wb3N0L2ludGVybmV0LWV4cGxvcmVyLTktb25pbnB1dC8KICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZWwgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwoKICAgIGlmIChlbCAmJiBlbC52bW9kZWwpIHsKICAgICAgdHJpZ2dlcihlbCwgJ2lucHV0Jyk7CiAgICB9CiAgfSk7Cn0KCnZhciBkaXJlY3RpdmUgPSB7CiAgaW5zZXJ0ZWQ6IGZ1bmN0aW9uIGluc2VydGVkKGVsLCBiaW5kaW5nLCB2bm9kZSwgb2xkVm5vZGUpIHsKICAgIGlmICh2bm9kZS50YWcgPT09ICdzZWxlY3QnKSB7CiAgICAgIC8vICM2OTAzCiAgICAgIGlmIChvbGRWbm9kZS5lbG0gJiYgIW9sZFZub2RlLmVsbS5fdk9wdGlvbnMpIHsKICAgICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRpcmVjdGl2ZS5jb21wb25lbnRVcGRhdGVkKGVsLCBiaW5kaW5nLCB2bm9kZSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLmNvbnRleHQpOwogICAgICB9CgogICAgICBlbC5fdk9wdGlvbnMgPSBbXS5tYXAuY2FsbChlbC5vcHRpb25zLCBnZXRWYWx1ZSk7CiAgICB9IGVsc2UgaWYgKHZub2RlLnRhZyA9PT0gJ3RleHRhcmVhJyB8fCBpc1RleHRJbnB1dFR5cGUoZWwudHlwZSkpIHsKICAgICAgZWwuX3ZNb2RpZmllcnMgPSBiaW5kaW5nLm1vZGlmaWVyczsKCiAgICAgIGlmICghYmluZGluZy5tb2RpZmllcnMubGF6eSkgewogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbXBvc2l0aW9uc3RhcnQnLCBvbkNvbXBvc2l0aW9uU3RhcnQpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbXBvc2l0aW9uZW5kJywgb25Db21wb3NpdGlvbkVuZCk7IC8vIFNhZmFyaSA8IDEwLjIgJiBVSVdlYlZpZXcgZG9lc24ndCBmaXJlIGNvbXBvc2l0aW9uZW5kIHdoZW4KICAgICAgICAvLyBzd2l0Y2hpbmcgZm9jdXMgYmVmb3JlIGNvbmZpcm1pbmcgY29tcG9zaXRpb24gY2hvaWNlCiAgICAgICAgLy8gdGhpcyBhbHNvIGZpeGVzIHRoZSBpc3N1ZSB3aGVyZSBzb21lIGJyb3dzZXJzIGUuZy4gaU9TIENocm9tZQogICAgICAgIC8vIGZpcmVzICJjaGFuZ2UiIGluc3RlYWQgb2YgImlucHV0IiBvbiBhdXRvY29tcGxldGUuCgogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIG9uQ29tcG9zaXRpb25FbmQpOwogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgICAgICBpZiAoaXNJRTkpIHsKICAgICAgICAgIGVsLnZtb2RlbCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwKICBjb21wb25lbnRVcGRhdGVkOiBmdW5jdGlvbiBjb21wb25lbnRVcGRhdGVkKGVsLCBiaW5kaW5nLCB2bm9kZSkgewogICAgaWYgKHZub2RlLnRhZyA9PT0gJ3NlbGVjdCcpIHsKICAgICAgc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLmNvbnRleHQpOyAvLyBpbiBjYXNlIHRoZSBvcHRpb25zIHJlbmRlcmVkIGJ5IHYtZm9yIGhhdmUgY2hhbmdlZCwKICAgICAgLy8gaXQncyBwb3NzaWJsZSB0aGF0IHRoZSB2YWx1ZSBpcyBvdXQtb2Ytc3luYyB3aXRoIHRoZSByZW5kZXJlZCBvcHRpb25zLgogICAgICAvLyBkZXRlY3Qgc3VjaCBjYXNlcyBhbmQgZmlsdGVyIG91dCB2YWx1ZXMgdGhhdCBubyBsb25nZXIgaGFzIGEgbWF0Y2hpbmcKICAgICAgLy8gb3B0aW9uIGluIHRoZSBET00uCgogICAgICB2YXIgcHJldk9wdGlvbnMgPSBlbC5fdk9wdGlvbnM7CiAgICAgIHZhciBjdXJPcHRpb25zID0gZWwuX3ZPcHRpb25zID0gW10ubWFwLmNhbGwoZWwub3B0aW9ucywgZ2V0VmFsdWUpOwoKICAgICAgaWYgKGN1ck9wdGlvbnMuc29tZShmdW5jdGlvbiAobywgaSkgewogICAgICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCBwcmV2T3B0aW9uc1tpXSk7CiAgICAgIH0pKSB7CiAgICAgICAgLy8gdHJpZ2dlciBjaGFuZ2UgZXZlbnQgaWYKICAgICAgICAvLyBubyBtYXRjaGluZyBvcHRpb24gZm91bmQgZm9yIGF0IGxlYXN0IG9uZSB2YWx1ZQogICAgICAgIHZhciBuZWVkUmVzZXQgPSBlbC5tdWx0aXBsZSA/IGJpbmRpbmcudmFsdWUuc29tZShmdW5jdGlvbiAodikgewogICAgICAgICAgcmV0dXJuIGhhc05vTWF0Y2hpbmdPcHRpb24odiwgY3VyT3B0aW9ucyk7CiAgICAgICAgfSkgOiBiaW5kaW5nLnZhbHVlICE9PSBiaW5kaW5nLm9sZFZhbHVlICYmIGhhc05vTWF0Y2hpbmdPcHRpb24oYmluZGluZy52YWx1ZSwgY3VyT3B0aW9ucyk7CgogICAgICAgIGlmIChuZWVkUmVzZXQpIHsKICAgICAgICAgIHRyaWdnZXIoZWwsICdjaGFuZ2UnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pIHsKICBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSk7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChpc0lFIHx8IGlzRWRnZSkgewogICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAgIH0sIDApOwogIH0KfQoKZnVuY3Rpb24gYWN0dWFsbHlTZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pIHsKICB2YXIgdmFsdWUgPSBiaW5kaW5nLnZhbHVlOwogIHZhciBpc011bHRpcGxlID0gZWwubXVsdGlwbGU7CgogIGlmIChpc011bHRpcGxlICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCI8c2VsZWN0IG11bHRpcGxlIHYtbW9kZWw9XCIiICsgYmluZGluZy5leHByZXNzaW9uICsgIlwiPiAiICsgImV4cGVjdHMgYW4gQXJyYXkgdmFsdWUgZm9yIGl0cyBiaW5kaW5nLCBidXQgZ290ICIgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLnNsaWNlKDgsIC0xKSwgdm0pOwogICAgcmV0dXJuOwogIH0KCiAgdmFyIHNlbGVjdGVkLCBvcHRpb247CgogIGZvciAodmFyIGkgPSAwLCBsID0gZWwub3B0aW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIG9wdGlvbiA9IGVsLm9wdGlvbnNbaV07CgogICAgaWYgKGlzTXVsdGlwbGUpIHsKICAgICAgc2VsZWN0ZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIGdldFZhbHVlKG9wdGlvbikpID4gLTE7CgogICAgICBpZiAob3B0aW9uLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHNlbGVjdGVkOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAobG9vc2VFcXVhbChnZXRWYWx1ZShvcHRpb24pLCB2YWx1ZSkpIHsKICAgICAgICBpZiAoZWwuc2VsZWN0ZWRJbmRleCAhPT0gaSkgewogICAgICAgICAgZWwuc2VsZWN0ZWRJbmRleCA9IGk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CgogIGlmICghaXNNdWx0aXBsZSkgewogICAgZWwuc2VsZWN0ZWRJbmRleCA9IC0xOwogIH0KfQoKZnVuY3Rpb24gaGFzTm9NYXRjaGluZ09wdGlvbih2YWx1ZSwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmV2ZXJ5KGZ1bmN0aW9uIChvKSB7CiAgICByZXR1cm4gIWxvb3NlRXF1YWwobywgdmFsdWUpOwogIH0pOwp9CgpmdW5jdGlvbiBnZXRWYWx1ZShvcHRpb24pIHsKICByZXR1cm4gJ192YWx1ZScgaW4gb3B0aW9uID8gb3B0aW9uLl92YWx1ZSA6IG9wdGlvbi52YWx1ZTsKfQoKZnVuY3Rpb24gb25Db21wb3NpdGlvblN0YXJ0KGUpIHsKICBlLnRhcmdldC5jb21wb3NpbmcgPSB0cnVlOwp9CgpmdW5jdGlvbiBvbkNvbXBvc2l0aW9uRW5kKGUpIHsKICAvLyBwcmV2ZW50IHRyaWdnZXJpbmcgYW4gaW5wdXQgZXZlbnQgZm9yIG5vIHJlYXNvbgogIGlmICghZS50YXJnZXQuY29tcG9zaW5nKSB7CiAgICByZXR1cm47CiAgfQoKICBlLnRhcmdldC5jb21wb3NpbmcgPSBmYWxzZTsKICB0cmlnZ2VyKGUudGFyZ2V0LCAnaW5wdXQnKTsKfQoKZnVuY3Rpb24gdHJpZ2dlcihlbCwgdHlwZSkgewogIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICBlLmluaXRFdmVudCh0eXBlLCB0cnVlLCB0cnVlKTsKICBlbC5kaXNwYXRjaEV2ZW50KGUpOwp9Ci8qICAqLwovLyByZWN1cnNpdmVseSBzZWFyY2ggZm9yIHBvc3NpYmxlIHRyYW5zaXRpb24gZGVmaW5lZCBpbnNpZGUgdGhlIGNvbXBvbmVudCByb290CgoKZnVuY3Rpb24gbG9jYXRlTm9kZSh2bm9kZSkgewogIHJldHVybiB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSAmJiAoIXZub2RlLmRhdGEgfHwgIXZub2RlLmRhdGEudHJhbnNpdGlvbikgPyBsb2NhdGVOb2RlKHZub2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZSkgOiB2bm9kZTsKfQoKdmFyIHNob3cgPSB7CiAgYmluZDogZnVuY3Rpb24gYmluZChlbCwgcmVmLCB2bm9kZSkgewogICAgdmFyIHZhbHVlID0gcmVmLnZhbHVlOwogICAgdm5vZGUgPSBsb2NhdGVOb2RlKHZub2RlKTsKICAgIHZhciB0cmFuc2l0aW9uJCQxID0gdm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLnRyYW5zaXRpb247CiAgICB2YXIgb3JpZ2luYWxEaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5ID0gZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJycgOiBlbC5zdHlsZS5kaXNwbGF5OwoKICAgIGlmICh2YWx1ZSAmJiB0cmFuc2l0aW9uJCQxKSB7CiAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgIGVudGVyKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IG9yaWdpbmFsRGlzcGxheTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBvcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICB9CiAgfSwKICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShlbCwgcmVmLCB2bm9kZSkgewogICAgdmFyIHZhbHVlID0gcmVmLnZhbHVlOwogICAgdmFyIG9sZFZhbHVlID0gcmVmLm9sZFZhbHVlOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKCF2YWx1ZSA9PT0gIW9sZFZhbHVlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgdmFyIHRyYW5zaXRpb24kJDEgPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKCiAgICBpZiAodHJhbnNpdGlvbiQkMSkgewogICAgICB2bm9kZS5kYXRhLnNob3cgPSB0cnVlOwoKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZW50ZXIodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBlbC5fX3ZPcmlnaW5hbERpc3BsYXk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGVhdmUodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZSA/IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA6ICdub25lJzsKICAgIH0KICB9LAogIHVuYmluZDogZnVuY3Rpb24gdW5iaW5kKGVsLCBiaW5kaW5nLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSkgewogICAgaWYgKCFpc0Rlc3Ryb3kpIHsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheTsKICAgIH0KICB9Cn07CnZhciBwbGF0Zm9ybURpcmVjdGl2ZXMgPSB7CiAgbW9kZWw6IGRpcmVjdGl2ZSwKICBzaG93OiBzaG93Cn07Ci8qICAqLwoKdmFyIHRyYW5zaXRpb25Qcm9wcyA9IHsKICBuYW1lOiBTdHJpbmcsCiAgYXBwZWFyOiBCb29sZWFuLAogIGNzczogQm9vbGVhbiwKICBtb2RlOiBTdHJpbmcsCiAgdHlwZTogU3RyaW5nLAogIGVudGVyQ2xhc3M6IFN0cmluZywKICBsZWF2ZUNsYXNzOiBTdHJpbmcsCiAgZW50ZXJUb0NsYXNzOiBTdHJpbmcsCiAgbGVhdmVUb0NsYXNzOiBTdHJpbmcsCiAgZW50ZXJBY3RpdmVDbGFzczogU3RyaW5nLAogIGxlYXZlQWN0aXZlQ2xhc3M6IFN0cmluZywKICBhcHBlYXJDbGFzczogU3RyaW5nLAogIGFwcGVhckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgYXBwZWFyVG9DbGFzczogU3RyaW5nLAogIGR1cmF0aW9uOiBbTnVtYmVyLCBTdHJpbmcsIE9iamVjdF0KfTsgLy8gaW4gY2FzZSB0aGUgY2hpbGQgaXMgYWxzbyBhbiBhYnN0cmFjdCBjb21wb25lbnQsIGUuZy4gPGtlZXAtYWxpdmU+Ci8vIHdlIHdhbnQgdG8gcmVjdXJzaXZlbHkgcmV0cmlldmUgdGhlIHJlYWwgY29tcG9uZW50IHRvIGJlIHJlbmRlcmVkCgpmdW5jdGlvbiBnZXRSZWFsQ2hpbGQodm5vZGUpIHsKICB2YXIgY29tcE9wdGlvbnMgPSB2bm9kZSAmJiB2bm9kZS5jb21wb25lbnRPcHRpb25zOwoKICBpZiAoY29tcE9wdGlvbnMgJiYgY29tcE9wdGlvbnMuQ3Rvci5vcHRpb25zWyJhYnN0cmFjdCJdKSB7CiAgICByZXR1cm4gZ2V0UmVhbENoaWxkKGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoY29tcE9wdGlvbnMuY2hpbGRyZW4pKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHZub2RlOwogIH0KfQoKZnVuY3Rpb24gZXh0cmFjdFRyYW5zaXRpb25EYXRhKGNvbXApIHsKICB2YXIgZGF0YSA9IHt9OwogIHZhciBvcHRpb25zID0gY29tcC4kb3B0aW9uczsgLy8gcHJvcHMKCiAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMucHJvcHNEYXRhKSB7CiAgICBkYXRhW2tleV0gPSBjb21wW2tleV07CiAgfSAvLyBldmVudHMuCiAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgYW5kIHBhc3MgdGhlbSBkaXJlY3RseSB0byB0aGUgdHJhbnNpdGlvbiBtZXRob2RzCgoKICB2YXIgbGlzdGVuZXJzID0gb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzOwoKICBmb3IgKHZhciBrZXkkMSBpbiBsaXN0ZW5lcnMpIHsKICAgIGRhdGFbY2FtZWxpemUoa2V5JDEpXSA9IGxpc3RlbmVyc1trZXkkMV07CiAgfQoKICByZXR1cm4gZGF0YTsKfQoKZnVuY3Rpb24gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpIHsKICBpZiAoL1xkLWtlZXAtYWxpdmUkLy50ZXN0KHJhd0NoaWxkLnRhZykpIHsKICAgIHJldHVybiBoKCdrZWVwLWFsaXZlJywgewogICAgICBwcm9wczogcmF3Q2hpbGQuY29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGEKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gaGFzUGFyZW50VHJhbnNpdGlvbih2bm9kZSkgewogIHdoaWxlICh2bm9kZSA9IHZub2RlLnBhcmVudCkgewogICAgaWYgKHZub2RlLmRhdGEudHJhbnNpdGlvbikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgewogIHJldHVybiBvbGRDaGlsZC5rZXkgPT09IGNoaWxkLmtleSAmJiBvbGRDaGlsZC50YWcgPT09IGNoaWxkLnRhZzsKfQoKdmFyIGlzTm90VGV4dE5vZGUgPSBmdW5jdGlvbiBpc05vdFRleHROb2RlKGMpIHsKICByZXR1cm4gYy50YWcgfHwgaXNBc3luY1BsYWNlaG9sZGVyKGMpOwp9OwoKdmFyIGlzVlNob3dEaXJlY3RpdmUgPSBmdW5jdGlvbiBpc1ZTaG93RGlyZWN0aXZlKGQpIHsKICByZXR1cm4gZC5uYW1lID09PSAnc2hvdyc7Cn07Cgp2YXIgVHJhbnNpdGlvbiA9IHsKICBuYW1lOiAndHJhbnNpdGlvbicsCiAgcHJvcHM6IHRyYW5zaXRpb25Qcm9wcywKICAiYWJzdHJhY3QiOiB0cnVlLAogIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKGgpIHsKICAgIHZhciB0aGlzJDEgPSB0aGlzOwogICAgdmFyIGNoaWxkcmVuID0gdGhpcy4kc2xvdHNbImRlZmF1bHQiXTsKCiAgICBpZiAoIWNoaWxkcmVuKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gZmlsdGVyIG91dCB0ZXh0IG5vZGVzIChwb3NzaWJsZSB3aGl0ZXNwYWNlcykKCgogICAgY2hpbGRyZW4gPSBjaGlsZHJlbi5maWx0ZXIoaXNOb3RUZXh0Tm9kZSk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCkgewogICAgICByZXR1cm47CiAgICB9IC8vIHdhcm4gbXVsdGlwbGUgZWxlbWVudHMKCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY2hpbGRyZW4ubGVuZ3RoID4gMSkgewogICAgICB3YXJuKCc8dHJhbnNpdGlvbj4gY2FuIG9ubHkgYmUgdXNlZCBvbiBhIHNpbmdsZSBlbGVtZW50LiBVc2UgJyArICc8dHJhbnNpdGlvbi1ncm91cD4gZm9yIGxpc3RzLicsIHRoaXMuJHBhcmVudCk7CiAgICB9CgogICAgdmFyIG1vZGUgPSB0aGlzLm1vZGU7IC8vIHdhcm4gaW52YWxpZCBtb2RlCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgbW9kZSAmJiBtb2RlICE9PSAnaW4tb3V0JyAmJiBtb2RlICE9PSAnb3V0LWluJykgewogICAgICB3YXJuKCdpbnZhbGlkIDx0cmFuc2l0aW9uPiBtb2RlOiAnICsgbW9kZSwgdGhpcy4kcGFyZW50KTsKICAgIH0KCiAgICB2YXIgcmF3Q2hpbGQgPSBjaGlsZHJlblswXTsgLy8gaWYgdGhpcyBpcyBhIGNvbXBvbmVudCByb290IG5vZGUgYW5kIHRoZSBjb21wb25lbnQncwogICAgLy8gcGFyZW50IGNvbnRhaW5lciBub2RlIGFsc28gaGFzIHRyYW5zaXRpb24sIHNraXAuCgogICAgaWYgKGhhc1BhcmVudFRyYW5zaXRpb24odGhpcy4kdm5vZGUpKSB7CiAgICAgIHJldHVybiByYXdDaGlsZDsKICAgIH0gLy8gYXBwbHkgdHJhbnNpdGlvbiBkYXRhIHRvIGNoaWxkCiAgICAvLyB1c2UgZ2V0UmVhbENoaWxkKCkgdG8gaWdub3JlIGFic3RyYWN0IGNvbXBvbmVudHMgZS5nLiBrZWVwLWFsaXZlCgoKICAgIHZhciBjaGlsZCA9IGdldFJlYWxDaGlsZChyYXdDaGlsZCk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAoIWNoaWxkKSB7CiAgICAgIHJldHVybiByYXdDaGlsZDsKICAgIH0KCiAgICBpZiAodGhpcy5fbGVhdmluZykgewogICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpOwogICAgfSAvLyBlbnN1cmUgYSBrZXkgdGhhdCBpcyB1bmlxdWUgdG8gdGhlIHZub2RlIHR5cGUgYW5kIHRvIHRoaXMgdHJhbnNpdGlvbgogICAgLy8gY29tcG9uZW50IGluc3RhbmNlLiBUaGlzIGtleSB3aWxsIGJlIHVzZWQgdG8gcmVtb3ZlIHBlbmRpbmcgbGVhdmluZyBub2RlcwogICAgLy8gZHVyaW5nIGVudGVyaW5nLgoKCiAgICB2YXIgaWQgPSAiX190cmFuc2l0aW9uLSIgKyB0aGlzLl91aWQgKyAiLSI7CiAgICBjaGlsZC5rZXkgPSBjaGlsZC5rZXkgPT0gbnVsbCA/IGNoaWxkLmlzQ29tbWVudCA/IGlkICsgJ2NvbW1lbnQnIDogaWQgKyBjaGlsZC50YWcgOiBpc1ByaW1pdGl2ZShjaGlsZC5rZXkpID8gU3RyaW5nKGNoaWxkLmtleSkuaW5kZXhPZihpZCkgPT09IDAgPyBjaGlsZC5rZXkgOiBpZCArIGNoaWxkLmtleSA6IGNoaWxkLmtleTsKICAgIHZhciBkYXRhID0gKGNoaWxkLmRhdGEgfHwgKGNoaWxkLmRhdGEgPSB7fSkpLnRyYW5zaXRpb24gPSBleHRyYWN0VHJhbnNpdGlvbkRhdGEodGhpcyk7CiAgICB2YXIgb2xkUmF3Q2hpbGQgPSB0aGlzLl92bm9kZTsKICAgIHZhciBvbGRDaGlsZCA9IGdldFJlYWxDaGlsZChvbGRSYXdDaGlsZCk7IC8vIG1hcmsgdi1zaG93CiAgICAvLyBzbyB0aGF0IHRoZSB0cmFuc2l0aW9uIG1vZHVsZSBjYW4gaGFuZCBvdmVyIHRoZSBjb250cm9sIHRvIHRoZSBkaXJlY3RpdmUKCiAgICBpZiAoY2hpbGQuZGF0YS5kaXJlY3RpdmVzICYmIGNoaWxkLmRhdGEuZGlyZWN0aXZlcy5zb21lKGlzVlNob3dEaXJlY3RpdmUpKSB7CiAgICAgIGNoaWxkLmRhdGEuc2hvdyA9IHRydWU7CiAgICB9CgogICAgaWYgKG9sZENoaWxkICYmIG9sZENoaWxkLmRhdGEgJiYgIWlzU2FtZUNoaWxkKGNoaWxkLCBvbGRDaGlsZCkgJiYgIWlzQXN5bmNQbGFjZWhvbGRlcihvbGRDaGlsZCkgJiYgLy8gIzY2ODcgY29tcG9uZW50IHJvb3QgaXMgYSBjb21tZW50IG5vZGUKICAgICEob2xkQ2hpbGQuY29tcG9uZW50SW5zdGFuY2UgJiYgb2xkQ2hpbGQuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlLmlzQ29tbWVudCkpIHsKICAgICAgLy8gcmVwbGFjZSBvbGQgY2hpbGQgdHJhbnNpdGlvbiBkYXRhIHdpdGggZnJlc2ggb25lCiAgICAgIC8vIGltcG9ydGFudCBmb3IgZHluYW1pYyB0cmFuc2l0aW9ucyEKICAgICAgdmFyIG9sZERhdGEgPSBvbGRDaGlsZC5kYXRhLnRyYW5zaXRpb24gPSBleHRlbmQoe30sIGRhdGEpOyAvLyBoYW5kbGUgdHJhbnNpdGlvbiBtb2RlCgogICAgICBpZiAobW9kZSA9PT0gJ291dC1pbicpIHsKICAgICAgICAvLyByZXR1cm4gcGxhY2Vob2xkZXIgbm9kZSBhbmQgcXVldWUgdXBkYXRlIHdoZW4gbGVhdmUgZmluaXNoZXMKICAgICAgICB0aGlzLl9sZWF2aW5nID0gdHJ1ZTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhvbGREYXRhLCAnYWZ0ZXJMZWF2ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHRoaXMkMS5fbGVhdmluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcyQxLiRmb3JjZVVwZGF0ZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCk7CiAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2luLW91dCcpIHsKICAgICAgICBpZiAoaXNBc3luY1BsYWNlaG9sZGVyKGNoaWxkKSkgewogICAgICAgICAgcmV0dXJuIG9sZFJhd0NoaWxkOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbGF5ZWRMZWF2ZTsKCiAgICAgICAgdmFyIHBlcmZvcm1MZWF2ZSA9IGZ1bmN0aW9uIHBlcmZvcm1MZWF2ZSgpIHsKICAgICAgICAgIGRlbGF5ZWRMZWF2ZSgpOwogICAgICAgIH07CgogICAgICAgIG1lcmdlVk5vZGVIb29rKGRhdGEsICdhZnRlckVudGVyJywgcGVyZm9ybUxlYXZlKTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhkYXRhLCAnZW50ZXJDYW5jZWxsZWQnLCBwZXJmb3JtTGVhdmUpOwogICAgICAgIG1lcmdlVk5vZGVIb29rKG9sZERhdGEsICdkZWxheUxlYXZlJywgZnVuY3Rpb24gKGxlYXZlKSB7CiAgICAgICAgICBkZWxheWVkTGVhdmUgPSBsZWF2ZTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiByYXdDaGlsZDsKICB9Cn07Ci8qICAqLwoKdmFyIHByb3BzID0gZXh0ZW5kKHsKICB0YWc6IFN0cmluZywKICBtb3ZlQ2xhc3M6IFN0cmluZwp9LCB0cmFuc2l0aW9uUHJvcHMpOwpkZWxldGUgcHJvcHMubW9kZTsKdmFyIFRyYW5zaXRpb25Hcm91cCA9IHsKICBwcm9wczogcHJvcHMsCiAgYmVmb3JlTW91bnQ6IGZ1bmN0aW9uIGJlZm9yZU1vdW50KCkgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CiAgICB2YXIgdXBkYXRlID0gdGhpcy5fdXBkYXRlOwoKICAgIHRoaXMuX3VwZGF0ZSA9IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh0aGlzJDEpOyAvLyBmb3JjZSByZW1vdmluZyBwYXNzCgogICAgICB0aGlzJDEuX19wYXRjaF9fKHRoaXMkMS5fdm5vZGUsIHRoaXMkMS5rZXB0LCBmYWxzZSwgLy8gaHlkcmF0aW5nCiAgICAgIHRydWUgLy8gcmVtb3ZlT25seSAoIWltcG9ydGFudCwgYXZvaWRzIHVubmVjZXNzYXJ5IG1vdmVzKQogICAgICApOwoKICAgICAgdGhpcyQxLl92bm9kZSA9IHRoaXMkMS5rZXB0OwogICAgICByZXN0b3JlQWN0aXZlSW5zdGFuY2UoKTsKICAgICAgdXBkYXRlLmNhbGwodGhpcyQxLCB2bm9kZSwgaHlkcmF0aW5nKTsKICAgIH07CiAgfSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihoKSB7CiAgICB2YXIgdGFnID0gdGhpcy50YWcgfHwgdGhpcy4kdm5vZGUuZGF0YS50YWcgfHwgJ3NwYW4nOwogICAgdmFyIG1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB2YXIgcHJldkNoaWxkcmVuID0gdGhpcy5wcmV2Q2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgdmFyIHJhd0NoaWxkcmVuID0gdGhpcy4kc2xvdHNbImRlZmF1bHQiXSB8fCBbXTsKICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgIHZhciB0cmFuc2l0aW9uRGF0YSA9IGV4dHJhY3RUcmFuc2l0aW9uRGF0YSh0aGlzKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJhd0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjID0gcmF3Q2hpbGRyZW5baV07CgogICAgICBpZiAoYy50YWcpIHsKICAgICAgICBpZiAoYy5rZXkgIT0gbnVsbCAmJiBTdHJpbmcoYy5rZXkpLmluZGV4T2YoJ19fdmxpc3QnKSAhPT0gMCkgewogICAgICAgICAgY2hpbGRyZW4ucHVzaChjKTsKICAgICAgICAgIG1hcFtjLmtleV0gPSBjOwogICAgICAgICAgKGMuZGF0YSB8fCAoYy5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gdHJhbnNpdGlvbkRhdGE7CiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB2YXIgb3B0cyA9IGMuY29tcG9uZW50T3B0aW9uczsKICAgICAgICAgIHZhciBuYW1lID0gb3B0cyA/IG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcgfHwgJycgOiBjLnRhZzsKICAgICAgICAgIHdhcm4oIjx0cmFuc2l0aW9uLWdyb3VwPiBjaGlsZHJlbiBtdXN0IGJlIGtleWVkOiA8IiArIG5hbWUgKyAiPiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChwcmV2Q2hpbGRyZW4pIHsKICAgICAgdmFyIGtlcHQgPSBbXTsKICAgICAgdmFyIHJlbW92ZWQgPSBbXTsKCiAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IHByZXZDaGlsZHJlbi5sZW5ndGg7IGkkMSsrKSB7CiAgICAgICAgdmFyIGMkMSA9IHByZXZDaGlsZHJlbltpJDFdOwogICAgICAgIGMkMS5kYXRhLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRGF0YTsKICAgICAgICBjJDEuZGF0YS5wb3MgPSBjJDEuZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICBpZiAobWFwW2MkMS5rZXldKSB7CiAgICAgICAgICBrZXB0LnB1c2goYyQxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVtb3ZlZC5wdXNoKGMkMSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmtlcHQgPSBoKHRhZywgbnVsbCwga2VwdCk7CiAgICAgIHRoaXMucmVtb3ZlZCA9IHJlbW92ZWQ7CiAgICB9CgogICAgcmV0dXJuIGgodGFnLCBudWxsLCBjaGlsZHJlbik7CiAgfSwKICB1cGRhdGVkOiBmdW5jdGlvbiB1cGRhdGVkKCkgewogICAgdmFyIGNoaWxkcmVuID0gdGhpcy5wcmV2Q2hpbGRyZW47CiAgICB2YXIgbW92ZUNsYXNzID0gdGhpcy5tb3ZlQ2xhc3MgfHwgKHRoaXMubmFtZSB8fCAndicpICsgJy1tb3ZlJzsKCiAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCB8fCAhdGhpcy5oYXNNb3ZlKGNoaWxkcmVuWzBdLmVsbSwgbW92ZUNsYXNzKSkgewogICAgICByZXR1cm47CiAgICB9IC8vIHdlIGRpdmlkZSB0aGUgd29yayBpbnRvIHRocmVlIGxvb3BzIHRvIGF2b2lkIG1peGluZyBET00gcmVhZHMgYW5kIHdyaXRlcwogICAgLy8gaW4gZWFjaCBpdGVyYXRpb24gLSB3aGljaCBoZWxwcyBwcmV2ZW50IGxheW91dCB0aHJhc2hpbmcuCgoKICAgIGNoaWxkcmVuLmZvckVhY2goY2FsbFBlbmRpbmdDYnMpOwogICAgY2hpbGRyZW4uZm9yRWFjaChyZWNvcmRQb3NpdGlvbik7CiAgICBjaGlsZHJlbi5mb3JFYWNoKGFwcGx5VHJhbnNsYXRpb24pOyAvLyBmb3JjZSByZWZsb3cgdG8gcHV0IGV2ZXJ5dGhpbmcgaW4gcG9zaXRpb24KICAgIC8vIGFzc2lnbiB0byB0aGlzIHRvIGF2b2lkIGJlaW5nIHJlbW92ZWQgaW4gdHJlZS1zaGFraW5nCiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCiAgICB0aGlzLl9yZWZsb3cgPSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDsKICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgaWYgKGMuZGF0YS5tb3ZlZCkgewogICAgICAgIHZhciBlbCA9IGMuZWxtOwogICAgICAgIHZhciBzID0gZWwuc3R5bGU7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBtb3ZlQ2xhc3MpOwogICAgICAgIHMudHJhbnNmb3JtID0gcy5XZWJraXRUcmFuc2Zvcm0gPSBzLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcnOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIodHJhbnNpdGlvbkVuZEV2ZW50LCBlbC5fbW92ZUNiID0gZnVuY3Rpb24gY2IoZSkgewogICAgICAgICAgaWYgKGUgJiYgZS50YXJnZXQgIT09IGVsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWUgfHwgL3RyYW5zZm9ybSQvLnRlc3QoZS5wcm9wZXJ0eU5hbWUpKSB7CiAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIodHJhbnNpdGlvbkVuZEV2ZW50LCBjYik7CiAgICAgICAgICAgIGVsLl9tb3ZlQ2IgPSBudWxsOwogICAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIG1vdmVDbGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0sCiAgbWV0aG9kczogewogICAgaGFzTW92ZTogZnVuY3Rpb24gaGFzTW92ZShlbCwgbW92ZUNsYXNzKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoIWhhc1RyYW5zaXRpb24pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICAgICAgaWYgKHRoaXMuX2hhc01vdmUpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzTW92ZTsKICAgICAgfSAvLyBEZXRlY3Qgd2hldGhlciBhbiBlbGVtZW50IHdpdGggdGhlIG1vdmUgY2xhc3MgYXBwbGllZCBoYXMKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zLiBTaW5jZSB0aGUgZWxlbWVudCBtYXkgYmUgaW5zaWRlIGFuIGVudGVyaW5nCiAgICAgIC8vIHRyYW5zaXRpb24gYXQgdGhpcyB2ZXJ5IG1vbWVudCwgd2UgbWFrZSBhIGNsb25lIG9mIGl0IGFuZCByZW1vdmUKICAgICAgLy8gYWxsIG90aGVyIHRyYW5zaXRpb24gY2xhc3NlcyBhcHBsaWVkIHRvIGVuc3VyZSBvbmx5IHRoZSBtb3ZlIGNsYXNzCiAgICAgIC8vIGlzIGFwcGxpZWQuCgoKICAgICAgdmFyIGNsb25lID0gZWwuY2xvbmVOb2RlKCk7CgogICAgICBpZiAoZWwuX3RyYW5zaXRpb25DbGFzc2VzKSB7CiAgICAgICAgZWwuX3RyYW5zaXRpb25DbGFzc2VzLmZvckVhY2goZnVuY3Rpb24gKGNscykgewogICAgICAgICAgcmVtb3ZlQ2xhc3MoY2xvbmUsIGNscyk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGFkZENsYXNzKGNsb25lLCBtb3ZlQ2xhc3MpOwogICAgICBjbG9uZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB0aGlzLiRlbC5hcHBlbmRDaGlsZChjbG9uZSk7CiAgICAgIHZhciBpbmZvID0gZ2V0VHJhbnNpdGlvbkluZm8oY2xvbmUpOwogICAgICB0aGlzLiRlbC5yZW1vdmVDaGlsZChjbG9uZSk7CiAgICAgIHJldHVybiB0aGlzLl9oYXNNb3ZlID0gaW5mby5oYXNUcmFuc2Zvcm07CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gY2FsbFBlbmRpbmdDYnMoYykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChjLmVsbS5fbW92ZUNiKSB7CiAgICBjLmVsbS5fbW92ZUNiKCk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKGMuZWxtLl9lbnRlckNiKSB7CiAgICBjLmVsbS5fZW50ZXJDYigpOwogIH0KfQoKZnVuY3Rpb24gcmVjb3JkUG9zaXRpb24oYykgewogIGMuZGF0YS5uZXdQb3MgPSBjLmVsbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKfQoKZnVuY3Rpb24gYXBwbHlUcmFuc2xhdGlvbihjKSB7CiAgdmFyIG9sZFBvcyA9IGMuZGF0YS5wb3M7CiAgdmFyIG5ld1BvcyA9IGMuZGF0YS5uZXdQb3M7CiAgdmFyIGR4ID0gb2xkUG9zLmxlZnQgLSBuZXdQb3MubGVmdDsKICB2YXIgZHkgPSBvbGRQb3MudG9wIC0gbmV3UG9zLnRvcDsKCiAgaWYgKGR4IHx8IGR5KSB7CiAgICBjLmRhdGEubW92ZWQgPSB0cnVlOwogICAgdmFyIHMgPSBjLmVsbS5zdHlsZTsKICAgIHMudHJhbnNmb3JtID0gcy5XZWJraXRUcmFuc2Zvcm0gPSAidHJhbnNsYXRlKCIgKyBkeCArICJweCwiICsgZHkgKyAicHgpIjsKICAgIHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJzBzJzsKICB9Cn0KCnZhciBwbGF0Zm9ybUNvbXBvbmVudHMgPSB7CiAgVHJhbnNpdGlvbjogVHJhbnNpdGlvbiwKICBUcmFuc2l0aW9uR3JvdXA6IFRyYW5zaXRpb25Hcm91cAp9OwovKiAgKi8KLy8gaW5zdGFsbCBwbGF0Zm9ybSBzcGVjaWZpYyB1dGlscwoKVnVlLmNvbmZpZy5tdXN0VXNlUHJvcCA9IG11c3RVc2VQcm9wOwpWdWUuY29uZmlnLmlzUmVzZXJ2ZWRUYWcgPSBpc1Jlc2VydmVkVGFnOwpWdWUuY29uZmlnLmlzUmVzZXJ2ZWRBdHRyID0gaXNSZXNlcnZlZEF0dHI7ClZ1ZS5jb25maWcuZ2V0VGFnTmFtZXNwYWNlID0gZ2V0VGFnTmFtZXNwYWNlOwpWdWUuY29uZmlnLmlzVW5rbm93bkVsZW1lbnQgPSBpc1Vua25vd25FbGVtZW50OyAvLyBpbnN0YWxsIHBsYXRmb3JtIHJ1bnRpbWUgZGlyZWN0aXZlcyAmIGNvbXBvbmVudHMKCmV4dGVuZChWdWUub3B0aW9ucy5kaXJlY3RpdmVzLCBwbGF0Zm9ybURpcmVjdGl2ZXMpOwpleHRlbmQoVnVlLm9wdGlvbnMuY29tcG9uZW50cywgcGxhdGZvcm1Db21wb25lbnRzKTsgLy8gaW5zdGFsbCBwbGF0Zm9ybSBwYXRjaCBmdW5jdGlvbgoKVnVlLnByb3RvdHlwZS5fX3BhdGNoX18gPSBpbkJyb3dzZXIgPyBwYXRjaCA6IG5vb3A7IC8vIHB1YmxpYyBtb3VudCBtZXRob2QKClZ1ZS5wcm90b3R5cGUuJG1vdW50ID0gZnVuY3Rpb24gKGVsLCBoeWRyYXRpbmcpIHsKICBlbCA9IGVsICYmIGluQnJvd3NlciA/IHF1ZXJ5KGVsKSA6IHVuZGVmaW5lZDsKICByZXR1cm4gbW91bnRDb21wb25lbnQodGhpcywgZWwsIGh5ZHJhdGluZyk7Cn07IC8vIGRldnRvb2xzIGdsb2JhbCBob29rCgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCmlmIChpbkJyb3dzZXIpIHsKICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIGlmIChjb25maWcuZGV2dG9vbHMpIHsKICAgICAgaWYgKGRldnRvb2xzKSB7CiAgICAgICAgZGV2dG9vbHMuZW1pdCgnaW5pdCcsIFZ1ZSk7CiAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnKSB7CiAgICAgICAgY29uc29sZVtjb25zb2xlLmluZm8gPyAnaW5mbycgOiAnbG9nJ10oJ0Rvd25sb2FkIHRoZSBWdWUgRGV2dG9vbHMgZXh0ZW5zaW9uIGZvciBhIGJldHRlciBkZXZlbG9wbWVudCBleHBlcmllbmNlOlxuJyArICdodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVlLWRldnRvb2xzJyk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Rlc3QnICYmIGNvbmZpZy5wcm9kdWN0aW9uVGlwICE9PSBmYWxzZSAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgY29uc29sZVtjb25zb2xlLmluZm8gPyAnaW5mbycgOiAnbG9nJ10oIllvdSBhcmUgcnVubmluZyBWdWUgaW4gZGV2ZWxvcG1lbnQgbW9kZS5cbiIgKyAiTWFrZSBzdXJlIHRvIHR1cm4gb24gcHJvZHVjdGlvbiBtb2RlIHdoZW4gZGVwbG95aW5nIGZvciBwcm9kdWN0aW9uLlxuIiArICJTZWUgbW9yZSB0aXBzIGF0IGh0dHBzOi8vdnVlanMub3JnL2d1aWRlL2RlcGxveW1lbnQuaHRtbCIpOwogICAgfQogIH0sIDApOwp9Ci8qICAqLwoKCmV4cG9ydCBkZWZhdWx0IFZ1ZTs="},null]}